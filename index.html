<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é›²ç«¯è¨˜å¸³ Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config={theme:{extend:{colors:{primary:'#6366f1',primaryDark:'#4338ca',secondary:'#10B981',danger:'#f43f5e',warning:'#f59e0b',dark:'#1e293b',surface:'#f8fafc'},fontFamily:{sans:['Noto Sans TC','sans-serif'],mono:['Courier Prime','monospace']},boxShadow:{'soft':'0 4px 20px -2px rgba(0,0,0,0.05)','glow':'0 0 15px rgba(99,102,241,0.3)'},animation:{'slide-up':'slideUp 0.3s cubic-bezier(0.16,1,0.3,1)','fade-in':'fadeIn 0.2s ease-out','pulse-fast':'pulseFast 1.5s cubic-bezier(0.4,0,0.6,1) infinite'},keyframes:{slideUp:{'0%':{transform:'translateY(100%)'},'100%':{transform:'translateY(0)'}},fadeIn:{'0%':{opacity:'0'},'100%':{opacity:'1'}},pulseFast:{'0%,100%':{opacity:'1'},'50%':{opacity:'.7'}}}}}}
    </script>
    <style>
        body{-webkit-tap-highlight-color:transparent;background-color:#f1f5f9;font-family:'Noto Sans TC',sans-serif}
        .glass{background:rgba(255,255,255,0.95);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-top:1px solid rgba(255,255,255,0.8)}
        .app-frame{max-width:28rem;margin:0 auto;background-color:#f8fafc;height:100dvh;width:100%;display:flex;flex-direction:column;box-shadow:0 0 40px rgba(0,0,0,0.1);position:relative;overflow:hidden}
        @media(min-width:640px){.app-frame{height:95vh;margin-top:2.5vh;border-radius:2rem;border:8px solid #fff}}
        .hide-scrollbar::-webkit-scrollbar{display:none}.hide-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
        .fab-btn{background:linear-gradient(135deg,#6366f1 0%,#4f46e5 100%);box-shadow:0 8px 20px -4px rgba(99,102,241,0.5)}
        .gradient-card{background:linear-gradient(135deg,#4f46e5 0%,#818cf8 100%);color:white}
        .nav-item.active{color:#4f46e5}.nav-item.active::after{content:'';position:absolute;bottom:-4px;left:50%;transform:translateX(-50%);width:4px;height:4px;background-color:#4f46e5;border-radius:50%}
        .input-box{background:#f1f5f9;border:1px solid transparent;transition:all 0.2s}.input-box:focus{background:#fff;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
        .receipt-jagged{background:linear-gradient(135deg,transparent 5px,white 0) top left,linear-gradient(225deg,transparent 5px,white 0) top right;background-size:10px 10px;background-repeat:repeat-x}
        .nav-scroll { overflow-x: auto; padding-left: 0.5rem; padding-right: 0.5rem; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        #main-content { padding-bottom: 8.5rem; } 
    </style>
</head>
<body class="text-slate-600 text-sm selection:bg-indigo-100 selection:text-indigo-700">
    <div id="login-view" class="fixed inset-0 z-50 bg-white flex flex-col justify-center items-center p-8 animate-fade-in max-w-md mx-auto h-full">
        <div class="mb-12 text-center w-full">
            <img src="https://i.ibb.co/PvVffGgL/image.png" class="w-full max-w-[320px] h-auto object-contain drop-shadow-xl mb-8 mx-auto">
            <h1 class="text-3xl font-bold text-slate-800">é›²ç«¯è¨˜å¸³ <span class="text-primary text-lg">Lite</span></h1>
            <p class="text-slate-400 mt-3 text-sm font-medium">ç°¡å–®ã€ç›´è¦ºçš„å€‹äººè²¡å‹™ç®¡å®¶</p>
        </div>
        <div class="w-full space-y-3">
            <button onclick="App.loginGoogle()" class="w-full bg-white border border-slate-200 text-slate-700 py-3.5 rounded-2xl font-bold shadow-soft hover:bg-slate-50 flex items-center justify-center gap-3 transition-all active:scale-[0.98]"><i class="fa-brands fa-google text-red-500 text-lg"></i> ä½¿ç”¨ Google ç¹¼çºŒ</button>
            <button onclick="App.loginAnon()" class="w-full bg-slate-800 text-white py-3.5 rounded-2xl font-bold shadow-lg hover:bg-slate-900 transition-all active:scale-[0.98]">è¨ªå®¢é«”é©—</button>
        </div>
        <p class="absolute bottom-8 text-xs text-slate-300">Designed for Wilson</p>
    </div>

    <div id="app-container" class="hidden app-frame">
        <header class="bg-white/80 backdrop-blur-md sticky top-0 px-5 py-3 flex justify-between items-center z-20 shrink-0 border-b border-slate-100/50">
            <h1 class="font-bold text-slate-800 flex items-center gap-2.5 text-lg"><img id="header-icon" src="https://i.ibb.co/PvVffGgL/image.png" class="h-10 w-auto object-contain"><span id="page-title" class="hidden">ç¸½è¦½</span></h1>
            <div class="flex items-center gap-3">
                <button onclick="App.openNotificationModal()" class="relative text-slate-400 hover:text-primary p-1 group"><i class="fa-solid fa-bell text-lg group-active:scale-95"></i><span id="notification-badge" class="absolute top-0.5 right-0.5 w-2.5 h-2.5 bg-rose-500 rounded-full border-2 border-white hidden animate-bounce"></span></button>
                <div id="user-info" class="hidden sm:block text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-lg"></div>
                <button onclick="App.logout()" class="text-slate-400 hover:text-danger p-1"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto hide-scrollbar relative px-4 pt-4">
            <div id="view-accounting" class="view-section animate-fade-in space-y-4"></div>
            <div id="view-investment" class="view-section hidden animate-fade-in space-y-4"></div>
            <div id="view-debt" class="view-section hidden animate-fade-in space-y-4"></div>
            <div id="view-reports" class="view-section hidden animate-fade-in space-y-4"></div>
            <div id="view-events" class="view-section hidden animate-fade-in space-y-4"></div>
        </main>

        <nav class="absolute bottom-0 w-full glass pb-safe pt-2 z-30 border-t border-white/60 shadow-[0_-4px_20px_rgba(0,0,0,0.02)]">
            <div class="flex justify-between items-center px-2 nav-scroll hide-scrollbar min-w-full gap-2">
                <button id="nav-accounting" onclick="App.switchTab('accounting',this)" class="nav-item active flex flex-col items-center gap-1.5 p-2 min-w-[3.2rem] flex-shrink-0"><i class="fa-solid fa-house text-lg mb-0.5"></i> è¨˜å¸³</button>
                <button onclick="App.switchTab('investment',this)" class="nav-item flex flex-col items-center gap-1.5 p-2 min-w-[3.2rem] flex-shrink-0"><i class="fa-solid fa-piggy-bank text-lg mb-0.5"></i> è³‡ç”¢</button>
                
                <div class="relative -top-6 mx-1 flex-shrink-0">
                    <button onclick="App.handleFabClick()" class="fab-btn w-14 h-14 rounded-full text-white text-2xl flex items-center justify-center transition-transform hover:scale-105 active:scale-95 shadow-glow"><i class="fa-solid fa-plus"></i></button>
                </div>

                <button onclick="App.switchTab('debt',this)" class="nav-item flex flex-col items-center gap-1.5 p-2 min-w-[3.2rem] flex-shrink-0"><i class="fa-solid fa-file-invoice-dollar text-lg mb-0.5"></i> è² å‚µ</button>
                <button onclick="App.switchTab('events',this)" class="nav-item flex flex-col items-center gap-1.5 p-2 min-w-[3.2rem] flex-shrink-0"><i class="fa-solid fa-calendar-day text-lg mb-0.5"></i> å¤§äº‹</button>
                <button onclick="App.switchTab('reports',this)" class="nav-item flex flex-col items-center gap-1.5 p-2 min-w-[3.2rem] flex-shrink-0"><i class="fa-solid fa-chart-pie text-lg mb-0.5"></i> å ±è¡¨</button>
            </div>
        </nav>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/40 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[28rem] rounded-t-[2rem] sm:rounded-2xl p-6 shadow-2xl animate-slide-up sm:animate-fade-in max-h-[90vh] overflow-y-auto hide-scrollbar relative pb-10"><div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6 sm:hidden"></div></div>
    </div>
    <div id="sub-modal-overlay" class="fixed inset-0 bg-slate-900/30 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm transition-all"><div id="sub-modal-content" class="bg-white w-full max-w-[28rem] rounded-t-[2rem] sm:rounded-2xl p-6 shadow-2xl animate-slide-up max-h-[70vh] overflow-y-auto hide-scrollbar"></div></div>

    <!-- TEMPLATES -->
    <template id="tpl-notifications"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">æé†’äº‹é …</h3><button onclick="App.closeModal()" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200"><i class="fa-solid fa-xmark"></i></button></div><div id="notification-list" class="space-y-3 pb-4"></div><div id="no-notification" class="hidden text-center py-10"><div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300"><i class="fa-regular fa-bell-slash text-xl"></i></div><p class="text-slate-400 text-xs">ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é …</p></div></template>

    <template id="tpl-accounting">
        <div class="gradient-card rounded-3xl p-5 shadow-soft relative overflow-hidden mb-4">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div><div class="absolute bottom-0 left-0 w-24 h-24 bg-black/10 rounded-full blur-xl -ml-10 -mb-5"></div>
            <div id="acc-overdue-badge" class="absolute -top-1 -left-1 hidden z-20 animate-pulse-fast"><div class="bg-rose-500 text-white text-[10px] font-bold px-3 py-1 rounded-br-2xl rounded-tl-xl shadow-md border-b-2 border-r-2 border-rose-700/30">âš ï¸ é€¾æœŸæœªæ”¶ <span id="acc-overdue-val"></span></div></div>
            <div id="acc-pending-income-badge" class="absolute bottom-0 right-0 hidden z-20"><div class="bg-white/20 backdrop-blur-sm text-white text-[10px] font-bold px-3 py-1 rounded-tl-2xl shadow-sm border-t border-l border-white/20">ğŸ“… æœ¬æœˆé æœŸ <span id="acc-pending-income-val"></span></div></div>
            <div class="relative z-10">
                <div class="flex justify-between items-center mb-6 pl-2"><span class="text-indigo-100 text-xs font-medium bg-white/10 px-2 py-1 rounded-lg backdrop-blur-sm">æœ¬æœˆæ¦‚æ³</span><div class="relative"><input type="month" id="date-filter" class="bg-white/20 text-white border-none rounded-lg px-3 py-1 text-xs font-bold focus:ring-2 focus:ring-white/50 cursor-pointer pl-8 backdrop-blur-sm placeholder-white" onchange="App.renderTransactions()"><i class="fa-regular fa-calendar absolute left-2.5 top-1/2 -translate-y-1/2 text-xs text-indigo-100 pointer-events-none"></i></div></div>
                <div class="flex flex-col items-center mb-6"><span class="text-indigo-100 text-xs mb-1">æœ¬æœˆçµé¤˜</span><span id="monthly-balance" class="text-4xl font-bold tracking-tight text-white drop-shadow-sm">0</span></div>
                <div class="grid grid-cols-2 gap-4"><div class="bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10"><p class="text-[10px] opacity-80 mb-1">ç¸½æ”¶å…¥</p><p id="monthly-income" class="text-lg font-bold">0</p></div><div class="bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10"><p class="text-[10px] opacity-80 mb-1">ç¸½æ”¯å‡º</p><p id="monthly-expense" class="text-lg font-bold">0</p></div></div>
            </div>
        </div>
        <div class="flex items-center justify-between px-2 pt-2 mb-2"><span class="text-xs font-bold text-slate-400">æœ¬æ—¥å°è¨ˆ</span><div class="flex gap-3 text-xs font-medium"><span class="text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded">æ”¶ <span id="today-income">0</span></span><span class="text-rose-500 bg-rose-50 px-2 py-0.5 rounded">æ”¯ <span id="today-expense">0</span></span><span class="text-slate-500 bg-slate-100 px-2 py-0.5 rounded" id="today-balance-container">é¤˜ <span id="today-balance">0</span></span></div></div>
        <ul id="tx-list" class="space-y-4 pb-6"></ul>
        <div class="mt-8 pb-4"><div class="flex justify-between items-center px-1 mb-3"><span class="text-xs font-bold text-slate-400 uppercase tracking-wider">é ç®— / æ’ç¨‹</span><button onclick="App.openBudgetModal('accounting')" class="text-primary text-[10px] font-bold bg-indigo-50 px-2 py-1 rounded-lg hover:bg-indigo-100"><i class="fa-solid fa-plus"></i> æ–°å¢</button></div><ul id="accounting-budget-list" class="space-y-2"></ul></div>
    </template>

    <template id="tpl-investment">
        <div class="sticky top-0 z-10 bg-[#f8fafc]/90 backdrop-blur-md pb-2 -mt-2 pt-2 flex justify-between items-center mb-2 px-1"><h3 class="text-lg font-bold text-slate-700">å…¶ä»–è³‡ç”¢</h3><input type="month" id="inv-date-filter" class="bg-white border-none rounded-lg px-2 py-1.5 text-xs font-bold text-slate-600 shadow-sm" onchange="App.renderInvestments()"></div>
        <div class="bg-white p-5 rounded-3xl shadow-soft border border-slate-100 relative overflow-hidden mb-4">
            <div class="relative z-10"><p class="text-slate-400 text-xs font-medium mb-1">è³‡ç”¢ç¸½æ·¨å€¼</p><h2 id="inv-total-val" class="text-3xl font-bold tracking-tight mb-2 text-slate-800">--</h2><div class="flex gap-4 border-t border-slate-100 pt-3"><div><span class="text-slate-400 text-[10px] block mb-0.5">ç´¯ç©æç›Š</span><span id="inv-total-ret" class="font-bold text-sm text-slate-700">--</span></div><div><span class="text-slate-400 text-[10px] block mb-0.5">å ±é…¬ç‡</span><span id="inv-roi" class="font-bold text-sm">--</span></div></div><div id="inv-penalty-summary" class="mt-3 pt-2 border-t border-slate-100 flex items-center justify-between text-rose-500 hidden"><span class="text-[10px] font-bold">âš ï¸ å¾…æ”¶ç½°é‡‘</span><span class="font-bold text-xs" id="inv-total-penalty">$0</span></div></div>
        </div>
        <div class="flex justify-between items-center mb-3"><div class="bg-white p-1 rounded-xl shadow-sm inline-flex"><button class="tab-pill px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500 transition-all active bg-indigo-50 text-primary" onclick="App.switchInvTab('active',this)">é€²è¡Œä¸­</button><button class="tab-pill px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500 transition-all hover:text-slate-700" onclick="App.switchInvTab('archived',this)">å·²çµæ¡ˆ</button></div><button onclick="App.openModal('investment-modal')" class="text-primary text-xs font-bold bg-indigo-50 px-3 py-2 rounded-xl hover:bg-indigo-100 flex items-center gap-1"><i class="fa-solid fa-plus"></i> æ–°å¢å¸³æˆ¶</button></div>
        <span id="inv-monthly-summary" class="block text-center text-xs text-slate-400 mb-3 bg-white/50 py-1 rounded-lg">æœ¬æœˆæ”¶ç›Š: $0</span>
        <div id="inv-list" class="grid gap-3"></div>
        <div class="mt-6"><div class="flex justify-between items-center px-1 mb-3"><span class="text-xs font-bold text-slate-400 uppercase tracking-wider">å®šæœŸå®šé¡ / é æœŸæ”¶å…¥</span><div class="flex gap-2"><select id="inv-budget-filter-select" class="bg-slate-100 border-none rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 outline-none" onchange="App.renderInvestments()"><option value="all">å…¨éƒ¨</option></select><button onclick="App.openBudgetModal('investment')" class="text-secondary text-[10px] font-bold bg-emerald-50 px-2 py-1 rounded-lg hover:bg-emerald-100"><i class="fa-solid fa-plus"></i> æ–°å¢</button></div></div><ul id="inv-budget-list" class="space-y-2"></ul></div>
    </template>

    <template id="tpl-debt">
         <div class="sticky top-0 z-10 bg-[#f8fafc]/90 backdrop-blur-md pb-2 -mt-2 pt-2 flex justify-between items-center mb-2 px-1"><h3 class="text-lg font-bold text-slate-700">è² å‚µç®¡ç†</h3><input type="month" id="debt-date-filter" class="bg-white border-none rounded-lg px-2 py-1.5 text-xs font-bold text-slate-600 shadow-sm" onchange="App.renderDebts()"></div>
        <div class="bg-white p-5 rounded-3xl shadow-soft border-l-4 border-warning mb-4 relative overflow-hidden">
             <div class="flex justify-between items-end mb-4 relative z-10"><div><p class="text-xs text-slate-400 font-medium mb-1">å‰©é¤˜ç¸½è² å‚µ</p><p id="debt-total-remaining" class="text-3xl font-bold text-slate-800 tracking-tight">--</p></div><div class="text-right"><p class="text-[10px] text-slate-400 mb-1">æ•´é«”é‚„æ¬¾é€²åº¦</p><p id="debt-progress-text" class="text-xl font-bold text-warning">0%</p></div></div>
            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden relative z-10"><div id="debt-progress-bar" class="bg-warning h-full rounded-full transition-all duration-1000 ease-out relative" style="width:0%"><div class="absolute inset-0 bg-white/30 w-full h-full animate-[pulse_2s_infinite]"></div></div></div><div class="absolute right-0 bottom-0 w-32 h-32 bg-warning/5 rounded-full blur-2xl -mr-10 -mb-10"></div>
        </div>
        <div class="flex justify-between items-center px-1 mb-3"><span id="debt-monthly-summary" class="text-xs text-danger font-bold bg-rose-50 px-2 py-1 rounded-lg">æœ¬æœˆé‚„æ¬¾: $0</span><button onclick="App.openModal('debt-modal')" class="text-primary text-xs font-bold bg-indigo-50 px-3 py-2 rounded-xl hover:bg-indigo-100 flex items-center gap-1"><i class="fa-solid fa-plus"></i> æ–°å¢é …ç›®</button></div>
        <div id="debt-list" class="space-y-3"></div>
        <div class="mt-6"><div class="flex justify-between items-center px-1 mb-3"><span class="text-xs font-bold text-slate-400 uppercase tracking-wider">é‚„æ¬¾è¨ˆç•«</span><button onclick="App.openBudgetModal('debt')" class="text-danger text-[10px] font-bold bg-rose-50 px-2 py-1 rounded-lg hover:bg-rose-100 transition"><i class="fa-solid fa-plus"></i> æ–°å¢</button></div><ul id="debt-budget-list" class="space-y-2"></ul></div>
    </template>

    <template id="tpl-reports">
        <div class="bg-white p-4 rounded-2xl shadow-soft mb-4 space-y-3"><div class="flex gap-3"><div class="relative flex-1"><select id="report-year" class="w-full bg-slate-50 rounded-xl px-3 py-2 text-xs font-bold appearance-none outline-none" onchange="App.renderReports()"></select><i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400 pointer-events-none"></i></div><div class="relative flex-1"><select id="report-month-select" class="w-full bg-slate-50 rounded-xl px-3 py-2 text-xs font-bold appearance-none outline-none" onchange="App.renderReports()"><option value="all">å…¨å¹´åº¦</option><option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option><option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option><option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option><option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option></select><i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400 pointer-events-none"></i></div></div><div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1"><select id="report-project" class="bg-slate-50 rounded-lg px-3 py-1.5 text-xs font-medium border-none min-w-[100px]" onchange="App.renderReports()"><option value="all">å…¨éƒ¨å°ˆæ¡ˆ</option></select><select id="report-category" class="bg-slate-50 rounded-lg px-3 py-1.5 text-xs font-medium border-none min-w-[100px]" onchange="App.renderReports()"><option value="all">å…¨éƒ¨åˆ†é¡</option></select><button onclick="App.copyReport()" class="bg-indigo-50 w-8 h-8 flex items-center justify-center rounded-lg text-primary hover:bg-indigo-100 flex-shrink-0"><i class="fa-solid fa-copy text-xs"></i></button><button onclick="App.exportReport()" class="bg-indigo-50 w-8 h-8 flex items-center justify-center rounded-lg text-primary hover:bg-indigo-100 flex-shrink-0"><i class="fa-solid fa-file-export text-xs"></i></button></div></div>
        <div class="bg-white p-5 rounded-3xl shadow-soft"><h3 class="font-bold mb-6 text-center text-xs text-slate-400 uppercase tracking-widest">æ”¯å‡ºåˆ†ä½ˆ</h3><div class="h-56 relative"><canvas id="expense-chart"></canvas></div></div>
        <div class="bg-white p-5 rounded-3xl shadow-soft mt-4 mb-20"><h3 class="font-bold mb-4 text-sm text-slate-700 flex items-center gap-2"><i class="fa-solid fa-list-ul text-primary"></i> çµ±è¨ˆèˆ‡æ˜ç´°</h3><ul id="report-stats" class="space-y-3 text-xs mb-6 bg-slate-50 p-3 rounded-xl"></ul><ul id="report-details" class="space-y-3"></ul></div>
    </template>
    
    <template id="tpl-events">
        <div class="flex gap-3 mb-6"><button onclick="App.openModal('event-modal')" class="flex-1 py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold hover:bg-slate-50 hover:border-primary hover:text-primary transition text-xs flex flex-col items-center gap-1 group"><i class="fa-solid fa-pen-fancy text-lg group-hover:scale-110"></i><span>ç´€éŒ„ç”Ÿæ´»å¤§äº‹</span></button><button onclick="App.copyEvents()" class="w-14 flex items-center justify-center bg-white shadow-soft rounded-2xl text-slate-400 hover:text-primary"><i class="fa-solid fa-copy"></i></button><button onclick="App.exportEvents()" class="w-14 flex items-center justify-center bg-white shadow-soft rounded-2xl text-slate-400 hover:text-primary"><i class="fa-solid fa-file-export"></i></button></div>
        <div id="event-list" class="space-y-6 px-1 relative"><div class="absolute left-[19px] top-0 bottom-0 w-0.5 bg-slate-200"></div></div>
    </template>

    <template id="tpl-event-modal">
        <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">ç”Ÿæ´»å¤§äº‹</h3><div class="flex items-center gap-3"><button id="btn-delete-event" class="hidden w-9 h-9 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center hover:bg-rose-100 transition"><i class="fa-solid fa-trash-can text-sm"></i></button><button onclick="App.closeModal()" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button></div></div>
        <form onsubmit="App.handleSaveEvent(event)" class="space-y-5"><input type="hidden" name="id"><div><label class="text-[10px] font-bold text-slate-400 ml-1 block mb-1">æ¨™é¡Œ</label><input type="text" name="title" class="input-box w-full rounded-xl p-3 text-sm" placeholder="ä¾‹å¦‚: è²·æˆ¿, çµå©š, ç•¢æ¥­..." required></div><div><label class="text-[10px] font-bold text-slate-400 ml-1 block mb-1">æ—¥æœŸ</label><input type="date" name="date" class="input-box w-full rounded-xl p-3 text-sm" required></div><div><label class="text-[10px] font-bold text-slate-400 ml-1 block mb-1">è©³ç´°æè¿°</label><textarea name="desc" rows="3" class="input-box w-full rounded-xl p-3 text-sm resize-none" placeholder="è¨˜éŒ„ä¸€ä¸‹ç•¶ä¸‹çš„å¿ƒæƒ…..."></textarea></div><button type="submit" class="w-full bg-primary text-white font-bold py-3.5 rounded-2xl shadow-lg hover:bg-primaryDark active:scale-[0.98] transition">å„²å­˜ç´€éŒ„</button></form>
    </template>

    <template id="tpl-transaction-modal">
        <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800" id="tx-modal-title">è¨˜ä¸€ç­†</h3><div class="flex items-center gap-3"><button id="btn-copy-tx" class="hidden w-9 h-9 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center hover:bg-indigo-100 active:scale-95"><i class="fa-solid fa-copy text-sm"></i></button><button id="btn-delete-tx" class="hidden w-9 h-9 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center hover:bg-rose-100 active:scale-95"><i class="fa-solid fa-trash-can text-sm"></i></button><button onclick="App.closeModal()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 active:scale-95"><i class="fa-solid fa-xmark"></i></button></div></div>
        <form onsubmit="App.handleSaveTransaction(event)" class="space-y-5"><input type="hidden" name="id"><input type="hidden" name="legacy_inv_id"><div class="flex bg-slate-100 p-1.5 rounded-2xl relative"><button type="button" class="type-btn flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-500 transition-all z-10" onclick="App.toggleTxType('expense')" id="btn-expense">æ”¯å‡º</button><button type="button" class="type-btn flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-500 transition-all z-10" onclick="App.toggleTxType('income')" id="btn-income">æ”¶å…¥</button></div><input type="hidden" name="type" id="tx-type" value="expense"><div class="text-center py-2"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">é‡‘é¡</label><div class="relative inline-block w-full"><span class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl text-slate-300 font-bold">$</span><input type="number" name="amount" class="w-full text-4xl font-bold text-slate-800 border-none bg-transparent text-center focus:outline-none placeholder-slate-200" placeholder="0" required inputmode="decimal"></div></div><div class="space-y-4"><div class="grid grid-cols-2 gap-4"><div class="group"><label class="text-[10px] font-bold text-slate-400 ml-1 mb-1 block">æ—¥æœŸ</label><input type="date" name="date" class="input-box w-full rounded-xl px-4 py-3 text-sm font-medium text-slate-700" required></div><div><label class="text-[10px] font-bold text-slate-400 ml-1 block mb-1">åˆ†é¡</label><div class="flex gap-2"><input name="category" class="input-box w-full rounded-xl px-4 py-3 text-sm font-medium text-slate-700" placeholder="åˆ†é¡..." required><button type="button" onclick="App.openCategorySelector()" class="w-12 h-11 bg-indigo-50 rounded-xl flex items-center justify-center text-primary hover:bg-indigo-100 shrink-0 mt-[1px]"><i class="fa-solid fa-list-ul"></i></button></div></div></div><div><label class="text-[10px] font-bold text-slate-400 ml-1 block mb-1">å°ˆæ¡ˆ / å¸³æˆ¶ <span class="text-slate-300 font-normal">(é¸å¡«)</span></label><input type="text" name="project" class="input-box w-full rounded-xl px-4 py-3 text-sm font-medium text-slate-700" placeholder="ä¾‹å¦‚: æ—…éŠåŸºé‡‘ã€å°ç©é›»..."></div><div><label class="text-[10px] font-bold text-slate-400 ml-1 block mb-1">å‚™è¨»</label><textarea name="remarks" rows="2" class="input-box w-full rounded-xl px-4 py-3 text-sm font-medium text-slate-700 resize-none" placeholder="å¯«é»ä»€éº¼..."></textarea></div><div class="flex items-center gap-2 px-1 pt-2"><input type="checkbox" id="tx-unrealized" name="isUnrealized" class="w-5 h-5 rounded text-primary focus:ring-primary border-gray-300 transition cursor-pointer"><label for="tx-unrealized" class="text-xs font-bold text-slate-500 cursor-pointer select-none">æœªå¯¦ç¾ (åƒ…åŠ å…¥é ç®—åˆ—è¡¨)</label></div></div><div class="pt-4"><button type="submit" class="w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 text-sm hover:bg-primaryDark transition active:scale-[0.98]">å„²å­˜ç´€éŒ„</button></div></form>
    </template>

    <template id="tpl-budget-modal">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-slate-800" id="budget-modal-title">æ–°å¢é ç®—</h3>
            <button onclick="App.closeModal()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <form onsubmit="App.handleSaveBudget(event)" class="space-y-5">
            <input type="hidden" name="id">
            <input type="hidden" name="context" id="budget-context">
            <input type="hidden" name="type" id="budget-type" value="expense">
            <div class="flex bg-slate-100 p-1.5 rounded-2xl relative mb-4">
                <button type="button" class="flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-500 transition-all z-10" onclick="App.toggleBudgetType('expense')" id="btn-budget-expense">æ”¯å‡º</button>
                <button type="button" class="flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-500 transition-all z-10" onclick="App.toggleBudgetType('income')" id="btn-budget-income">æ”¶å…¥</button>
            </div>
            <div>
                <label class="text-[10px] font-bold text-slate-400 ml-1 block mb-1">ç›®æ¨™å°è±¡</label>
                <input type="text" name="targetId_input" id="budget-target-input" class="input-box w-full rounded-xl p-3 text-sm hidden" list="budget-categories-list" placeholder="è¼¸å…¥åç¨±...">
                <datalist id="budget-categories-list"></datalist>
                <select name="targetId_select" id="budget-target-select" class="input-box w-full rounded-xl p-3 text-sm font-bold text-slate-700 hidden"></select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-[10px] font-bold text-slate-400 ml-1 block mb-1">é è¨ˆé‡‘é¡</label><input type="number" name="amount" class="input-box w-full rounded-xl p-3 text-sm" placeholder="0" required></div>
                <div><label class="text-[10px] font-bold text-slate-400 ml-1 block mb-1">é è¨ˆæ—¥æœŸ</label><input type="date" name="date" class="input-box w-full rounded-xl p-3 text-sm" required></div>
            </div>
            <div><label class="text-[10px] font-bold text-slate-400 ml-1 block mb-1">èªªæ˜ / å‚™è¨»</label><input type="text" name="desc" class="input-box w-full rounded-xl p-3 text-sm" placeholder="èªªæ˜..."></div>
            <div id="penalty-config" class="hidden flex items-center gap-2 bg-rose-50 p-3 rounded-xl border border-rose-100"><input type="checkbox" name="enablePenalty" id="chk-penalty" class="w-4 h-4 text-rose-500 rounded border-gray-300 focus:ring-rose-500"><div class="flex-1"><label for="chk-penalty" class="text-xs font-bold text-rose-700 block">å•Ÿç”¨æ»¯ç´ç½°é‡‘</label><input type="number" name="dailyPenalty" class="bg-white border border-rose-200 rounded-lg p-1.5 text-xs w-full mt-1" placeholder="æ¯æ—¥ç½°é‡‘é‡‘é¡..."></div></div>
            <div id="recurring-config" class="hidden flex items-center gap-2 bg-indigo-50 p-3 rounded-xl border border-indigo-100"><input type="checkbox" name="enableRecurring" id="chk-recurring" class="w-4 h-4 text-primary rounded border-gray-300 focus:ring-primary"><div class="flex-1"><label for="chk-recurring" class="text-xs font-bold text-indigo-700 block">å•Ÿç”¨è‡ªå‹•é€±æœŸ</label><div class="flex items-center gap-2 mt-1"><span class="text-[10px] text-indigo-400">æ¯</span><input type="number" name="recurringDays" class="bg-white border border-indigo-200 rounded-lg p-1.5 text-xs w-16 text-center" placeholder="30"><span class="text-[10px] text-indigo-400">å¤©ä¸€æ¬¡</span></div></div></div>
            <button type="submit" class="w-full bg-slate-800 text-white font-bold py-3.5 rounded-2xl shadow-lg hover:bg-slate-900 active:scale-[0.98] transition">å„²å­˜é ç®—</button>
        </form>
    </template>
    
    <template id="tpl-category-selector"><div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-slate-800">é¸æ“‡åˆ†é¡</h3><button onclick="App.closeSubModal()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200"><i class="fa-solid fa-xmark"></i></button></div><div id="category-chips" class="flex flex-wrap gap-2.5 pb-4"></div></template>
    <template id="tpl-receipt-modal"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-slate-800">ç”¢ç”Ÿæ”¶æ“š</h3><button onclick="App.closeSubModal()" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition"><i class="fa-solid fa-xmark"></i></button></div><div class="mb-6 space-y-3"><div><label class="text-[10px] font-bold text-slate-400 block mb-1">å®¢æˆ¶åç¨± / æŠ¬é ­</label><input type="text" id="receipt-client-name" class="input-box w-full rounded-xl p-3 text-sm" placeholder="è¼¸å…¥å®¢æˆ¶å§“å..." oninput="App.updateReceiptPreview()"></div></div><div id="receipt-preview" class="bg-white p-6 shadow-md relative overflow-hidden mx-auto max-w-[320px] font-mono border-t-[8px] border-black"><div class="text-center border-b-2 border-dashed border-slate-800 pb-4 mb-4"><h2 class="text-2xl font-bold text-slate-800 tracking-widest">RECEIPT</h2><p class="text-xs text-slate-400 mt-1 uppercase tracking-widest">Official Record</p></div><div class="space-y-4 text-sm text-slate-600"><div class="flex justify-between"><span class="text-slate-400 text-xs">DATE</span><span id="r-date" class="font-bold text-slate-800"></span></div><div class="flex justify-between"><span class="text-slate-400 text-xs">NO.</span><span id="r-id" class="font-bold text-[10px] text-slate-500"></span></div><div class="pt-2"><span class="text-slate-400 block text-xs mb-1">RECEIVED FROM</span><span id="r-client" class="font-bold text-lg block border-b border-slate-800 pb-1 text-slate-800 min-h-[1.75rem]"></span></div><div class="pt-2"><span class="text-slate-400 block text-xs mb-1">FOR</span><span id="r-desc" class="font-bold block text-slate-700"></span></div><div class="flex justify-between items-end pt-4 border-t-2 border-dashed border-slate-800 mt-4"><span class="text-slate-400 font-bold text-xs">AMOUNT</span><span id="r-amount" class="text-2xl font-bold text-slate-800"></span></div></div><div class="mt-8 pt-8 text-center relative"><div class="absolute top-8 left-0 right-0 border-t border-slate-800"></div><p class="text-[10px] text-slate-300 uppercase tracking-widest bg-white relative z-10 inline-block px-2 -mt-2">Authorized Signature</p><p class="text-sm font-bold text-slate-500 mt-2" id="r-signer">å¨çˆ¾è¨­è¨ˆ</p></div><div class="mt-6 text-center"><img src="https://i.ibb.co/xt6cCqVS/grok-image-38ff8969-e1d9-4592-98d6-1366fb857c2c-image-edit-0-1.jpg" alt="Studio Logo" class="h-32 mx-auto opacity-80 mix-blend-multiply"></div><div class="absolute bottom-0 left-0 w-full h-3 receipt-jagged"></div></div><div class="mt-6 flex gap-3"><button onclick="App.printReceipt()" class="flex-1 bg-slate-800 text-white py-3.5 rounded-2xl font-bold text-xs hover:bg-slate-900 transition flex items-center justify-center gap-2"><i class="fa-solid fa-print"></i> åˆ—å° / å„²å­˜</button><button onclick="App.closeSubModal()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-bold text-xs hover:bg-slate-200 transition">å®Œæˆ</button></div></template>

    <script type="module">
        import {initializeApp} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {getAuth,signInAnonymously,onAuthStateChanged,GoogleAuthProvider,signInWithPopup,signOut} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {getFirestore,collection,addDoc,query,onSnapshot,doc,deleteDoc,updateDoc,increment,Timestamp,writeBatch,getDocs,getDoc} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const FIREBASE_API_KEY = "AIzaSyAqFHm6Bn35m8xauc50ZvNNy_rxIZzCMTE";
        const GEMINI_API_KEY = "AIzaSyAze_WqtUmWv7i2xwQHosePZtUI9NZvr0w";
        
        // Define Global App Object Immediately (and locally for module scope access)
        const App = window.App = {};
        
        try {
            const app=initializeApp({apiKey:FIREBASE_API_KEY,authDomain:"moneyw-f8105.firebaseapp.com",projectId:"moneyw-f8105",storageBucket:"moneyw-f8105.appspot.com",messagingSenderId:"155586195799",appId:"1:155586195799:web:302184fbf613f032a88e12"});
            const auth=getAuth(app);
            const db=getFirestore(app);

            const State={user:null,data:{transactions:[],debts:[],investments:[],stocks:[],stockTxs:[],events:[],investmentBudgets:[],debtBudgets:[],accountingBudgets:[],legacyTxs:{}},listeners:[],chart:null,categories:{expense:['é£²é£Ÿ','äº¤é€š','å±…ä½','å¨›æ¨‚','è³¼ç‰©','é†«ç™‚','æ•™è‚²','æŠ•è³‡','å…¶ä»–'],income:['è–ªè³‡','çé‡‘','æŠ•è³‡','å…¼è·','å…¶ä»–']},view:{invTab:'active',currentTab:'accounting'},reminders:[]};
            const $=i=>document.getElementById(i);
            const Q=s=>document.querySelector(s);
            const getTxDate=t=>{if(!t)return new Date();try{if(t.timestamp?.toDate)return t.timestamp.toDate();if(t.date){if(t.date.toDate)return t.date.toDate();const d=new Date(t.date);if(!isNaN(d))return d}if(t.timestamp?.seconds)return new Date(t.timestamp.seconds*1000)}catch(e){}return new Date()};
            const toDateStr=d=>{const dt=(d instanceof Date)?d:getTxDate({timestamp:d});return dt.toISOString().split('T')[0]};
            const STOCK_MAP = {
                '0050':'å…ƒå¤§å°ç£50','0056':'å…ƒå¤§é«˜è‚¡æ¯','00878':'åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯','00929':'å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯','00919':'ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯','00940':'å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯','006208':'å¯Œé‚¦å°50','2330':'å°ç©é›»','2317':'é´»æµ·','2337':'æ—ºå®','2454':'è¯ç™¼ç§‘','2308':'å°é”é›»','2382':'å»£é”','2881':'å¯Œé‚¦é‡‘','2882':'åœ‹æ³°é‡‘','2412':'ä¸­è¯é›»','1301':'å°å¡‘','1303':'å—äº','2002':'ä¸­é‹¼','2303':'è¯é›»','2891':'ä¸­ä¿¡é‡‘','2886':'å…†è±é‡‘','2884':'ç‰å±±é‡‘','2892':'ç¬¬ä¸€é‡‘','5880':'åˆåº«é‡‘','2885':'å…ƒå¤§é‡‘','2880':'è¯å—é‡‘','2883':'é–‹ç™¼é‡‘','2887':'å°æ–°é‡‘','2890':'æ°¸è±é‡‘','1216':'çµ±ä¸€','2912':'çµ±ä¸€è¶…','3008':'å¤§ç«‹å…‰','1101':'å°æ³¥','1102':'äºæ³¥','2327':'åœ‹å·¨','2357':'è¯ç¢©','2395':'ç ”è¯','3045':'å°ç£å¤§','4904':'é å‚³','2603':'é•·æ¦®','2609':'é™½æ˜','2615':'è¬æµ·','9910':'è±æ³°','9904':'å¯¶æˆ','1402':'é æ±æ–°','6505':'å°å¡‘åŒ–','2408':'å—äºç§‘','2344':'è¯é‚¦é›»','2409':'å‹é”','3481':'ç¾¤å‰µ','2353':'å®ç¢','2324':'ä»å¯¶','3231':'ç·¯å‰µ','3711':'æ—¥æœˆå…‰æŠ•æ§','5871':'ä¸­ç§Ÿ-KY','1605':'è¯æ–°','2379':'ç‘æ˜±','3034':'è¯è© ','2345':'æ™ºé‚¦','2377':'å¾®æ˜Ÿ','2301':'å…‰å¯¶ç§‘','4938':'å’Œç¢©','3037':'æ¬£èˆˆ','2474':'å¯æˆ','4958':'è‡»é¼-KY','6415':'çŸ½åŠ›-KY','2492':'è¯æ–°ç§‘'
            };

            // --- App Implementation ---
            App.init = () => onAuthStateChanged(auth, u => {
                State.user = u;
                $('login-view').classList.toggle('hidden', !!u);
                $('app-container').classList.toggle('hidden', !u);
                if (u) {
                    $('user-info').innerText = u.isAnonymous ? 'è¨ªå®¢' : u.displayName;
                    App.switchTab('accounting', Q('#nav-accounting'));
                    setTimeout(() => App.startListeners(u.uid), 100);
                } else App.stopListeners();
            });

            App.startListeners = uid => {
                const l = (c, k) => State.listeners.push(onSnapshot(query(collection(db, `users/${uid}/${c}`)), s => {
                    State.data[k] = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    App.calculateReminders();
                    App.refreshCurrentView();
                    if (k === 'debts') App.processAutoInterest(State.data.debts, 'debt');
                }));
                ['transactions', 'debts', 'events', 'debtBudgets', 'accountingBudgets', 'stocks', 'stockTransactions'].forEach(k => l(k, k === 'stockTransactions' ? 'stockTxs' : k));
                
                State.listeners.push(onSnapshot(query(collection(db, `users/${uid}/debtBudgets`)), s => {
                    const list = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    State.data.debtBudgets = list;
                    App.checkAutoBudgetItems(list, 'debt');
                    App.calculateReminders();
                    App.refreshCurrentView();
                }));

                State.listeners.push(onSnapshot(query(collection(db, `users/${uid}/investmentBudgets`)), s => {
                    const list = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    State.data.investmentBudgets = list;
                    App.checkAutoBudgetItems(list, 'investment');
                    App.calculateReminders();
                    App.refreshCurrentView();
                }));
                
                State.listeners.push(onSnapshot(query(collection(db, `users/${uid}/investments`)), async s => {
                    State.data.investments = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    App.processAutoInterest(State.data.investments, 'investment');
                    for (let i of State.data.investments) {
                        if (!State.data.legacyTxs[i.id]) try {
                            const sub = await getDocs(collection(db, `users/${uid}/investments/${i.id}/transactions`));
                            State.data.legacyTxs[i.id] = sub.docs.map(d => {
                                const v = d.data();
                                return { id: d.id, ...v, timestamp: v.timestamp || v.date || Timestamp.now(), isLegacy: true, legacyInvId: i.id };
                            });
                        } catch (e) { State.data.legacyTxs[i.id] = []; }
                    }
                    App.refreshCurrentView();
                }));
            };

            App.calculateReminders = () => {
                const t = new Date(); t.setHours(0, 0, 0, 0); const l = new Date(t); l.setDate(t.getDate() + 3);
                const all = [...State.data.accountingBudgets.map(b => ({ ...b, s: 'accounting', l: 'è¨˜å¸³' })), ...State.data.investmentBudgets.map(b => ({ ...b, s: 'investment', l: 'æŠ•è³‡' })), ...State.data.debtBudgets.map(b => ({ ...b, s: 'debt', l: 'è² å‚µ' }))];
                State.reminders = all.filter(b => !b.isRealized && getTxDate({ timestamp: b.expectedDate }) <= l).sort((a, b) => getTxDate({ timestamp: a.expectedDate }) - getTxDate({ timestamp: b.expectedDate }));
                const bg = $('notification-badge'); State.reminders.length ? bg.classList.remove('hidden') : bg.classList.add('hidden');
            };

            App.openNotificationModal = () => {
                const c = $('modal-content'); c.innerHTML = $('tpl-notifications').innerHTML;
                const l = c.querySelector('#notification-list');
                if (!State.reminders.length) {
                    l.classList.add('hidden'); c.querySelector('#no-notification').classList.remove('hidden');
                } else {
                    const t = new Date(); t.setHours(0, 0, 0, 0);
                    l.innerHTML = State.reminders.map(r => {
                        const d = getTxDate({ timestamp: r.expectedDate }); d.setHours(0, 0, 0, 0);
                        let s = 'å³å°‡åˆ°æœŸ', sc = 'text-slate-500 bg-slate-50 border-slate-100', ic = 'fa-calendar-day';
                        if (d < t) { s = 'å·²é€¾æœŸ'; sc = 'text-rose-500 bg-rose-50 border-rose-100'; ic = 'fa-circle-exclamation'; }
                        else if (d.getTime() === t.getTime()) { s = 'ä»Šå¤©åˆ°æœŸ'; sc = 'text-amber-500 bg-amber-50 border-amber-100'; ic = 'fa-clock'; }
                        let n = r.targetId; if (r.s === 'investment') n = State.data.investments.find(i => i.id === r.targetId)?.name || 'æœªçŸ¥'; if (r.s === 'debt') n = State.data.debts.find(d => d.id === r.targetId)?.name || 'æœªçŸ¥';
                        return `<div class="flex items-center gap-3 p-3 rounded-xl border ${sc} cursor-pointer" onclick="App.openBudgetModal('${r.s}','${r.id}');App.closeModal()"><div class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm shrink-0"><i class="fa-solid ${ic} text-lg ${sc.split(' ')[0]}"></i></div><div class="flex-1 min-w-0"><div class="flex justify-between items-center mb-0.5"><span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-white/60 ${sc.split(' ')[0]}">${s}</span><span class="text-xs text-slate-400 font-mono">${toDateStr(d)}</span></div><div class="flex justify-between items-center"><h4 class="font-bold text-slate-700 text-sm truncate pr-2">${r.description || n}</h4><span class="font-bold text-slate-800 text-sm whitespace-nowrap">$${parseFloat(r.amount).toLocaleString()}</span></div><p class="text-[10px] text-slate-400 mt-0.5">åˆ†é¡: ${r.l}</p></div></div>`;
                    }).join('');
                }
                $('modal-overlay').classList.remove('hidden'); $('modal-overlay').classList.add('flex');
            };

            // Enhanced Auto Logic
            App.checkAutoBudgetItems = async (list, type) => {
                const b = writeBatch(db), t = new Date(); t.setHours(0, 0, 0, 0); let has = false;
                const ex = list.filter(x => x.isPenalty || x.isRecurringItem);
                const colName = type === 'investment' ? 'investmentBudgets' : 'debtBudgets';
                
                for (const i of list) {
                    // Penalty Logic
                    if (!i.isPenalty && !i.isRealized && i.enablePenalty && i.dailyPenalty > 0) {
                        const e = getTxDate({ timestamp: i.expectedDate }); e.setHours(0, 0, 0, 0);
                        if (t > e) {
                            let c = new Date(e); c.setDate(c.getDate() + 1);
                            while (c <= t) {
                                // Check if penalty for this specific date exists
                                if (!ex.some(p => p.isPenalty && p.parentBudgetId === i.id && getTxDate({ timestamp: p.expectedDate }).getTime() === c.getTime())) {
                                    b.set(doc(collection(db, `users/${State.user.uid}/${colName}`)), { 
                                        targetId: i.targetId, 
                                        parentBudgetId: i.id, 
                                        amount: parseFloat(i.dailyPenalty), 
                                        expectedDate: Timestamp.fromDate(new Date(c)), 
                                        description: `[ç½°é‡‘] ${i.description} (${c.getMonth() + 1}/${c.getDate()})`, 
                                        type: type === 'investment' ? 'income' : 'expense', // Penalty on debt is expense, on investment (receivable) is income
                                        isRealized: false, 
                                        isPenalty: true, 
                                        createdAt: Timestamp.now() 
                                    }); 
                                    has = true;
                                }
                                c.setDate(c.getDate() + 1);
                            }
                        }
                    }
                    // Recurring Logic
                    if (i.enableRecurring && i.recurringDays > 0 && !i.isRecurringItem) {
                        let ld = i.lastRecurringDate ? getTxDate({ timestamp: i.lastRecurringDate }) : getTxDate({ timestamp: i.expectedDate }); ld.setHours(0, 0, 0, 0);
                        let nd = new Date(ld); nd.setDate(nd.getDate() + parseInt(i.recurringDays));
                        while (nd <= t) {
                            if (!ex.some(x => x.isRecurringItem && x.parentBudgetId === i.id && getTxDate({ timestamp: x.expectedDate }).getTime() === nd.getTime())) {
                                b.set(doc(collection(db, `users/${State.user.uid}/${colName}`)), { 
                                    targetId: i.targetId, 
                                    parentBudgetId: i.id, 
                                    amount: parseFloat(i.amount), 
                                    expectedDate: Timestamp.fromDate(new Date(nd)), 
                                    description: `[è‡ªå‹•] ${i.description} (${nd.getMonth() + 1}/${nd.getDate()})`, 
                                    type: i.type || (type === 'investment' ? 'income' : 'expense'), 
                                    isRealized: false, 
                                    isRecurringItem: true, 
                                    createdAt: Timestamp.now() 
                                });
                                b.update(doc(db, `users/${State.user.uid}/${colName}`, i.id), { lastRecurringDate: Timestamp.fromDate(new Date(nd)) }); 
                                has = true;
                            }
                            nd.setDate(nd.getDate() + parseInt(i.recurringDays));
                        }
                    }
                }
                if (has) await b.commit();
            };

            App.processAutoInterest = async (items, type) => {
                const now = new Date();
                const currentMonthKey = `${now.getFullYear()}-${now.getMonth() + 1}`;
                const b = writeBatch(db);
                let has = false;
                const colName = type === 'investment' ? 'investmentBudgets' : 'debtBudgets';
                const budgetList = State.data[colName] || [];

                for (const item of items) {
                    if (item.annualRate && parseFloat(item.annualRate) > 0) {
                        // Check if interest budget already exists for this month
                        const alreadyExists = budgetList.some(budget => 
                            budget.targetId === item.id && 
                            budget.isAutoInterest && 
                            budget.forMonth === currentMonthKey
                        );

                        if (!alreadyExists) {
                            // Logic: Interest generated on the 1st of month or today if not generated
                            // Amount = Principal * (Rate/100) / 12
                            const principal = type === 'investment' ? (parseFloat(item.marketValue) || parseFloat(item.initialValue)) : parseFloat(item.remainingAmount);
                            const monthlyRate = parseFloat(item.annualRate) / 100 / 12;
                            const interestAmount = Math.round(principal * monthlyRate);

                            if (interestAmount > 0) {
                                b.set(doc(collection(db, `users/${State.user.uid}/${colName}`)), {
                                    targetId: item.id,
                                    amount: interestAmount,
                                    expectedDate: Timestamp.now(),
                                    description: `[è‡ªå‹•åˆ©æ¯] ${currentMonthKey} (${item.annualRate}%)`,
                                    type: type === 'investment' ? 'income' : 'expense',
                                    isRealized: false,
                                    isAutoInterest: true,
                                    forMonth: currentMonthKey,
                                    createdAt: Timestamp.now()
                                });
                                has = true;
                            }
                        }
                    }
                }
                if (has) await b.commit();
            };

            App.stopListeners = () => { State.listeners.forEach(u => u()); State.listeners = []; };
            App.loginGoogle = () => signInWithPopup(auth, new GoogleAuthProvider());
            App.loginAnon = () => signInAnonymously(auth);
            App.logout = () => signOut(auth);

            App.refreshCurrentView = () => {
                const t = State.view.currentTab;
                try {
                    if (t === 'accounting' && $('tx-list')) { App.renderTransactions(); App.updateDashboard(); App.renderAccountingBudgets(); }
                    else if (t === 'investment' && $('inv-list')) App.renderInvestments();
                    else if (t === 'debt' && $('debt-list')) App.renderDebts();
                    else if (t === 'reports' && $('report-stats')) App.renderReports();
                    else if (t === 'events' && $('event-list')) App.renderEvents();
                    else if (t === 'stock' && $('stock-list')) App.renderStocks();
                } catch (e) { console.error(e); }
            };

            App.switchTab = (t, b) => {
                State.view.currentTab = t;
                document.querySelectorAll('.view-section').forEach(e => { e.classList.add('hidden'); e.innerHTML = ''; });
                const tg = $(`view-${t}`); tg.classList.remove('hidden'); tg.innerHTML = $(`tpl-${t}`).innerHTML;
                if (t === 'accounting') $('date-filter').value = new Date().toISOString().slice(0, 7);
                else if (t === 'investment') $('inv-date-filter').value = new Date().toISOString().slice(0, 7);
                else if (t === 'debt') $('debt-date-filter').value = new Date().toISOString().slice(0, 7);
                else if (t === 'reports') {
                    const y = $('report-year'), cy = new Date().getFullYear(); y.innerHTML = '';
                    for (let i = cy - 2; i <= cy + 1; i++) y.innerHTML += `<option value="${i}" ${i === cy ? 'selected' : ''}>${i}å¹´</option>`;
                    $('report-month-select').value = (new Date().getMonth() + 1).toString();
                }
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                if (b) b.classList.add('active');
                $('page-title').innerText = { accounting: 'ç¸½è¦½', investment: 'è³‡ç”¢çµ„åˆ', debt: 'è² å‚µç®¡ç†', reports: 'åˆ†æå ±è¡¨', events: 'ç”Ÿæ´»å¤§äº‹', stock: 'è‚¡å¸‚è³‡ç”¢' }[t];
                if (t === 'accounting') { $('header-icon').src = 'https://i.ibb.co/PvVffGgL/image.png'; $('header-icon').className = 'h-20 w-auto object-contain'; }
                App.refreshCurrentView();
            };

            App.handleFabClick = () => {
                const t = State.view.currentTab;
                if (t === 'stock') App.openModal('stock-tx-modal');
                else if (t === 'debt') App.openModal('debt-modal');
                else if (t === 'investment') App.openModal('investment-modal');
                else if (t === 'events') App.openModal('event-modal');
                else App.openModal('transaction-modal');
            };

            App.getAllTransactions = () => {
                let a = [], l = new Set();
                State.data.investments.forEach(i => { (State.data.legacyTxs[i.id] || []).forEach(t => { a.push({ ...t, project: i.name, category: t.category || (t.type === 'income' ? 'æŠ•è³‡æ”¶å…¥' : 'æŠ•è³‡æ”¯å‡º'), timestamp: Timestamp.fromDate(getTxDate(t)), amount: parseFloat(t.amount) || 0, isLegacy: true, legacyInvId: i.id }); if (t.mainTransactionId) l.add(t.mainTransactionId); }); });
                State.data.transactions.forEach(t => { if (!l.has(t.id)) a.push(t); });
                return a.sort((x, y) => getTxDate(y) - getTxDate(x));
            };

            App.switchInvTab = (t, b) => {
                State.view.invTab = t;
                document.querySelectorAll('.tab-pill').forEach(e => { e.classList.remove('active', 'bg-indigo-50', 'text-primary'); e.classList.add('hover:text-slate-700'); });
                b.classList.add('active', 'bg-indigo-50', 'text-primary'); b.classList.remove('hover:text-slate-700');
                App.renderInvestments();
            };

            App.handleSaveTransaction = async e => {
                e.preventDefault(); const f = e.target, u = State.user.uid, id = f.id.value, lid = f.legacy_inv_id.value, d = new Date(f.date.value + 'T12:00:00'), amt = parseFloat(f.amount.value);
                if (f.isUnrealized?.checked) {
                    const b = writeBatch(db); b.set(doc(collection(db, `users/${u}/accountingBudgets`)), { targetId: f.category.value, amount: amt, expectedDate: Timestamp.fromDate(d), description: f.remarks.value + (f.project.value ? ` [${f.project.value}]` : ''), type: f.type.value, isRealized: false, createdAt: Timestamp.now() });
                    if (id) (lid && lid !== 'undefined') ? b.delete(doc(db, `users/${u}/investments/${lid}/transactions`, id)) : b.delete(doc(db, `users/${u}/transactions`, id));
                    await b.commit(); App.closeModal(); return;
                }
                const dt = { type: f.type.value, amount: amt, category: f.category.value, remarks: f.remarks.value, timestamp: Timestamp.fromDate(d), project: f.project.value }, bt = writeBatch(db);
                if (dt.type === 'expense' && dt.project && !id) { const dbItem = State.data.debts.find(x => x.name === dt.project); if (dbItem) bt.update(doc(db, `users/${u}/debts`, dbItem.id), { remainingAmount: increment(-amt) }); }
                if (lid && id) { bt.set(doc(collection(db, `users/${u}/transactions`)), dt); bt.delete(doc(db, `users/${u}/investments/${lid}/transactions`, id)); if (State.data.legacyTxs[lid]) State.data.legacyTxs[lid] = State.data.legacyTxs[lid].filter(t => t.id !== id); } else id ? await updateDoc(doc(db, `users/${u}/transactions`, id), dt) : await addDoc(collection(db, `users/${u}/transactions`), dt);
                await bt.commit(); App.closeModal();
            };

            App.handleSaveInvestment = async e => {
                e.preventDefault(); const f = e.target, d = { name: f.name.value, initialValue: parseFloat(f.initial.value) || 0, annualRate: parseFloat(f.annualRate.value) || 0, isArchived: f.isArchived.checked };
                if (!f.id.value) { d.marketValue = d.initialValue; d.createdAt = Timestamp.now(); }
                f.id.value ? await updateDoc(doc(db, `users/${State.user.uid}/investments`, f.id.value), d) : (await addDoc(collection(db, `users/${State.user.uid}/investments`), d) && d.initialValue > 0 && await addDoc(collection(db, `users/${State.user.uid}/transactions`), { type: 'expense', amount: d.initialValue, category: 'æŠ•è³‡', project: f.name.value, remarks: 'åˆå§‹æŠ•å…¥', timestamp: Timestamp.now() })); App.closeModal();
            };

            App.handleSaveDebt = async e => {
                e.preventDefault(); const f = e.target, d = { name: f.name.value, totalAmount: parseFloat(f.total.value), annualRate: parseFloat(f.annualRate.value) || 0 };
                if (f.remaining?.value) d.remainingAmount = parseFloat(f.remaining.value); else if (!f.id.value) { d.remainingAmount = parseFloat(f.total.value); d.createdAt = Timestamp.now(); }
                f.id.value ? await updateDoc(doc(db, `users/${State.user.uid}/debts`, f.id.value), d) : await addDoc(collection(db, `users/${State.user.uid}/debts`), d); App.closeModal();
            };

            App.handleSaveBudget = async e => {
                e.preventDefault(); const f = e.target, ctx = f.context.value, col = ctx === 'investment' ? 'investmentBudgets' : ctx === 'debt' ? 'debtBudgets' : 'accountingBudgets', tv = ctx === 'accounting' ? f.targetId_input.value : f.targetId_select.value; if (!tv) return alert('è«‹è¼¸å…¥ç›®æ¨™');
                const d = { targetId: tv, amount: parseFloat(f.amount.value), expectedDate: Timestamp.fromDate(new Date(f.date.value + 'T12:00:00')), description: f.desc.value, type: f.type.value || 'expense' };
                if (ctx === 'investment' || ctx === 'debt') { d.enablePenalty = f.enablePenalty.checked; d.dailyPenalty = d.enablePenalty ? parseFloat(f.dailyPenalty.value) || 0 : 0; d.enableRecurring = f.enableRecurring.checked; d.recurringDays = d.enableRecurring ? parseInt(f.recurringDays.value) || 0 : 0; }
                if (!f.id.value) { d.isRealized = false; d.createdAt = Timestamp.now(); }
                f.id.value ? await updateDoc(doc(db, `users/${State.user.uid}/${col}`, f.id.value), d) : await addDoc(collection(db, `users/${State.user.uid}/${col}`), d); App.closeModal();
            };

            App.handleSaveEvent = async e => {
                e.preventDefault(); const f = e.target, d = { title: f.title.value, description: f.desc.value, date: Timestamp.fromDate(new Date(f.date.value)) };
                f.id.value ? await updateDoc(doc(db, `users/${State.user.uid}/events`, f.id.value), d) : await addDoc(collection(db, `users/${State.user.uid}/events`), d); App.closeModal();
            };

            // Stock Logic
            App.toggleStockType = t => {
                $('stock-tx-type').value = t; const b = $('btn-stock-buy'), s = $('btn-stock-sell');
                if (t === 'buy') { b.classList.add('bg-white', 'shadow', 'text-rose-500'); b.classList.remove('text-slate-500'); s.classList.remove('bg-white', 'shadow', 'text-emerald-500'); s.classList.add('text-slate-500'); }
                else { s.classList.add('bg-white', 'shadow', 'text-emerald-500'); s.classList.remove('text-slate-500'); b.classList.remove('bg-white', 'shadow', 'text-rose-500'); b.classList.add('text-slate-500'); }
            };

            App.handleStockSymbolInput = async (e) => {
                const v = e.value.toUpperCase(); e.value = v;
                if (STOCK_MAP[v]) {
                    e.form.querySelector('[name=name]').value = STOCK_MAP[v];
                } else {
                    e.form.querySelector('[name=name]').value = "æŸ¥è©¢ä¸­...";
                    // Gemini AI Auto-Complete
                    try {
                        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: `What is the Traditional Chinese stock name for the stock symbol "${v}" in Taiwan (TWSE/TPEX)? If not found in Taiwan, check US market. Return ONLY the company name, nothing else. If you are unsure, return ""` }] }] })
                        });
                        const d = await r.json();
                        const n = d.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                        if (n) e.form.querySelector('[name=name]').value = n;
                        else e.form.querySelector('[name=name]').value = "";
                    } catch(err) { 
                        console.error(err); 
                        e.form.querySelector('[name=name]').value = "";
                        e.form.querySelector('[name=name]').removeAttribute('readonly'); // Allow user to edit if AI fails
                    }
                }
            };

            App.calcStockTotal = () => { const p = parseFloat(document.querySelector('[name=price]').value) || 0, q = parseFloat(document.querySelector('[name=shares]').value) || 0; $('stock-total-input').value = Math.round(p * q); };

            App.handleSaveStockTx = async e => {
                e.preventDefault(); const f = e.target, u = State.user.uid;
                const d = { symbol: f.symbol.value.toUpperCase(), name: f.name.value, date: Timestamp.fromDate(new Date(f.date.value + 'T12:00:00')), type: f.type.value, price: parseFloat(f.price.value), quantity: parseFloat(f.shares.value), total: parseFloat(f.total.value) };
                if (!d.symbol || !d.price || !d.quantity) return alert('è«‹å®Œæ•´å¡«å¯«');
                const b = writeBatch(db); b.set(doc(collection(db, `users/${u}/stockTransactions`)), { ...d, createdAt: Timestamp.now() });
                const sRef = doc(db, `users/${u}/stocks`, d.symbol); const sDoc = State.data.stocks.find(s => s.id === d.symbol);
                if (!sDoc) b.set(sRef, { id: d.symbol, symbol: d.symbol, name: d.name, currentPrice: d.price, updatedAt: Timestamp.now() }); else if (d.type === 'buy') b.update(sRef, { currentPrice: d.price, name: d.name || sDoc.name });
                await b.commit(); App.closeModal();
            };

            App.updateStockPrice = async (s, old) => {
                let suggested = old;
                // AI Auto-Fetch Price
                try {
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Search for the latest stock price of ${s} on Yahoo Finance Taiwan (å¥‡æ‘©è‚¡å¸‚). Return ONLY the numeric price value (e.g. 1080.00). Do not include currency or text.` }] }], tools: [{ google_search: {} }] })
                    });
                    const d = await r.json();
                    const txt = d.candidates?.[0]?.content?.parts?.[0]?.text;
                    const m = txt.match(/[\d,]+\.?\d*/);
                    if(m) suggested = parseFloat(m[0].replace(/,/g,''));
                } catch(e) { console.error(e); }

                const p=prompt(`æ›´æ–° ${s} ç¾åƒ¹ (AI å»ºè­°: ${suggested}):`,suggested);
                if(p&&!isNaN(p))await updateDoc(doc(db,`users/${State.user.uid}/stocks`,s),{currentPrice:parseFloat(p),updatedAt:Timestamp.now()})
            };

            App.updateAllStockPrices = async () => {
                const btn = $('btn-update-all');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';
                btn.disabled = true;

                const uniqueSymbols = [...new Set(State.data.stockTxs.map(t => t.symbol))];
                let updatedCount = 0;

                for (const symbol of uniqueSymbols) {
                    try {
                        const isTw = /^\d{4,6}$/.test(symbol);
                        const queryText = isTw ? 
                            `Search site:tw.stock.yahoo.com for the latest price of stock ${symbol}. Extract the current price. Return ONLY the number.` : 
                            `Search for the latest stock price of ${symbol} on Yahoo Finance. Return ONLY the numeric price value.`;

                        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: queryText }] }],
                                tools: [{ google_search: {} }]
                            })
                        });
                        const d = await r.json();
                        const txt = d.candidates?.[0]?.content?.parts?.[0]?.text;
                        const m = txt ? txt.match(/[\d,]+\.?\d*/) : null;
                        
                        if (m) {
                            const price = parseFloat(m[0].replace(/,/g, ''));
                            if (!isNaN(price)) {
                                await updateDoc(doc(db, `users/${State.user.uid}/stocks`, symbol), { currentPrice: price, updatedAt: Timestamp.now() });
                                updatedCount++;
                            }
                        }
                    } catch (e) {
                        console.error(`Failed to update ${symbol}:`, e);
                    }
                    await new Promise(r => setTimeout(r, 1500));
                }

                btn.innerHTML = originalText;
                btn.disabled = false;
                alert(`å·²æ›´æ–° ${updatedCount} æª”è‚¡ç¥¨åƒ¹æ ¼`);
            };

            App.renderStocks = () => {
                if (!$('stock-list')) return; const holdings = {};
                State.data.stockTxs.sort((a, b) => getTxDate(a) - getTxDate(b)).forEach(t => {
                    if (!holdings[t.symbol]) holdings[t.symbol] = { s: t.symbol, n: t.name, q: 0, cost: 0, realized: 0 };
                    const h = holdings[t.symbol];
                    if (t.type === 'buy') { 
                        h.q += t.quantity; 
                        h.cost += t.total; 
                        h.n = t.name || h.n; 
                    } else { 
                        const avgCost = h.q > 0 ? h.cost / h.q : 0; 
                        const costSold = avgCost * t.quantity;
                        h.realized += (t.total - costSold);
                        h.q -= t.quantity; 
                        h.cost -= costSold; 
                        if (h.q < 0.0001) { h.q = 0; h.cost = 0; }
                    }
                });
                let totalMkt = 0, totalCost = 0, totalRealized = 0;
                
                const listHtml = Object.values(holdings).filter(h => h.q > 0 || h.realized !== 0).map(h => {
                    const curr = State.data.stocks.find(s => s.id === h.s)?.currentPrice || 0;
                    const mkt = Math.round(curr * h.q); 
                    const avg = h.q > 0 ? h.cost / h.q : 0; 
                    const pl = mkt - h.cost;
                    
                    totalMkt += mkt; 
                    totalCost += h.cost;
                    totalRealized += h.realized;
                    
                    const isCleared = h.q === 0;
                    
                    return `<div class="bg-white p-4 rounded-2xl shadow-soft border border-slate-50 mb-2 ${isCleared ? 'opacity-70 grayscale' : ''}" onclick="App.showStockDetails('${h.s}')">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                                    ${h.n} <span class="bg-slate-100 text-slate-500 text-[10px] px-1.5 py-0.5 rounded font-mono">${h.s}</span>
                                    ${isCleared ? '<span class="text-[10px] bg-slate-200 text-slate-500 px-1.5 py-0.5 rounded">å·²æ¸…ç©º</span>' : ''}
                                </h4>
                                <p class="text-[10px] text-slate-400 mt-0.5">æŒè‚¡: ${h.q} è‚¡ â€¢ å‡åƒ¹: ${avg.toFixed(1)}</p>
                            </div>
                            <div class="text-right">
                                ${!isCleared ? `<button onclick="event.stopPropagation();App.updateStockPrice('${h.s}','${curr}')" class="bg-slate-50 px-2 py-1 rounded-lg text-xs font-bold text-slate-800 hover:bg-slate-100 transition mb-1">ç¾åƒ¹ $${curr}</button>` : ''}
                                <p class="text-[10px] font-bold ${h.realized >= 0 ? 'text-emerald-500' : 'text-rose-500'}">å·²å¯¦ç¾: ${h.realized >= 0 ? '+' : ''}${Math.round(h.realized).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-xs pt-2 border-t border-slate-50">
                            <span class="text-slate-400">å¸‚å€¼ $${mkt.toLocaleString()}</span>
                            <span class="text-[10px] ${pl >= 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-500'} px-2 py-0.5 rounded-lg font-bold">${!isCleared && h.cost > 0 ? ((pl / h.cost) * 100).toFixed(1) + '%' : '--'}</span>
                        </div>
                    </div>`;
                }).join('');
                
                $('stock-list').innerHTML = listHtml || '<div class="text-center text-slate-300 py-10 text-xs">å°šç„¡æŒè‚¡æˆ–äº¤æ˜“ç´€éŒ„</div>';
                
                const tpl = totalMkt - totalCost;
                $('stock-total-assets').innerText = `$${Math.round(totalMkt).toLocaleString()}`;
                $('stock-total-cost').innerText = `$${Math.round(totalCost).toLocaleString()}`;
                $('stock-total-pl').innerText = `${tpl >= 0 ? '+' : ''}${Math.round(tpl).toLocaleString()}`;
                $('stock-total-pl').className = `font-bold text-lg ${tpl >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
                
                $('stock-realized-pl').innerText = `${totalRealized >= 0 ? '+' : ''}${Math.round(totalRealized).toLocaleString()}`;
                $('stock-realized-pl').className = `font-bold text-sm ${totalRealized >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
                
                $('stock-roi').innerText = `${totalCost > 0 ? ((tpl / totalCost) * 100).toFixed(1) : 0}%`;
                $('stock-roi').className = `font-bold text-sm ${tpl >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
            };

            App.showStockDetails = (symbol) => {
                const txs = State.data.stockTxs.filter(t => t.symbol === symbol).sort((a,b) => getTxDate(b) - getTxDate(a));
                const stockInfo = State.data.stocks.find(s => s.id === symbol) || { name: txs[0]?.name || symbol, currentPrice: 0 };
                
                const c = $('modal-content');
                c.innerHTML = $('tpl-details-modal').innerHTML;
                c.querySelector('.details-title').innerText = `${stockInfo.name} (${symbol})`;
                
                const budgetSection = c.querySelector('.details-budget-section');
                if(budgetSection) budgetSection.classList.add('hidden'); 

                const list = c.querySelector('.details-list');
                list.innerHTML = txs.map(t => {
                    const isBuy = t.type === 'buy';
                    return `<li class="flex justify-between items-center py-3 px-3 rounded-xl mb-2 ${isBuy ? 'bg-indigo-50/50' : 'bg-emerald-50/50'}">
                        <div>
                            <p class="text-[10px] text-slate-400 mb-0.5">${getTxDate(t).toLocaleDateString()}</p>
                            <p class="text-xs font-bold text-slate-700">${isBuy ? 'è²·å…¥' : 'è³£å‡º'} ${t.quantity} è‚¡ @ $${t.price}</p>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-sm font-bold ${isBuy ? 'text-indigo-600' : 'text-emerald-600'}">$${t.total.toLocaleString()}</span>
                            <button onclick="event.stopPropagation(); App.deleteStockTransaction(event, '${t.id}', this)" class="text-[10px] text-slate-300 hover:text-rose-500 mt-1 p-2"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </li>`;
                }).join('') || '<li class="text-center text-xs text-slate-300 py-6">ç„¡äº¤æ˜“ç´€éŒ„</li>';

                const act = c.querySelector('.details-actions');
                
                const addBtn = document.createElement('button');
                addBtn.className = "w-full bg-primary text-white py-3 rounded-xl font-bold text-xs mt-2 shadow-lg mb-2 active:scale-[0.98] transition";
                addBtn.innerText = "+ æ–°å¢äº¤æ˜“";
                addBtn.onclick = () => App.openModal('stock-tx-modal', null, { symbol: symbol, name: stockInfo.name });
                act.appendChild(addBtn);

                const priceBtn = document.createElement('button');
                priceBtn.className = "w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-xs shadow-sm hover:bg-slate-200 transition mt-2";
                priceBtn.innerText = "æ›´æ–°ç¾åƒ¹";
                priceBtn.onclick = () => App.updateStockPrice(symbol, stockInfo.currentPrice);
                act.appendChild(priceBtn);

                $('modal-overlay').classList.remove('hidden');
                $('modal-overlay').classList.add('flex');
            };

            App.deleteStockTransaction = async (event, id, btn) => {
                if (event) {
                    event.stopPropagation();
                    event.preventDefault();
                }
                
                if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†äº¤æ˜“ç´€éŒ„ï¼Ÿ')) return;
                
                const li = btn.closest('li');
                if(li) li.style.opacity = '0.5';

                try {
                    await deleteDoc(doc(db, `users/${State.user.uid}/stockTransactions`, id));
                    
                    // Remove locally to prevent stale data until next snapshot
                    State.data.stockTxs = State.data.stockTxs.filter(t => t.id !== id);

                    if(li) {
                        li.remove();
                        const list = document.querySelector('#modal-content .details-list');
                        if(list && list.children.length === 0) list.innerHTML = '<li class="text-center text-slate-300 py-6">ç„¡äº¤æ˜“ç´€éŒ„</li>';
                    }
                    App.renderStocks();
                } catch(e) { 
                    console.error(e);
                    if(li) li.style.opacity = '1'; 
                    alert('åˆªé™¤å¤±æ•—: ' + e.message); 
                }
            };
            
            App.showDetails = (type, id) => {
                const isInv = type === 'investment';
                const col = isInv ? 'investments' : 'debts';
                const item = State.data[col].find(i => i.id === id);
                if (!item) return;

                const c = $('modal-content');
                c.innerHTML = $('tpl-details-modal').innerHTML;
                c.querySelector('.details-title').innerText = item.name;

                const allTxs = App.getAllTransactions();
                const relatedTxs = allTxs.filter(t => {
                    if (isInv) return t.project === item.name || t.legacyInvId === id;
                    return t.project === item.name;
                });

                const list = c.querySelector('.details-list');
                list.innerHTML = relatedTxs.map(t => {
                    const isExp = t.type === 'expense';
                    return `<li class="flex justify-between items-center py-3 border-b border-slate-50 last:border-0 group cursor-pointer hover:bg-slate-50 p-2 rounded-xl transition" onclick="App.openModal('transaction-modal','${t.id}')">
                        <div class="flex-1 min-w-0 mr-2">
                            <p class="text-xs text-slate-400 mb-0.5">${toDateStr(getTxDate(t))} <span class="font-bold text-slate-700 ml-1">${t.category}</span></p>
                            <p class="text-[10px] text-slate-400 break-words whitespace-pre-wrap">${t.remarks || ''}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold ${isExp ? 'text-rose-500' : 'text-emerald-500'} whitespace-nowrap">${isExp ? '-' : '+'} ${parseFloat(t.amount).toLocaleString()}</span>
                            <button type="button" class="w-6 h-6 rounded-full bg-slate-100 text-slate-400 hover:text-primary flex items-center justify-center opacity-0 group-hover:opacity-100 transition" onclick="event.stopPropagation();App.openModal('transaction-modal','${t.id}')"><i class="fa-solid fa-pen text-[10px]"></i></button>
                        </div>
                    </li>`;
                }).join('') || '<li class="text-center text-xs text-slate-300 py-8">ç„¡äº¤æ˜“ç´€éŒ„</li>';

                const budgetList = c.querySelector('.details-budget-list');
                const budgetSection = c.querySelector('.details-budget-section');
                
                // Safety: ensure array exists
                const sourceBudgets = State.data[isInv ? 'investmentBudgets' : 'debtBudgets'] || [];
                const budgets = sourceBudgets.filter(b => b.targetId === id && !b.isRealized);
                
                if (budgets.length > 0) {
                    budgetSection.classList.remove('hidden');
                    
                    // Render List with Signs and Colors
                    budgetList.innerHTML = budgets.sort((a, b) => (a.expectedDate?.seconds || 0) - (b.expectedDate?.seconds || 0)).map(b => {
                        const isExp = b.type === 'expense';
                        const color = isExp ? 'text-rose-500' : 'text-emerald-500';
                        const sign = isExp ? '-' : '+';
                        // Safety: Handle undefined description/amount
                        const desc = b.description || 'ç„¡æè¿°';
                        const amt = parseFloat(b.amount) || 0;
                        
                        return `<li class="flex justify-between items-center text-xs p-2 bg-slate-50 rounded-lg">
                            <span class="text-slate-600">${desc} (${toDateStr(b.expectedDate)})</span>
                            <span class="font-bold ${color}">${sign}$${amt.toLocaleString()}</span>
                         </li>`
                    }).join('');

                    // Calculate subtotals considering type
                    const stats = {};
                    let grandTotal = 0;
                    budgets.forEach(b => {
                        // Safety: Handle description matching safely
                        const desc = b.description || '';
                        const match = desc.match(/^\[(.*?)\]/);
                        const cat = match ? match[1] : 'ä¸€èˆ¬é …ç›®';
                        if (!stats[cat]) stats[cat] = 0;
                        
                        const val = (parseFloat(b.amount)||0) * (b.type === 'expense' ? -1 : 1);
                        stats[cat] += val;
                        grandTotal += val;
                    });
                    
                    // Generate HTML with Signs and Colors
                    const summaryHtml = Object.entries(stats).map(([k, v]) => {
                        const color = v >= 0 ? 'text-emerald-600' : 'text-rose-500';
                        const sign = v >= 0 ? '+' : '';
                        return `<div class="flex justify-between items-center text-[10px] text-slate-500 mt-1 px-2 border-b border-slate-50 last:border-0 py-1">
                            <span>${k}</span>
                            <span class="font-bold ${color}">${sign}$${Math.abs(v).toLocaleString()}</span>
                         </div>`;
                    }).join('');
                    
                    const totalColor = grandTotal >= 0 ? 'text-emerald-600' : 'text-rose-500';
                    const totalSign = grandTotal >= 0 ? '+' : '';

                    const summaryContainer = document.createElement('div');
                    summaryContainer.className = "mt-3 bg-slate-50/50 rounded-xl p-2 border border-slate-100";
                    summaryContainer.innerHTML = `<h5 class="text-[10px] font-bold text-slate-400 mb-1">åˆ†é¡çµ±è¨ˆ</h5>${summaryHtml}<div class="flex justify-between items-center text-[10px] text-slate-600 mt-2 pt-2 border-t border-slate-200 px-2 font-bold"><span>ç¸½è¨ˆ</span><span class="${totalColor}">${totalSign}$${Math.abs(grandTotal).toLocaleString()}</span></div>`;
                    
                    budgetSection.appendChild(summaryContainer);
                }

                const act = c.querySelector('.details-actions');
                
                const addBtn = document.createElement('button');
                addBtn.className = "w-full bg-primary text-white py-3 rounded-xl font-bold text-xs shadow-lg active:scale-[0.98] transition flex justify-center items-center gap-2";
                addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> æ–°å¢äº¤æ˜“ç´€éŒ„';
                addBtn.onclick = () => App.openModal('transaction-modal', null, { project: item.name }); 
                act.appendChild(addBtn);

                if (isInv) {
                    const editBtn = document.createElement('button');
                    editBtn.className = "w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-xs hover:bg-slate-200 transition";
                    editBtn.innerText = "ç·¨è¼¯å¸³æˆ¶è¨­å®š";
                    editBtn.onclick = () => App.openModal('investment-modal', id);
                    act.appendChild(editBtn);
                } else {
                    const repayBtn = document.createElement('button');
                    repayBtn.className = "w-full bg-emerald-50 text-emerald-600 py-3 rounded-xl font-bold text-xs hover:bg-emerald-100 transition mt-2";
                    repayBtn.innerText = "å¿«é€Ÿé‚„æ¬¾";
                    repayBtn.onclick = () => App.openRepayModal(id, item.name);
                    act.appendChild(repayBtn);
                }

                $('modal-overlay').classList.remove('hidden');
                $('modal-overlay').classList.add('flex');
            };

            App.handleRepayDebt = async e => {
                e.preventDefault();
                const f = e.target;
                const id = f.id.value;
                const amt = parseFloat(f.amount.value);
                const date = new Date(f.date.value);
                const u = State.user.uid;
                const item = State.data.debts.find(d => d.id === id);

                if (!item) return;

                const b = writeBatch(db);
                b.set(doc(collection(db, `users/${u}/transactions`)), {
                    type: 'expense',
                    amount: amt,
                    category: 'è² å‚µé‚„æ¬¾',
                    project: item.name,
                    remarks: `å„Ÿé‚„: ${item.name}`,
                    timestamp: Timestamp.fromDate(date)
                });
                b.update(doc(db, `users/${u}/debts`, id), {
                    remainingAmount: increment(-amt)
                });

                await b.commit();
                App.closeModal();
            };

            App.deleteTransaction = async (id, lid) => {
                if (!confirm('åˆªé™¤?')) return; const u = State.user.uid, p = lid && lid !== 'undefined' ? `users/${u}/investments/${lid}/transactions/${id}` : `users/${u}/transactions/${id}`;
                try {
                    const s = await getDoc(doc(db, p)), td = s.data(), b = writeBatch(db);
                    if (!lid && td.type === 'expense' && td.project) { const d = State.data.debts.find(x => x.name === td.project); if (d) b.update(doc(db, `users/${u}/debts`, d.id), { remainingAmount: increment(td.amount) }); }
                    b.delete(doc(db, p)); await b.commit();
                    if (lid && State.data.legacyTxs[lid]) State.data.legacyTxs[lid] = State.data.legacyTxs[lid].filter(t => t.id !== id);
                    App.closeModal();
                } catch (e) { alert('å¤±æ•—'); }
            };

            App.deleteItem = async (c, id) => { if (confirm('åˆªé™¤?')) { await deleteDoc(doc(db, `users/${State.user.uid}/${c}`, id)); App.closeModal(); } };
            App.updateMarketValue = async (id, old) => { const v = prompt("ç›®å‰å¸‚å€¼:", old); if (v && !isNaN(v)) await updateDoc(doc(db, `users/${State.user.uid}/investments`, id), { marketValue: parseFloat(v) }); };
            
            App.realizeBudget = async (ctx, id) => {
                if (!confirm("åŸ·è¡Œä¸¦çµç®—?")) return; const u = State.user.uid, col = ctx === 'investment' ? 'investmentBudgets' : ctx === 'debt' ? 'debtBudgets' : 'accountingBudgets', b = State.data[col].find(i => i.id === id), tn = ctx === 'investment' ? State.data.investments.find(i => i.id === b.targetId)?.name : ctx === 'debt' ? State.data.debts.find(d => d.id === b.targetId)?.name : '', bt = writeBatch(db);
                bt.update(doc(db, `users/${u}/${col}`, id), { isRealized: true });
                bt.set(doc(collection(db, `users/${u}/transactions`)), { type: b.type || (ctx === 'investment' ? 'income' : 'expense'), amount: parseFloat(b.amount), category: ctx === 'investment' ? 'æŠ•è³‡' : ctx === 'debt' ? 'è² å‚µé‚„æ¬¾' : b.targetId, remarks: `é ç®—åŸ·è¡Œ: ${b.description}`, timestamp: Timestamp.now(), project: tn || '' });
                if (ctx === 'investment') {
                    State.data.investmentBudgets.filter(p => p.parentBudgetId === id && p.isPenalty && !p.isRealized).forEach(p => bt.delete(doc(db, `users/${u}/investmentBudgets`, p.id)));
                    if (b.enablePenalty && b.dailyPenalty) {
                        const e = getTxDate({ timestamp: b.expectedDate }); e.setHours(0, 0, 0, 0); const t = new Date(); t.setHours(0, 0, 0, 0);
                        if (t > e) { let c = new Date(e); while (c <= t) { bt.set(doc(collection(db, `users/${u}/transactions`)), { type: 'income', amount: parseFloat(b.dailyPenalty), category: 'æ»¯ç´é‡‘', remarks: `æ»¯ç´é‡‘ (${b.description}) [${c.getMonth() + 1}/${c.getDate()}]`, timestamp: Timestamp.fromDate(new Date(c)), project: tn || '' }); c.setDate(c.getDate() + 1); } }
                    }
                }
                if (ctx === 'debt' && b.targetId) bt.update(doc(db, `users/${u}/debts`, b.targetId), { remainingAmount: increment(-b.amount) });
                await bt.commit();
            };

            App.copyTransaction = id => { const t = App.getAllTransactions().find(x => x.id === id); if (t) App.openModal('transaction-modal', null, t) };
            App.copyBudget = (c, id) => { const l = c === 'investment' ? State.data.investmentBudgets : c === 'debt' ? State.data.debtBudgets : State.data.accountingBudgets, b = l.find(x => x.id === id); if (b) App.openBudgetModal(c, null, b) };
            App.openReceiptModal = id => { const t = App.getAllTransactions().find(x => x.id === id); if (!t) return; const c = $('sub-modal-content'); c.innerHTML = $('tpl-receipt-modal').innerHTML; c.querySelector('#r-date').innerText = toDateStr(t.timestamp); c.querySelector('#r-id').innerText = '#' + t.id.slice(0, 6).toUpperCase(); c.querySelector('#r-desc').innerText = t.remarks || t.category; c.querySelector('#r-amount').innerText = '$' + parseFloat(t.amount).toLocaleString(); c.querySelector('#r-signer').innerText = 'å¨çˆ¾è¨­è¨ˆ'; c.querySelector('#r-client').innerText = "____________"; App.currentReceiptTx = t; $('sub-modal-overlay').classList.remove('hidden'); $('sub-modal-overlay').classList.add('flex') };
            App.updateReceiptPreview = () => { $('r-client').innerText = $('receipt-client-name').value || "____________" };
            App.printReceipt = () => { const w = window.open('', '', 'height=800,width=600'); w.document.write('<html><head><title>æ”¶æ“š</title><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet"><script src="https://cdn.tailwindcss.com"></scr' + 'ipt><style>body{font-family:"Courier Prime",monospace}.receipt-jagged{background:linear-gradient(135deg,transparent 5px,white 0)top left,linear-gradient(225deg,transparent 5px,white 0)top right;background-size:10px 10px;background-repeat:repeat-x}</style></head><body class="bg-gray-100 flex items-center justify-center min-h-screen p-8"><div class="bg-white p-8 max-w-[320px] w-full relative border-t-[8px] border-black shadow-none">' + $('receipt-preview').innerHTML + '</div></body></html>'); w.document.close(); w.focus(); setTimeout(() => { w.print(); w.close() }, 500) };
            
            // Helper for CSV escaping
            const toCSV = t => { if(t===null||t===undefined)return''; const s=''+t; if(s.includes(',')||s.includes('\n')||s.includes('"')) return `"${s.replace(/"/g,'""')}"`; return s; };

            App.exportReport = () => { 
                if (!confirm("åŒ¯å‡ºå ±è¡¨ç‚º CSV (å¯ç›´æ¥åŒ¯å…¥ Google Sheets)?")) return; 
                const h = ["æ—¥æœŸ", "åˆ†é¡", "å°ˆæ¡ˆ/å°è±¡", "å‚™è¨»", "é¡å‹", "é‡‘é¡"].join(",");
                const r = App.getAllTransactions().map(t => [
                    toDateStr(t.timestamp), 
                    t.category, 
                    t.project, 
                    t.remarks, 
                    t.type==='expense'?'æ”¯å‡º':'æ”¶å…¥', 
                    (t.type==='expense'?'-':'')+t.amount
                ].map(toCSV).join(",")).join("\n");
                
                const l = document.createElement("a"); 
                l.href = URL.createObjectURL(new Blob(["\uFEFF" + h + "\n" + r], { type: 'text/csv;charset=utf-8;' })); 
                l.download = `MoneyLite_Report_${new Date().toISOString().split('T')[0]}.csv`; 
                l.click(); 
            };

            App.copyReport = () => {
                const h = ["æ—¥æœŸ", "åˆ†é¡", "å°ˆæ¡ˆ/å°è±¡", "å‚™è¨»", "é¡å‹", "é‡‘é¡"].join("\t");
                const r = App.getAllTransactions().map(t => [
                    toDateStr(t.timestamp),
                    t.category,
                    t.project,
                    (t.remarks||'').replace(/\t|\n/g, ' '),
                    t.type==='expense'?'æ”¯å‡º':'æ”¶å…¥',
                    (t.type==='expense'?'-':'')+t.amount
                ].join("\t")).join("\n");
                App.copyToClipboard(h + "\n" + r);
            };

            App.exportEvents = () => { 
                if (!confirm("åŒ¯å‡ºå¤§äº‹è¨˜ç‚º CSV (å¯ç›´æ¥åŒ¯å…¥ Google Sheets)?")) return; 
                const h = ["æ—¥æœŸ", "æ¨™é¡Œ", "è©³ç´°æè¿°"].join(",");
                const r = State.data.events.sort((a, b) => getTxDate(b) - getTxDate(a)).map(e => [
                    toDateStr(getTxDate(e)), 
                    e.title, 
                    e.description
                ].map(toCSV).join(",")).join("\n");
                
                const l = document.createElement("a"); 
                l.href = URL.createObjectURL(new Blob(["\uFEFF" + h + "\n" + r], { type: 'text/csv;charset=utf-8;' })); 
                l.download = `MoneyLite_Events_${new Date().toISOString().split('T')[0]}.csv`; 
                l.click(); 
            };

            App.copyEvents = () => {
                const h = ["æ—¥æœŸ", "æ¨™é¡Œ", "è©³ç´°æè¿°"].join("\t");
                const r = State.data.events.sort((a, b) => getTxDate(b) - getTxDate(a)).map(e => [
                    toDateStr(getTxDate(e)),
                    e.title,
                    (e.description||'').replace(/\t|\n/g, ' ')
                ].join("\t")).join("\n");
                App.copyToClipboard(h + "\n" + r);
            };

            App.copyToClipboard = (str) => {
                const el = document.createElement('textarea');
                el.value = str;
                document.body.appendChild(el);
                el.select();
                try {
                    document.execCommand('copy');
                    alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\nè«‹ç›´æ¥åœ¨ Google è©¦ç®—è¡¨æŒ‰ Ctrl+V è²¼ä¸Šå³å¯ã€‚");
                } catch (e) {
                    alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•åŒ¯å‡ºã€‚");
                }
                document.body.removeChild(el);
            };

            App.openCategorySelector = () => { const t = $('tx-type').value, h = App.getAllTransactions().filter(x => x.type === t && x.category).map(x => x.category), c = {}; h.forEach(k => c[k] = (c[k] || 0) + 1); const list = [...new Set([...Object.keys(c).sort((a, b) => c[b] - c[a]), ...State.categories[t]])], el = $('sub-modal-content'); el.innerHTML = $('tpl-category-selector').innerHTML; $('category-chips').innerHTML = list.map(k => `<button onclick="App.pickCategory('${k}')" class="bg-slate-100 hover:bg-primary hover:text-white text-slate-600 px-4 py-2.5 rounded-xl text-xs font-bold transition shadow-sm border border-slate-200">${k}</button>`).join(''); $('sub-modal-overlay').classList.remove('hidden'); $('sub-modal-overlay').classList.add('flex') };
            App.closeSubModal = () => $('sub-modal-overlay').classList.add('hidden'); App.pickCategory = v => { document.querySelector('#modal-content input[name="category"]').value = v; App.closeSubModal() };
            App.toggleTxType = t => { $('tx-type').value = t; const e = $('btn-expense'), i = $('btn-income'); if (t === 'expense') { e.classList.add('bg-white', 'shadow-md', 'text-rose-500'); e.classList.remove('text-slate-500'); i.classList.remove('bg-white', 'shadow-md', 'text-emerald-500'); i.classList.add('text-slate-500') } else { i.classList.add('bg-white', 'shadow-md', 'text-emerald-500'); i.classList.remove('text-slate-500'); e.classList.remove('bg-white', 'shadow-md', 'text-rose-500'); e.classList.add('text-slate-500') } };
            App.toggleBudgetType = t => { $('budget-type').value = t; const e = $('btn-budget-expense'), i = $('btn-budget-income'), ctx = $('budget-context').value; $('penalty-config')?.classList.toggle('hidden', ctx !== 'investment' && ctx !== 'debt'); $('recurring-config')?.classList.toggle('hidden', ctx !== 'investment' && ctx !== 'debt'); if (ctx === 'accounting') $('budget-categories-list').innerHTML = (t === 'expense' ? State.categories.expense : State.categories.income).map(c => `<option value="${c}">`).join(''); if (t === 'expense') { e.classList.add('bg-white', 'shadow', 'text-rose-500'); e.classList.remove('text-slate-500'); i.classList.remove('bg-white', 'shadow', 'text-emerald-500'); i.classList.add('text-slate-500'); e.innerText = ctx === 'investment' ? 'é è¨ˆæŠ•å…¥' : 'æ”¯å‡º' } else { i.classList.add('bg-white', 'shadow', 'text-emerald-500'); i.classList.remove('text-slate-500'); e.classList.remove('bg-white', 'shadow', 'text-rose-500'); e.classList.add('text-slate-500'); i.innerText = ctx === 'investment' ? 'é æœŸç²åˆ©' : 'æ”¶å…¥' } };
            
            App.openBudgetModal = (ctx, id = null, data = null) => {
                const c = $('modal-content'); c.innerHTML = $('tpl-budget-modal').innerHTML;
                const f = c.querySelector('form'); f.context.value = ctx; f.id.value = id || '';
                const inp = f.querySelector('#budget-target-input'), sel = f.querySelector('#budget-target-select');
                if (ctx === 'accounting') { inp.classList.remove('hidden'); inp.required = true; } 
                else {
                    sel.classList.remove('hidden'); sel.required = true;
                    const opts = ctx === 'investment' ? State.data.investments.filter(i => !i.isArchived).map(i => ({ v: i.id, l: i.name })) : State.data.debts.map(d => ({ v: d.id, l: d.name }));
                    sel.innerHTML = opts.map(o => `<option value="${o.v}">${o.l}</option>`).join('');
                }
                const item = data || (id ? State.data[ctx === 'investment' ? 'investmentBudgets' : ctx === 'debt' ? 'debtBudgets' : 'accountingBudgets'].find(i => i.id === id) : null);
                if (item) {
                    f.amount.value = item.amount; f.date.value = toDateStr(item.expectedDate); f.desc.value = item.description; App.toggleBudgetType(item.type || 'expense');
                    if (ctx === 'accounting') inp.value = item.targetId; else sel.value = item.targetId;
                    if (item.enablePenalty) { f.enablePenalty.checked = true; f.dailyPenalty.value = item.dailyPenalty; }
                    if (item.enableRecurring) { f.enableRecurring.checked = true; f.recurringDays.value = item.recurringDays; }
                    $('budget-modal-title').innerText = 'ç·¨è¼¯é ç®—';
                } else { f.date.value = toDateStr(new Date()); App.toggleBudgetType('expense'); }
                $('modal-overlay').classList.remove('hidden'); $('modal-overlay').classList.add('flex');
            };

            App.openModal = (t, id, def = {}) => {
                const c = $('modal-content'); c.innerHTML = $(`tpl-${t}`).innerHTML;
                if (c.querySelector('form')) c.querySelector('form').reset();
                c.querySelector('[name=id]').value = '';
                if (c.querySelector('[name=legacy_inv_id]')) c.querySelector('[name=legacy_inv_id]').value = '';
                if (t === 'transaction-modal') {
                    if (def.project) c.querySelector('[name=project]').value = def.project;
                    if (def.category) c.querySelector('[name=category]').value = def.category;
                    if (def.amount) c.querySelector('[name=amount]').value = def.amount;
                    if (def.remarks) c.querySelector('[name=remarks]').value = def.remarks;
                    if (def.type) App.toggleTxType(def.type)
                }
                if (id) {
                    let item = State.data[t === 'transaction-modal' ? 'transactions' : t === 'investment-modal' ? 'investments' : t === 'debt-modal' ? 'debts' : t === 'event-modal' ? 'events' : []].find(i => i.id === id);
                    if (!item && t === 'transaction-modal') item = App.getAllTransactions().find(i => i.id === id);
                    if (item) {
                        c.querySelector('[name=id]').value = id;
                        if (t === 'transaction-modal') { c.querySelector('[name=amount]').value = item.amount; c.querySelector('[name=date]').value = toDateStr(getTxDate(item)); c.querySelector('[name=category]').value = item.category; c.querySelector('[name=remarks]').value = item.remarks; c.querySelector('[name=project]').value = item.project || ''; if (item.isLegacy) c.querySelector('[name=legacy_inv_id]').value = item.legacyInvId; App.toggleTxType(item.type); const cb = c.querySelector('#btn-copy-tx'); cb && cb.classList.remove('hidden'); cb && (cb.onclick = () => App.copyTransaction(id)) }
                        else if (t === 'investment-modal') { c.querySelector('[name=name]').value = item.name; c.querySelector('[name=initial]').value = item.initialValue; c.querySelector('[name=annualRate]').value = item.annualRate || ''; c.querySelector('[name=isArchived]').checked = item.isArchived }
                        else if (t === 'debt-modal') { c.querySelector('[name=name]').value = item.name; c.querySelector('[name=total]').value = item.totalAmount; c.querySelector('[name=remaining]').value = item.remainingAmount; c.querySelector('[name=annualRate]').value = item.annualRate || ''; }
                        else if (t === 'event-modal') { c.querySelector('[name=title]').value = item.title; c.querySelector('[name=desc]').value = item.description; c.querySelector('[name=date]').value = toDateStr(getTxDate(item)) }
                    }
                } else { const d = c.querySelector('[name=date]'); d && !d.value && (d.value = toDateStr(new Date())) }
                if (t === 'transaction-modal' && id) { const db = c.querySelector('#btn-delete-tx'); db.classList.remove('hidden'); let lid = App.getAllTransactions().find(i => i.id === id)?.legacyInvId; db.onclick = () => App.deleteTransaction(id, lid) }
                if (t === 'event-modal' && id) { const db = c.querySelector('#btn-delete-event'); db && db.classList.remove('hidden'); db && (db.onclick = () => App.deleteItem('events', id)) }
                if (t === 'investment-modal' && id) { const db = c.querySelector('#btn-delete-inv'); db && db.classList.remove('hidden'); db && (db.onclick = () => App.deleteItem('investments', id)) }
                if (t === 'debt-modal' && id) { const db = c.querySelector('#btn-delete-debt'); db && db.classList.remove('hidden'); db && (db.onclick = () => App.deleteItem('debts', id)) }
                $('modal-overlay').classList.remove('hidden'); $('modal-overlay').classList.add('flex')
            };
            App.closeModal = () => $('modal-overlay').classList.add('hidden');
            App.openRepayModal = (id, n) => { const c = $('modal-content'); c.innerHTML = '<div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">å„Ÿé‚„è² å‚µ</h3><button onclick="App.closeModal()" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button></div><form onsubmit="App.handleRepayDebt(event)" class="space-y-5"><input type="hidden" name="id" id="repay-id" value="' + id + '"><div class="text-center"><p class="text-xs text-slate-400 mb-1">å„Ÿé‚„é …ç›®</p><h4 class="text-lg font-bold text-slate-700" id="repay-debt-name">' + n + '</h4></div><div><label class="text-[10px] font-bold text-slate-400 block mb-1">é‡‘é¡</label><input type="number" name="amount" class="input-box w-full rounded-xl p-3 text-sm" required></div><div><label class="text-[10px] font-bold text-slate-400 block mb-1">æ—¥æœŸ</label><input type="date" name="date" class="input-box w-full rounded-xl p-3 text-sm" required value="' + toDateStr(new Date()) + '"></div><button class="w-full bg-emerald-500 text-white font-bold py-3.5 rounded-2xl shadow-lg hover:bg-emerald-600 transition">ç¢ºèªé‚„æ¬¾</button></form>'; $('modal-overlay').classList.remove('hidden'); $('modal-overlay').classList.add('flex') },
            
            App.renderTransactions = () => {
                if (!$('tx-list')) return;
                const v = $('date-filter').value, [y, m] = v.split('-').map(Number), s = new Date(y, m - 1, 1), e = new Date(y, m, 0, 23, 59, 59), tx = State.data.transactions.filter(t => { const d = getTxDate(t); return d >= s && d <= e }).sort((a, b) => getTxDate(b) - getTxDate(a)), g = {};
                tx.forEach(t => { const k = getTxDate(t).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', weekday: 'short' }); if (!g[k]) g[k] = { l: [], i: 0, e: 0 }; g[k].l.push(t); t.type === 'income' ? g[k].i += parseFloat(t.amount) : g[k].e += parseFloat(t.amount) });
                const r = ([k, v]) => `<div class="mb-4 animate-fade-in"><div class="flex justify-between items-center text-xs font-bold text-slate-400 mb-2 px-2"><span>${k}</span><div class="flex gap-3"><span class="text-emerald-500 bg-emerald-50/50 px-1.5 rounded">+${v.i.toLocaleString()}</span><span class="text-rose-400 bg-rose-50/50 px-1.5 rounded">-${v.e.toLocaleString()}</span></div></div><div class="bg-white rounded-2xl shadow-soft border border-slate-50 overflow-hidden">${v.l.map(t => `<div class="flex justify-between items-center py-4 px-4 border-b border-slate-50 hover:bg-slate-50 cursor-pointer transition active:scale-[0.99]" onclick="App.openModal('transaction-modal','${t.id}')"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-2xl flex items-center justify-center text-sm font-bold shadow-sm ${t.type === 'expense' ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-500'}">${(t.category || 'æœª')[0]}</div><div class="min-w-0"><p class="font-bold text-slate-700 text-sm mb-0.5">${t.category || 'æœªåˆ†é¡'}</p><p class="text-[10px] text-slate-400 break-words whitespace-pre-wrap">${t.remarks || ''}</p></div></div><div class="flex flex-col items-end"><span class="font-bold text-sm ${t.type === 'expense' ? 'text-slate-700' : 'text-emerald-500'}">${t.type === 'expense' ? '-' : '+'} ${parseFloat(t.amount).toLocaleString()}</span><span class="text-[10px] text-slate-300">${t.project || ''}</span></div></div>`).join('')}</div></div>`;
                const en = Object.entries(g), rec = en.slice(0, 3), old = en.slice(3); let h = rec.map(r).join('');
                if (old.length) h += `<div class="text-center py-2 relative z-10"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div><div class="relative flex justify-center"><button onclick="document.getElementById('older-txs').classList.remove('hidden');this.parentElement.parentElement.classList.add('hidden')" class="bg-slate-50 text-slate-400 px-4 py-1.5 rounded-full text-xs font-bold border border-slate-200 hover:bg-slate-100 shadow-sm">é¡¯ç¤ºæ›´æ—©ç´€éŒ„ (${old.length}å¤©) <i class="fa-solid fa-chevron-down ml-1"></i></button></div></div><div id="older-txs" class="hidden space-y-4">${old.map(r).join('')}</div>`;
                if (!en.length) h = '<div class="text-center py-16"><div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300 text-2xl"><i class="fa-solid fa-receipt"></i></div><p class="text-slate-400 text-xs">æœ¬æœˆå°šç„¡ç´€éŒ„</p></div>';
                $('tx-list').innerHTML = h
            };
            
            App.renderAccountingBudgets = () => {
                const l = $('accounting-budget-list'); if (!l) return;
                l.innerHTML = State.data.accountingBudgets.filter(b => !b.isRealized).sort((a, b) => (a.expectedDate?.seconds || 0) - (b.expectedDate?.seconds || 0)).map(b => {
                    const isExp = !b.type || b.type === 'expense', pst = b.expectedDate?.toDate() < new Date().setHours(0, 0, 0, 0);
                    return `<li class="flex justify-between items-center p-3 rounded-xl border shadow-soft mb-2 ${pst ? 'bg-rose-50 border-rose-100' : 'bg-white border-slate-50'}"><div class="flex items-center gap-3"><div class="w-1 ${isExp ? 'bg-rose-500' : 'bg-emerald-500'} h-8 rounded-full"></div><div><span class="font-bold text-slate-700 text-xs block">${b.targetId || 'ä¸€èˆ¬'}</span><div class="flex gap-2 text-[10px] text-slate-400"><span>${toDateStr(b.expectedDate)}</span><span>${b.description}</span><span class="font-bold ${isExp ? 'text-rose-500' : 'text-emerald-500'}">$${(parseFloat(b.amount) || 0).toLocaleString()}</span></div></div></div><div class="flex gap-2"><button onclick="App.realizeBudget('accounting','${b.id}')" class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 hover:bg-emerald-100 flex items-center justify-center transition"><i class="fa-solid fa-check text-xs"></i></button><button onclick="App.copyBudget('accounting','${b.id}')" class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-400 hover:bg-indigo-100 flex items-center justify-center transition"><i class="fa-solid fa-copy text-xs"></i></button><button onclick="App.openBudgetModal('accounting','${b.id}')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 flex items-center justify-center transition"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="App.deleteItem('accountingBudgets','${b.id}')" class="w-8 h-8 rounded-full bg-rose-50 text-rose-400 hover:bg-rose-100 flex items-center justify-center transition"><i class="fa-solid fa-trash text-xs"></i></button></div></li>`
                }).join('') || '<li class="text-xs text-slate-300 text-center py-4 border-2 border-dashed border-slate-100 rounded-xl">å°šç„¡é ç®—é …ç›®</li>'
            };
            
            App.updateDashboard = () => {
                if (!document.getElementById('monthly-balance')) return;
                const v = $('date-filter').value, [y, m] = v.split('-').map(Number), s = new Date(y, m - 1, 1), e = new Date(y, m, 0, 23, 59, 59), tx = State.data.transactions.filter(t => { const d = getTxDate(t); return d >= s && d <= e }), inc = tx.filter(t => t.type === 'income').reduce((a, b) => a + (parseFloat(b.amount) || 0), 0), exp = tx.filter(t => t.type === 'expense').reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                $('monthly-income').innerText = inc.toLocaleString(); $('monthly-expense').innerText = exp.toLocaleString(); $('monthly-balance').innerText = `$${(inc - exp).toLocaleString()}`;
                const n = new Date();
                if (n.getMonth() + 1 === m && n.getFullYear() === y) {
                    const ts = new Date(n.getFullYear(), n.getMonth(), n.getDate()), te = new Date(n.getFullYear(), n.getMonth(), n.getDate() + 1), ttx = State.data.transactions.filter(t => { const d = getTxDate(t); return d >= ts && d < te }), ti = ttx.filter(t => t.type === 'income').reduce((a, b) => a + (parseFloat(b.amount) || 0), 0), tep = ttx.filter(t => t.type === 'expense').reduce((a, b) => a + (parseFloat(b.amount) || 0), 0), tb = ti - tep;
                    $('today-income').innerText = ti.toLocaleString(); $('today-expense').innerText = tep.toLocaleString(); $('today-balance').innerText = tb.toLocaleString(); $('today-balance-container').className = `px-2 py-0.5 rounded ${tb < 0 ? 'text-rose-500 bg-rose-50' : 'text-indigo-600 bg-indigo-50'}`
                }
                const t = new Date(); t.setHours(0, 0, 0, 0);
                const oi = State.data.accountingBudgets.reduce((s, b) => { const d = getTxDate({ timestamp: b.expectedDate }); d.setHours(0, 0, 0, 0); return (b.type === 'income' && !b.isRealized && d < t) ? s + (parseFloat(b.amount) || 0) : s }, 0);
                const pi = State.data.accountingBudgets.reduce((sum, b) => { const d = getTxDate({ timestamp: b.expectedDate }); return (b.type === 'income' && !b.isRealized && d >= s && d <= e) ? sum + (parseFloat(b.amount) || 0) : sum }, 0);
                if ($('acc-overdue-badge')) { $('acc-overdue-val').innerText = `$${oi.toLocaleString()}`; $('acc-overdue-badge').classList.toggle('hidden', oi <= 0) }
                if ($('acc-pending-income-badge')) { $('acc-pending-income-val').innerText = `$${pi.toLocaleString()}`; $('acc-pending-income-badge').classList.toggle('hidden', pi <= 0) }
            };
            
            App.toCal = (t, d, desc) => window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t)}&dates=${d.replace(/-/g, '')}/${d.replace(/-/g, '')}&details=${encodeURIComponent(desc)}`, '_blank');
            App.renderEvents = () => { if (!$('event-list')) return; const g = {}; State.data.events.sort((a, b) => getTxDate(b) - getTxDate(a)).forEach(e => { const k = getTxDate(e).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' }); if (!g[k]) g[k] = []; g[k].push(e) }); $('event-list').innerHTML = `<div class="absolute left-[19px] top-0 bottom-0 w-0.5 bg-slate-100 z-0"></div>` + (Object.keys(g).length ? Object.entries(g).map(([m, evs]) => `<div class="mb-8 relative z-10"><h3 class="text-xs font-bold text-slate-400 mb-4 bg-[#f8fafc] inline-block pr-2 sticky top-0">${m}</h3><div class="space-y-6">${evs.map(e => `<div class="relative pl-8 group cursor-pointer" onclick="App.openModal('event-modal','${e.id}')"><div class="absolute left-3 top-1.5 w-4 h-4 rounded-full border-[3px] border-[#f8fafc] bg-indigo-300 group-hover:bg-primary group-hover:scale-125 transition shadow-sm"></div><div class="bg-white p-4 rounded-2xl shadow-soft border border-slate-50 hover:shadow-md transition active:scale-[0.99]"><div class="flex justify-between items-start mb-1"><span class="text-[10px] font-bold text-primary bg-indigo-50 px-2 py-0.5 rounded-lg">${getTxDate(e).toLocaleDateString('zh-TW', { day: 'numeric', weekday: 'short' })}</span><div class="opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-pen text-slate-300 text-xs"></i></div></div><h4 class="font-bold text-slate-800 text-sm mb-1">${e.title}</h4><p class="text-xs text-slate-500 leading-relaxed whitespace-pre-wrap">${e.description || ''}</p></div></div>`).join('')}</div></div>`).join('') : '<div class="text-center py-20"><div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300"><i class="fa-solid fa-camera-retro text-xl"></i></div><p class="text-slate-400 text-xs">é€™è£¡ç©ºç©ºçš„ï¼Œè¨˜éŒ„ä¸€é»ç”Ÿæ´»å§ï¼Ÿ</p></div>') };
            
            App.renderInvestments = () => {if(!$('inv-list'))return;const mv=$('inv-date-filter').value,[yr,mn]=mv?mv.split('-').map(Number):[new Date().getFullYear(),new Date().getMonth()+1],sm=new Date(yr,mn-1,1),em=new Date(yr,mn,0,23,59,59),ins=State.data.investments.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)),ai=ins.filter(i=>State.view.invTab==='active'?!i.isArchived:i.isArchived);let tv=0,tr=0,tc=0;$('inv-list').innerHTML=ai.length?ai.map(i=>{const sub=State.data.legacyTxs[i.id]||[],main=State.data.transactions.filter(t=>t.project===i.name),l=new Set(sub.map(t=>t.mainTransactionId).filter(Boolean)),all=[...sub,...main.filter(t=>!l.has(t.id))],inc=all.filter(t=>t.type==='income').reduce((a,b)=>a+parseFloat(b.amount),0),exp=all.filter(t=>t.type==='expense').reduce((a,b)=>a+parseFloat(b.amount),0),p=inc-exp;if(State.view.invTab==='active'){tv+=(parseFloat(i.marketValue)||0);tc+=exp;tr+=p}const mi=all.filter(t=>{const d=getTxDate(t);return t.type==='income'&&d>=sm&&d<=em}).reduce((s,t)=>s+parseFloat(t.amount),0),md=mi>0?`<div class="mt-2 pt-2 border-t border-slate-50 flex justify-between items-center"><span class="text-[10px] text-slate-400">æœ¬æœˆå¯¦ç¾</span><span class="text-xs font-bold text-emerald-500">+$${mi.toLocaleString()}</span></div>`:'',pp=State.data.investmentBudgets.filter(b=>b.targetId===i.id&&!b.isRealized&&b.isPenalty).reduce((s,b)=>s+parseFloat(b.amount),0),pb=pp>0?`<div class="absolute -top-1 -left-1 bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-md z-10 animate-pulse-fast">âš ï¸ ç´¯ç©ç½°é‡‘ $${pp.toLocaleString()}</div>`:'';return`<div class="bg-white p-4 rounded-2xl shadow-soft border border-slate-50 cursor-pointer hover:shadow-md transition active:scale-[0.99] group relative" onclick="App.showDetails('investment','${i.id}')">${pb}<div class="flex justify-between items-start mb-2"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-indigo-50 text-primary flex items-center justify-center font-bold text-lg shadow-sm">${i.name[0]}</div><div><h4 class="font-bold text-slate-800 text-sm">${i.name}</h4><p class="text-[10px] text-slate-400">æˆæœ¬: $${(parseFloat(i.initialValue)||0).toLocaleString()}</p></div></div><div class="text-right"><p class="font-bold text-base text-slate-800">$${(parseFloat(i.marketValue)||0).toLocaleString()}</p><p class="text-[10px] font-bold ${p>=0?'text-emerald-500':'text-rose-500'}">${p>=0?'+':''}${p.toLocaleString()}</p></div></div>${md}<div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition"><button onclick="event.stopPropagation();App.openModal('investment-modal','${i.id}')" type="button" class="w-6 h-6 rounded-full bg-slate-100 text-slate-400 hover:text-primary flex items-center justify-center"><i class="fa-solid fa-pen text-[10px]"></i></button></div></div>`}).join(''):'<div class="text-center text-slate-400 py-10 text-xs">å°šç„¡æŠ•è³‡å¸³æˆ¶</div>';const aii=App.getAllTransactions().filter(t=>{const d=getTxDate(t);return t.type==='income'&&t.category.includes('æŠ•è³‡')&&d>=sm&&d<=em}).reduce((s,t)=>s+parseFloat(t.amount),0);$('inv-monthly-summary').innerText=`æœ¬æœˆç¸½æ”¶ç›Š: $${aii.toLocaleString()}`;const roi=tc>0?(tr/tc)*100:0;$('inv-total-val').innerText=`$${tv.toLocaleString()}`;$('inv-total-ret').innerText=`${tr>0?'+':''}${tr.toLocaleString()}`;$('inv-roi').innerText=`${roi.toFixed(1)}%`;$('inv-roi').className=`font-bold text-base ${tr>=0?'text-emerald-400':'text-rose-400'}`;const tpp=State.data.investmentBudgets.filter(b=>!b.isRealized&&b.isPenalty).reduce((s,b)=>s+parseFloat(b.amount),0);if(tpp>0){$('inv-total-penalty').innerText=`$${tpp.toLocaleString()}`;$('inv-penalty-summary').classList.remove('hidden')}else $('inv-penalty-summary').classList.add('hidden');const fs=$('inv-budget-filter-select'),cf=fs?fs.value:'all';if(fs&&fs.options.length<=1)fs.innerHTML=`<option value="all">å…¨éƒ¨é …ç›®</option><option value="penalty">åƒ…é¡¯ç¤ºç½°é‡‘</option>`+State.data.investments.filter(i=>!i.isArchived).map(i=>`<option value="${i.id}">${i.name}</option>`).join('');let bl=State.data.investmentBudgets.filter(b=>!b.isRealized);if(cf!=='all')bl=bl.filter(b=>cf==='penalty'?b.isPenalty:b.targetId===cf);
                $('inv-budget-list').innerHTML=bl.sort((a,b)=>(a.expectedDate?.seconds||0)-(b.expectedDate?.seconds||0)).map(b=>{const ie=(!b.type||b.type==='expense'),ip=b.expectedDate?.toDate()<new Date().setHours(0,0,0,0),isP=b.isPenalty,rb=isP?'bg-rose-50 border-rose-200':(ip?'bg-rose-50 border-rose-100':'bg-white border-slate-50'),ic=isP?'bg-rose-500':(ie?'bg-rose-500':'bg-emerald-500'),ac=isP?'text-rose-600':(ie?'text-rose-500':'text-emerald-500'), dateStr=toDateStr(b.expectedDate), tName=ins.find(i=>i.id===b.targetId)?.name||'æœªçŸ¥';return`<li class="flex justify-between items-center p-3 rounded-xl border shadow-soft mb-2 ${rb}"><div class="flex items-center gap-3"><div class="w-1 ${ic} h-8 rounded-full"></div><div><span class="font-bold text-slate-700 text-xs block">${tName}</span><div class="flex gap-2 text-[10px] text-slate-400"><span>${dateStr}</span><span>${b.description}</span></div></div></div><div class="flex flex-col items-end mr-3"><span class="font-bold ${ac} text-xs">$${(parseFloat(b.amount)||0).toLocaleString()}</span></div><div class="flex gap-2"><button onclick="App.toCal('[æŠ•è³‡] ${tName}: ${b.description}', '${dateStr}', 'é è¨ˆé‡‘é¡: $${b.amount}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-400 hover:bg-blue-100 flex items-center justify-center transition"><i class="fa-solid fa-calendar-plus text-xs"></i></button><button onclick="App.realizeBudget('investment','${b.id}')" class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 hover:bg-emerald-100 flex items-center justify-center transition"><i class="fa-solid fa-check text-xs"></i></button><button onclick="App.copyBudget('investment','${b.id}')" class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-400 hover:bg-indigo-100 flex items-center justify-center transition"><i class="fa-solid fa-copy text-xs"></i></button><button onclick="App.openBudgetModal('investment','${b.id}')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 flex items-center justify-center transition"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="App.deleteItem('investmentBudgets','${b.id}')" class="w-8 h-8 rounded-full bg-rose-50 text-rose-400 hover:bg-rose-100 flex items-center justify-center transition"><i class="fa-solid fa-trash text-xs"></i></button></div></li>`}).join('')||'<li class="text-xs text-slate-300 text-center py-4 border-2 border-dashed border-slate-100 rounded-xl">å°šç„¡é ç®—é …ç›®</li>'};
            
            App.renderDebts = () => {if(!$('debt-list'))return;const mv=$('debt-date-filter').value,[yr,mn]=mv?mv.split('-').map(Number):[new Date().getFullYear(),new Date().getMonth()+1],sm=new Date(yr,mn-1,1),em=new Date(yr,mn,0,23,59,59),ds=State.data.debts.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));let tr=0,tm=0,to=0,trem=0;ds.forEach(d=>{to+=parseFloat(d.totalAmount)||0;trem+=parseFloat(d.remainingAmount)||0});const gp=to>0?Math.round(((to-trem)/to)*100):0;$('debt-list').innerHTML=ds.map(d=>{tr+=parseFloat(d.remainingAmount);const p=Math.round(((d.totalAmount-d.remainingAmount)/d.totalAmount)*100),mr=State.data.transactions.filter(t=>t.type==='expense'&&t.project===d.name).reduce((s,t)=>{const dt=getTxDate(t);return(dt>=sm&&dt<=em)?s+(parseFloat(t.amount)||0):s},0);tm+=mr;const md=mr>0?`<span class="text-[10px] text-emerald-600 font-bold bg-emerald-50 px-2 py-0.5 rounded-lg">æœ¬æœˆå·²é‚„: $${mr.toLocaleString()}</span>`:'';return`<div class="bg-white p-4 rounded-2xl shadow-soft border border-slate-50 cursor-pointer active:scale-[0.99] transition relative group" onclick="App.showDetails('debt','${d.id}')"><div class="flex justify-between mb-2"><span class="font-bold text-slate-700">${d.name}</span><div class="flex items-center gap-2">${md}<span class="text-xs font-bold text-warning">${p}%</span></div></div><div class="w-full bg-slate-100 rounded-full h-2 mb-3"><div class="bg-warning h-2 rounded-full" style="width:${p}%"></div></div><div class="flex justify-between items-end"><div class="text-xs text-slate-400">å‰©é¤˜ <span class="text-slate-700 font-bold text-sm">$${d.remainingAmount.toLocaleString()}</span></div><div class="flex gap-2 relative z-10"><button onclick="event.stopPropagation();App.openRepayModal('${d.id}','${d.name}')" class="text-xs bg-emerald-50 text-emerald-600 font-bold px-3 py-1.5 rounded-lg hover:bg-emerald-100 transition">é‚„æ¬¾</button></div></div><button onclick="event.stopPropagation();App.openModal('debt-modal','${d.id}')" class="absolute top-4 right-4 text-slate-300 hover:text-primary opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-pen text-xs"></i></button></div>`}).join('');$('debt-total-remaining').innerText=`$${tr.toLocaleString()}`;$('debt-monthly-summary').innerText=`æœ¬æœˆé‚„æ¬¾: $${tm.toLocaleString()}`;$('debt-progress-text').innerText=`${gp}%`;$('debt-progress-bar').style.width=`${gp}%`;
            $('debt-budget-list').innerHTML=State.data.debtBudgets.filter(b=>!b.isRealized).sort((a,b)=>(a.expectedDate?.seconds||0)-(b.expectedDate?.seconds||0)).map(b=>{ const dateStr = toDateStr(b.expectedDate); const tName = State.data.debts.find(d=>d.id===b.targetId)?.name||'æœªçŸ¥'; const isAutoInterest = b.isAutoInterest; const isPenalty = b.isPenalty; const isP = isAutoInterest || isPenalty; const rowBg = isP ? 'bg-indigo-50 border-indigo-200' : (b.expectedDate?.toDate()<new Date().setHours(0,0,0,0)?'bg-rose-50 border-rose-100':'bg-white border-slate-50'); return `<li class="flex justify-between items-center p-3 rounded-xl border shadow-soft mb-2 ${rowBg}"><div class="flex items-center gap-3"><div class="w-1 bg-warning h-8 rounded-full"></div><div><span class="font-bold text-slate-700 text-xs block">${tName}</span><div class="flex gap-2 text-[10px] text-slate-400"><span>${dateStr}</span><span>${b.description}</span></div></div></div><div class="flex flex-col items-end mr-3"><span class="font-bold text-rose-500 text-xs">$${(parseFloat(b.amount)||0).toLocaleString()}</span></div><div class="flex gap-2"><button onclick="App.toCal('[é‚„æ¬¾] ${tName}: ${b.description}', '${dateStr}', 'é è¨ˆé‡‘é¡: $${b.amount}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-400 hover:bg-blue-100 flex items-center justify-center transition"><i class="fa-solid fa-calendar-plus text-xs"></i></button><button onclick="App.realizeBudget('debt','${b.id}')" class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 hover:bg-emerald-100 flex items-center justify-center transition"><i class="fa-solid fa-check text-xs"></i></button><button onclick="App.copyBudget('debt','${b.id}')" class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-400 hover:bg-indigo-100 flex items-center justify-center transition"><i class="fa-solid fa-copy text-xs"></i></button><button onclick="App.openBudgetModal('debt','${b.id}')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 flex items-center justify-center transition"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="App.deleteItem('debtBudgets','${b.id}')" class="w-8 h-8 rounded-full bg-rose-50 text-rose-400 hover:bg-rose-100 flex items-center justify-center transition"><i class="fa-solid fa-trash text-xs"></i></button></div></li>`}).join('')||'<li class="text-xs text-slate-300 text-center py-4 border-2 border-dashed border-slate-100 rounded-xl">å°šç„¡é‚„æ¬¾è¨ˆç•«</li>'};
            
            App.renderReports = () => {if(!$('report-project'))return;const tx=App.getAllTransactions(),ps=$('report-project'),cs=$('report-category'),cp=ps.value,cc=cs.value,pr=[...new Set(tx.map(t=>t.project).filter(Boolean))].sort();ps.innerHTML='<option value="all">å…¨éƒ¨å°ˆæ¡ˆ</option>'+pr.map(p=>`<option value="${p}">${p}</option>`).join('');if(pr.includes(cp))ps.value=cp;const ct=[...new Set(tx.map(t=>t.category).filter(Boolean))].sort();cs.innerHTML='<option value="all">å…¨éƒ¨åˆ†é¡</option>'+ct.map(c=>`<option value="${c}">${c}</option>`).join('');if(ct.includes(cc))cs.value=cc;const yr=parseInt($('report-year').value),mv=$('report-month-select').value;let s,e;if(mv==='all'){s=new Date(yr,0,1);e=new Date(yr,11,31,23,59,59)}else{const m=parseInt(mv);s=new Date(yr,m-1,1);e=new Date(yr,m,0,23,59,59)}const f=tx.filter(t=>{const d=getTxDate(t);return d>=s&&d<=e&&(ps.value==='all'||t.project===ps.value)&&(cs.value==='all'||t.category===cs.value)}).sort((a,b)=>getTxDate(b)-getTxDate(a));if(State.chart)State.chart.destroy();const m={},tot=f.filter(t=>t.type==='expense').reduce((s,t)=>{const c=t.category||'æœªåˆ†é¡';m[c]=(m[c]||0)+parseFloat(t.amount);return s+parseFloat(t.amount)},0);State.chart=new Chart($('expense-chart').getContext('2d'),{type:'doughnut',data:{labels:Object.keys(m),datasets:[{data:Object.values(m),backgroundColor:['#f43f5e','#f59e0b','#10b981','#3b82f6','#6366f1','#8b5cf6','#ec4899','#64748b'],borderWidth:0,hoverOffset:4}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:10},plugins:{legend:{position:'right',labels:{font:{size:11,family:"'Noto Sans TC'"},usePointStyle:true,boxWidth:8}}}}});let html='';const im={},em={};let it=0,et=0;f.forEach(t=>{const a=parseFloat(t.amount)||0,c=t.category||'æœªåˆ†é¡';if(t.type==='expense'){em[c]=(em[c]||0)+a;et+=a}else{im[c]=(im[c]||0)+a;it+=a}});if(it>0)html+=`<li class="text-xs font-bold text-emerald-600 mb-2 pb-1 mt-2 flex justify-between items-center"><span>æ”¶å…¥çµ±è¨ˆ</span><span class="bg-emerald-100 px-2 py-0.5 rounded-lg">$${it.toLocaleString()}</span></li>`+Object.entries(im).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<li class="flex justify-between border-b border-slate-100 py-1.5 last:border-0 text-slate-600"><span>${k}</span><span class="font-bold text-emerald-600">$${v.toLocaleString()} <span class="text-[10px] text-slate-300 font-normal">(${((v/it)*100).toFixed(1)}%)</span></span></li>`).join('');if(et>0)html+=`<li class="text-xs font-bold text-rose-500 mb-2 pb-1 mt-4 flex justify-between items-center"><span>æ”¯å‡ºçµ±è¨ˆ</span><span class="bg-rose-100 px-2 py-0.5 rounded-lg">$${et.toLocaleString()}</span></li>`+Object.entries(em).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<li class="flex justify-between border-b border-slate-100 py-1.5 last:border-0 text-slate-600"><span>${k}</span><span class="font-bold text-rose-500">$${v.toLocaleString()} <span class="text-[10px] text-slate-300 font-normal">(${((v/et)*100).toFixed(1)}%)</span></span></li>`).join('');if(!it&&!et)html='<li class="text-center text-slate-300 py-4">ç„¡æ•¸æ“š</li>';$('report-stats').innerHTML=html;$('report-details').innerHTML=f.length?f.map(t=>`<li class="flex justify-between items-center py-3 border-b border-slate-50 last:border-0 group cursor-pointer hover:bg-slate-50 p-2 rounded-xl transition" onclick="App.openModal('transaction-modal','${t.id}')"><div class="flex-1 min-w-0 mr-2"><p class="text-xs text-slate-400 mb-0.5">${getTxDate(t).toLocaleDateString()} <span class="font-bold text-slate-700 ml-1">${t.category}</span></p><p class="text-[10px] text-slate-400 break-words whitespace-pre-wrap">${t.remarks||''}</p></div><div class="flex items-center gap-2"><span class="text-xs font-bold ${t.type==='expense'?'text-rose-500':'text-emerald-500'} whitespace-nowrap">${t.type==='expense'?'-':'+'} ${parseFloat(t.amount).toLocaleString()}</span><button type="button" class="w-6 h-6 rounded-full bg-slate-100 text-slate-400 hover:text-primary flex items-center justify-center opacity-0 group-hover:opacity-100 transition" onclick="event.stopPropagation();App.openModal('transaction-modal','${t.id}')"><i class="fa-solid fa-pen text-[10px]"></i></button></div></li>`).join(''):'<li class="text-center text-xs text-slate-300 py-8">ç„¡äº¤æ˜“ç´€éŒ„</li>'};

            App.init();
        } catch (e) {
            console.error("Initialization Error:", e);
            alert("æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚");
        }
    </script>
</body>
</html>
