<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>雲端記帳 Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#4F46E5', secondary: '#10B981', danger: '#EF4444', warning: '#F59E0B', dark: '#1F2937' },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #F3F4F6; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fab { box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
        .card-shadow { box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .animate-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Mobile Nav Active State */
        .nav-btn.active { color: #4F46E5; }
        .nav-btn.active i { transform: translateY(-2px); }
        input, select, textarea { transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { ring: 2px; ring-color: #4F46E5; border-color: transparent; }
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden">

    <!-- Auth / Login View -->
    <div id="login-view" class="fixed inset-0 z-50 bg-white flex flex-col justify-center items-center p-6 animate-fade">
        <div class="mb-8 text-center">
            <div class="w-20 h-20 bg-primary/10 rounded-3xl flex items-center justify-center mx-auto mb-4 text-primary text-4xl">
                <i class="fa-solid fa-wallet"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800">雲端記帳</h1>
            <p class="text-gray-500 mt-2">簡單、直覺、好用的財務管家</p>
        </div>
        <button id="google-login-btn" class="w-full max-w-sm bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-medium shadow-sm hover:bg-gray-50 flex items-center justify-center gap-3 transition">
            <i class="fa-brands fa-google text-red-500"></i> Google 登入
        </button>
        <button id="anonymous-login-btn" class="mt-4 w-full max-w-sm bg-gray-800 text-white py-3 rounded-xl font-medium shadow-lg hover:bg-gray-900 transition">
            訪客體驗
        </button>
    </div>

    <!-- Main App Layout -->
    <div id="app-container" class="hidden flex-col h-full">
        <!-- Top Bar -->
        <header class="bg-white px-6 py-4 flex justify-between items-center shadow-sm z-10">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-chart-pie text-primary"></i> <span id="page-title">總覽</span>
            </h1>
            <div class="flex items-center gap-3">
                <div id="user-info" class="text-sm font-medium text-gray-600"></div>
                <button onclick="logout()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto p-4 pb-24 hide-scrollbar relative">
            
            <!-- Dashboard (Accounting) -->
            <div id="view-accounting" class="view-section space-y-4 animate-fade">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-primary/5 p-4 rounded-2xl border border-primary/10">
                        <p class="text-xs text-gray-500 mb-1">本月結餘</p>
                        <p id="monthly-balance" class="text-xl font-bold text-primary">--</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                        <p class="text-xs text-gray-500 mb-1">本月支出</p>
                        <p id="monthly-expense" class="text-xl font-bold text-danger">--</p>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="flex gap-2 overflow-x-auto hide-scrollbar py-1">
                    <button onclick="openModal('transaction-modal')" class="bg-primary text-white px-4 py-2 rounded-full text-sm shadow-md whitespace-nowrap"><i class="fa-solid fa-plus mr-1"></i> 記一筆</button>
                    <input type="date" id="date-filter" class="bg-white border-none rounded-full px-4 py-2 text-sm shadow-sm" onchange="App.renderTransactions()">
                </div>

                <!-- Recent Transactions List -->
                <div class="bg-white rounded-2xl p-4 card-shadow">
                    <h3 class="font-bold text-gray-800 mb-3 text-sm">近期紀錄</h3>
                    <ul id="tx-list" class="space-y-3">
                        <!-- Rendered via JS -->
                        <li class="text-center text-gray-400 py-4 text-sm">載入中...</li>
                    </ul>
                </div>
            </div>

            <!-- Investment View -->
            <div id="view-investment" class="view-section hidden space-y-4 animate-fade">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-5 text-white shadow-lg">
                    <p class="text-blue-100 text-sm">總資產現值</p>
                    <h2 id="inv-total-val" class="text-3xl font-bold mt-1">--</h2>
                    <div class="flex gap-4 mt-4 text-sm">
                        <div><span class="opacity-70">總損益</span> <span id="inv-total-ret" class="font-bold">--</span></div>
                        <div><span class="opacity-70">ROI</span> <span id="inv-roi" class="font-bold">--</span></div>
                    </div>
                </div>
                <div class="flex justify-end"><button onclick="openModal('investment-modal')" class="text-primary text-sm font-bold">+ 新增帳戶</button></div>
                <div id="inv-list" class="grid gap-3"></div>
            </div>

            <!-- Debt View -->
            <div id="view-debt" class="view-section hidden space-y-4 animate-fade">
                <div class="bg-white p-5 rounded-2xl card-shadow border-l-4 border-warning">
                    <p class="text-xs text-gray-500">剩餘總負債</p>
                    <p id="debt-total-remaining" class="text-2xl font-bold text-gray-800">--</p>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 mt-3">
                        <div id="debt-progress-bar" class="bg-warning h-1.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="flex justify-end"><button onclick="openModal('debt-modal')" class="text-primary text-sm font-bold">+ 新增負債</button></div>
                <div id="debt-list" class="space-y-3"></div>
            </div>

            <!-- Reports View -->
            <div id="view-reports" class="view-section hidden space-y-4 animate-fade">
                <div class="bg-white p-4 rounded-2xl card-shadow">
                    <h3 class="font-bold mb-4 text-center">支出分佈</h3>
                    <div class="h-64 relative"><canvas id="expense-chart"></canvas></div>
                </div>
            </div>

            <!-- Events View (Timeline) -->
            <div id="view-events" class="view-section hidden space-y-4 animate-fade">
                 <button onclick="openModal('event-modal')" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-gray-50 mb-2">+ 紀錄大事記</button>
                 <div id="event-list" class="space-y-4 pl-2"></div>
            </div>

        </main>

        <!-- Bottom Navigation (Mobile Style) -->
        <nav class="bg-white border-t border-gray-100 px-6 py-3 flex justify-between items-center text-xs font-medium text-gray-400 z-20">
            <button onclick="switchTab('accounting', this)" class="nav-btn active flex flex-col items-center gap-1 transition">
                <i class="fa-solid fa-house text-lg"></i> 記帳
            </button>
            <button onclick="switchTab('investment', this)" class="nav-btn flex flex-col items-center gap-1 transition">
                <i class="fa-solid fa-arrow-trend-up text-lg"></i> 投資
            </button>
            <div class="relative -top-6">
                <button onclick="openModal('transaction-modal')" class="fab w-14 h-14 bg-primary rounded-full text-white text-2xl flex items-center justify-center transition hover:scale-105 active:scale-95">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
            <button onclick="switchTab('debt', this)" class="nav-btn flex flex-col items-center gap-1 transition">
                <i class="fa-solid fa-credit-card text-lg"></i> 負債
            </button>
            <button onclick="switchTab('reports', this)" class="nav-btn flex flex-col items-center gap-1 transition">
                <i class="fa-solid fa-chart-simple text-lg"></i> 報表
            </button>
        </nav>
    </div>

    <!-- Universal Modal System -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-50 hidden flex items-end sm:items-center justify-center animate-fade backdrop-blur-sm">
        <div id="modal-content" class="bg-white w-full sm:w-[400px] rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl transform transition-transform duration-300">
            <!-- Dynamic Content Injected Here -->
        </div>
    </div>

    <!-- Hidden Forms Templates -->
    <template id="tpl-transaction-form">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">新增紀錄</h3>
            <button onclick="closeModal()" class="text-gray-400 p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <form onsubmit="App.handleAddTransaction(event)" class="space-y-4">
            <div class="flex bg-gray-100 p-1 rounded-xl">
                <button type="button" class="type-btn flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow text-danger transition" onclick="toggleTxType('expense')" id="btn-expense">支出</button>
                <button type="button" class="type-btn flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 transition" onclick="toggleTxType('income')" id="btn-income">收入</button>
            </div>
            <input type="hidden" name="type" id="tx-type" value="expense">
            <div>
                <label class="text-xs text-gray-500 ml-1">金額</label>
                <input type="number" name="amount" class="w-full text-3xl font-bold text-gray-800 border-b border-gray-200 py-2 focus:outline-none focus:border-primary bg-transparent" placeholder="0" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-gray-500 ml-1">日期</label>
                    <input type="date" name="date" class="w-full bg-gray-50 rounded-xl px-3 py-3 text-sm focus:outline-none" required>
                </div>
                <div>
                    <label class="text-xs text-gray-500 ml-1">分類</label>
                    <input list="cat-list" name="category" class="w-full bg-gray-50 rounded-xl px-3 py-3 text-sm focus:outline-none" placeholder="選擇分類" required>
                    <datalist id="cat-list"></datalist>
                </div>
            </div>
            <div>
                <label class="text-xs text-gray-500 ml-1">備註 (選填)</label>
                <input type="text" name="remarks" class="w-full bg-gray-50 rounded-xl px-3 py-3 text-sm focus:outline-none" placeholder="寫點什麼...">
            </div>
            <button type="submit" class="w-full bg-primary text-white font-bold py-3.5 rounded-xl shadow-lg shadow-primary/30 mt-2 active:scale-95 transition">儲存</button>
        </form>
    </template>

    <template id="tpl-investment-form">
        <h3 class="text-xl font-bold mb-4">新增投資帳戶</h3>
        <form onsubmit="App.handleAddInvestment(event)" class="space-y-4">
            <input type="text" name="name" class="w-full bg-gray-50 rounded-xl p-3" placeholder="帳戶名稱 (如: 台積電)" required>
            <input type="number" name="initial" class="w-full bg-gray-50 rounded-xl p-3" placeholder="初始投入金額 (選填)">
            <div class="flex gap-2">
                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 py-3 rounded-xl font-bold">取消</button>
                <button type="submit" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold shadow-lg">建立</button>
            </div>
        </form>
    </template>

    <template id="tpl-debt-form">
        <h3 class="text-xl font-bold mb-4">新增負債</h3>
        <form onsubmit="App.handleAddDebt(event)" class="space-y-4">
            <input type="text" name="name" class="w-full bg-gray-50 rounded-xl p-3" placeholder="負債項目 (如: 學貸)" required>
            <input type="number" name="total" class="w-full bg-gray-50 rounded-xl p-3" placeholder="總金額" required>
            <div class="flex gap-2">
                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 py-3 rounded-xl font-bold">取消</button>
                <button type="submit" class="flex-1 bg-warning text-white py-3 rounded-xl font-bold shadow-lg">新增</button>
            </div>
        </form>
    </template>

    <template id="tpl-event-form">
        <h3 class="text-xl font-bold mb-4">新增大事記</h3>
        <form onsubmit="App.handleAddEvent(event)" class="space-y-4">
            <input type="date" name="date" class="w-full bg-gray-50 rounded-xl p-3" required>
            <input type="text" name="title" class="w-full bg-gray-50 rounded-xl p-3" placeholder="標題" required>
            <textarea name="desc" rows="3" class="w-full bg-gray-50 rounded-xl p-3" placeholder="內容..."></textarea>
            <button type="submit" class="w-full bg-dark text-white py-3 rounded-xl font-bold">紀錄</button>
        </form>
    </template>

    <template id="tpl-repay-form">
        <h3 class="text-xl font-bold mb-2">償還負債</h3>
        <p id="repay-debt-name" class="text-sm text-gray-500 mb-4"></p>
        <form onsubmit="App.handleRepayDebt(event)" class="space-y-4">
            <input type="hidden" name="id" id="repay-id">
            <input type="number" name="amount" class="w-full text-3xl font-bold border-b py-2 focus:outline-none text-center" placeholder="輸入金額" required>
            <input type="date" name="date" class="w-full bg-gray-50 rounded-xl p-3" required>
            <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg">確認還款</button>
        </form>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, updateDoc, increment, Timestamp, writeBatch, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = { apiKey: "AIzaSyAqFHm6Bn35m8xauc50ZvNNy_rxIZzCMTE", authDomain: "moneyw-f8105.firebaseapp.com", projectId: "moneyw-f8105", storageBucket: "moneyw-f8105.appspot.com", messagingSenderId: "155586195799", appId: "1:155586195799:web:302184fbf613f032a88e12" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State & Cache
        const State = {
            user: null,
            data: { transactions: [], debts: [], investments: [], events: [] },
            listeners: [],
            chart: null,
            categories: { 
                expense: ['飲食', '交通', '居住', '娛樂', '購物', '醫療', '教育', '投資', '其他'], 
                income: ['薪資', '獎金', '投資', '兼職', '其他'] 
            }
        };

        // --- App Logic ---
        window.App = {
            init: () => {
                onAuthStateChanged(auth, user => {
                    State.user = user;
                    const loginView = document.getElementById('login-view');
                    const appContainer = document.getElementById('app-container');
                    
                    if (user) {
                        loginView.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        appContainer.classList.add('flex');
                        document.getElementById('user-info').innerHTML = user.isAnonymous ? '訪客' : `<span class="truncate max-w-[100px]">${user.displayName}</span>`;
                        document.getElementById('date-filter').valueAsDate = new Date();
                        App.startListeners(user.uid);
                    } else {
                        loginView.classList.remove('hidden');
                        appContainer.classList.add('hidden');
                        appContainer.classList.remove('flex');
                        App.stopListeners();
                    }
                });
            },

            // Generic Firestore Listener
            startListeners: (uid) => {
                const listen = (colName, sortField, targetKey, renderFn) => {
                    const q = query(collection(db, `users/${uid}/${colName}`), orderBy(sortField, 'desc'));
                    const unsub = onSnapshot(q, snap => {
                        State.data[targetKey] = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        renderFn();
                    });
                    State.listeners.push(unsub);
                };
                
                // Transactions needs client-side filtering sometimes if compound queries are missing indexes
                // keeping it simple: fetch all by timestamp, filter in memory for this light app
                listen('transactions', 'timestamp', 'transactions', () => { App.renderTransactions(); App.updateDashboard(); App.renderReports(); });
                listen('debts', 'createdAt', 'debts', App.renderDebts);
                listen('investments', 'createdAt', 'investments', App.renderInvestments);
                listen('events', 'date', 'events', App.renderEvents);
            },

            stopListeners: () => { State.listeners.forEach(u => u()); State.listeners = []; },

            // --- Actions ---
            loginGoogle: () => signInWithPopup(auth, new GoogleAuthProvider()),
            loginAnon: () => signInAnonymously(auth),
            logout: () => signOut(auth),

            handleAddTransaction: async (e) => {
                e.preventDefault();
                const f = e.target;
                const date = new Date(f.date.value);
                await addDoc(collection(db, `users/${State.user.uid}/transactions`), {
                    type: f.type.value, amount: parseFloat(f.amount.value), category: f.category.value,
                    remarks: f.remarks.value, timestamp: Timestamp.fromDate(date)
                });
                closeModal();
            },

            handleAddInvestment: async (e) => {
                e.preventDefault();
                const f = e.target;
                const init = parseFloat(f.initial.value) || 0;
                const ref = await addDoc(collection(db, `users/${State.user.uid}/investments`), {
                    name: f.name.value, initialValue: init, marketValue: init, createdAt: Timestamp.now()
                });
                if (init > 0) { // Auto-record expense
                    await addDoc(collection(db, `users/${State.user.uid}/transactions`), {
                        type: 'expense', amount: init, category: '投資', project: f.name.value,
                        remarks: '初始投入', timestamp: Timestamp.now()
                    });
                }
                closeModal();
            },

            handleAddDebt: async (e) => {
                e.preventDefault();
                const f = e.target;
                await addDoc(collection(db, `users/${State.user.uid}/debts`), {
                    name: f.name.value, totalAmount: parseFloat(f.total.value), remainingAmount: parseFloat(f.total.value), createdAt: Timestamp.now()
                });
                closeModal();
            },

            handleAddEvent: async (e) => {
                e.preventDefault();
                const f = e.target;
                await addDoc(collection(db, `users/${State.user.uid}/events`), {
                    title: f.title.value, description: f.desc.value, date: Timestamp.fromDate(new Date(f.date.value))
                });
                closeModal();
            },

            handleRepayDebt: async (e) => {
                e.preventDefault();
                const f = e.target;
                const amount = parseFloat(f.amount.value);
                const debt = State.data.debts.find(d => d.id === f.id.value);
                const batch = writeBatch(db);
                
                batch.update(doc(db, `users/${State.user.uid}/debts`, f.id.value), { remainingAmount: increment(-amount) });
                batch.set(doc(collection(db, `users/${State.user.uid}/transactions`)), {
                    type: 'expense', amount: amount, category: '負債還款', project: debt.name,
                    remarks: `償還: ${debt.name}`, timestamp: Timestamp.fromDate(new Date(f.date.value))
                });
                await batch.commit();
                closeModal();
            },

            deleteItem: async (col, id) => {
                if(confirm('確定刪除?')) await deleteDoc(doc(db, `users/${State.user.uid}/${col}`, id));
            },

            updateMarketValue: async (id, oldVal) => {
                const newVal = prompt("輸入目前市值:", oldVal);
                if(newVal && !isNaN(newVal)) await updateDoc(doc(db, `users/${State.user.uid}/investments`, id), { marketValue: parseFloat(newVal) });
            },

            // --- Render Logic ---
            renderTransactions: () => {
                const list = document.getElementById('tx-list');
                const dateFilter = new Date(document.getElementById('date-filter').value);
                const start = new Date(dateFilter.getFullYear(), dateFilter.getMonth(), 1);
                const end = new Date(dateFilter.getFullYear(), dateFilter.getMonth() + 1, 0, 23, 59, 59);

                // Filter for "Month View" in dashboard
                const monthTxs = State.data.transactions.filter(t => t.timestamp.toDate() >= start && t.timestamp.toDate() <= end);
                
                // Recent 10 for list
                const recentTxs = [...State.data.transactions].sort((a,b) => b.timestamp - a.timestamp).slice(0, 20);

                list.innerHTML = recentTxs.length ? recentTxs.map(t => {
                    const isExp = t.type === 'expense';
                    const date = t.timestamp.toDate().toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'});
                    return `
                    <li class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0">
                        <div class="flex items-center gap-3">
                            <div class="bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center text-gray-500 text-sm font-bold">
                                ${t.category.substring(0,1)}
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${t.category} <span class="text-xs text-gray-400 font-normal">(${date})</span></p>
                                <p class="text-xs text-gray-400 truncate max-w-[150px]">${t.remarks || t.project || ''}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${isExp ? 'text-gray-800' : 'text-green-600'}">${isExp ? '-' : '+'} $${t.amount.toLocaleString()}</p>
                            <button onclick="App.deleteItem('transactions', '${t.id}')" class="text-xs text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </li>`;
                }).join('') : '<li class="text-center text-gray-400 py-4 text-sm">無紀錄</li>';
            },

            updateDashboard: () => {
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                const currentMonthTxs = State.data.transactions.filter(t => t.timestamp.toDate() >= start);
                
                const income = currentMonthTxs.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
                const expense = currentMonthTxs.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);
                
                document.getElementById('monthly-balance').innerText = `$${(income - expense).toLocaleString()}`;
                document.getElementById('monthly-expense').innerText = `$${expense.toLocaleString()}`;
            },

            renderInvestments: () => {
                const list = document.getElementById('inv-list');
                const invs = State.data.investments;
                let totalVal = 0, totalInit = 0;

                list.innerHTML = invs.map(i => {
                    totalVal += (i.marketValue || 0);
                    totalInit += (i.initialValue || 0);
                    const gain = (i.marketValue || 0) - (i.initialValue || 0);
                    const gainClass = gain >= 0 ? 'text-red-500' : 'text-green-500'; // TW Stocks red is up
                    return `
                    <div class="bg-white p-4 rounded-2xl card-shadow flex justify-between items-center">
                        <div onclick="App.updateMarketValue('${i.id}', ${i.marketValue})">
                            <h4 class="font-bold text-gray-800">${i.name}</h4>
                            <p class="text-xs text-gray-400">成本: ${i.initialValue.toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-800">$${(i.marketValue||0).toLocaleString()}</p>
                            <p class="text-xs font-bold ${gainClass}">${gain>0?'+':''}${gain.toLocaleString()}</p>
                        </div>
                    </div>`;
                }).join('');
                
                document.getElementById('inv-total-val').innerText = `$${totalVal.toLocaleString()}`;
                const totalGain = totalVal - totalInit;
                const roi = totalInit > 0 ? (totalGain/totalInit)*100 : 0;
                document.getElementById('inv-total-ret').innerText = `${totalGain>0?'+':''}${totalGain.toLocaleString()}`;
                document.getElementById('inv-roi').innerText = `${roi.toFixed(1)}%`;
            },

            renderDebts: () => {
                const list = document.getElementById('debt-list');
                let totalRem = 0, totalOrig = 0;
                
                list.innerHTML = State.data.debts.map(d => {
                    totalRem += d.remainingAmount;
                    totalOrig += d.totalAmount;
                    const pct = Math.round(((d.totalAmount - d.remainingAmount) / d.totalAmount) * 100);
                    return `
                    <div class="bg-white p-4 rounded-2xl card-shadow">
                        <div class="flex justify-between mb-2">
                            <span class="font-bold">${d.name}</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full text-gray-500">剩 $${d.remainingAmount.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2 mb-2">
                            <div class="bg-primary h-2 rounded-full transition-all duration-500" style="width: ${pct}%"></div>
                        </div>
                        <div class="flex justify-end gap-2">
                             <button onclick="openRepayModal('${d.id}', '${d.name}')" class="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-full font-bold">還款</button>
                             <button onclick="App.deleteItem('debts', '${d.id}')" class="text-xs text-gray-300 px-2"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('debt-total-remaining').innerText = `$${totalRem.toLocaleString()}`;
                const totalPct = totalOrig > 0 ? ((totalOrig-totalRem)/totalOrig)*100 : 0;
                document.getElementById('debt-progress-bar').style.width = `${totalPct}%`;
            },

            renderEvents: () => {
                const list = document.getElementById('event-list');
                list.innerHTML = State.data.events.map(e => `
                    <div class="relative pl-6 border-l-2 border-gray-200 pb-4">
                        <div class="absolute -left-[5px] top-1 w-2.5 h-2.5 bg-primary rounded-full"></div>
                        <p class="text-xs text-gray-400">${e.date.toDate().toLocaleDateString()}</p>
                        <h4 class="font-bold text-gray-800">${e.title}</h4>
                        <p class="text-sm text-gray-500 mt-1">${e.description}</p>
                        <button onclick="App.deleteItem('events', '${e.id}')" class="absolute right-0 top-0 text-gray-200 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `).join('');
            },

            renderReports: () => {
                if(State.chart) State.chart.destroy();
                const ctx = document.getElementById('expense-chart').getContext('2d');
                const catMap = {};
                State.data.transactions.filter(t => t.type === 'expense').forEach(t => {
                    catMap[t.category] = (catMap[t.category] || 0) + t.amount;
                });
                
                State.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(catMap),
                        datasets: [{ data: Object.values(catMap), backgroundColor: ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#EC4899', '#8B5CF6', '#6366F1'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }
        };

        // --- Global UI Helpers ---
        window.switchTab = (viewId, btn) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active', 'text-primary'));
            if(btn) btn.classList.add('active', 'text-primary');
            
            const titles = { accounting: '總覽', investment: '投資組合', debt: '負債管理', reports: '財務報表', events: '時間軸' };
            document.getElementById('page-title').innerText = titles[viewId];
            
            if(viewId === 'reports') App.renderReports();
        };

        window.openModal = (type) => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            let tplId = '';
            
            if(type === 'transaction-modal') tplId = 'tpl-transaction-form';
            else if(type === 'investment-modal') tplId = 'tpl-investment-form';
            else if(type === 'debt-modal') tplId = 'tpl-debt-form';
            else if(type === 'event-modal') tplId = 'tpl-event-form';

            if(!tplId) return;

            content.innerHTML = document.getElementById(tplId).innerHTML;
            
            // Post-render init
            if(type === 'transaction-modal') {
                const today = new Date().toISOString().split('T')[0];
                content.querySelector('input[name="date"]').value = today;
                renderDatalist(content.querySelector('#cat-list'), State.categories.expense);
            }
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        };
        
        window.openRepayModal = (id, name) => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.innerHTML = document.getElementById('tpl-repay-form').innerHTML;
            content.querySelector('#repay-id').value = id;
            content.querySelector('#repay-debt-name').innerText = name;
            content.querySelector('input[name="date"]').value = new Date().toISOString().split('T')[0];
            overlay.classList.remove('hidden'); overlay.classList.add('flex');
        };

        window.closeModal = () => {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('modal-overlay').classList.remove('flex');
        };

        window.toggleTxType = (type) => {
            document.getElementById('tx-type').value = type;
            const btnExp = document.getElementById('btn-expense');
            const btnInc = document.getElementById('btn-income');
            const datalist = document.getElementById('cat-list');

            if(type === 'expense') {
                btnExp.classList.add('bg-white', 'shadow', 'text-danger'); btnExp.classList.remove('text-gray-500');
                btnInc.classList.remove('bg-white', 'shadow', 'text-primary'); btnInc.classList.add('text-gray-500');
                renderDatalist(datalist, State.categories.expense);
            } else {
                btnInc.classList.add('bg-white', 'shadow', 'text-primary'); btnInc.classList.remove('text-gray-500');
                btnExp.classList.remove('bg-white', 'shadow', 'text-danger'); btnExp.classList.add('text-gray-500');
                renderDatalist(datalist, State.categories.income);
            }
        };

        function renderDatalist(el, items) { el.innerHTML = items.map(i => `<option value="${i}">`).join(''); }
        
        // Expose globals for HTML events
        window.loginGoogle = App.loginGoogle;
        window.loginAnon = App.loginAnon;
        window.logout = App.logout;
        window.App = App;

        App.init(); // Start
    </script>
</body>
</html>
