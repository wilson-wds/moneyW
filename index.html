<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>雲端記帳 Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        primary: '#6366f1', // Indigo-500
                        primaryDark: '#4338ca', // Indigo-700
                        secondary: '#10B981', 
                        danger: '#f43f5e', // Rose-500
                        warning: '#f59e0b', 
                        dark: '#1e293b',
                        surface: '#f8fafc'
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(99, 102, 241, 0.3)',
                        'inner-light': 'inset 0 2px 4px 0 rgba(255, 255, 255, 0.3)'
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.2s ease-out'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; font-family: 'Noto Sans TC', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.5); }
        .app-frame { max-width: 28rem; margin: 0 auto; background-color: #f8fafc; height: 100dvh; width: 100%; display: flex; flex-direction: column; box-shadow: 0 0 40px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        @media (min-width: 640px) { .app-frame { height: 95vh; margin-top: 2.5vh; border-radius: 2rem; border: 8px solid #fff; } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fab-btn { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); box-shadow: 0 8px 20px -4px rgba(99, 102, 241, 0.5); }
        .gradient-card { background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%); color: white; }
        .nav-item { position: relative; transition: all 0.2s; }
        .nav-item.active { color: #4f46e5; }
        .nav-item.active::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background-color: #4f46e5; border-radius: 50%; }
        .input-box { background: #f1f5f9; border: 1px solid transparent; transition: all 0.2s; }
        .input-box:focus { background: #fff; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
    </style>
</head>
<body class="text-slate-600 text-sm selection:bg-indigo-100 selection:text-indigo-700">

    <!-- Auth View -->
    <div id="login-view" class="fixed inset-0 z-50 bg-white flex flex-col justify-center items-center p-8 animate-fade-in max-w-md mx-auto h-full">
        <div class="mb-12 text-center w-full">
            <div class="w-full max-w-[320px] mx-auto mb-8">
                <img src="https://i.ibb.co/PvVffGgL/image.png" alt="App Logo" class="w-full h-auto object-contain drop-shadow-xl">
            </div>
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">雲端記帳 <span class="text-primary text-lg align-top">Lite</span></h1>
            <p class="text-slate-400 mt-3 text-sm font-medium">簡單、直覺的個人財務管家</p>
        </div>
        <div class="w-full space-y-3">
            <button onclick="App.loginGoogle()" class="w-full bg-white border border-slate-200 text-slate-700 py-3.5 rounded-2xl font-bold shadow-soft hover:bg-slate-50 flex items-center justify-center gap-3 transition-all active:scale-[0.98]">
                <i class="fa-brands fa-google text-red-500 text-lg"></i> 使用 Google 繼續
            </button>
            <button onclick="App.loginAnon()" class="w-full bg-slate-800 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-slate-200 hover:bg-slate-900 transition-all active:scale-[0.98]">
                訪客體驗
            </button>
        </div>
        <p class="absolute bottom-8 text-xs text-slate-300">Designed for Wilson</p>
    </div>

    <!-- Main App Frame -->
    <div id="app-container" class="hidden app-frame">
        <header class="bg-white/80 backdrop-blur-md sticky top-0 px-5 py-3 flex justify-between items-center z-20 shrink-0 border-b border-slate-100/50">
            <h1 class="font-bold text-slate-800 flex items-center gap-2.5 text-lg tracking-tight">
                <img id="header-icon" src="https://i.ibb.co/PvVffGgL/image.png" class="h-10 w-auto object-contain">
                <span id="page-title" class="hidden">總覽</span>
            </h1>
            <div class="flex items-center gap-4">
                <div id="user-info" class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-lg"></div>
                <button onclick="App.logout()" class="text-slate-400 hover:text-danger transition-colors p-1"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto hide-scrollbar relative pb-24 px-4 pt-4">
            <div id="view-accounting" class="view-section animate-fade-in space-y-4"></div>
            <div id="view-investment" class="view-section hidden animate-fade-in space-y-4"></div>
            <div id="view-debt" class="view-section hidden animate-fade-in space-y-4"></div>
            <div id="view-reports" class="view-section hidden animate-fade-in space-y-4"></div>
            <div id="view-events" class="view-section hidden animate-fade-in space-y-4"></div>
        </main>

        <nav class="absolute bottom-0 w-full glass pb-safe pt-2 px-1 flex justify-between items-center text-[10px] font-medium text-slate-400 z-30 shrink-0">
            <button id="nav-accounting" onclick="App.switchTab('accounting', this)" class="nav-item active flex flex-col items-center gap-1.5 p-2 min-w-[3rem]">
                <i class="fa-solid fa-house text-xl mb-0.5"></i> 記帳
            </button>
            <button onclick="App.switchTab('investment', this)" class="nav-item flex flex-col items-center gap-1.5 p-2 min-w-[3rem]">
                <i class="fa-solid fa-arrow-trend-up text-xl mb-0.5"></i> 投資
            </button>
            <button onclick="App.switchTab('debt', this)" class="nav-item flex flex-col items-center gap-1.5 p-2 min-w-[3rem]">
                <i class="fa-solid fa-file-invoice-dollar text-xl mb-0.5"></i> 負債
            </button>
            <div class="relative -top-8 mx-1">
                <button onclick="App.openModal('transaction-modal')" class="fab-btn w-12 h-12 rounded-full text-white text-xl flex items-center justify-center transition-transform hover:scale-105 active:scale-95">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
            <button onclick="App.switchTab('events', this)" class="nav-item flex flex-col items-center gap-1.5 p-2 min-w-[3rem]">
                <i class="fa-solid fa-calendar-day text-xl mb-0.5"></i> 大事
            </button>
            <button onclick="App.switchTab('reports', this)" class="nav-item flex flex-col items-center gap-1.5 p-2 min-w-[3rem]">
                <i class="fa-solid fa-chart-simple text-xl mb-0.5"></i> 報表
            </button>
        </nav>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/40 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[28rem] rounded-t-[2rem] sm:rounded-2xl p-6 shadow-2xl animate-slide-up sm:animate-fade-in max-h-[85vh] overflow-y-auto hide-scrollbar relative">
        </div>
    </div>
    <div id="sub-modal-overlay" class="fixed inset-0 bg-slate-900/30 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm transition-all">
        <div id="sub-modal-content" class="bg-white w-full max-w-[28rem] rounded-t-[2rem] sm:rounded-2xl p-6 shadow-2xl animate-slide-up max-h-[60vh] overflow-y-auto hide-scrollbar"></div>
    </div>

    <!-- TEMPLATES (Restored Logic) -->
    <template id="tpl-accounting">
        <div class="gradient-card rounded-3xl p-5 shadow-soft shadow-indigo-200 relative overflow-hidden mb-4">
            <div class="relative z-10">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-indigo-100 text-xs font-medium tracking-wide bg-white/10 px-2 py-1 rounded-lg">本月概況</span>
                    <input type="month" id="date-filter" class="bg-white/20 text-white border-none rounded-lg px-3 py-1 text-xs font-bold focus:ring-0 cursor-pointer appearance-none" onchange="App.renderTransactions()">
                </div>
                <div class="flex flex-col items-center mb-6">
                      <span class="text-indigo-100 text-xs mb-1">本月結餘</span>
                      <span id="monthly-balance" class="text-4xl font-bold tracking-tight text-white">0</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10">
                        <p class="text-[10px] opacity-80 mb-1">總收入</p>
                        <p id="monthly-income" class="text-lg font-bold">0</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10">
                        <p class="text-[10px] opacity-80 mb-1">總支出</p>
                        <p id="monthly-expense" class="text-lg font-bold">0</p>
                    </div>
                </div>
            </div>
        </div>
        <ul id="tx-list" class="space-y-4 pb-6"></ul>
        <div class="mt-8 pb-4">
            <div class="flex justify-between items-center px-1 mb-3">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">預算 / 排程</span>
                <button onclick="App.openBudgetModal('accounting')" class="text-primary text-[10px] font-bold bg-indigo-50 px-2 py-1 rounded-lg"><i class="fa-solid fa-plus"></i> 新增</button>
            </div>
            <ul id="accounting-budget-list" class="space-y-2"></ul>
        </div>
    </template>

    <template id="tpl-investment">
        <div class="flex justify-between items-center mb-2 px-1">
            <h3 class="text-lg font-bold text-slate-700">投資組合</h3>
            <input type="month" id="inv-date-filter" class="bg-white border-none rounded-lg px-2 py-1.5 text-xs font-bold text-slate-600 shadow-sm" onchange="App.renderInvestments()">
        </div>
        <div class="bg-dark text-white rounded-3xl p-5 shadow-lg relative overflow-hidden mb-4">
            <p class="text-slate-400 text-xs font-medium mb-1">總資產現值</p>
            <h2 id="inv-total-val" class="text-3xl font-bold tracking-tight mb-4 text-white">--</h2>
            <div class="flex gap-8 border-t border-white/10 pt-4">
                <div><span class="text-slate-400 text-[10px] block mb-0.5">總損益</span><span id="inv-total-ret" class="font-bold text-base">--</span></div>
                <div><span class="text-slate-400 text-[10px] block mb-0.5">報酬率</span><span id="inv-roi" class="font-bold text-base">--</span></div>
            </div>
        </div>
        <div class="flex justify-between items-center mb-3">
             <div class="bg-white p-1 rounded-xl shadow-sm inline-flex">
                <button class="tab-pill px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500 active bg-indigo-50 text-primary" onclick="App.switchInvTab('active', this)">進行中</button>
                <button class="tab-pill px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500" onclick="App.switchInvTab('archived', this)">已結案</button>
            </div>
            <button onclick="App.openModal('investment-modal')" class="text-primary text-xs font-bold bg-indigo-50 px-3 py-2 rounded-xl"><i class="fa-solid fa-plus"></i> 新增</button>
        </div>
        <div id="inv-list" class="grid gap-3"></div>
        <div class="mt-6">
            <div class="flex justify-between items-center px-1 mb-3">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">定期定額 / 目標</span>
                <button onclick="App.openBudgetModal('investment')" class="text-secondary text-[10px] font-bold bg-emerald-50 px-2 py-1 rounded-lg"><i class="fa-solid fa-plus"></i> 新增</button>
            </div>
            <ul id="inv-budget-list" class="space-y-2"></ul>
        </div>
    </template>

    <template id="tpl-debt">
         <div class="flex justify-between items-center mb-2 px-1">
            <h3 class="text-lg font-bold text-slate-700">負債管理</h3>
            <input type="month" id="debt-date-filter" class="bg-white border-none rounded-lg px-2 py-1.5 text-xs font-bold text-slate-600 shadow-sm" onchange="App.renderDebts()">
        </div>
        <div class="bg-white p-5 rounded-3xl shadow-soft border-l-4 border-warning mb-4">
            <div class="flex justify-between items-end mb-4">
                <div><p class="text-xs text-slate-400 mb-1">剩餘總負債</p><p id="debt-total-remaining" class="text-3xl font-bold text-slate-800">--</p></div>
                <div class="text-right"><p class="text-[10px] text-slate-400 mb-1">還款進度</p><p id="debt-progress-text" class="text-xl font-bold text-warning">0%</p></div>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                <div id="debt-progress-bar" class="bg-warning h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
        </div>
        <div id="debt-list" class="space-y-3"></div>
        <div class="mt-6">
            <div class="flex justify-between items-center px-1 mb-3">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">還款計畫</span>
                <button onclick="App.openBudgetModal('debt')" class="text-danger text-[10px] font-bold bg-rose-50 px-2 py-1 rounded-lg"><i class="fa-solid fa-plus"></i> 新增</button>
            </div>
            <ul id="debt-budget-list" class="space-y-2"></ul>
        </div>
    </template>

    <template id="tpl-reports">
        <div class="bg-white p-4 rounded-2xl shadow-soft mb-4 flex gap-3">
            <select id="report-year" class="flex-1 bg-slate-50 rounded-xl px-3 py-2 text-xs font-bold appearance-none outline-none" onchange="App.renderReports()"></select>
            <select id="report-month-select" class="flex-1 bg-slate-50 rounded-xl px-3 py-2 text-xs font-bold appearance-none outline-none" onchange="App.renderReports()">
                <option value="all">全年度</option>
                <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option><option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
                <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option><option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
            </select>
        </div>
        <div class="bg-white p-5 rounded-3xl shadow-soft mb-4">
            <h3 class="font-bold mb-6 text-center text-xs text-slate-400 uppercase tracking-widest">支出分佈</h3>
            <div class="h-56 relative"><canvas id="expense-chart"></canvas></div>
        </div>
        <div class="bg-white p-5 rounded-3xl shadow-soft mt-4 mb-20">
            <ul id="report-stats" class="space-y-3 text-xs mb-6 bg-slate-50 p-3 rounded-xl"></ul>
            <ul id="report-details" class="space-y-3"></ul>
        </div>
    </template>
    
    <template id="tpl-events">
        <div class="flex justify-center mb-6">
            <button onclick="App.openModal('event-modal')" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold hover:bg-slate-50 transition text-xs">紀錄生活大事</button>
        </div>
        <div id="event-list" class="space-y-6 relative">
            <div class="absolute left-[19px] top-0 bottom-0 w-0.5 bg-slate-200"></div>
        </div>
    </template>

    <!-- Modal Templates -->
    <template id="tpl-transaction-modal">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-slate-800">記一筆</h3>
            <div class="flex items-center gap-2">
                 <button type="button" id="btn-delete-tx" class="hidden w-8 h-8 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center"><i class="fa-solid fa-trash-can text-xs"></i></button>
                 <button type="button" onclick="App.closeModal()" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        <form onsubmit="App.handleSaveTransaction(event)" class="space-y-5">
            <input type="hidden" name="id">
            <div class="flex bg-slate-100 p-1.5 rounded-2xl relative">
                <button type="button" class="type-btn flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-500 transition-all z-10" onclick="App.toggleTxType('expense')" id="btn-expense">支出</button>
                <button type="button" class="type-btn flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-500 transition-all z-10" onclick="App.toggleTxType('income')" id="btn-income">收入</button>
            </div>
            <input type="hidden" name="type" id="tx-type" value="expense">
            <div class="text-center py-2">
                <input type="number" name="amount" class="w-full text-4xl font-bold text-slate-800 border-none bg-transparent text-center focus:outline-none placeholder-slate-200" placeholder="0" required inputmode="decimal">
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">日期</label><input type="date" name="date" class="input-box w-full rounded-xl px-4 py-3 text-sm font-medium text-slate-700" required></div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 mb-1 block">分類</label>
                        <div class="flex gap-2"><input name="category" class="input-box w-full rounded-xl px-4 py-3 text-sm font-medium text-slate-700" placeholder="分類..." required><button type="button" onclick="App.openCategorySelector()" class="w-12 h-11 bg-indigo-50 rounded-xl flex items-center justify-center text-primary shrink-0"><i class="fa-solid fa-list-ul"></i></button></div>
                    </div>
                </div>
                <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">專案 / 帳戶</label><input type="text" name="project" class="input-box w-full rounded-xl px-4 py-3 text-sm font-medium text-slate-700" placeholder="例如: 投資帳戶, 房貸..."></div>
                <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">備註</label><input type="text" name="remarks" class="input-box w-full rounded-xl px-4 py-3 text-sm font-medium text-slate-700" placeholder="寫點什麼..."></div>
            </div>
            <button type="submit" class="w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg text-sm active:scale-[0.98] transition">儲存紀錄</button>
        </form>
    </template>

    <template id="tpl-budget-form">
        <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">設定計畫</h3><button type="button" onclick="App.closeModal()" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveBudget(event)" class="space-y-5">
            <input type="hidden" name="id"><input type="hidden" name="context" id="budget-context">
            <div>
                <label class="text-[10px] font-bold text-slate-400 mb-1 block">目標項目</label>
                <div id="target-select-container"><select name="targetId_select" id="budget-target-select" class="input-box w-full rounded-xl p-3 text-sm"></select></div>
                <div id="target-input-container" class="hidden"><input type="text" name="targetId_input" class="input-box w-full rounded-xl p-3 text-sm" placeholder="輸入名稱或分類..."></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">金額</label><input type="number" name="amount" class="input-box w-full rounded-xl p-3 text-sm" placeholder="0" required></div>
                <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">預計日期</label><input type="date" name="date" class="input-box w-full rounded-xl p-3 text-sm" required></div>
            </div>
            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">說明</label><input type="text" name="desc" class="input-box w-full rounded-xl p-3 text-sm" placeholder="例如: 每月扣款" required></div>
            <button type="submit" class="w-full bg-primary text-white py-3.5 rounded-2xl font-bold shadow-lg text-sm active:scale-[0.98] transition">設定計畫</button>
        </form>
    </template>

    <template id="tpl-details-modal">
        <div class="sticky top-0 bg-white z-10 pb-4 border-b border-slate-50 mb-4 flex justify-between items-center">
            <h3 class="text-lg font-bold text-slate-800 details-title truncate pr-4"></h3>
            <button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 flex-shrink-0"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="max-h-[60vh] overflow-y-auto hide-scrollbar"><ul class="details-list space-y-3"></ul></div>
        <div class="details-actions mt-4 pt-4 border-t border-slate-100 flex flex-col gap-2"></div>
    </template>

    <template id="tpl-investment-modal">
        <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">投資帳戶</h3><button type="button" onclick="App.closeModal()" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveInvestment(event)" class="space-y-5">
            <input type="hidden" name="id">
            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">帳戶名稱</label><input type="text" name="name" class="input-box w-full rounded-xl p-3 text-sm" required></div>
            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">初始投入成本</label><input type="number" name="initial" class="input-box w-full rounded-xl p-3 text-sm" placeholder="0"></div>
            <div class="flex items-center gap-2"><input type="checkbox" name="isArchived" id="inv-archived" class="w-4 h-4"><label for="inv-archived" class="text-xs">已結案 (歸檔)</label></div>
            <button type="submit" class="w-full bg-primary text-white font-bold py-3.5 rounded-2xl shadow-lg active:scale-[0.98]">儲存帳戶</button>
        </form>
    </template>

    <template id="tpl-debt-modal">
        <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">負債項目</h3><button type="button" onclick="App.closeModal()" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveDebt(event)" class="space-y-5">
            <input type="hidden" name="id">
            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">名稱</label><input type="text" name="name" class="input-box w-full rounded-xl p-3 text-sm" required></div>
            <div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] font-bold text-slate-400 mb-1 block">總金額</label><input type="number" name="total" class="input-box w-full rounded-xl p-3 text-sm" required></div><div><label class="text-[10px] font-bold text-slate-400 mb-1 block">剩餘金額</label><input type="number" name="remaining" class="input-box w-full rounded-xl p-3 text-sm"></div></div>
            <button type="submit" class="w-full bg-warning text-white font-bold py-3.5 rounded-2xl shadow-lg active:scale-[0.98]">儲存項目</button>
        </form>
    </template>

    <template id="tpl-event-modal">
        <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">生活大事</h3><button type="button" onclick="App.closeModal()" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveEvent(event)" class="space-y-5">
            <input type="hidden" name="id">
            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">日期</label><input type="date" name="date" class="input-box w-full rounded-xl p-3 text-sm" required></div>
            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">標題</label><input type="text" name="title" class="input-box w-full rounded-xl p-3 text-sm font-bold" required></div>
            <div><label class="text-[10px] font-bold text-slate-400 mb-1 block">詳細內容</label><textarea name="desc" rows="4" class="input-box w-full rounded-xl p-3 text-sm"></textarea></div>
            <button type="submit" class="w-full bg-dark text-white py-4 rounded-2xl font-bold shadow-lg active:scale-[0.98]">紀錄下來</button>
        </form>
    </template>

    <template id="tpl-category-selector">
        <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-slate-800">選擇分類</h3><button onclick="App.closeSubModal()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200"><i class="fa-solid fa-xmark"></i></button></div>
        <div id="category-chips" class="flex flex-wrap gap-2 pb-4"></div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, updateDoc, increment, Timestamp, writeBatch, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Restore Original Wilson's Firebase Config
        const app = initializeApp({ 
            apiKey: "AIzaSyAqFHm6Bn35m8xauc50ZvNNy_rxIZzCMTE", 
            authDomain: "moneyw-f8105.firebaseapp.com", 
            projectId: "moneyw-f8105", 
            storageBucket: "moneyw-f8105.appspot.com", 
            messagingSenderId: "155586195799", 
            appId: "1:155586195799:web:302184fbf613f032a88e12" 
        });
        const auth = getAuth(app);
        const db = getFirestore(app);

        const State = { user: null, data: { transactions: [], debts: [], investments: [], events: [], investmentBudgets: [], debtBudgets: [], accountingBudgets: [], legacyTxs: {} }, listeners: [], chart: null, categories: { expense: ['飲食', '交通', '居住', '娛樂', '購物', '醫療', '教育', '投資', '其他'], income: ['薪資', '獎金', '投資', '兼職', '其他'] }, view: { invTab: 'active', currentTab: 'accounting' } };

        const getTxDate = (tx) => { if (!tx) return new Date(); try { if (tx.timestamp && typeof tx.timestamp.toDate === 'function') return tx.timestamp.toDate(); if (tx.date) { if (typeof tx.date.toDate === 'function') return tx.date.toDate(); const d = new Date(tx.date); if (!isNaN(d.getTime())) return d; } if (tx.timestamp && tx.timestamp.seconds) return new Date(tx.timestamp.seconds * 1000); } catch (e) {} return new Date(); };
        const toDateStr = (dateObj) => { if(!dateObj) return ''; const d = (dateObj instanceof Date) ? dateObj : getTxDate({timestamp: dateObj}); return d.toISOString().split('T')[0]; };

        const App = {
            init: () => onAuthStateChanged(auth, u => {
                State.user = u;
                document.getElementById('login-view').classList.toggle('hidden', !!u);
                document.getElementById('app-container').classList.toggle('hidden', !u);
                if(u) {
                    document.getElementById('user-info').innerText = u.displayName || u.email || '使用者';
                    App.switchTab('accounting', document.querySelector('#nav-accounting'));
                    App.startListeners(u.uid);
                } else App.stopListeners();
            }),
            startListeners: (uid) => {
                App.stopListeners();
                const listen = (c, k) => State.listeners.push(onSnapshot(query(collection(db, `users/${uid}/${c}`)), s => { State.data[k] = s.docs.map(d=>({id:d.id, ...d.data()})); App.refreshCurrentView(); }));
                listen('transactions', 'transactions'); listen('debts', 'debts'); listen('events', 'events'); listen('investmentBudgets', 'investmentBudgets'); listen('debtBudgets', 'debtBudgets'); listen('accountingBudgets', 'accountingBudgets'); listen('investments', 'investments');
            },
            stopListeners: () => { State.listeners.forEach(u=>u()); State.listeners=[]; },
            loginGoogle: () => signInWithPopup(auth, new GoogleAuthProvider()),
            loginAnon: () => signInAnonymously(auth),
            logout: () => signOut(auth),
            refreshCurrentView: () => {
                const tab = State.view.currentTab;
                if (tab === 'accounting' && document.getElementById('tx-list')) { App.renderTransactions(); App.updateDashboard(); App.renderAccountingBudgets(); }
                else if (tab === 'investment' && document.getElementById('inv-list')) App.renderInvestments();
                else if (tab === 'debt' && document.getElementById('debt-list')) App.renderDebts();
                else if (tab === 'reports' && document.getElementById('report-stats')) App.renderReports();
                else if (tab === 'events' && document.getElementById('event-list')) App.renderEvents();
            },
            switchTab: (tab, btn) => {
                State.view.currentTab = tab;
                document.querySelectorAll('.view-section').forEach(e => { e.classList.add('hidden'); e.innerHTML = ''; }); 
                const target = document.getElementById(`view-${tab}`); target.classList.remove('hidden'); target.innerHTML = document.getElementById(`tpl-${tab}`).innerHTML; 
                if(tab === 'accounting') document.getElementById('date-filter').value = new Date().toISOString().slice(0, 7);
                else if(tab === 'investment') document.getElementById('inv-date-filter').value = new Date().toISOString().slice(0, 7);
                else if(tab === 'debt') document.getElementById('debt-date-filter').value = new Date().toISOString().slice(0, 7);
                else if(tab === 'reports') { const yrSel = document.getElementById('report-year'); const curYr = new Date().getFullYear(); yrSel.innerHTML = ''; for(let y=curYr-2; y<=curYr+1; y++) yrSel.innerHTML += `<option value="${y}" ${y===curYr?'selected':''}>${y}年</option>`; document.getElementById('report-month-select').value = (new Date().getMonth()+1).toString(); }
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); if(btn) btn.classList.add('active');
                document.getElementById('page-title').innerText = {accounting:'總覽', investment:'投資組合', debt:'負債管理', reports:'分析報表', events:'生活大事'}[tab];
                App.refreshCurrentView();
            },
            renderTransactions: () => {
                const list = document.getElementById('tx-list'); if(!list) return;
                const [y, m] = document.getElementById('date-filter').value.split('-').map(Number);
                const txs = State.data.transactions.filter(t => { const d = getTxDate(t); return d.getFullYear()===y && d.getMonth()+1===m; }).sort((a,b)=>getTxDate(b)-getTxDate(a));
                const grouped = {}; txs.forEach(t=>{ const k=getTxDate(t).toLocaleDateString('zh-TW',{month:'numeric',day:'numeric',weekday:'short'}); if(!grouped[k])grouped[k]={list:[],inc:0,exp:0}; grouped[k].list.push(t); t.type==='income'?grouped[k].inc+=t.amount:grouped[k].exp+=t.amount; });
                list.innerHTML = Object.entries(grouped).map(([k,v])=>`<div class="mb-4 animate-fade-in"><div class="flex justify-between text-xs font-bold text-slate-400 mb-2 px-2"><span>${k}</span><div class="flex gap-2"><span class="text-emerald-500">+${v.inc.toLocaleString()}</span><span class="text-rose-400">-${v.exp.toLocaleString()}</span></div></div><div class="bg-white rounded-2xl shadow-soft overflow-hidden">${v.list.map(t=>`<div class="flex justify-between items-center py-3.5 px-4 border-b border-slate-50 last:border-0" onclick="App.openModal('transaction-modal','${t.id}')"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-xl flex items-center justify-center font-bold ${t.type==='expense'?'bg-rose-50 text-rose-500':'bg-emerald-50 text-emerald-500'}">${(t.category||'未')[0]}</div><div><p class="font-bold text-slate-700 text-sm">${t.category||'未分類'}</p><p class="text-[10px] text-slate-400">${t.remarks||''}</p></div></div><span class="font-bold text-sm ${t.type==='expense'?'text-rose-500':'text-emerald-500'}">${t.type==='expense'?'-':'+'} ${t.amount.toLocaleString()}</span></div>`).join('')}</div></div>`).join('') || '<p class="text-center py-10 text-slate-300">本月尚無紀錄</p>';
            },
            renderAccountingBudgets: () => {
                const list = document.getElementById('accounting-budget-list'); if(!list) return;
                const todayStr = toDateStr(new Date());
                list.innerHTML = State.data.accountingBudgets.filter(b=>!b.isRealized).sort((a,b)=>(a.expectedDate?.seconds||0)-(b.expectedDate?.seconds||0)).map(b => {
                    const isToday = toDateStr(b.expectedDate) === todayStr;
                    const isPast = b.expectedDate?.toDate() < new Date().setHours(0,0,0,0);
                    const bgClass = isPast ? 'bg-rose-50 border-rose-100' : isToday ? 'bg-amber-50 border-amber-100' : 'bg-white border-slate-50';
                    const hint = isToday ? '<i class="fa-solid fa-bell text-warning animate-pulse ml-1"></i>' : '';
                    return `<li class="flex justify-between items-center p-3 rounded-xl border shadow-soft mb-2 ${bgClass}"><div class="flex items-center gap-3"><div class="w-1 ${b.type==='expense'?'bg-rose-500':'bg-emerald-500'} h-8 rounded-full"></div><div><span class="font-bold text-slate-700 text-xs block">${b.targetId || '一般'}${hint}</span><div class="flex gap-2 text-[10px] text-slate-400"><span>${toDateStr(b.expectedDate)}</span><span>${b.description}</span><span class="font-bold ${b.type==='expense'?'text-rose-500':'text-emerald-500'}">$${b.amount.toLocaleString()}</span></div></div></div><div class="flex gap-1"><button onclick="App.realizeBudget('accounting','${b.id}')" class="w-7 h-7 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center"><i class="fa-solid fa-check text-[10px]"></i></button><button onclick="App.deleteItem('accountingBudgets','${b.id}')" class="w-7 h-7 rounded-full bg-rose-50 text-rose-400 flex items-center justify-center"><i class="fa-solid fa-trash text-[10px]"></i></button></div></li>`;
                }).join('') || '<p class="text-center py-4 text-xs text-slate-300">尚無預算項目</p>';
            },
            renderInvestments: () => {
                const list = document.getElementById('inv-list'); if(!list) return;
                const todayStr = toDateStr(new Date());
                const activeInvs = State.data.investments.filter(i => State.view.invTab === 'active' ? !i.isArchived : i.isArchived);
                list.innerHTML = activeInvs.map(i => {
                    const txs = State.data.transactions.filter(t => t.project === i.name);
                    const profit = txs.reduce((s,t) => s + (t.type==='income' ? t.amount : -t.amount), 0);
                    return `<div class="bg-white p-4 rounded-2xl shadow-soft border border-slate-50" onclick="App.showDetails('investment','${i.id}')"><div class="flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-indigo-50 text-primary flex items-center justify-center font-bold">${i.name[0]}</div><div><h4 class="font-bold text-slate-800 text-sm">${i.name}</h4><p class="text-[10px] text-slate-400">累計收益: ${profit.toLocaleString()}</p></div></div><div class="text-right"><p class="font-bold text-slate-800">$${(i.marketValue||0).toLocaleString()}</p></div></div></div>`;
                }).join('') || '<p class="text-center py-10 text-xs text-slate-300">尚無帳戶</p>';

                document.getElementById('inv-budget-list').innerHTML = State.data.investmentBudgets.filter(b=>!b.isRealized).sort((a,b)=>(a.expectedDate?.seconds||0)-(b.expectedDate?.seconds||0)).map(b => {
                    const isToday = toDateStr(b.expectedDate) === todayStr;
                    const isPast = b.expectedDate?.toDate() < new Date().setHours(0,0,0,0);
                    const bgClass = isPast ? 'bg-rose-50 border-rose-100' : isToday ? 'bg-amber-50 border-amber-100' : 'bg-white border-slate-50';
                    const hint = isToday ? '<i class="fa-solid fa-bell text-warning animate-pulse ml-1"></i>' : '';
                    const name = State.data.investments.find(i=>i.id===b.targetId)?.name || '未知';
                    return `<li class="flex justify-between items-center p-3 rounded-xl border shadow-soft mb-2 ${bgClass}"><div class="flex items-center gap-3"><div class="w-1 ${b.type==='expense'?'bg-rose-500':'bg-emerald-500'} h-8 rounded-full"></div><div><span class="font-bold text-slate-700 text-xs block">${name}${hint}</span><div class="flex gap-2 text-[10px] text-slate-400"><span>${toDateStr(b.expectedDate)}</span><span>$${b.amount.toLocaleString()}</span></div></div></div><div class="flex gap-1"><button onclick="App.realizeBudget('investment','${b.id}')" class="w-7 h-7 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center"><i class="fa-solid fa-check text-[10px]"></i></button><button onclick="App.deleteItem('investmentBudgets','${b.id}')" class="w-7 h-7 rounded-full bg-rose-50 text-rose-400 flex items-center justify-center"><i class="fa-solid fa-trash text-[10px]"></i></button></div></li>`;
                }).join('') || '<p class="text-center py-4 text-xs text-slate-300">無預算</p>';
                
                const tv = activeInvs.reduce((s,i)=>s+(i.marketValue||0),0);
                document.getElementById('inv-total-val').innerText = `$${tv.toLocaleString()}`;
            },
            renderDebts: () => {
                const list = document.getElementById('debt-list'); if(!list) return;
                const todayStr = toDateStr(new Date());
                list.innerHTML = State.data.debts.map(d => {
                    const p = Math.round(((d.totalAmount - d.remainingAmount) / d.totalAmount) * 100);
                    return `<div class="bg-white p-4 rounded-2xl shadow-soft mb-3" onclick="App.showDetails('debt','${d.id}')"><div class="flex justify-between mb-2"><span class="font-bold text-slate-700">${d.name}</span><span class="text-xs font-bold text-warning">${p}%</span></div><div class="w-full bg-slate-100 rounded-full h-1.5 mb-2"><div class="bg-warning h-1.5 rounded-full" style="width:${p}%"></div></div><div class="text-xs text-slate-400 text-right">剩餘 $${d.remainingAmount.toLocaleString()}</div></div>`;
                }).join('') || '<p class="text-center py-10 text-xs text-slate-300">無負債紀錄</p>';

                document.getElementById('debt-budget-list').innerHTML = State.data.debtBudgets.filter(b=>!b.isRealized).sort((a,b)=>(a.expectedDate?.seconds||0)-(b.expectedDate?.seconds||0)).map(b => {
                    const isToday = toDateStr(b.expectedDate) === todayStr;
                    const isPast = b.expectedDate?.toDate() < new Date().setHours(0,0,0,0);
                    const bgClass = isPast ? 'bg-rose-50 border-rose-100' : isToday ? 'bg-amber-50 border-amber-100' : 'bg-white border-slate-50';
                    const hint = isToday ? '<i class="fa-solid fa-bell text-warning animate-pulse ml-1"></i>' : '';
                    const name = State.data.debts.find(d=>d.id===b.targetId)?.name || '未知';
                    return `<li class="flex justify-between items-center p-3 rounded-xl border shadow-soft mb-2 ${bgClass}"><div class="flex items-center gap-3"><div><span class="font-bold text-xs">${name}${hint}</span><p class="text-[10px] text-slate-400">${toDateStr(b.expectedDate)} 還款 $${b.amount.toLocaleString()}</p></div></div><button onclick="App.realizeBudget('debt','${b.id}')" class="w-7 h-7 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-check text-[10px]"></i></button></li>`;
                }).join('') || '<p class="text-center py-4 text-xs text-slate-300">無計畫</p>';
                
                const tr = State.data.debts.reduce((s,d)=>s+d.remainingAmount, 0);
                document.getElementById('debt-total-remaining').innerText = `$${tr.toLocaleString()}`;
            },
            renderReports: () => {
                const yrSel = document.getElementById('report-year'); if(!yrSel) return;
                const txs = State.data.transactions;
                const yr = parseInt(yrSel.value), mnVal = document.getElementById('report-month-select').value;
                const filtered = txs.filter(t => { const d = getTxDate(t); return d.getFullYear()===yr && (mnVal==='all'||d.getMonth()+1===parseInt(mnVal)); });
                const map = {}; filtered.filter(t=>t.type==='expense').forEach(t=>{ const c=t.category||'其他'; map[c]=(map[c]||0)+t.amount; });
                if (State.chart) State.chart.destroy();
                State.chart = new Chart(document.getElementById('expense-chart').getContext('2d'), { type:'doughnut', data:{ labels:Object.keys(map), datasets:[{data:Object.values(map), backgroundColor:['#6366f1','#f43f5e','#f59e0b','#10b981','#3b82f6']}] }, options:{plugins:{legend:{display:false}}} });
                document.getElementById('report-stats').innerHTML = Object.entries(map).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<li class="flex justify-between"><span>${k}</span><span class="font-bold">$${v.toLocaleString()}</span></li>`).join('');
                document.getElementById('report-details').innerHTML = filtered.map(t=>`<li class="flex justify-between text-xs py-2 border-b"><span>${toDateStr(t.timestamp)} ${t.category}</span><span class="${t.type==='expense'?'text-rose-500':'text-emerald-500'}">${t.amount.toLocaleString()}</span></li>`).join('');
            },
            renderEvents: () => {
                const list = document.getElementById('event-list'); if(!list) return;
                list.innerHTML = `<div class="absolute left-[19px] top-0 bottom-0 w-0.5 bg-slate-100"></div>` + State.data.events.sort((a,b)=>getTxDate(b)-getTxDate(a)).map(e => `<div class="relative pl-8 mb-6"><div class="absolute left-3 top-1.5 w-4 h-4 rounded-full border-4 border-white bg-indigo-300"></div><div class="bg-white p-4 rounded-2xl shadow-soft" onclick="App.openModal('event-modal','${e.id}')"><p class="text-[10px] font-bold text-primary mb-1">${toDateStr(e.date)}</p><h4 class="font-bold text-slate-800 text-sm">${e.title}</h4><p class="text-xs text-slate-500 mt-1">${e.description||''}</p></div></div>`).join('');
            },
            showDetails: async (type, id) => {
                const item = State.data[type + 's'].find(i => i.id === id); if(!item) return;
                const c = document.getElementById('modal-content'); c.innerHTML = document.getElementById('tpl-details-modal').innerHTML;
                c.querySelector('.details-title').innerText = item.name;
                const txs = State.data.transactions.filter(t => t.project === item.name);
                c.querySelector('.details-list').innerHTML = txs.map(t => `<li class="flex justify-between text-xs py-2 border-b"><span>${toDateStr(t.timestamp)} ${t.remarks||t.category}</span><span class="font-bold ${t.type==='expense'?'text-rose-500':'text-emerald-500'}">${t.type==='expense'?'-':'+'}${t.amount.toLocaleString()}</span></li>`).join('') || '<p class="text-center py-4 text-slate-300">無歷史紀錄</p>';
                const btn = document.createElement('button'); btn.className="w-full bg-primary text-white py-3 rounded-xl font-bold mt-4 shadow-lg"; btn.innerText="編輯項目"; btn.onclick=()=>App.openModal(type+'-modal', id);
                c.querySelector('.details-actions').appendChild(btn);
                document.getElementById('modal-overlay').classList.remove('hidden'); document.getElementById('modal-overlay').classList.add('flex');
            },
            handleSaveTransaction: async (e) => { e.preventDefault(); const f=e.target, uid=State.user.uid, id=f.id.value; const d = { type: f.type.value, amount: parseFloat(f.amount.value), category: f.category.value, remarks: f.remarks.value, timestamp: Timestamp.fromDate(new Date(f.date.value + 'T12:00:00')), project: f.project.value }; id ? await updateDoc(doc(db, `users/${uid}/transactions`, id), d) : await addDoc(collection(db, `users/${uid}/transactions`), d); App.closeModal(); },
            handleSaveBudget: async (e) => { e.preventDefault(); const f=e.target, ctx=f.context.value; let col = ctx==='investment'?'investmentBudgets':ctx==='debt'?'debtBudgets':'accountingBudgets'; const d = { targetId: ctx==='accounting'?f.targetId_input.value:f.targetId_select.value, amount:parseFloat(f.amount.value), expectedDate:Timestamp.fromDate(new Date(f.date.value)), description:f.desc.value, type: 'expense', isRealized: false, createdAt: Timestamp.now() }; f.id.value ? await updateDoc(doc(db, `users/${State.user.uid}/${col}`, f.id.value), d) : await addDoc(collection(db, `users/${State.user.uid}/${col}`), d); App.closeModal(); },
            handleSaveInvestment: async (e) => { e.preventDefault(); const f=e.target; const d={name:f.name.value, initialValue:parseFloat(f.initial.value)||0, marketValue:parseFloat(f.initial.value)||0, isArchived:f.isArchived.checked, createdAt:Timestamp.now()}; f.id.value ? await updateDoc(doc(db, `users/${State.user.uid}/investments`, f.id.value), d) : await addDoc(collection(db, `users/${State.user.uid}/investments`), d); App.closeModal(); },
            handleSaveDebt: async (e) => { e.preventDefault(); const f=e.target; const d={name:f.name.value, totalAmount:parseFloat(f.total.value), remainingAmount:parseFloat(f.remaining.value)||parseFloat(f.total.value), createdAt:Timestamp.now()}; f.id.value ? await updateDoc(doc(db, `users/${State.user.uid}/debts`, f.id.value), d) : await addDoc(collection(db, `users/${State.user.uid}/debts`), d); App.closeModal(); },
            handleSaveEvent: async (e) => { e.preventDefault(); const f=e.target; const d={title:f.title.value, description:f.desc.value, date:Timestamp.fromDate(new Date(f.date.value))}; f.id.value ? await updateDoc(doc(db, `users/${State.user.uid}/events`, f.id.value), d) : await addDoc(collection(db, `users/${State.user.uid}/events`), d); App.closeModal(); },
            realizeBudget: async(ctx, id) => { if(!confirm("執行此預算項目?"))return; let col=ctx==='investment'?'investmentBudgets':ctx==='debt'?'debtBudgets':'accountingBudgets'; const b=State.data[col].find(i=>i.id===id); const batch=writeBatch(db); batch.update(doc(db, `users/${State.user.uid}/${col}`, id),{isRealized:true}); batch.set(doc(collection(db, `users/${State.user.uid}/transactions`)),{type:b.type||'expense',amount:b.amount,category:ctx==='investment'?'投資':ctx==='debt'?'負債還款':b.targetId,remarks:`預算執行: ${b.description}`,timestamp:Timestamp.now()}); await batch.commit(); },
            deleteItem: async (c, id) => { if(confirm('確定刪除？')) await deleteDoc(doc(db, `users/${State.user.uid}/${c}`, id)); },
            openModal: (t, id) => {
                const c = document.getElementById('modal-content'); c.innerHTML = document.getElementById(`tpl-${t}`).innerHTML;
                if(id) {
                    let item = [...State.data.transactions, ...State.data.investments, ...State.data.debts, ...State.data.events].find(i=>i.id===id);
                    if(item) {
                        c.querySelector('[name=id]').value = id;
                        if(t==='transaction-modal') { c.querySelector('[name=amount]').value = item.amount; c.querySelector('[name=date]').value = toDateStr(getTxDate(item)); c.querySelector('[name=category]').value = item.category; c.querySelector('[name=remarks]').value = item.remarks; c.querySelector('[name=project]').value = item.project || ''; App.toggleTxType(item.type); c.querySelector('#btn-delete-tx').classList.remove('hidden'); c.querySelector('#btn-delete-tx').onclick=()=>App.deleteItem('transactions',id); }
                        else if(t==='investment-modal') { c.querySelector('[name=name]').value = item.name; c.querySelector('[name=initial]').value = item.initialValue; c.querySelector('[name=isArchived]').checked = item.isArchived; }
                        else if(t==='debt-modal') { c.querySelector('[name=name]').value = item.name; c.querySelector('[name=total]').value = item.totalAmount; c.querySelector('[name=remaining]').value = item.remainingAmount; }
                        else if(t==='event-modal') { c.querySelector('[name=title]').value = item.title; c.querySelector('[name=desc]').value = item.description; c.querySelector('[name=date]').value = toDateStr(getTxDate(item)); }
                    }
                } else if(c.querySelector('[name=date]')) c.querySelector('[name=date]').value = toDateStr(new Date());
                document.getElementById('modal-overlay').classList.remove('hidden'); document.getElementById('modal-overlay').classList.add('flex');
            },
            closeModal: () => document.getElementById('modal-overlay').classList.add('hidden'),
            openBudgetModal: (ctx) => {
                const c = document.getElementById('modal-content'); c.innerHTML = document.getElementById('tpl-budget-form').innerHTML;
                c.querySelector('#budget-context').value = ctx;
                const sel = c.querySelector('#budget-target-select'), inp = c.querySelector('#target-input-container');
                if(ctx==='accounting'){ sel.parentElement.classList.add('hidden'); inp.classList.remove('hidden'); }
                else if(ctx==='investment') State.data.investments.forEach(i=>sel.innerHTML+=`<option value="${i.id}">${i.name}</option>`);
                else if(ctx==='debt') State.data.debts.forEach(d=>sel.innerHTML+=`<option value="${d.id}">${d.name}</option>`);
                c.querySelector('[name=date]').value = toDateStr(new Date());
                document.getElementById('modal-overlay').classList.remove('hidden'); document.getElementById('monthly-balance').innerText; // placeholder
                document.getElementById('modal-overlay').classList.add('flex');
            },
            toggleTxType: (t) => {
                document.getElementById('tx-type').value=t; 
                const e=document.getElementById('btn-expense'), i=document.getElementById('btn-income');
                if(t==='expense'){ e.classList.add('bg-white','shadow-md','text-rose-500'); i.classList.remove('bg-white','shadow-md','text-emerald-500'); }
                else { i.classList.add('bg-white','shadow-md','text-emerald-500'); e.classList.remove('bg-white','shadow-md','text-rose-500'); }
            },
            openCategorySelector: () => {
                const c = document.getElementById('sub-modal-content'); c.innerHTML = document.getElementById('tpl-category-selector').innerHTML;
                const type = document.getElementById('tx-type').value;
                document.getElementById('category-chips').innerHTML = State.categories[type].map(v=>`<button type="button" onclick="App.pickCategory('${v}')" class="bg-slate-100 px-3 py-2 rounded-xl text-xs font-bold">${v}</button>`).join('');
                document.getElementById('sub-modal-overlay').classList.remove('hidden'); document.getElementById('sub-modal-overlay').classList.add('flex');
            },
            closeSubModal: () => document.getElementById('sub-modal-overlay').classList.add('hidden'),
            pickCategory: (v) => { document.querySelector('#modal-content [name=category]').value = v; App.closeSubModal(); },
            updateDashboard: () => {
                const [y, m] = document.getElementById('date-filter').value.split('-').map(Number);
                const txs = State.data.transactions.filter(t => { const d = getTxDate(t); return d.getFullYear()===y && d.getMonth()+1===m; });
                const inc = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
                const exp = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
                document.getElementById('monthly-income').innerText = inc.toLocaleString(); document.getElementById('monthly-expense').innerText = exp.toLocaleString(); document.getElementById('monthly-balance').innerText = `$${(inc-exp).toLocaleString()}`;
            },
            switchInvTab: (tab, btn) => { State.view.invTab = tab; document.querySelectorAll('.tab-pill').forEach(e => e.classList.remove('active', 'bg-indigo-50', 'text-primary')); btn.classList.add('active', 'bg-indigo-50', 'text-primary'); App.renderInvestments(); },
        };
        window.App = App; App.init();
    </script>
</body>
</html>
