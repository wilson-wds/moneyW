<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端記帳軟體 (專案、報表、負債與事件)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .loader-small { border: 2px solid #f3f3f3; border-top: 2px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #555; }
        .tab-btn.active { border-color: #3b82f6; background-color: #3b82f6; color: white; }
        .debt-card-clickable, .asset-card-clickable, .lending-card-clickable, .investment-card-clickable, .loan-card-clickable { cursor: pointer; }
        .category-stat-item.active { background-color: #dbeafe; }
    </style>
    <!-- Print-specific styles -->
    <style>
        @media print {
            body * { visibility: hidden; }
            .print-section, .print-section * { visibility: visible; }
            .print-section { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; padding: 20px !important; border: none !important; box-shadow: none !important; background-color: white !important; }
            .print-section .no-print { display: none !important; }
            .print-section.fixed { position: relative !important; inset: auto !important; }
            .print-section > div { box-shadow: none !important; max-width: 100% !important; width: 100% !important; padding: 0 !important; border: none !important; }
            .print-section ul, .print-section li { list-style: none; padding: 0; margin: 0; }
            .print-section li { border-bottom: 1px solid #ccc; padding: 8px 0; page-break-inside: avoid; }
            .print-section h1, .print-section h2, .print-section h3, .print-section h4 { margin-bottom: 1rem; color: black !important; }
            .print-section p, .print-section span, .print-section div { color: black !important; background: none !important; }
            .print-section a { text-decoration: none; }
            .print-section .text-green-600, .print-section .text-red-600 { color: black !important; }
            .print-section .bg-gray-50, .print-section .bg-green-100, .print-section .bg-red-100, .print-section .bg-blue-100 { background: none !important; border: 1px solid #ddd; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- 登入畫面 -->
    <div id="login-view" class="container mx-auto p-8 max-w-md text-center h-screen flex flex-col justify-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">歡迎使用雲端記帳</h1>
        <p class="text-gray-600 mb-8">請選擇登入方式以開始使用。</p>
        <div class="space-y-4">
            <button id="google-login-btn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 flex items-center justify-center gap-3 transition-colors">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                使用 Google 登入
            </button>
            <button id="anonymous-login-btn" class="w-full bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-gray-800 transition-colors">
                以訪客身份繼續
            </button>
        </div>
    </div>
    <!-- 主應用程式畫面 (預設隱藏) -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-5xl opacity-0 transition-opacity duration-500 hidden">
        <header class="mb-6 text-center no-print">
            <div id="auth-info" class="flex justify-center items-center gap-4 mb-4"></div>
            <h1 class="text-4xl font-bold text-gray-800">雲端記帳軟體</h1>
        </header>

        <!-- 分頁導覽 -->
        <nav class="mb-8 flex justify-center border-b flex-wrap no-print">
            <button id="tab-accounting" class="tab-btn active py-3 px-6 text-lg font-semibold border-b-4 transition-colors">記帳</button>
            <button id="tab-fixed-expense" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">固定支出</button>
            <button id="tab-budget" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">收入預算</button>
            <button id="tab-investment" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">投資</button>
            <button id="tab-debt" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">負債</button>
            <button id="tab-lending" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">債權</button>
            <button id="tab-events" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">事件紀錄</button>
            <button id="tab-reports" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">報表</button>
            <button id="tab-calculator" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">貸款試算</button>
            <button id="tab-settings" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">設定</button>
        </nav>

        <!-- 記帳分頁內容 -->
        <div id="accounting-view">
            <section class="mb-8 bg-white p-6 md:p-8 rounded-2xl shadow-lg no-print">
                <h2 class="text-2xl font-bold mb-6 text-center">即時統計</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-600 text-center border-b pb-2">本日</h3>
                        <div id="today-summary">
                            <div class="bg-teal-50 p-3 rounded-xl shadow-sm"><h2 class="text-sm font-semibold text-teal-800">收入</h2><p id="today-income" class="text-lg font-bold text-teal-600 mt-1">NT$ 0</p></div>
                            <div class="bg-orange-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-orange-800">支出</h2><p id="today-expense" class="text-lg font-bold text-orange-600 mt-1">NT$ 0</p></div>
                            <div class="bg-indigo-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-indigo-800">結餘</h2><p id="today-balance" class="text-lg font-bold text-indigo-600 mt-1">NT$ 0</p></div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-600 text-center border-b pb-2">本月</h3>
                        <div id="monthly-summary">
                            <div class="bg-pink-50 p-3 rounded-xl shadow-sm"><h2 class="text-sm font-semibold text-pink-800">收入</h2><p id="monthly-income" class="text-lg font-bold text-pink-600 mt-1">NT$ 0</p></div>
                            <div class="bg-amber-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-amber-800">支出</h2><p id="monthly-expense" class="text-lg font-bold text-amber-600 mt-1">NT$ 0</p></div>
                            <div class="bg-purple-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-purple-800">結餘</h2><p id="monthly-balance" class="text-lg font-bold text-purple-600 mt-1">NT$ 0</p></div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-600 text-center border-b pb-2">總計</h3>
                        <div id="summary">
                            <div class="bg-green-50 p-3 rounded-xl shadow-sm"><h2 class="text-sm font-semibold text-green-800">總收入</h2><p id="total-income" class="text-lg font-bold text-green-600 mt-1">NT$ 0</p></div>
                            <div class="bg-red-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-red-800">總支出</h2><p id="total-expense" class="text-lg font-bold text-red-600 mt-1">NT$ 0</p></div>
                            <div class="bg-blue-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-blue-800">目前結餘</h2><p id="balance" class="text-lg font-bold text-blue-600 mt-1">NT$ 0</p></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8 no-print">
                <h2 class="text-2xl font-bold mb-6">新增 / 編輯紀錄</h2>
                <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="hidden" id="transaction-id">
                    <div class="md:col-span-2"><fieldset class="flex gap-4"><legend class="sr-only">交易類型</legend><div><input type="radio" name="type" id="type-expense" value="expense" class="sr-only" checked><label for="type-expense" class="type-label cursor-pointer block w-full text-center p-3 rounded-lg border-2 border-gray-300 transition">支出</label></div><div><input type="radio" name="type" id="type-income" value="income" class="sr-only"><label for="type-income" class="type-label cursor-pointer block w-full text-center p-3 rounded-lg border-2 border-gray-300 transition">收入</label></div></fieldset></div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="amount" class="block text-sm font-medium text-gray-700 mb-1">金額</label><input type="number" id="amount" placeholder="輸入金額" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div>
                        <div><label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="transaction-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div>
                    </div>
                    <div class="flex items-end gap-2"><div class="flex-grow"><label for="category-input" class="block text-sm font-medium text-gray-700 mb-1">分類</label><input list="category-list" id="category-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="選擇或輸入新分類" required><datalist id="category-list"></datalist></div><button type="button" id="manage-categories-btn" class="p-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" title="管理分類"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button></div>
                    <div class="flex items-end gap-2"><div class="flex-grow"><label for="project-input" class="block text-sm font-medium text-gray-700 mb-1">專案 (選填)</label><input list="project-list" id="project-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="選擇或輸入新專案"><datalist id="project-list"></datalist></div><button type="button" id="manage-projects-btn" class="p-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" title="管理專案"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg></button></div>
                    <div class="md:col-span-2"><label for="remarks" class="block text-sm font-medium text-gray-700 mb-1">備註 (選填)</label><input type="text" id="remarks" placeholder="這筆錢用在哪裡？" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 flex justify-center items-center"><span id="submit-btn-text">新增紀錄</span><div id="submit-spinner" class="hidden loader-small"></div></button></div>
                </form>
            </section>
            <section id="main-transaction-list-section" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold">歷史紀錄</h2>
                    <div class="flex items-center gap-2 no-print">
                        <label for="history-date-filter" class="text-sm font-medium text-gray-600">篩選日期:</label>
                        <input type="date" id="history-date-filter" class="p-2 border rounded-lg text-sm">
                        <button id="show-today-btn" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition text-sm">顯示本日</button>
                        <button id="print-transactions-btn" class="bg-gray-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-gray-600 text-sm">列印</button>
                    </div>
                </div>
                <p id="history-display-date" class="text-lg font-semibold text-gray-600 mb-4 text-center"></p>
                <div id="loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <ul id="transaction-list" class="space-y-4"></ul>
                <p id="empty-state" class="hidden text-center text-gray-500 py-8">還沒有任何紀錄，快來新增第一筆吧！</p>
            </section>
        </div>

        <!-- [NEW] Fixed Expense View -->
        <div id="fixed-expense-view" class="hidden">
            <section class="mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-700">每月固定支出總計</h2>
                    <p id="total-fixed-expense" class="text-3xl font-bold text-red-600 mt-2">NT$ 0</p>
                </div>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">新增固定支出項目</h2>
                <form id="fixed-expense-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="fixed-expense-name" class="block text-sm font-medium text-gray-700 mb-1">項目名稱</label>
                        <input type="text" id="fixed-expense-name" placeholder="例如: 房租、Netflix" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="md:col-span-1">
                        <label for="fixed-expense-amount" class="block text-sm font-medium text-gray-700 mb-1">每月金額</label>
                        <input type="number" id="fixed-expense-amount" placeholder="輸入金額" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="md:col-span-1 w-full bg-orange-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-700">新增項目</button>
                </form>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">固定支出列表</h2>
                <div id="fixed-expense-loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <ul id="fixed-expense-list" class="space-y-3"></ul>
                <p id="fixed-expense-empty-state" class="hidden text-center text-gray-500 py-8">尚未新增任何固定支出項目。</p>
            </section>
        </div>

        <!-- Budget View -->
        <div id="budget-view" class="hidden">
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">設定投資帳戶收入預算</h2>
                    <input type="month" id="budget-month-select" class="p-2 border rounded-lg">
                </div>
                <form id="budget-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="budget-account-select" class="block text-sm font-medium text-gray-700 mb-1">投資帳戶</label>
                        <select id="budget-account-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-green-500" required></select>
                    </div>
                    <div class="md:col-span-1">
                        <label for="budget-amount" class="block text-sm font-medium text-gray-700 mb-1">預算金額</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">NT$</div>
                            <input type="number" id="budget-amount" placeholder="輸入目標金額" class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                        </div>
                    </div>
                    <button type="submit" class="md:col-span-1 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 flex justify-center items-center">
                        <span id="budget-submit-btn-text">設定/更新</span>
                        <div id="budget-submit-spinner" class="hidden loader-small"></div>
                    </button>
                </form>
            </section>
            <section id="budget-progress-section" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-bold">預算進度</h2>
                     <div class="text-right">
                         <p class="text-sm text-gray-500">總目標</p>
                         <p id="budget-total-target" class="text-xl font-bold text-blue-600">NT$ 0</p>
                     </div>
                </div>
                <div id="budget-list" class="space-y-6">
                    <!-- Budget items will be rendered here -->
                </div>
                 <p id="budget-empty-state" class="hidden text-center text-gray-500 py-8">尚未設定任何投資帳戶的預算。</p>
            </section>
        </div>

        <!-- 投資分頁內容 -->
        <div id="investment-view" class="hidden">
            <section class="mb-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4">投資總覽</h2>
                <div id="investment-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-100 p-6 rounded-xl shadow-sm">
                        <h2 class="text-lg font-semibold text-blue-800">總資產現值</h2>
                        <p id="total-investment-value" class="text-2xl font-bold text-blue-600 mt-2">NT$ 0</p>
                    </div>
                    <div class="bg-purple-100 p-6 rounded-xl shadow-sm">
                        <h2 class="text-lg font-semibold text-purple-800">總報酬 (已實現)</h2>
                        <p id="total-investment-return" class="text-2xl font-bold text-purple-600 mt-2">NT$ 0</p>
                    </div>
                    <div class="bg-teal-100 p-6 rounded-xl shadow-sm">
                        <h2 class="text-lg font-semibold text-teal-800">總報酬率 (ROI)</h2>
                        <p id="total-investment-roi" class="text-2xl font-bold text-teal-600 mt-2">0.00%</p>
                    </div>
                </div>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">新增投資帳戶</h2>
                <form id="investment-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="investment-name" class="block text-sm font-medium text-gray-700 mb-1">帳戶名稱</label><input type="text" id="investment-name" placeholder="例如: 富邦證券" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <div><label for="investment-initial-value" class="block text-sm font-medium text-gray-700 mb-1">初始投入金額 (選填)</label><input type="number" id="investment-initial-value" placeholder="輸入初始金額 (可為0)" class="w-full p-3 border border-gray-300 rounded-lg"></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">建立帳戶</button></div>
                </form>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">投資帳戶列表</h2>
                <div id="investment-loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <div id="investment-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <p id="investment-empty-state" class="hidden text-center text-gray-500 py-8">尚未建立任何投資帳戶。</p>
            </section>
        </div>

        <!-- 報表分頁內容 -->
        <div id="reports-view" class="hidden">
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8 no-print">
                <h2 class="text-2xl font-bold mb-6">支出分類圖</h2>
                <div id="no-expense-data" class="hidden text-center text-gray-500 py-8">尚無足夠的支出資料可產生報表。</div>
                <div class="max-w-xl mx-auto"><canvas id="expense-chart"></canvas></div>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8 no-print">
                <h2 class="text-2xl font-bold mb-6">期間分類統計 (可點擊)</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4 text-red-600">支出</h3>
                        <ul id="expense-stats-list" class="space-y-1"></ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4 text-green-600">收入</h3>
                        <ul id="income-stats-list" class="space-y-1"></ul>
                    </div>
                </div>
            </section>
            <section id="filtered-transaction-list-section" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">交易明細</h2>
                    <button id="print-report-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 no-print">列印此報表</button>
                </div>
                <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-gray-50 rounded-lg border no-print">
                    <button id="filter-this-month" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">本月</button>
                    <div class="flex items-center gap-2">
                        <label for="start-date" class="text-sm font-medium">從:</label>
                        <input type="date" id="start-date" class="p-2 border rounded-lg text-sm">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="end-date" class="text-sm font-medium">到:</label>
                        <input type="date" id="end-date" class="p-2 border rounded-lg text-sm">
                    </div>
                    <button id="filter-custom-date" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">查詢</button>
                </div>
                <div id="filtered-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-100 p-4 rounded-xl"><h3 class="font-semibold text-green-800">期間總收入</h3><p id="filtered-income" class="text-xl font-bold text-green-600">NT$ 0</p></div>
                        <div class="bg-red-100 p-4 rounded-xl"><h3 class="font-semibold text-red-800">期間總支出</h3><p id="filtered-expense" class="text-xl font-bold text-red-600">NT$ 0</p></div>
                        <div class="bg-blue-100 p-4 rounded-xl"><h3 class="font-semibold text-blue-800">期間結餘</h3><p id="filtered-balance" class="text-xl font-bold text-blue-600">NT$ 0</p></div>
                </div>
                <ul id="filtered-transaction-list" class="space-y-2"></ul>
                <p id="filtered-empty-state" class="hidden text-center text-gray-500 py-8">在選定範圍內沒有交易紀錄。</p>
            </section>
        </div>

        <!-- 負債分頁內容 -->
        <div id="debt-view" class="hidden">
            <section class="mb-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4">負債總覽</h2>
                <div id="debt-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-yellow-100 p-4 rounded-xl shadow-sm">
                        <h2 class="text-base font-semibold text-yellow-800">初始總負債</h2>
                        <p id="total-initial-debt" class="text-xl font-bold text-yellow-600 mt-1">NT$ 0</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-xl shadow-sm">
                        <h2 class="text-base font-semibold text-red-800">目前總負債</h2>
                        <p id="total-current-debt" class="text-xl font-bold text-red-600 mt-1">NT$ 0</p>
                    </div>
                    <div class="bg-cyan-100 p-4 rounded-xl shadow-sm">
                        <h2 class="text-base font-semibold text-cyan-800">當月還款總額</h2>
                        <p id="total-monthly-repayment" class="text-xl font-bold text-cyan-600 mt-1">NT$ 0</p>
                    </div>
                </div>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">新增一筆負債</h2>
                <form id="debt-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="debt-name" class="block text-sm font-medium text-gray-700 mb-1">負債項目</label><input type="text" id="debt-name" placeholder="例如: 信用卡、學貸" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required></div>
                    <div><label for="debt-total-amount" class="block text-sm font-medium text-gray-700 mb-1">總金額</label><input type="number" id="debt-total-amount" placeholder="輸入總負債金額" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300 flex justify-center items-center"><span id="add-debt-btn-text">新增負債</span><div id="add-debt-spinner" class="hidden loader-small"></div></button></div>
                </form>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">負債列表</h2>
                <div id="debt-loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <div id="debt-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <p id="debt-empty-state" class="hidden text-center text-gray-500 py-8">太棒了！目前沒有任何負債紀錄。</p>
            </section>
        </div>

        <!-- 債權(個人借貸)分頁內容 -->
        <div id="lending-view" class="hidden">
            <section class="mb-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4">債權總覽</h2>
                <div id="lending-summary" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-lime-100 p-6 rounded-xl shadow-sm">
                        <h2 class="text-lg font-semibold text-lime-800">借出總額</h2>
                        <p id="total-lending-amount" class="text-2xl font-bold text-lime-600 mt-2">NT$ 0</p>
                    </div>
                    <div class="bg-emerald-100 p-6 rounded-xl shadow-sm">
                        <h2 class="text-lg font-semibold text-emerald-800">待收回總額</h2>
                        <p id="total-lending-remaining" class="text-2xl font-bold text-emerald-600 mt-2">NT$ 0</p>
                    </div>
                </div>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">新增一筆借出款</h2>
                <form id="lending-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="lending-name" class="block text-sm font-medium text-gray-700 mb-1">借款人/項目</label><input type="text" id="lending-name" placeholder="例如: 王小明" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <div><label for="lending-total-amount" class="block text-sm font-medium text-gray-700 mb-1">借出金額</label><input type="number" id="lending-total-amount" placeholder="輸入借出總金額" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 flex justify-center items-center">新增借款</button></div>
                </form>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">債權列表</h2>
                <div id="lending-loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <div id="lending-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <p id="lending-empty-state" class="hidden text-center text-gray-500 py-8">尚未有任何借出款紀錄。</p>
            </section>
        </div>

        <!-- 事件紀錄分頁 -->
        <div id="events-view" class="hidden">
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">新增事件紀錄</h2>
                <form id="event-form" class="space-y-4">
                    <div><label for="event-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="event-date" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <div><label for="event-title" class="block text-sm font-medium text-gray-700 mb-1">標題</label><input type="text" id="event-title" placeholder="事件標題" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <div><label for="event-description" class="block text-sm font-medium text-gray-700 mb-1">內容</label><textarea id="event-description" placeholder="詳細內容..." rows="4" class="w-full p-3 border border-gray-300 rounded-lg"></textarea></div>
                    <div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">新增事件</button></div>
                </form>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">事件時間軸</h2>
                <div id="event-loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <div id="event-list" class="space-y-6 border-l-2 border-indigo-200 ml-3"></div>
                <p id="event-empty-state" class="hidden text-center text-gray-500 py-8">尚未有任何事件紀錄。</p>
            </section>
        </div>
        
        <!-- Loan Calculator View -->
        <div id="calculator-view" class="hidden">
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">新增貸款帳戶</h2>
                <form id="loan-calculator-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="loan-name" class="block text-sm font-medium text-gray-700 mb-1">帳戶名稱</label>
                        <input type="text" id="loan-name" placeholder="例如: 房屋貸款" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="loan-amount" class="block text-sm font-medium text-gray-700 mb-1">貸款金額</label>
                        <input type="number" id="loan-amount" placeholder="輸入總貸款金額" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="interest-rate" class="block text-sm font-medium text-gray-700 mb-1">利率 (%)</label>
                        <div class="flex">
                            <input type="number" id="interest-rate" step="0.01" placeholder="例如: 2.5" class="w-full p-3 border border-r-0 border-gray-300 rounded-l-lg" required>
                            <select id="rate-type" class="p-3 border border-gray-300 rounded-r-lg bg-gray-50">
                                <option value="annual">年利率</option>
                                <option value="monthly">月利率</option>
                            </select>
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">計算方式</label>
                        <select id="loan-type" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50">
                            <option value="amortization">本息攤還</option>
                            <option value="interest-only">純繳利息</option>
                        </select>
                    </div>
                    <div id="loan-term-container">
                        <label for="loan-term" class="block text-sm font-medium text-gray-700 mb-1">期數 (月)</label>
                        <input type="number" id="loan-term" placeholder="輸入總期數" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="flex items-center pt-6">
                        <input id="interest-reduction-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="interest-reduction-checkbox" class="ml-2 block text-sm text-gray-900">還本降息</label>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-700">建立貸款帳戶</button>
                    </div>
                </form>
            </section>
            <section id="loan-accounts-section">
                 <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">貸款帳戶列表</h2>
                    <div id="loan-account-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <p id="loan-account-empty-state" class="hidden text-center text-gray-500 py-8">尚未建立任何貸款帳戶。</p>
                 </div>
            </section>
        </div>

        <!-- 設定分頁 -->
        <div id="settings-view" class="hidden">
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">資料備份</h2>
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <p class="text-gray-600 mb-4">點擊以下載您所有的記帳、負債、投資等資料的 JSON 備份檔案。您可以將此檔案儲存至您的電腦或上傳至雲端硬碟。</p>
                    <button id="backup-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">下載備份檔案</button>
                </div>
            </section>
        </div>

    </div>
    <!-- Modals -->
    <div id="calculator-password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-6">請輸入密碼</h3>
            <form id="calculator-password-form">
                <input type="password" id="calculator-password-input" class="w-full p-3 border border-gray-300 rounded-lg mb-4" required>
                <p id="calculator-password-error" class="text-red-500 text-sm mb-4 hidden">密碼錯誤</p>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">確認</button>
            </form>
        </div>
    </div>
    <div id="loan-transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md">
            <h3 id="loan-transaction-title" class="text-2xl font-bold mb-6">新增還款交易</h3>
            <form id="loan-transaction-form">
                <input type="hidden" id="loan-transaction-id">
                <input type="hidden" id="loan-transaction-account-id">
                <input type="hidden" id="loan-transaction-original-principal">
                <input type="hidden" id="loan-transaction-original-interest">
                <div class="mb-4">
                    <label for="loan-repayment-principal" class="block text-sm font-medium text-gray-700 mb-1">還款本金</label>
                    <input type="number" id="loan-repayment-principal" placeholder="輸入本金金額" class="w-full p-3 border border-gray-300 rounded-lg" value="0">
                </div>
                <div class="mb-4">
                    <label for="loan-repayment-interest" class="block text-sm font-medium text-gray-700 mb-1">還款利息</label>
                    <input type="number" id="loan-repayment-interest" placeholder="輸入利息金額" class="w-full p-3 border border-gray-300 rounded-lg" value="0">
                </div>
                 <div class="mb-4">
                    <label for="loan-repayment-date" class="block text-sm font-medium text-gray-700 mb-1">還款日期</label>
                    <input type="date" id="loan-repayment-date" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-loan-transaction-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button>
                    <button type="submit" id="submit-loan-transaction-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">確認還款</button>
                </div>
            </form>
        </div>
    </div>
    <div id="loan-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="loan-detail-title" class="text-2xl font-bold">貸款詳情</h3>
                <button id="close-loan-detail-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none no-print">&times;</button>
            </div>
            <div id="loan-detail-summary" class="mb-4 p-4 bg-gray-50 rounded-lg"></div>
            <div class="mb-4 p-4 bg-gray-50 rounded-lg flex items-center justify-between">
                <label for="loan-detail-interest-reduction" class="font-medium text-gray-700">還本降息</label>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="loan-detail-interest-reduction" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="loan-detail-interest-reduction" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
                <style>.toggle-checkbox:checked { right: 0; border-color: #3b82f6; } .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }</style>
            </div>
            <h4 class="text-lg font-bold mb-2 border-t pt-4">還款紀錄</h4>
            <ul id="loan-history-list" class="space-y-2 max-h-60 overflow-y-auto"></ul>
            <p id="loan-history-empty" class="hidden text-center text-gray-500 py-4">尚無還款紀錄</p>
        </div>
    </div>
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">管理分類</h3><button id="close-category-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><ul id="custom-category-list" class="space-y-2 max-h-60 overflow-y-auto mb-6 border-t border-b py-4"></ul><div class="flex justify-end"><button type="button" id="close-category-modal-btn-bottom" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">關閉</button></div></div></div>
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">管理專案</h3><button id="close-project-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><ul id="custom-project-list" class="space-y-2 max-h-60 overflow-y-auto mb-6 border-t border-b py-4"></ul><div class="flex justify-end"><button type="button" id="close-project-modal-btn-bottom" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">關閉</button></div></div></div>
    <div id="repayment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-6">記錄一筆還款</h3><form id="repayment-form"><input type="hidden" id="repayment-debt-id"><input type="hidden" id="repayment-debt-name"><div class="mb-4"><label for="repayment-amount" class="block text-sm font-medium text-gray-700 mb-1">還款金額</label><input type="number" id="repayment-amount" placeholder="輸入此次還款金額" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="repayment-date" class="block text-sm font-medium text-gray-700 mb-1">還款日期</label><input type="date" id="repayment-date" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="repayment-remark" class="block text-sm font-medium text-gray-700 mb-1">備註 (選填)</label><input type="text" id="repayment-remark" placeholder="還款備註" class="w-full p-3 border border-gray-300 rounded-lg"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-repayment-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">確認還款</button></div></form></div></div>
    <div id="debt-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-lg"><div class="flex justify-between items-center mb-4"><h3 id="debt-detail-title" class="text-2xl font-bold">負債詳情</h3><button id="close-debt-detail-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none no-print">&times;</button></div><div id="debt-detail-display-view"><div class="mb-4 p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">項目名稱</p><p id="debt-detail-name" class="text-lg font-semibold"></p><p class="text-sm text-gray-500 mt-2">初始總金額</p><p id="debt-detail-total" class="text-lg font-semibold"></p><p class="text-sm text-gray-500 mt-2">本月已還</p><p id="debt-detail-monthly-repayment" class="text-lg font-semibold text-cyan-600"></p></div><div class="flex justify-end mb-4 gap-2 no-print"><button id="print-debt-detail-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">列印</button><button id="edit-debt-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">編輯</button></div></div><form id="debt-edit-form" class="hidden mb-4 no-print"><input type="hidden" id="edit-debt-id"><div class="mb-4"><label for="edit-debt-name" class="block text-sm font-medium text-gray-700 mb-1">項目名稱</label><input type="text" id="edit-debt-name" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="edit-debt-total" class="block text-sm font-medium text-gray-700 mb-1">初始總金額</label><input type="number" id="edit-debt-total" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="flex justify-end gap-4"><button type="button" id="cancel-edit-debt-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">儲存變更</button></div></form><h4 class="text-lg font-bold mb-2 border-t pt-4">還款紀錄</h4><ul id="repayment-history-list" class="space-y-2 max-h-48 overflow-y-auto"></ul><p id="repayment-history-empty" class="hidden text-center text-gray-500 py-4">尚無還款紀錄</p></div></div>
    <div id="receive-payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-6">記錄一筆收款</h3><form id="receive-payment-form"><input type="hidden" id="receive-payment-lending-id"><input type="hidden" id="receive-payment-lending-name"><div class="mb-4"><label for="receive-payment-amount" class="block text-sm font-medium text-gray-700 mb-1">收款金額</label><input type="number" id="receive-payment-amount" placeholder="輸入此次收款金額" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="receive-payment-date" class="block text-sm font-medium text-gray-700 mb-1">收款日期</label><input type="date" id="receive-payment-date" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="flex justify-end gap-4"><button type="button" id="cancel-receive-payment-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700">確認收款</button></div></form></div></div>
    <div id="investment-transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><h3 id="investment-transaction-title" class="text-2xl font-bold mb-6"></h3><form id="investment-transaction-form"><input type="hidden" id="investment-transaction-account-id"><input type="hidden" id="investment-transaction-account-name"><input type="hidden" id="investment-transaction-id"><input type="hidden" id="investment-main-transaction-id"><div class="mb-4"><label for="investment-transaction-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="investment-transaction-date" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">類型</label><select id="investment-transaction-type" class="w-full p-3 border border-gray-300 rounded-lg bg-white"><option value="expense">支出 (買入/投入)</option><option value="income">收入 (賣出/配息)</option></select></div><div class="mb-4"><label for="investment-transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">金額</label><input type="number" id="investment-transaction-amount" placeholder="輸入金額" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="investment-transaction-remark" class="block text-sm font-medium text-gray-700 mb-1">備註</label><input type="text" id="investment-transaction-remark" placeholder="例如: 買入TSMC 1股" class="w-full p-3 border border-gray-300 rounded-lg"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-investment-transaction-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">確認</button></div></form></div></div>
    <div id="investment-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-lg"><div class="flex justify-between items-center mb-4"><h3 id="investment-detail-title" class="text-2xl font-bold"></h3><div class="flex items-center gap-2 no-print"><button id="print-investment-detail-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">列印</button><button id="close-investment-detail-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div></div><h4 class="text-lg font-bold mb-2 border-t pt-4">交易紀錄</h4><ul id="investment-history-list" class="space-y-2 max-h-96 overflow-y-auto"></ul><p id="investment-history-empty" class="hidden text-center text-gray-500 py-4">尚無交易紀錄</p></div></div>
    <div id="edit-investment-account-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-6">編輯投資帳戶</h3><form id="edit-investment-account-form"><input type="hidden" id="edit-investment-account-id"><div class="mb-4"><label for="edit-investment-account-name" class="block text-sm font-medium text-gray-700 mb-1">帳戶名稱</label><input type="text" id="edit-investment-account-name" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="flex justify-end gap-4"><button type="button" id="cancel-edit-investment-account-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">儲存</button></div></form></div></div>
    <div id="update-market-value-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><h3 id="update-market-value-title" class="text-2xl font-bold mb-6">更新資產現值</h3><form id="update-market-value-form"><input type="hidden" id="update-market-value-id"><div class="mb-4"><label for="update-market-value-amount" class="block text-sm font-medium text-gray-700 mb-1">目前資產總價值</label><input type="number" id="update-market-value-amount" placeholder="輸入目前總市價" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="flex justify-end gap-4"><button type="button" id="cancel-update-market-value-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">確認更新</button></div></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, serverTimestamp, updateDoc, increment, Timestamp, getDocs, writeBatch, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM 元素 ---
        const loginView = document.getElementById('login-view');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const anonymousLoginBtn = document.getElementById('anonymous-login-btn');
        const appContainer = document.getElementById('app-container'), authInfo = document.getElementById('auth-info');
        const accountingView = document.getElementById('accounting-view'), reportsView = document.getElementById('reports-view'), debtView = document.getElementById('debt-view'), eventsView = document.getElementById('events-view'), lendingView = document.getElementById('lending-view'), investmentView = document.getElementById('investment-view'), calculatorView = document.getElementById('calculator-view'), budgetView = document.getElementById('budget-view'), fixedExpenseView = document.getElementById('fixed-expense-view');
        const tabAccounting = document.getElementById('tab-accounting'), tabReports = document.getElementById('tab-reports'), tabDebt = document.getElementById('tab-debt'), tabEvents = document.getElementById('tab-events'), tabLending = document.getElementById('tab-lending'), tabInvestment = document.getElementById('tab-investment'), tabCalculator = document.getElementById('tab-calculator'), tabBudget = document.getElementById('tab-budget'), tabFixedExpense = document.getElementById('tab-fixed-expense');
        const form = document.getElementById('transaction-form'), amountInput = document.getElementById('amount'), transactionDateInput = document.getElementById('transaction-date'), remarksInput = document.getElementById('remarks'), transactionList = document.getElementById('transaction-list');
        const categoryInput = document.getElementById('category-input'), categoryDatalist = document.getElementById('category-list');
        const projectInput = document.getElementById('project-input'), projectDatalist = document.getElementById('project-list');
        const totalIncomeEl = document.getElementById('total-income'), totalExpenseEl = document.getElementById('total-expense'), balanceEl = document.getElementById('balance');
        const todayIncomeEl = document.getElementById('today-income'), todayExpenseEl = document.getElementById('today-expense'), todayBalanceEl = document.getElementById('today-balance');
        const monthlyIncomeEl = document.getElementById('monthly-income'), monthlyExpenseEl = document.getElementById('monthly-expense'), monthlyBalanceEl = document.getElementById('monthly-balance');
        const loadingIndicator = document.getElementById('loading-indicator'), emptyState = document.getElementById('empty-state');
        const typeLabels = document.querySelectorAll('.type-label'), expenseRadio = document.getElementById('type-expense');
        const submitBtnText = document.getElementById('submit-btn-text'), submitSpinner = document.getElementById('submit-spinner');
        const manageCategoriesBtn = document.getElementById('manage-categories-btn'), categoryModal = document.getElementById('category-modal'), customCategoryList = document.getElementById('custom-category-list');
        const manageProjectsBtn = document.getElementById('manage-projects-btn'), projectModal = document.getElementById('project-modal'), customProjectList = document.getElementById('custom-project-list');
        const expenseChartCanvas = document.getElementById('expense-chart'), noExpenseDataMsg = document.getElementById('no-expense-data');
        const debtForm = document.getElementById('debt-form'), debtList = document.getElementById('debt-list'), debtLoadingIndicator = document.getElementById('debt-loading-indicator'), debtEmptyState = document.getElementById('debt-empty-state');
        const totalInitialDebtEl = document.getElementById('total-initial-debt'), totalCurrentDebtEl = document.getElementById('total-current-debt'), totalMonthlyRepaymentEl = document.getElementById('total-monthly-repayment');
        const repaymentModal = document.getElementById('repayment-modal'), repaymentForm = document.getElementById('repayment-form'), repaymentDebtIdInput = document.getElementById('repayment-debt-id'), repaymentDebtNameInput = document.getElementById('repayment-debt-name'), repaymentAmountInput = document.getElementById('repayment-amount'), repaymentDateInput = document.getElementById('repayment-date'), cancelRepaymentBtn = document.getElementById('cancel-repayment-btn');
        const debtDetailModal = document.getElementById('debt-detail-modal'), closeDebtDetailModalBtn = document.getElementById('close-debt-detail-modal-btn');
        const debtDetailDisplayView = document.getElementById('debt-detail-display-view'), debtEditForm = document.getElementById('debt-edit-form');
        const debtDetailName = document.getElementById('debt-detail-name'), debtDetailTotal = document.getElementById('debt-detail-total'), debtDetailMonthlyRepayment = document.getElementById('debt-detail-monthly-repayment');
        const editDebtBtn = document.getElementById('edit-debt-btn'), cancelEditDebtBtn = document.getElementById('cancel-edit-debt-btn');
        const editDebtIdInput = document.getElementById('edit-debt-id'), editDebtNameInput = document.getElementById('edit-debt-name'), editDebtTotalInput = document.getElementById('edit-debt-total');
        const repaymentHistoryList = document.getElementById('repayment-history-list'), repaymentHistoryEmpty = document.getElementById('repayment-history-empty');
        const eventForm = document.getElementById('event-form'), eventList = document.getElementById('event-list'), eventLoadingIndicator = document.getElementById('event-loading-indicator'), eventEmptyState = document.getElementById('event-empty-state');
        const lendingForm = document.getElementById('lending-form'), lendingList = document.getElementById('lending-list'), lendingLoadingIndicator = document.getElementById('lending-loading-indicator'), lendingEmptyState = document.getElementById('lending-empty-state');
        const totalLendingAmountEl = document.getElementById('total-lending-amount'), totalLendingRemainingEl = document.getElementById('total-lending-remaining');
        const receivePaymentModal = document.getElementById('receive-payment-modal'), receivePaymentForm = document.getElementById('receive-payment-form'), cancelReceivePaymentBtn = document.getElementById('cancel-receive-payment-btn');
        const receivePaymentLendingIdInput = document.getElementById('receive-payment-lending-id'), receivePaymentLendingNameInput = document.getElementById('receive-payment-lending-name'), receivePaymentAmountInput = document.getElementById('receive-payment-amount'), receivePaymentDateInput = document.getElementById('receive-payment-date');
        const investmentForm = document.getElementById('investment-form'), investmentList = document.getElementById('investment-list'), investmentLoadingIndicator = document.getElementById('investment-loading-indicator'), investmentEmptyState = document.getElementById('investment-empty-state');
        const totalInvestmentValueEl = document.getElementById('total-investment-value'), totalInvestmentReturnEl = document.getElementById('total-investment-return'), totalInvestmentRoiEl = document.getElementById('total-investment-roi');
        const investmentTransactionModal = document.getElementById('investment-transaction-modal'), investmentTransactionForm = document.getElementById('investment-transaction-form'), cancelInvestmentTransactionBtn = document.getElementById('cancel-investment-transaction-btn');
        const investmentDetailModal = document.getElementById('investment-detail-modal'), closeInvestmentDetailModalBtn = document.getElementById('close-investment-detail-modal-btn'), investmentHistoryList = document.getElementById('investment-history-list'), investmentHistoryEmpty = document.getElementById('investment-history-empty');
        const editInvestmentAccountModal = document.getElementById('edit-investment-account-modal'), editInvestmentAccountForm = document.getElementById('edit-investment-account-form'), cancelEditInvestmentAccountBtn = document.getElementById('cancel-edit-investment-account-btn');
        const updateMarketValueModal = document.getElementById('update-market-value-modal'), updateMarketValueForm = document.getElementById('update-market-value-form'), cancelUpdateMarketValueBtn = document.getElementById('cancel-update-market-value-btn');
        const filterThisMonthBtn = document.getElementById('filter-this-month'), filterCustomDateBtn = document.getElementById('filter-custom-date'), startDateInput = document.getElementById('start-date'), endDateInput = document.getElementById('end-date');
        const filteredTransactionList = document.getElementById('filtered-transaction-list'), filteredEmptyState = document.getElementById('filtered-empty-state');
        const filteredIncomeEl = document.getElementById('filtered-income'), filteredExpenseEl = document.getElementById('filtered-expense'), filteredBalanceEl = document.getElementById('filtered-balance');
        const expenseStatsList = document.getElementById('expense-stats-list');
        const incomeStatsList = document.getElementById('income-stats-list');
        const backupBtn = document.getElementById('backup-btn');
        const printTransactionsBtn = document.getElementById('print-transactions-btn');
        const printReportBtn = document.getElementById('print-report-btn');
        const printDebtDetailBtn = document.getElementById('print-debt-detail-btn');
        const printInvestmentDetailBtn = document.getElementById('print-investment-detail-btn');
        const historyDateFilter = document.getElementById('history-date-filter');
        const showTodayBtn = document.getElementById('show-today-btn');
        const historyDisplayDateEl = document.getElementById('history-display-date');
        const loanCalculatorForm = document.getElementById('loan-calculator-form');
        const loanAccountList = document.getElementById('loan-account-list');
        const loanAccountEmptyState = document.getElementById('loan-account-empty-state');
        const loanTypeSelect = document.getElementById('loan-type');
        const loanTermInput = document.getElementById('loan-term');
        const loanTermContainer = document.getElementById('loan-term-container');
        const calculatorPasswordModal = document.getElementById('calculator-password-modal');
        const calculatorPasswordForm = document.getElementById('calculator-password-form');
        const loanTransactionModal = document.getElementById('loan-transaction-modal');
        const loanTransactionForm = document.getElementById('loan-transaction-form');
        const cancelLoanTransactionBtn = document.getElementById('cancel-loan-transaction-btn');
        const loanDetailModal = document.getElementById('loan-detail-modal');
        const closeLoanDetailModalBtn = document.getElementById('close-loan-detail-modal-btn');
        const loanHistoryList = document.getElementById('loan-history-list');
        const loanHistoryEmpty = document.getElementById('loan-history-empty');
        // Budget Elements
        const budgetForm = document.getElementById('budget-form');
        const budgetMonthSelect = document.getElementById('budget-month-select');
        const budgetAccountSelect = document.getElementById('budget-account-select');
        const budgetAmountInput = document.getElementById('budget-amount');
        const budgetList = document.getElementById('budget-list');
        const budgetTotalTargetEl = document.getElementById('budget-total-target');
        const budgetEmptyState = document.getElementById('budget-empty-state');
        // Fixed Expense Elements
        const fixedExpenseForm = document.getElementById('fixed-expense-form');
        const fixedExpenseList = document.getElementById('fixed-expense-list');
        const totalFixedExpenseEl = document.getElementById('total-fixed-expense');
        const fixedExpenseLoadingIndicator = document.getElementById('fixed-expense-loading-indicator');
        const fixedExpenseEmptyState = document.getElementById('fixed-expense-empty-state');

        // --- Firebase & App 狀態 ---
        let db, auth, userId, transactionsColRef, categoriesColRef, projectsColRef, debtsColRef, eventsColRef, lendingsColRef, investmentsColRef, loansColRef, budgetsColRef, fixedExpensesColRef;
        let unsubscribeTransactions, unsubscribeCategories, unsubscribeProjects, unsubscribeDebts, unsubscribeEvents, unsubscribeLendings, unsubscribeInvestments, unsubscribeLoans, unsubscribeBudgets, unsubscribeFixedExpenses;
        let allTransactions = [], customCategories = [], customProjects = [], allDebts = [], allEvents = [], allLendings = [], allInvestments = [], allLoans = [], allFixedExpenses = [];
        let currentBudget = { accounts: {} };
        let selectedBudgetDate = new Date();
        let expenseChart = null;
        let activeCategoryFilter = { type: null, category: null };
        const defaultCategories = { expense: ['飲食', '交通', '居住', '娛樂', '購物', '醫療', '教育', '負債還款', '投資支出', '其他'], income: ['薪資', '獎金', '投資收入', '兼職', '債權回收', '其他'] };

        const firebaseConfig = {
          apiKey: "AIzaSyAqFHm6Bn35m8xauc50ZvNNy_rxIZzCMTE",
          authDomain: "moneyw-f8105.firebaseapp.com",
          projectId: "moneyw-f8105",
          storageBucket: "moneyw-f8105.appspot.com",
          messagingSenderId: "155586195799",
          appId: "1:155586195799:web:302184fbf613f032a88e12"
        };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                const basePath = `/users/${userId}`;
                transactionsColRef = collection(db, `${basePath}/transactions`);
                categoriesColRef = collection(db, `${basePath}/categories`);
                projectsColRef = collection(db, `${basePath}/projects`);
                debtsColRef = collection(db, `${basePath}/debts`);
                eventsColRef = collection(db, `${basePath}/events`);
                lendingsColRef = collection(db, `${basePath}/lendings`);
                investmentsColRef = collection(db, `${basePath}/investments`);
                loansColRef = collection(db, `${basePath}/loans`);
                budgetsColRef = collection(db, `${basePath}/budgets`);
                fixedExpensesColRef = collection(db, `${basePath}/fixedExpenses`);

                setupUIForLoggedInUser(user);

                listenForTransactions();
                listenForCustomItems(categoriesColRef, (items) => { customCategories = items; populateCategoryDatalist(); populateModalList(customCategoryList, customCategories, '尚無自訂分類', 'category'); });
                listenForCustomItems(projectsColRef, (items) => { customProjects = items; populateDatalist(projectDatalist, customProjects.map(p => p.name)); populateModalList(customProjectList, customProjects, '尚無自訂專案', 'project'); });
                listenForDebts();
                listenForEvents();
                listenForLendings();
                listenForInvestments();
                listenForLoans();
                listenForBudgets();
                listenForFixedExpenses();

            } else {
                setupUIForLoggedOutUser();
                if (unsubscribeTransactions) unsubscribeTransactions();
                if (unsubscribeCategories) unsubscribeCategories();
                if (unsubscribeProjects) unsubscribeProjects();
                if (unsubscribeDebts) unsubscribeDebts();
                if (unsubscribeEvents) unsubscribeEvents();
                if (unsubscribeLendings) unsubscribeLendings();
                if (unsubscribeInvestments) unsubscribeInvestments();
                if (unsubscribeLoans) unsubscribeLoans();
                if (unsubscribeBudgets) unsubscribeBudgets();
                if (unsubscribeFixedExpenses) unsubscribeFixedExpenses();
            }
        });

        function setupUIForLoggedInUser(user) {
            loginView.classList.add('hidden');
            appContainer.classList.remove('hidden');
            setTimeout(() => appContainer.classList.remove('opacity-0'), 50);

            let userInfoHtml = '';
            if (user.isAnonymous) {
                userInfoHtml = `<span>訪客模式 (UID: <span class="font-mono">${user.uid.substring(0, 6)}...</span>)</span>`;
            } else {
                userInfoHtml = `<img src="${user.photoURL}" alt="User Avatar" class="w-8 h-8 rounded-full"><span class="font-semibold">${user.displayName}</span>`;
            }
            authInfo.innerHTML = `${userInfoHtml}<button id="logout-btn" class="ml-4 bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-red-600">登出</button>`;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        }

        function setupUIForLoggedOutUser() {
            loginView.classList.remove('hidden');
            appContainer.classList.add('hidden');
            appContainer.classList.add('opacity-0');
            authInfo.innerHTML = '';
            transactionList.innerHTML = '';
            debtList.innerHTML = '';
            eventList.innerHTML = '';
            lendingList.innerHTML = '';
            investmentList.innerHTML = '';
            loanAccountList.innerHTML = '';
            fixedExpenseList.innerHTML = '';
        }

        function listenForTransactions() {
            if (unsubscribeTransactions) unsubscribeTransactions();
            unsubscribeTransactions = onSnapshot(query(transactionsColRef), (snapshot) => {
                loadingIndicator.classList.add('hidden');
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allTransactions.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

                const now = new Date();
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                const todayTransactions = allTransactions.filter(tx => {
                    if (!tx.timestamp) return false;
                    const txDate = tx.timestamp.toDate();
                    return txDate >= startOfToday && txDate < endOfToday;
                });

                renderMainTransactionList();
                updateSummary(allTransactions);
                updateTodaySummary(todayTransactions);
                updateMonthlySummary(allTransactions);
                updateExpenseChart();
                updateMonthlyRepaymentSummary();
                renderBudgetView();
                if(reportsView.classList.contains('hidden') === false) { handleFilterThisMonth(); }
            }, (error) => console.error("監聽交易資料失敗:", error));
        }

        function listenForDebts() {
            if (unsubscribeDebts) unsubscribeDebts();
            unsubscribeDebts = onSnapshot(query(debtsColRef), (snapshot) => {
                debtLoadingIndicator.classList.add('hidden');
                allDebts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allDebts.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                updateDebtSummary(allDebts);
                renderDebts(allDebts);
                debtEmptyState.classList.toggle('hidden', allDebts.length > 0);
            }, (error) => console.error("監聽負債資料失敗:", error));
        }

        function listenForEvents() {
            if (unsubscribeEvents) unsubscribeEvents();
            unsubscribeEvents = onSnapshot(query(eventsColRef), (snapshot) => {
                eventLoadingIndicator.classList.add('hidden');
                allEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allEvents.sort((a, b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0));
                renderEvents(allEvents);
                eventEmptyState.classList.toggle('hidden', allEvents.length > 0);
            }, (error) => console.error("監聽事件資料失敗:", error));
        }

        function listenForLendings() {
            if (unsubscribeLendings) unsubscribeLendings();
            unsubscribeLendings = onSnapshot(query(lendingsColRef), (snapshot) => {
                lendingLoadingIndicator.classList.add('hidden');
                allLendings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateLendingSummary(allLendings);
                renderLendings(allLendings);
                lendingEmptyState.classList.toggle('hidden', allLendings.length > 0);
            }, (error) => console.error("監聽債權資料失敗:", error));
        }

        function listenForInvestments() {
            if(unsubscribeInvestments) unsubscribeInvestments();
            unsubscribeInvestments = onSnapshot(query(investmentsColRef), async (snapshot) => {
                investmentLoadingIndicator.classList.add('hidden');
                const investmentPromises = snapshot.docs.map(async (investmentDoc) => {
                    const investmentData = { id: investmentDoc.id, ...investmentDoc.data() };
                    const investmentTxColRef = collection(db, `${investmentsColRef.path}/${investmentDoc.id}/transactions`);
                    const txSnapshot = await getDocs(query(investmentTxColRef));
                    investmentData.transactions = txSnapshot.docs.map(txDoc => ({id: txDoc.id, ...txDoc.data()}));
                    return investmentData;
                });
                allInvestments = await Promise.all(investmentPromises);
                renderInvestments(allInvestments);
                updateInvestmentSummary(allInvestments);
                investmentEmptyState.classList.toggle('hidden', allInvestments.length > 0);
                populateBudgetAccountSelect();
            }, (error) => console.error("監聽投資資料失敗:", error));
        }
        
        function listenForLoans() {
            if(unsubscribeLoans) unsubscribeLoans();
            unsubscribeLoans = onSnapshot(query(loansColRef), (snapshot) => {
                allLoans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLoanAccounts(allLoans);
                loanAccountEmptyState.classList.toggle('hidden', allLoans.length > 0);
            }, (error) => console.error("監聽貸款帳戶失敗:", error));
        }

        function listenForBudgets() {
            if (unsubscribeBudgets) unsubscribeBudgets();
            const year = selectedBudgetDate.getFullYear();
            const month = String(selectedBudgetDate.getMonth() + 1).padStart(2, '0');
            const budgetId = `${year}-${month}`;
            const budgetDocRef = doc(budgetsColRef, budgetId);

            unsubscribeBudgets = onSnapshot(budgetDocRef, (doc) => {
                if (doc.exists()) {
                    currentBudget = { id: doc.id, ...doc.data() };
                } else {
                    currentBudget = { id: budgetId, accounts: {} };
                }
                renderBudgetView();
            }, (error) => console.error("監聽預算資料失敗:", error));
        }

        function listenForFixedExpenses() {
            if (unsubscribeFixedExpenses) unsubscribeFixedExpenses();
            unsubscribeFixedExpenses = onSnapshot(query(fixedExpensesColRef), (snapshot) => {
                fixedExpenseLoadingIndicator.classList.add('hidden');
                allFixedExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allFixedExpenses.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                renderFixedExpenses(allFixedExpenses);
                updateFixedExpenseSummary(allFixedExpenses);
                fixedExpenseEmptyState.classList.toggle('hidden', allFixedExpenses.length > 0);
            }, (error) => console.error("監聽固定支出失敗:", error));
        }

        function listenForCustomItems(collectionRef, callback) {
            const q = query(collectionRef);
            return onSnapshot(q, (snapshot) => {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                callback(items);
            }, (error) => console.error("監聽自訂項目失敗:", error));
        }

        // --- 渲染函式 ---
        function renderTransactions(transactions) {
            transactionList.innerHTML = '';
            transactions.forEach(tx => {
                const isIncome = tx.type === 'income';
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 rounded-lg hover:bg-gray-50 border-b';
                li.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="flex-shrink-0">
                            <p class="font-semibold">${tx.category}</p>
                            <p class="text-sm text-gray-500">${tx.project || '無專案'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">${tx.remarks || '無備註'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'} NT$ ${tx.amount.toLocaleString()}</p>
                        <div class="flex items-center gap-2 justify-end">
                            <span class="text-xs text-gray-400">${tx.timestamp ? tx.timestamp.toDate().toLocaleDateString('zh-TW') : '...'}</span>
                            <button data-id="${tx.id}" class="edit-btn text-gray-400 hover:text-blue-500 no-print p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                            </button>
                            <button data-id="${tx.id}" class="delete-btn text-gray-400 hover:text-red-500 no-print p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>`;
                transactionList.appendChild(li);
            });
        }

        function renderFilteredTransactions(transactions) {
            filteredTransactionList.innerHTML = '';
            filteredEmptyState.classList.toggle('hidden', transactions.length > 0);
            transactions.forEach(tx => {
                const isIncome = tx.type === 'income';
                const li = document.createElement('li');
                li.className = 'grid grid-cols-6 gap-2 items-center p-2 rounded-md hover:bg-gray-50 text-sm border-b';
                li.innerHTML = `
                    <span class="text-gray-600 col-span-1">${tx.timestamp ? tx.timestamp.toDate().toLocaleDateString('zh-TW') : '...'}</span>
                    <span class="font-medium col-span-1">${tx.category}</span>
                    <span class="text-gray-500 col-span-1">${tx.project || ''}</span>
                    <span class="text-gray-500 truncate col-span-1">${tx.remarks || ''}</span>
                    <span class="font-bold text-right col-span-1 ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'} ${tx.amount.toLocaleString()}</span>
                    <div class="text-center col-span-1 no-print">
                         <button data-id="${tx.id}" class="edit-btn text-gray-400 hover:text-blue-500 p-1 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                         </button>
                         <button data-id="${tx.id}" class="delete-btn text-gray-400 hover:text-red-500 p-1 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                         </button>
                    </div>
                `;
                filteredTransactionList.appendChild(li);
            });
        }

        function renderDebts(debts) {
            debtList.innerHTML = '';
            debts.forEach(debt => {
                const percentage = debt.totalAmount > 0 ? ((debt.totalAmount - debt.remainingAmount) / debt.totalAmount) * 100 : 100;
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border debt-card-clickable hover:shadow-md transition-shadow';
                card.dataset.id = debt.id;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-md font-bold text-gray-800">${debt.name}</h3>
                        <button class="delete-debt-btn text-gray-400 hover:text-red-500 z-10 relative no-print" data-id="${debt.id}">&times;</button>
                    </div>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>剩餘: NT$ ${debt.remainingAmount.toLocaleString()}</span>
                            <span>總額: NT$ ${debt.totalAmount.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-green-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    <div class="mt-3 text-right no-print">
                        <button class="repay-btn bg-green-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-green-700 z-10 relative text-sm" data-id="${debt.id}" data-name="${debt.name}" data-remaining="${debt.remainingAmount}">償還</button>
                    </div>
                `;
                debtList.appendChild(card);
            });
        }

        function renderEvents(events) {
            eventList.innerHTML = '';
            events.forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.className = 'relative pl-8';
                eventEl.innerHTML = `
                    <div class="absolute left-0 top-1 w-4 h-4 bg-indigo-500 rounded-full -ml-2 border-2 border-white"></div>
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <div class="flex justify-between items-center mb-1">
                            <p class="font-bold text-indigo-800">${event.title}</p>
                            <span class="text-sm text-gray-500">${event.date.toDate().toLocaleDateString('zh-TW')}</span>
                        </div>
                        <p class="text-gray-700 whitespace-pre-wrap">${event.description}</p>
                        <div class="text-right mt-2 no-print">
                             <button class="delete-event-btn text-gray-400 hover:text-red-500 text-xs" data-id="${event.id}">刪除</button>
                        </div>
                    </div>
                `;
                eventList.appendChild(eventEl);
            });
        }

        function renderLendings(lendings) {
            lendingList.innerHTML = '';
            lendings.forEach(lending => {
                const percentage = lending.totalAmount > 0 ? ((lending.totalAmount - lending.remainingAmount) / lending.totalAmount) * 100 : 100;
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-md font-bold text-gray-800">${lending.name}</h3>
                        <button class="delete-lending-btn text-gray-400 hover:text-red-500 z-10 relative no-print" data-id="${lending.id}">&times;</button>
                    </div>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>待收回: NT$ ${lending.remainingAmount.toLocaleString()}</span>
                            <span>總額: NT$ ${lending.totalAmount.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-emerald-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    <div class="mt-3 text-right no-print">
                        <button class="receive-payment-btn bg-emerald-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-emerald-700 z-10 relative text-sm" data-id="${lending.id}" data-name="${lending.name}" data-remaining="${lending.remainingAmount}">收款</button>
                    </div>
                `;
                lendingList.appendChild(card);
            });
        }

        function renderInvestments(investments) {
            investmentList.innerHTML = '';
            investments.forEach(inv => {
                const income = inv.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expense = inv.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const totalCost = expense;
                const profit = income - expense;
                const roi = totalCost > 0 ? (profit / totalCost) * 100 : 0;

                const profitColor = profit >= 0 ? 'text-green-600' : 'text-red-600';
                const roiColor = roi >= 0 ? 'text-teal-600' : 'text-orange-600';

                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-md font-bold text-gray-800 investment-card-clickable flex-grow" data-id="${inv.id}">${inv.name}</h3>
                        <div class="flex items-center no-print">
                            <button class="edit-investment-account-btn text-gray-400 hover:text-blue-500 p-1" data-id="${inv.id}" data-name="${inv.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                            </button>
                            <button class="delete-investment-btn text-gray-400 hover:text-red-500 p-1" data-id="${inv.id}">&times;</button>
                        </div>
                    </div>
                    <div class="mt-2 grid grid-cols-3 gap-y-2 gap-x-4 investment-card-clickable" data-id="${inv.id}">
                        <div>
                            <p class="text-xs text-gray-500">資產現值</p>
                            <p class="text-lg font-bold text-blue-600">NT$ ${(inv.marketValue || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">總報酬 (已實現)</p>
                            <p class="text-lg font-bold ${profitColor}">${profit >= 0 ? '+' : ''}${profit.toLocaleString()}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">報酬率</p>
                            <p class="text-lg font-bold ${roiColor}">${roi.toFixed(2)}%</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">總投資收入</p>
                            <p class="text-lg font-bold text-green-600">NT$ ${income.toLocaleString()}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">總投資支出</p>
                            <p class="text-lg font-bold text-red-600">NT$ ${expense.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-end gap-2 no-print">
                        <button class="update-market-value-btn bg-yellow-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-yellow-600 text-sm" data-id="${inv.id}" data-name="${inv.name}" data-value="${inv.marketValue || 0}">更新現值</button>
                        <button class="add-investment-tx-btn bg-blue-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-700 text-sm" data-id="${inv.id}" data-name="${inv.name}">新增交易</button>
                    </div>
                `;
                investmentList.appendChild(card);
            });
        }
        
        function renderLoanAccounts(loans) {
            loanAccountList.innerHTML = '';
            loans.forEach(loan => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border loan-card-clickable hover:shadow-md transition-shadow';
                card.dataset.id = loan.id;
                
                const monthlyRate = (loan.rateType === 'annual' ? loan.rate / 12 : loan.rate) / 100;
                let nextPaymentHtml = '';

                if (loan.loanType === 'amortization') {
                    const principalPart = loan.totalAmount / loan.term;
                    const interestPart = loan.interestReduction ? (loan.remainingPrincipal * monthlyRate) : (loan.totalAmount * monthlyRate);
                    const nextPayment = principalPart + interestPart;
                    nextPaymentHtml = `<div><span class="text-gray-500">下期應繳金額:</span><span class="font-semibold ml-1">NT$ ${Math.round(nextPayment).toLocaleString()}</span></div>`;
                } else { // interest-only
                    const nextInterest = loan.interestReduction ? (loan.remainingPrincipal * monthlyRate) : (loan.totalAmount * monthlyRate);
                    nextPaymentHtml = `<div><span class="text-gray-500">下期應繳利息:</span><span class="font-semibold ml-1 text-blue-600">NT$ ${Math.round(nextInterest).toLocaleString()}</span></div>`;
                }
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-md font-bold text-gray-800">${loan.name}</h3>
                        <button class="delete-loan-btn text-gray-400 hover:text-red-500 z-10 relative no-print" data-id="${loan.id}">&times;</button>
                    </div>
                    <div class="mt-2 grid grid-cols-2 gap-y-2 gap-x-4 text-sm">
                        <div><span class="text-gray-500">總金額:</span><span class="font-semibold ml-1">NT$ ${loan.totalAmount.toLocaleString()}</span></div>
                        <div><span class="text-gray-500">利率:</span><span class="font-semibold ml-1">${loan.rate}% (${loan.rateType === 'annual' ? '年' : '月'})</span></div>
                        <div><span class="text-gray-500">期數:</span><span class="font-semibold ml-1">${isFinite(loan.term) ? `${loan.term} 月` : 'N/A'}</span></div>
                        ${nextPaymentHtml}
                        <div><span class="text-gray-500">剩餘本金:</span><span class="font-semibold ml-1 text-red-600">NT$ ${loan.remainingPrincipal.toLocaleString()}</span></div>
                        <div><span class="text-gray-500">已還總額:</span><span class="font-semibold ml-1 text-green-600">NT$ ${loan.totalRepaid.toLocaleString()}</span></div>
                    </div>
                    <div class="mt-3 flex justify-end gap-2 no-print">
                        <button class="add-loan-tx-btn bg-cyan-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-cyan-700 text-sm" data-id="${loan.id}" data-name="${loan.name}">新增交易</button>
                    </div>
                `;
                loanAccountList.appendChild(card);
            });
        }

        function renderRepaymentHistory(debtName) {
            const history = allTransactions.filter(tx => tx.category === '負債還款' && tx.project === debtName);
            repaymentHistoryList.innerHTML = '';
            repaymentHistoryEmpty.classList.toggle('hidden', history.length > 0);
            history.forEach(tx => {
                const li = document.createElement('li');
                li.className = 'p-2 bg-gray-50 rounded';
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm text-gray-600">${tx.timestamp.toDate().toLocaleDateString('zh-TW')}</span>
                            ${tx.remarks ? `<p class="text-xs text-gray-500 mt-1">${tx.remarks}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                             <span class="text-sm font-semibold text-red-600">- NT$ ${tx.amount.toLocaleString()}</span>
                             <button data-id="${tx.id}" data-amount="${tx.amount}" class="delete-repayment-btn text-gray-400 hover:text-red-500 p-1 rounded-full no-print">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                             </button>
                        </div>
                    </div>
                `;
                repaymentHistoryList.appendChild(li);
            });
        }

        function renderInvestmentHistory(investmentId) {
            const investment = allInvestments.find(inv => inv.id === investmentId);
            if (!investment) return;
            investmentHistoryList.innerHTML = '';
            investmentHistoryEmpty.classList.toggle('hidden', investment.transactions.length > 0);

            investment.transactions.sort((a,b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0)).forEach(tx => {
                const li = document.createElement('li');
                const isIncome = tx.type === 'income';
                li.className = `p-2 rounded ${isIncome ? 'bg-green-50' : 'bg-red-50'}`;
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-grow">
                            <p class="text-sm text-gray-600">${tx.date.toDate().toLocaleDateString('zh-TW')}</p>
                            <p class="text-sm text-gray-500">${tx.remark || '無備註'}</p>
                        </div>
                        <span class="text-sm font-semibold ${isIncome ? 'text-green-700' : 'text-red-700'}">${isIncome ? '+' : '-'} NT$ ${tx.amount.toLocaleString()}</span>
                        <div class="flex items-center ml-2 no-print">
                            <button class="edit-investment-tx-btn text-gray-400 hover:text-blue-500 p-1" data-investment-id="${investmentId}" data-tx-id="${tx.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                            </button>
                            <button class="delete-investment-tx-btn text-gray-400 hover:text-red-500 p-1" data-investment-id="${investmentId}" data-tx-id="${tx.id}" data-main-tx-id="${tx.mainTransactionId}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                `;
                investmentHistoryList.appendChild(li);
            });
        }
        
        function renderLoanTransactionHistory(loanName) {
            const history = allTransactions.filter(tx => tx.category === '貸款還款' && tx.project === loanName);
            loanHistoryList.innerHTML = '';
            loanHistoryEmpty.classList.toggle('hidden', history.length > 0);
            history.forEach(tx => {
                const li = document.createElement('li');
                li.className = 'p-2 bg-gray-50 rounded';
                const remarks = tx.remarks || '';
                const principalMatch = remarks.match(/還本金: ([\d,]+)/);
                const interestMatch = remarks.match(/還利息: ([\d,]+)/);
                const principal = principalMatch ? principalMatch[1] : '0';
                const interest = interestMatch ? interestMatch[1] : '0';

                li.innerHTML = `
                    <div class="grid grid-cols-4 gap-2 items-center">
                        <span class="text-sm text-gray-600">${tx.timestamp.toDate().toLocaleDateString('zh-TW')}</span>
                        <span class="text-sm">本金: ${principal}</span>
                        <span class="text-sm">利息: ${interest}</span>
                        <div class="flex items-center gap-2 justify-end">
                             <span class="text-sm font-semibold text-red-600">- NT$ ${tx.amount.toLocaleString()}</span>
                             <button data-id="${tx.id}" class="edit-loan-tx-btn text-gray-400 hover:text-blue-500 p-1 rounded-full no-print">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                             </button>
                             <button data-id="${tx.id}" class="delete-loan-tx-btn text-gray-400 hover:text-red-500 p-1 rounded-full no-print">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                             </button>
                        </div>
                    </div>
                `;
                loanHistoryList.appendChild(li);
            });
        }

        function renderCategoryStats(listElement, summaryData, type) {
            listElement.innerHTML = '';
            const sortedSummary = Object.entries(summaryData).sort(([, a], [, b]) => b - a);

            if (sortedSummary.length === 0) {
                listElement.innerHTML = `<li class="text-center text-gray-400 text-sm py-2">無資料</li>`;
                return;
            }
            sortedSummary.forEach(([category, amount]) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between p-2 hover:bg-gray-100 rounded cursor-pointer category-stat-item';
                li.dataset.category = category;
                li.dataset.type = type;
                li.innerHTML = `
                    <span>${category}</span>
                    <span class="font-mono">${amount.toLocaleString()}</span>
                `;
                listElement.appendChild(li);
            });
        }

        function renderBudgetView() {
            const year = selectedBudgetDate.getFullYear();
            const month = selectedBudgetDate.getMonth() + 1;
            
            budgetList.innerHTML = '';
            const budgetAccounts = currentBudget.accounts || {};
            const hasBudgets = Object.keys(budgetAccounts).length > 0;
            budgetEmptyState.classList.toggle('hidden', hasBudgets);

            let totalTarget = 0;

            const startOfMonth = new Date(year, month - 1, 1);
            const endOfMonth = new Date(year, month, 0, 23, 59, 59, 999);
            const monthlyIncomes = allTransactions.filter(tx => {
                if (tx.type !== 'income' || !tx.timestamp) return false;
                const txDate = tx.timestamp.toDate();
                return txDate >= startOfMonth && txDate <= endOfMonth;
            });

            for (const accountName in budgetAccounts) {
                const targetAmount = budgetAccounts[accountName] || 0;
                if (targetAmount <= 0) continue;
                
                totalTarget += targetAmount;

                const currentAmount = monthlyIncomes
                    .filter(tx => tx.project === accountName)
                    .reduce((sum, tx) => sum + tx.amount, 0);

                const progress = targetAmount > 0 ? Math.min(100, (currentAmount / targetAmount) * 100) : 0;
                const remaining = Math.max(0, targetAmount - currentAmount);

                const li = document.createElement('div');
                li.innerHTML = `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="font-bold text-lg text-gray-700">${accountName}</h3>
                            <span class="text-sm font-medium ${progress >= 100 ? 'text-green-600' : 'text-gray-500'}">
                                ${currentAmount.toLocaleString()} / ${targetAmount.toLocaleString()}
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-green-500 h-4 rounded-full text-white text-xs flex items-center justify-center" style="width: ${progress}%;">
                                ${progress > 15 ? `${progress.toFixed(0)}%` : ''}
                            </div>
                        </div>
                        <p class="text-right text-xs text-gray-500 mt-1">尚需 NT$ ${remaining.toLocaleString()}</p>
                    </div>
                `;
                budgetList.appendChild(li);
            }
            budgetTotalTargetEl.textContent = `NT$ ${totalTarget.toLocaleString()}`;
        }

        function renderFixedExpenses(expenses) {
            fixedExpenseList.innerHTML = '';
            expenses.forEach(expense => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
                li.innerHTML = `
                    <span class="font-medium text-gray-800">${expense.name}</span>
                    <div class="flex items-center gap-4">
                        <span class="font-semibold text-red-500">NT$ ${expense.amount.toLocaleString()}</span>
                        <button data-id="${expense.id}" class="delete-fixed-expense-btn text-gray-400 hover:text-red-600 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                fixedExpenseList.appendChild(li);
            });
        }

        function updateSummary(transactions) {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            totalIncomeEl.textContent = `NT$ ${income.toLocaleString()}`;
            totalExpenseEl.textContent = `NT$ ${expense.toLocaleString()}`;
            balanceEl.textContent = `NT$ ${(income - expense).toLocaleString()}`;
        }

        function updateTodaySummary(transactions) {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            todayIncomeEl.textContent = `NT$ ${income.toLocaleString()}`;
            todayExpenseEl.textContent = `NT$ ${expense.toLocaleString()}`;
            todayBalanceEl.textContent = `NT$ ${(income - expense).toLocaleString()}`;
        }

        function updateMonthlySummary(transactions) {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);

            const monthlyTransactions = transactions.filter(tx => {
                 if (!tx.timestamp) return false;
                 const txDate = tx.timestamp.toDate();
                 return txDate >= startOfMonth && txDate <= endOfMonth;
            });

            const income = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            monthlyIncomeEl.textContent = `NT$ ${income.toLocaleString()}`;
            monthlyExpenseEl.textContent = `NT$ ${expense.toLocaleString()}`;
            monthlyBalanceEl.textContent = `NT$ ${(income - expense).toLocaleString()}`;
        }

        function updateDebtSummary(debts) {
            const initialDebt = debts.reduce((sum, d) => sum + d.totalAmount, 0);
            const currentDebt = debts.reduce((sum, d) => sum + d.remainingAmount, 0);
            totalInitialDebtEl.textContent = `NT$ ${initialDebt.toLocaleString()}`;
            totalCurrentDebtEl.textContent = `NT$ ${currentDebt.toLocaleString()}`;
        }

        function updateInvestmentSummary(investments) {
            let totalMarketValue = 0;
            let totalReturn = 0;
            let totalCostAggregated = 0;

            investments.forEach(inv => {
                const income = inv.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expense = inv.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const totalCost = expense;
                const profit = income - expense;

                totalMarketValue += (inv.marketValue || 0);
                totalCostAggregated += totalCost;
                totalReturn += profit;
            });

            const totalRoi = totalCostAggregated > 0 ? (totalReturn / totalCostAggregated) * 100 : 0;

            totalInvestmentValueEl.textContent = `NT$ ${totalMarketValue.toLocaleString()}`;
            totalInvestmentReturnEl.textContent = `NT$ ${totalReturn.toLocaleString()}`;
            totalInvestmentRoiEl.textContent = `${totalRoi.toFixed(2)}%`;

            totalInvestmentReturnEl.className = `text-2xl font-bold mt-2 ${totalReturn >= 0 ? 'text-purple-600' : 'text-red-600'}`;
            totalInvestmentRoiEl.className = `text-2xl font-bold mt-2 ${totalRoi >= 0 ? 'text-teal-600' : 'text-orange-600'}`;
        }

        function updateLendingSummary(lendings) {
            const totalLent = lendings.reduce((sum, l) => sum + l.totalAmount, 0);
            const totalRemaining = lendings.reduce((sum, l) => sum + l.remainingAmount, 0);
            totalLendingAmountEl.textContent = `NT$ ${totalLent.toLocaleString()}`;
            totalLendingRemainingEl.textContent = `NT$ ${totalRemaining.toLocaleString()}`;
        }

        function updateMonthlyRepaymentSummary() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);

            const monthlyRepayments = allTransactions.filter(tx => {
                if (tx.category !== '負債還款' || !tx.timestamp) return false;
                const txDate = tx.timestamp.toDate();
                return txDate >= startOfMonth && txDate <= endOfMonth;
            });

            const totalMonthlyPayment = monthlyRepayments.reduce((sum, tx) => sum + tx.amount, 0);
            totalMonthlyRepaymentEl.textContent = `NT$ ${totalMonthlyPayment.toLocaleString()}`;
        }

        function updateFilteredSummary(transactions) {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            filteredIncomeEl.textContent = `NT$ ${income.toLocaleString()}`;
            filteredExpenseEl.textContent = `NT$ ${expense.toLocaleString()}`;
            filteredBalanceEl.textContent = `NT$ ${(income - expense).toLocaleString()}`;
        }

        function updateExpenseChart() {
            const expenseData = allTransactions.filter(t => t.type === 'expense');
            noExpenseDataMsg.classList.toggle('hidden', expenseData.length > 0);
            expenseChartCanvas.classList.toggle('hidden', expenseData.length === 0);
            if(expenseData.length === 0) { if(expenseChart) expenseChart.destroy(); return; }
            const dataByCategory = expenseData.reduce((acc, curr) => { acc[curr.category] = (acc[curr.category] || 0) + curr.amount; return acc; }, {});
            if (expenseChart) expenseChart.destroy();
            expenseChart = new Chart(expenseChartCanvas, {
                type: 'pie',
                data: { labels: Object.keys(dataByCategory), datasets: [{ label: '支出金額', data: Object.values(dataByCategory), backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40', '#c9cbcf'], hoverOffset: 4 }] },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }

        function updateFixedExpenseSummary(expenses) {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            totalFixedExpenseEl.textContent = `NT$ ${total.toLocaleString()}`;
        }

        // --- UI & Event Listeners ---
        function setupEventListeners() {
            googleLoginBtn.addEventListener('click', () => {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider).catch(error => console.error("Google 登入失敗", error));
            });
            anonymousLoginBtn.addEventListener('click', () => {
                signInAnonymously(auth).catch(error => console.error("匿名登入失敗", error));
            });

            tabAccounting.addEventListener('click', () => switchTab('accounting'));
            tabFixedExpense.addEventListener('click', () => switchTab('fixed-expense'));
            tabBudget.addEventListener('click', () => switchTab('budget'));
            tabInvestment.addEventListener('click', () => switchTab('investment'));
            tabReports.addEventListener('click', () => switchTab('reports'));
            tabDebt.addEventListener('click', () => switchTab('debt'));
            tabLending.addEventListener('click', () => switchTab('lending'));
            tabEvents.addEventListener('click', () => switchTab('events'));
            tabCalculator.addEventListener('click', () => switchTab('calculator'));
            document.getElementById('tab-settings').addEventListener('click', () => switchTab('settings'));

            form.addEventListener('submit', handleFormSubmit);
            fixedExpenseForm.addEventListener('submit', handleFixedExpenseFormSubmit);
            budgetForm.addEventListener('submit', handleBudgetFormSubmit);
            budgetMonthSelect.addEventListener('change', handleBudgetMonthChange);
            debtForm.addEventListener('submit', handleDebtFormSubmit);
            lendingForm.addEventListener('submit', handleLendingFormSubmit);
            eventForm.addEventListener('submit', handleEventFormSubmit);
            investmentForm.addEventListener('submit', handleInvestmentFormSubmit);
            investmentTransactionForm.addEventListener('submit', handleInvestmentTransactionSubmit);
            editInvestmentAccountForm.addEventListener('submit', handleEditInvestmentAccountSubmit);
            updateMarketValueForm.addEventListener('submit', handleUpdateMarketValueSubmit);
            loanCalculatorForm.addEventListener('submit', handleLoanCalculatorSubmit);

            repaymentForm.addEventListener('submit', handleRepaymentSubmit);
            debtEditForm.addEventListener('submit', handleDebtEditSubmit);
            receivePaymentForm.addEventListener('submit', handleReceivePaymentSubmit);

            cancelRepaymentBtn.addEventListener('click', () => repaymentModal.classList.add('hidden'));
            cancelReceivePaymentBtn.addEventListener('click', () => receivePaymentModal.classList.add('hidden'));
            cancelInvestmentTransactionBtn.addEventListener('click', () => investmentTransactionModal.classList.add('hidden'));
            cancelEditInvestmentAccountBtn.addEventListener('click', () => editInvestmentAccountModal.classList.add('hidden'));
            cancelUpdateMarketValueBtn.addEventListener('click', () => updateMarketValueModal.classList.add('hidden'));

            expenseRadio.addEventListener('change', updateTypeSelection);
            document.querySelector('input[name="type"][value="income"]').addEventListener('change', updateTypeSelection);

            setupModal(manageCategoriesBtn, categoryModal, [document.getElementById('close-category-modal-btn'), document.getElementById('close-category-modal-btn-bottom')]);
            setupModal(manageProjectsBtn, projectModal, [document.getElementById('close-project-modal-btn'), document.getElementById('close-project-modal-btn-bottom')]);

            const handleTransactionListClick = (e) => {
                if (e.target.closest('.delete-btn')) {
                    handleDelete(e, '.delete-btn', transactionsColRef);
                } else if (e.target.closest('.edit-btn')) {
                    handleEditTransactionClick(e);
                }
            };
            transactionList.addEventListener('click', handleTransactionListClick);
            filteredTransactionList.addEventListener('click', handleTransactionListClick);

            eventList.addEventListener('click', (e) => handleDelete(e, '.delete-event-btn', eventsColRef));
            fixedExpenseList.addEventListener('click', (e) => handleDelete(e, '.delete-fixed-expense-btn', fixedExpensesColRef));

            debtList.addEventListener('click', (e) => {
                const debtCard = e.target.closest('.debt-card-clickable');
                if (e.target.closest('.repay-btn') || e.target.closest('.delete-debt-btn')) {
                    e.stopPropagation();
                     handleDelete(e, '.delete-debt-btn', debtsColRef);
                    handleRepayClick(e);
                    return;
                }
                if (debtCard) handleDebtCardClick(debtCard.dataset.id);
            });
            lendingList.addEventListener('click', (e) => {
                if (e.target.closest('.receive-payment-btn')) handleReceivePaymentClick(e);
                if (e.target.closest('.delete-lending-btn')) handleDelete(e, '.delete-lending-btn', lendingsColRef);
            });
            investmentList.addEventListener('click', (e) => {
                const cardClick = e.target.closest('.investment-card-clickable');
                const addTxBtn = e.target.closest('.add-investment-tx-btn');
                const editAccountBtn = e.target.closest('.edit-investment-account-btn');
                const deleteBtn = e.target.closest('.delete-investment-btn');
                const updateValueBtn = e.target.closest('.update-market-value-btn');

                if (addTxBtn) handleAddInvestmentTxClick(addTxBtn);
                else if (editAccountBtn) handleEditInvestmentAccountClick(editAccountBtn);
                else if (deleteBtn) handleDelete(deleteBtn, '.delete-investment-btn', investmentsColRef);
                else if (updateValueBtn) handleUpdateMarketValueClick(updateValueBtn);
                else if (cardClick) handleInvestmentCardClick(cardClick.dataset.id);
            });
            
            loanAccountList.addEventListener('click', (e) => {
                const card = e.target.closest('.loan-card-clickable');
                if (e.target.closest('.add-loan-tx-btn') || e.target.closest('.delete-loan-btn')) {
                    e.stopPropagation();
                    if(e.target.closest('.add-loan-tx-btn')) handleAddLoanTxClick(e);
                    if(e.target.closest('.delete-loan-btn')) handleDelete(e, '.delete-loan-btn', loansColRef);
                    return;
                }
                if(card) handleLoanCardClick(card.dataset.id);
            });

            customCategoryList.addEventListener('click', (e) => handleDelete(e, '.delete-category-btn', categoriesColRef));
            customProjectList.addEventListener('click', (e) => handleDelete(e, '.delete-project-btn', projectsColRef));
            filterThisMonthBtn.addEventListener('click', handleFilterThisMonth);
            filterCustomDateBtn.addEventListener('click', handleFilterCustomDate);
            closeDebtDetailModalBtn.addEventListener('click', () => debtDetailModal.classList.add('hidden'));
            editDebtBtn.addEventListener('click', toggleDebtEditView);
            cancelEditDebtBtn.addEventListener('click', toggleDebtEditView);
            repaymentHistoryList.addEventListener('click', handleDeleteRepayment);
            closeInvestmentDetailModalBtn.addEventListener('click', () => investmentDetailModal.classList.add('hidden'));
            investmentHistoryList.addEventListener('click', (e) => {
                if (e.target.closest('.delete-investment-tx-btn')) handleDeleteInvestmentTx(e);
                if (e.target.closest('.edit-investment-tx-btn')) handleEditInvestmentTxClick(e);
            });
            expenseStatsList.addEventListener('click', handleCategoryClick);
            incomeStatsList.addEventListener('click', handleCategoryClick);
            backupBtn.addEventListener('click', handleBackup);
            printTransactionsBtn.addEventListener('click', () => handlePrint('#main-transaction-list-section'));
            printReportBtn.addEventListener('click', () => handlePrint('#filtered-transaction-list-section'));
            printDebtDetailBtn.addEventListener('click', () => handlePrint('#debt-detail-modal'));
            printInvestmentDetailBtn.addEventListener('click', () => handlePrint('#investment-detail-modal'));
            historyDateFilter.addEventListener('change', renderMainTransactionList);
            showTodayBtn.addEventListener('click', () => {
                historyDateFilter.value = new Date().toISOString().split('T')[0];
                renderMainTransactionList();
            });
            window.addEventListener('afterprint', handleAfterPrint);
            calculatorPasswordForm.addEventListener('submit', handleCalculatorPasswordSubmit);
            loanTransactionForm.addEventListener('submit', handleLoanTransactionSubmit);
            cancelLoanTransactionBtn.addEventListener('click', () => loanTransactionModal.classList.add('hidden'));
            loanTypeSelect.addEventListener('change', handleLoanTypeChange);
            closeLoanDetailModalBtn.addEventListener('click', () => loanDetailModal.classList.add('hidden'));
            document.getElementById('loan-detail-interest-reduction').addEventListener('change', handleInterestReductionToggle);
            loanHistoryList.addEventListener('click', (e) => {
                if(e.target.closest('.edit-loan-tx-btn')) handleEditLoanTxClick(e);
                if(e.target.closest('.delete-loan-tx-btn')) handleDeleteLoanTx(e);
            });
        }

        function switchTab(tabName) {
            const views = { accounting: accountingView, 'fixed-expense': fixedExpenseView, budget: budgetView, investment: investmentView, reports: reportsView, debt: debtView, lending: lendingView, events: eventsView, calculator: calculatorView, settings: document.getElementById('settings-view') };
            const tabs = { accounting: tabAccounting, 'fixed-expense': tabFixedExpense, budget: tabBudget, investment: tabInvestment, reports: tabReports, debt: tabDebt, lending: tabLending, events: tabEvents, calculator: tabCalculator, settings: document.getElementById('tab-settings') };

            for (const key in views) {
                const isHidden = key !== tabName;
                views[key].classList.toggle('hidden', isHidden);
                tabs[key].classList.toggle('active', !isHidden);
            }
            
            if (tabName === 'calculator' && !calculatorView.dataset.unlocked) {
                calculatorPasswordModal.classList.remove('hidden');
            } else {
                 calculatorPasswordModal.classList.add('hidden');
            }

            if(tabName === 'reports') {
                updateExpenseChart();
                handleFilterThisMonth();
            }
        }
        
        function renderMainTransactionList() {
            const filterDateStr = historyDateFilter.value;
            let dateToFilter;

            if (filterDateStr) {
                dateToFilter = new Date(filterDateStr);
            } else {
                dateToFilter = new Date();
                historyDateFilter.value = dateToFilter.toISOString().split('T')[0];
            }

            // Adjust for timezone offset to compare dates correctly
            const userTimezoneOffset = dateToFilter.getTimezoneOffset() * 60000;
            const startOfDay = new Date(dateToFilter.getFullYear(), dateToFilter.getMonth(), dateToFilter.getDate());
            const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);

            const filteredTransactions = allTransactions.filter(tx => {
                if (!tx.timestamp) return false;
                const txDate = tx.timestamp.toDate();
                return txDate >= startOfDay && txDate < endOfDay;
            });

            renderTransactions(filteredTransactions);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (startOfDay.getTime() === today.getTime()) {
                historyDisplayDateEl.textContent = `本日 (${startOfDay.toLocaleDateString('zh-TW')}) 紀錄`;
            } else {
                historyDisplayDateEl.textContent = `${startOfDay.toLocaleDateString('zh-TW')} 紀錄`;
            }

            emptyState.classList.toggle('hidden', filteredTransactions.length > 0 || allTransactions.length > 0);
             if (filteredTransactions.length === 0 && allTransactions.length > 0) {
                emptyState.textContent = '此日期無交易紀錄。';
            } else if (allTransactions.length === 0) {
                 emptyState.textContent = '還沒有任何紀錄，快來新增第一筆吧！';
            }
        }

        function resetTransactionForm() {
            form.reset();
            document.getElementById('transaction-id').value = '';
            transactionDateInput.valueAsDate = new Date();
            submitBtnText.textContent = '新增紀錄';
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            updateTypeSelection();
        }

        function handleEditTransactionClick(e) {
            const editBtn = e.target.closest('.edit-btn');
            if (!editBtn) return;

            const txId = editBtn.dataset.id;
            const tx = allTransactions.find(t => t.id === txId);

            if (tx) {
                document.getElementById('transaction-id').value = tx.id;
                
                if (tx.type === 'income') {
                    document.getElementById('type-income').checked = true;
                } else {
                    document.getElementById('type-expense').checked = true;
                }
                updateTypeSelection(); 

                amountInput.value = tx.amount;
                transactionDateInput.value = tx.timestamp.toDate().toISOString().split('T')[0];
                categoryInput.value = tx.category;
                projectInput.value = tx.project || '';
                remarksInput.value = tx.remarks || '';

                submitBtnText.textContent = '儲存變更';
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitButton.classList.add('bg-green-600', 'hover:bg-green-700');

                form.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!userId) return;
            
            const txId = document.getElementById('transaction-id').value;
            const amount = parseFloat(amountInput.value);
            const category = categoryInput.value.trim();
            const project = projectInput.value.trim();
            const date = transactionDateInput.value;
            
            if (isNaN(amount) || amount <= 0 || category === '' || !date) { 
                console.warn("請輸入有效的金額、分類和日期！"); 
                return; 
            }

            submitBtnText.classList.add('hidden'); 
            submitSpinner.classList.remove('hidden'); 
            form.querySelector('button[type="submit"]').disabled = true;

            try {
                await saveNewCustomItemIfNeeded(category, customCategories, categoriesColRef);
                if (project) await saveNewCustomItemIfNeeded(project, customProjects, projectsColRef);

                const payload = {
                    type: document.querySelector('input[name="type"]:checked').value,
                    amount,
                    category,
                    project,
                    remarks: remarksInput.value.trim(),
                    timestamp: Timestamp.fromDate(new Date(date))
                };

                if (txId) {
                    const txRef = doc(transactionsColRef, txId);
                    await updateDoc(txRef, payload);
                } else {
                    await addDoc(transactionsColRef, payload);
                }
                
                resetTransactionForm();
            } catch (error) { 
                console.error("處理紀錄失敗:", error); 
            } finally { 
                submitBtnText.classList.remove('hidden'); 
                submitSpinner.classList.add('hidden'); 
                form.querySelector('button[type="submit"]').disabled = false; 
            }
        }

        async function handleBudgetFormSubmit(e) {
            e.preventDefault();
            const accountName = budgetAccountSelect.value;
            const targetAmount = parseFloat(budgetAmountInput.value);

            if (!accountName || isNaN(targetAmount) || targetAmount < 0) {
                alert("請選擇一個投資帳戶並輸入有效的預算金額。");
                return;
            }

            const btnText = document.getElementById('budget-submit-btn-text');
            const spinner = document.getElementById('budget-submit-spinner');
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');
            budgetForm.querySelector('button[type="submit"]').disabled = true;
            
            const year = selectedBudgetDate.getFullYear();
            const month = String(selectedBudgetDate.getMonth() + 1).padStart(2, '0');
            const budgetId = `${year}-${month}`;
            const budgetDocRef = doc(budgetsColRef, budgetId);

            try {
                await setDoc(budgetDocRef, { 
                    accounts: {
                        [accountName]: targetAmount
                    } 
                }, { merge: true });
                budgetForm.reset();
                populateBudgetAccountSelect();
            } catch (error) {
                console.error("儲存預算失敗:", error);
                alert("儲存預算失敗，請稍後再試。");
            } finally {
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
                budgetForm.querySelector('button[type="submit"]').disabled = false;
            }
        }

        function handleBudgetMonthChange() {
            const [year, month] = budgetMonthSelect.value.split('-');
            selectedBudgetDate = new Date(year, month - 1, 1);
            listenForBudgets();
        }

        async function handleDebtFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('debt-name').value.trim();
            const totalAmount = parseFloat(document.getElementById('debt-total-amount').value);
            if (name === '' || isNaN(totalAmount) || totalAmount <= 0) { console.warn("請輸入有效的負債項目和金額"); return; }

            const btnText = document.getElementById('add-debt-btn-text'), spinner = document.getElementById('add-debt-spinner');
            btnText.classList.add('hidden'); spinner.classList.remove('hidden'); debtForm.querySelector('button[type="submit"]').disabled = true;
            try {
                await addDoc(debtsColRef, { name, totalAmount, remainingAmount: totalAmount, createdAt: Timestamp.now() });
                debtForm.reset();
            } catch (error) { console.error("新增負債失敗:", error); }
            finally { btnText.classList.remove('hidden'); spinner.classList.add('hidden'); debtForm.querySelector('button[type="submit"]').disabled = false; }
        }

        async function handleEventFormSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('event-date').value;
            const title = document.getElementById('event-title').value.trim();
            const description = document.getElementById('event-description').value.trim();
            if (!date || title === '') { console.warn("請輸入日期和標題"); return; }

            try {
                await addDoc(eventsColRef, {
                    date: Timestamp.fromDate(new Date(date)),
                    title,
                    description,
                    createdAt: Timestamp.now()
                });
                eventForm.reset();
                document.getElementById('event-date').valueAsDate = new Date();
            } catch (error) {
                console.error("新增事件失敗:", error);
            }
        }

        async function handleLendingFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('lending-name').value.trim();
            const totalAmount = parseFloat(document.getElementById('lending-total-amount').value);
            if (name === '' || isNaN(totalAmount) || totalAmount <= 0) { console.warn("請輸入有效的借款項目和金額"); return; }

            try {
                await addDoc(lendingsColRef, { name, totalAmount, remainingAmount: totalAmount, createdAt: Timestamp.now() });
                await addDoc(transactionsColRef, { type: 'expense', amount: totalAmount, category: '債權借出', project: name, remarks: `借款給: ${name}`, timestamp: Timestamp.now() });
                lendingForm.reset();
            } catch (error) { console.error("新增債權失敗:", error); }
        }

        async function handleInvestmentFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('investment-name').value.trim();
            const initialValue = parseFloat(document.getElementById('investment-initial-value').value) || 0;
            if (name === '') { console.warn("請輸入有效的帳戶名稱"); return; }

            try {
                const now = new Date();
                const timestamp = Timestamp.fromDate(now);

                const newInvestmentRef = await addDoc(investmentsColRef, {
                     name,
                     initialValue,
                     marketValue: initialValue,
                     createdAt: timestamp
                 });

                if (initialValue > 0) {
                    const mainTxPayload = {
                        type: 'expense',
                         amount: initialValue,
                         category: '投資支出',
                         project: name,
                         remarks: `建立投資帳戶: ${name}`,
                         timestamp: timestamp
                    };
                    const mainTxRef = await addDoc(transactionsColRef, mainTxPayload);

                    const investmentTxColRef = collection(db, `${investmentsColRef.path}/${newInvestmentRef.id}/transactions`);
                    await addDoc(investmentTxColRef, {
                        date: timestamp,
                        type: 'expense',
                        amount: initialValue,
                        remark: '初始投入金額',
                        mainTransactionId: mainTxRef.id
                    });
                }
                investmentForm.reset();
            } catch (error) { console.error("新增投資帳戶失敗:", error); }
        }

        function handleAddInvestmentTxClick(btn) {
            if(btn) {
                investmentTransactionForm.reset();
                document.getElementById('investment-transaction-title').textContent = `新增交易至 "${btn.dataset.name}"`;
                document.getElementById('investment-transaction-account-id').value = btn.dataset.id;
                document.getElementById('investment-transaction-account-name').value = btn.dataset.name;
                document.getElementById('investment-transaction-id').value = '';
                document.getElementById('investment-main-transaction-id').value = '';
                document.getElementById('investment-transaction-date').valueAsDate = new Date();
                investmentTransactionModal.classList.remove('hidden');
            }
        }

        async function handleInvestmentTransactionSubmit(e) {
            e.preventDefault();
            const accountId = document.getElementById('investment-transaction-account-id').value;
            const accountName = document.getElementById('investment-transaction-account-name').value;
            const txId = document.getElementById('investment-transaction-id').value;
            const mainTxId = document.getElementById('investment-main-transaction-id').value;
            const date = document.getElementById('investment-transaction-date').value;
            const type = document.getElementById('investment-transaction-type').value;
            const amount = parseFloat(document.getElementById('investment-transaction-amount').value);
            const remark = document.getElementById('investment-transaction-remark').value.trim();

            if (!accountId || !date || isNaN(amount) || amount <= 0) {
                console.warn("請填寫完整交易資訊");
                return;
            }

            const transactionTimestamp = Timestamp.fromDate(new Date(date));
            const investmentTxColRef = collection(db, `${investmentsColRef.path}/${accountId}/transactions`);

            const mainTxPayload = {
                type: type,
                amount: amount,
                category: type === 'income' ? '投資收入' : '投資支出',
                project: accountName,
                remarks: remark,
                timestamp: transactionTimestamp
            };

            try {
                if (txId && mainTxId) {
                    const investmentTxRef = doc(investmentTxColRef, txId);
                    const mainTxRef = doc(transactionsColRef, mainTxId);

                    const batch = writeBatch(db);
                    batch.update(investmentTxRef, { date: transactionTimestamp, type, amount, remark });
                    batch.update(mainTxRef, mainTxPayload);
                    await batch.commit();

                } else {
                    const mainTxRef = await addDoc(transactionsColRef, mainTxPayload);
                    await addDoc(investmentTxColRef, { ...mainTxPayload, date: transactionTimestamp, remark: remark, mainTransactionId: mainTxRef.id });
                }

                investmentTransactionForm.reset();
                investmentTransactionModal.classList.add('hidden');
                listenForInvestments();
            } catch (error) {
                console.error("處理投資交易失敗:", error);
            }
        }

        async function handleDeleteInvestmentTx(e) {
            const deleteBtn = e.target.closest('.delete-investment-tx-btn');
            if (deleteBtn) {
                const investmentId = deleteBtn.dataset.investmentId;
                const txId = deleteBtn.dataset.txId;
                const mainTxId = deleteBtn.dataset.mainTxId;

                if (investmentId && txId) {
                    const txDocRef = doc(db, investmentsColRef.path, investmentId, 'transactions', txId);
                    try {
                        deleteBtn.disabled = true;
                        const batch = writeBatch(db);
                        batch.delete(txDocRef);
                        if (mainTxId) {
                            const mainTxRef = doc(transactionsColRef, mainTxId);
                            batch.delete(mainTxRef);
                        }
                        await batch.commit();

                        listenForInvestments();

                        if (!investmentDetailModal.classList.contains('hidden')) {
                           renderInvestmentHistory(investmentId);
                        }
                    } catch (error) {
                        console.error("刪除投資交易失敗:", error);
                        deleteBtn.disabled = false;
                    }
                }
            }
        }

        function handleEditInvestmentAccountClick(btn) {
            const accountId = btn.dataset.id;
            const accountName = btn.dataset.name;
            document.getElementById('edit-investment-account-id').value = accountId;
            document.getElementById('edit-investment-account-name').value = accountName;
            editInvestmentAccountModal.classList.remove('hidden');
        }

        async function handleEditInvestmentAccountSubmit(e) {
            e.preventDefault();
            const accountId = document.getElementById('edit-investment-account-id').value;
            const newName = document.getElementById('edit-investment-account-name').value.trim();
            if (!accountId || newName === '') return;

            const accountRef = doc(investmentsColRef, accountId);
            try {
                await updateDoc(accountRef, { name: newName });
                editInvestmentAccountModal.classList.add('hidden');
                listenForInvestments();
            } catch (error) {
                console.error("更新投資帳戶名稱失敗:", error);
            }
        }

        async function handleEditInvestmentTxClick(e) {
            const editBtn = e.target.closest('.edit-investment-tx-btn');
            if (!editBtn) return;

            const investmentId = editBtn.dataset.investmentId;
            const txId = editBtn.dataset.txId;

            const investment = allInvestments.find(inv => inv.id === investmentId);
            const tx = investment?.transactions.find(t => t.id === txId);

            if (investment && tx) {
                document.getElementById('investment-transaction-title').textContent = `編輯交易 "${investment.name}"`;
                document.getElementById('investment-transaction-account-id').value = investmentId;
                document.getElementById('investment-transaction-account-name').value = investment.name;
                document.getElementById('investment-transaction-id').value = txId;
                document.getElementById('investment-main-transaction-id').value = tx.mainTransactionId || '';
                document.getElementById('investment-transaction-date').value = tx.date.toDate().toISOString().split('T')[0];
                document.getElementById('investment-transaction-type').value = tx.type;
                document.getElementById('investment-transaction-amount').value = tx.amount;
                document.getElementById('investment-transaction-remark').value = tx.remark || '';

                investmentTransactionModal.classList.remove('hidden');
            }
        }

        function handleUpdateMarketValueClick(btn) {
            const id = btn.dataset.id;
            const name = btn.dataset.name;
            const value = btn.dataset.value;
            document.getElementById('update-market-value-title').textContent = `更新 "${name}" 的現值`;
            document.getElementById('update-market-value-id').value = id;
            document.getElementById('update-market-value-amount').value = value;
            updateMarketValueModal.classList.remove('hidden');
        }

        async function handleUpdateMarketValueSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('update-market-value-id').value;
            const amount = parseFloat(document.getElementById('update-market-value-amount').value);
            if (!id || isNaN(amount) || amount < 0) {
                console.warn("請輸入有效的金額");
                return;
            }
            const investmentRef = doc(investmentsColRef, id);
            try {
                await updateDoc(investmentRef, { marketValue: amount });
                updateMarketValueModal.classList.add('hidden');
                listenForInvestments();
            } catch(error) {
                console.error("更新資產現值失敗:", error);
            }
        }

        function handleRepayClick(e) {
            const repayBtn = e.target.closest('.repay-btn');
            if (repayBtn) {
                repaymentDebtIdInput.value = repayBtn.dataset.id;
                repaymentDebtNameInput.value = repayBtn.dataset.name;
                repaymentAmountInput.max = repayBtn.dataset.remaining;
                repaymentDateInput.valueAsDate = new Date();
                repaymentModal.classList.remove('hidden');
                repaymentAmountInput.focus();
            }
        }

        function handleReceivePaymentClick(e) {
            const receiveBtn = e.target.closest('.receive-payment-btn');
            if (receiveBtn) {
                receivePaymentLendingIdInput.value = receiveBtn.dataset.id;
                receivePaymentLendingNameInput.value = receiveBtn.dataset.name;
                receivePaymentAmountInput.max = receiveBtn.dataset.remaining;
                receivePaymentDateInput.valueAsDate = new Date();
                receivePaymentModal.classList.remove('hidden');
                receivePaymentAmountInput.focus();
            }
        }

        function handleDebtCardClick(debtId) {
            const debt = allDebts.find(d => d.id === debtId);
            if (!debt) return;

            const now = new Date(), startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1), endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            const monthlyRepayments = allTransactions.filter(tx => tx.category === '負債還款' && tx.project === debt.name && tx.timestamp && tx.timestamp.toDate() >= startOfMonth && tx.timestamp.toDate() <= endOfMonth);
            const totalMonthlyPaymentForDebt = monthlyRepayments.reduce((sum, tx) => sum + tx.amount, 0);

            debtDetailName.textContent = debt.name;
            debtDetailTotal.textContent = `NT$ ${debt.totalAmount.toLocaleString()}`;
            debtDetailMonthlyRepayment.textContent = `NT$ ${totalMonthlyPaymentForDebt.toLocaleString()}`;
            editDebtIdInput.value = debt.id;
            editDebtNameInput.value = debt.name;
            editDebtTotalInput.value = debt.totalAmount;
            renderRepaymentHistory(debt.name);
            debtDetailDisplayView.classList.remove('hidden');
            debtEditForm.classList.add('hidden');
            debtDetailModal.classList.remove('hidden');
        }

        function handleInvestmentCardClick(investmentId) {
            const investment = allInvestments.find(inv => inv.id === investmentId);
            if (!investment) return;

            document.getElementById('investment-detail-title').textContent = `"${investment.name}" 交易紀錄`;
            renderInvestmentHistory(investment.id);
            investmentDetailModal.classList.remove('hidden');
        }
        
        function handleLoanCardClick(loanId) {
            const loan = allLoans.find(l => l.id === loanId);
            if (!loan) return;

            document.getElementById('loan-detail-title').textContent = `"${loan.name}" 詳情`;
            
            const summaryEl = document.getElementById('loan-detail-summary');
            const monthlyRate = (loan.rateType === 'annual' ? loan.rate / 12 : loan.rate) / 100;
            
            let nextPaymentHtml = '';
            if (loan.loanType === 'amortization') {
                 const principalPart = loan.totalAmount / loan.term;
                 const interestPart = loan.interestReduction ? (loan.remainingPrincipal * monthlyRate) : (loan.totalAmount * monthlyRate);
                 const nextPayment = principalPart + interestPart;
                 nextPaymentHtml = `<div><span class="text-gray-500">下期應繳金額:</span><span class="font-semibold ml-1">NT$ ${Math.round(nextPayment).toLocaleString()}</span></div>`;
            } else {
                const nextInterest = loan.interestReduction ? (loan.remainingPrincipal * monthlyRate) : (loan.totalAmount * monthlyRate);
                nextPaymentHtml = `<div><span class="text-gray-500">下期應繳利息:</span><span class="font-semibold ml-1 text-blue-600">NT$ ${Math.round(nextInterest).toLocaleString()}</span></div>`;
            }
            
            summaryEl.innerHTML = `
                <div class="grid grid-cols-2 gap-y-2 gap-x-4 text-sm">
                    <div><span class="text-gray-500">總金額:</span><span class="font-semibold ml-1">NT$ ${loan.totalAmount.toLocaleString()}</span></div>
                    <div><span class="text-gray-500">利率:</span><span class="font-semibold ml-1">${loan.rate}% (${loan.rateType === 'annual' ? '年' : '月'})</span></div>
                    <div><span class="text-gray-500">期數:</span><span class="font-semibold ml-1">${isFinite(loan.term) ? `${loan.term} 月` : 'N/A'}</span></div>
                    ${nextPaymentHtml}
                    <div><span class="text-gray-500">剩餘本金:</span><span class="font-semibold ml-1 text-red-600">NT$ ${loan.remainingPrincipal.toLocaleString()}</span></div>
                    <div><span class="text-gray-500">已還總額:</span><span class="font-semibold ml-1 text-green-600">NT$ ${loan.totalRepaid.toLocaleString()}</span></div>
                </div>
            `;
            
            const interestReductionToggle = document.getElementById('loan-detail-interest-reduction');
            interestReductionToggle.checked = loan.interestReduction;
            interestReductionToggle.dataset.id = loanId;
            
            renderLoanTransactionHistory(loan.name);
            loanDetailModal.classList.remove('hidden');
        }

        function toggleDebtEditView() {
            debtDetailDisplayView.classList.toggle('hidden');
            debtEditForm.classList.toggle('hidden');
        }

        async function handleDebtEditSubmit(e) {
            e.preventDefault();
            const debtId = editDebtIdInput.value, newName = editDebtNameInput.value.trim(), newTotal = parseFloat(editDebtTotalInput.value);
            if (!debtId || newName === '' || isNaN(newTotal) || newTotal < 0) { console.warn("請輸入有效的項目名稱和總金額"); return; }

            const debtRef = doc(db, debtsColRef.path, debtId);
            try {
                const currentDebt = allDebts.find(d => d.id === debtId);
                if (!currentDebt) { console.error("找不到要編輯的負債"); return; }

                const amountPaid = currentDebt.totalAmount - currentDebt.remainingAmount;
                const newRemainingAmount = newTotal - amountPaid;

                await updateDoc(debtRef, { name: newName, totalAmount: newTotal, remainingAmount: newRemainingAmount < 0 ? 0 : newRemainingAmount });
                debtDetailModal.classList.add('hidden');
            } catch (error) { console.error("更新負債失敗:", error); }
        }

        async function handleRepaymentSubmit(e) {
            e.preventDefault();
            const debtId = repaymentDebtIdInput.value, debtName = repaymentDebtNameInput.value, amount = parseFloat(repaymentAmountInput.value), date = repaymentDateInput.value;
            const remark = document.getElementById('repayment-remark').value.trim();
            if (isNaN(amount) || amount <= 0 || !date) { console.warn("請輸入有效的還款金額和日期"); return; }

            const timestamp = Timestamp.fromDate(new Date(date));

            const debtRef = doc(db, debtsColRef.path, debtId);
            try {
                await updateDoc(debtRef, { remainingAmount: increment(-amount) });
                await addDoc(transactionsColRef, { type: 'expense', amount: amount, category: '負債還款', project: debtName, remarks: remark || `償還負債: ${debtName}`, timestamp: timestamp });
                repaymentForm.reset();
                repaymentModal.classList.add('hidden');
            } catch (error) { console.error("更新還款失敗:", error); }
        }

        async function handleDeleteRepayment(e) {
            const deleteBtn = e.target.closest('.delete-repayment-btn');
            if (!deleteBtn) return;

            const txId = deleteBtn.dataset.id;
            const amountToRestore = parseFloat(deleteBtn.dataset.amount);
            const debtId = editDebtIdInput.value;

            if (!txId || !debtId || isNaN(amountToRestore)) {
                console.error("無法刪除還款紀錄：缺少必要資訊。");
                return;
            }

            const txRef = doc(transactionsColRef, txId);
            const debtRef = doc(debtsColRef, debtId);

            try {
                deleteBtn.disabled = true;
                const batch = writeBatch(db);
                batch.delete(txRef);
                batch.update(debtRef, { remainingAmount: increment(amountToRestore) });
                await batch.commit();
                handleDebtCardClick(debtId);
            } catch (error) {
                console.error("刪除還款紀錄失敗:", error);
                deleteBtn.disabled = false;
            }
        }

        async function handleReceivePaymentSubmit(e) {
            e.preventDefault();
            const lendingId = receivePaymentLendingIdInput.value, lendingName = receivePaymentLendingNameInput.value, amount = parseFloat(receivePaymentAmountInput.value), date = receivePaymentDateInput.value;
            if (isNaN(amount) || amount <= 0 || !date) { console.warn("請輸入有效的收款金額和日期"); return; }

            const timestamp = Timestamp.fromDate(new Date(date));

            const lendingRef = doc(db, lendingsColRef.path, lendingId);
            try {
                await updateDoc(lendingRef, { remainingAmount: increment(-amount) });
                await addDoc(transactionsColRef, { type: 'income', amount: amount, category: '債權回收', project: lendingName, remarks: `收到還款: ${lendingName}`, timestamp: timestamp });
                receivePaymentForm.reset();
                receivePaymentModal.classList.add('hidden');
            } catch (error) { console.error("更新收款失敗:", error); }
        }

        async function handleDelete(eventOrElement, selector, collectionRef) {
            const deleteBtn = eventOrElement.target ? eventOrElement.target.closest(selector) : eventOrElement;
            if (deleteBtn && collectionRef) {
                const id = deleteBtn.dataset.id;
                try {
                    deleteBtn.disabled = true;
                    await deleteDoc(doc(db, collectionRef.path, id));
                } catch (error) { console.error("刪除失敗:", error); deleteBtn.disabled = false; }
            }
        }

        function handleFilterThisMonth() {
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            const end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            startDateInput.value = start.toISOString().split('T')[0];
            endDateInput.value = end.toISOString().split('T')[0];
            filterAndRenderDetails(start, end);
        }

        function handleFilterCustomDate() {
            const startVal = startDateInput.value, endVal = endDateInput.value;
            if (!startVal || !endVal) { console.warn("請選擇開始與結束日期"); return; }
            const start = new Date(startVal), end = new Date(endVal);
            end.setHours(23, 59, 59, 999);
            filterAndRenderDetails(start, end);
        }

        function filterAndRenderDetails(startDate, endDate, category = null, type = null) {
            let filtered = allTransactions.filter(tx => {
                if (!tx.timestamp) return false;
                const txDate = tx.timestamp.toDate();
                return txDate >= startDate && txDate <= endDate;
            });

            const expenseSummary = {};
            const incomeSummary = {};
            filtered.forEach(tx => {
                if (tx.type === 'expense') {
                    expenseSummary[tx.category] = (expenseSummary[tx.category] || 0) + tx.amount;
                } else {
                    incomeSummary[tx.category] = (incomeSummary[tx.category] || 0) + tx.amount;
                }
            });
            renderCategoryStats(expenseStatsList, expenseSummary, 'expense');
            renderCategoryStats(incomeStatsList, incomeSummary, 'income');

            if (category && type) {
                filtered = filtered.filter(tx => tx.category === category && tx.type === type);
                activeCategoryFilter = { type, category };
            } else {
                activeCategoryFilter = { type: null, category: null };
            }

            renderFilteredTransactions(filtered);
            updateFilteredSummary(filtered);
        }

        function handleCategoryClick(e) {
            const statItem = e.target.closest('.category-stat-item');
            if (!statItem) return;

            document.querySelectorAll('.category-stat-item').forEach(item => item.classList.remove('active'));

            const category = statItem.dataset.category;
            const type = statItem.dataset.type;

            if (activeCategoryFilter.category === category && activeCategoryFilter.type === type) {
                handleFilterCustomDate();
            } else {
                statItem.classList.add('active');
                const start = new Date(startDateInput.value);
                const end = new Date(endDateInput.value);
                end.setHours(23, 59, 59, 999);
                filterAndRenderDetails(start, end, category, type);
            }
        }
        
        async function handleLoanCalculatorSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('loan-name').value.trim();
            const amount = parseFloat(document.getElementById('loan-amount').value);
            const rate = parseFloat(document.getElementById('interest-rate').value);
            const rateType = document.getElementById('rate-type').value;
            const term = parseInt(loanTermInput.value);
            const loanType = loanTypeSelect.value;
            const interestReduction = document.getElementById('interest-reduction-checkbox').checked;

            let isInvalid = isNaN(amount) || isNaN(rate) || amount <= 0 || rate <= 0 || name === '';
            if (loanType === 'amortization' && (isNaN(term) || term <= 0)) {
                isInvalid = true;
            }

            if (isInvalid) {
                alert("請輸入有效的貸款名稱、金額、利率與期數。");
                return;
            }
            
            const loanData = {
                name,
                totalAmount: amount,
                rate: rate,
                rateType: rateType,
                term: loanType === 'amortization' ? term : Infinity,
                loanType,
                interestReduction,
                remainingPrincipal: amount,
                totalRepaid: 0,
                createdAt: Timestamp.now()
            };

            try {
                await addDoc(loansColRef, loanData);
                loanCalculatorForm.reset();
            } catch (error) {
                console.error("建立貸款帳戶失敗:", error);
            }
        }
        
        function handleAddLoanTxClick(e) {
            const btn = e.target.closest('.add-loan-tx-btn');
            if(btn) {
                const accountId = btn.dataset.id;
                const accountName = btn.dataset.name;
                loanTransactionForm.reset();
                document.getElementById('loan-transaction-account-id').value = accountId;
                document.getElementById('loan-transaction-id').value = '';
                document.getElementById('loan-transaction-title').textContent = `新增還款至 "${accountName}"`;
                document.getElementById('submit-loan-transaction-btn').textContent = '確認還款';
                document.getElementById('loan-repayment-date').valueAsDate = new Date();
                loanTransactionModal.classList.remove('hidden');
            }
        }
        
        async function handleLoanTransactionSubmit(e) {
            e.preventDefault();
            const accountId = document.getElementById('loan-transaction-account-id').value;
            const txId = document.getElementById('loan-transaction-id').value;
            const principal = parseFloat(document.getElementById('loan-repayment-principal').value) || 0;
            const interest = parseFloat(document.getElementById('loan-repayment-interest').value) || 0;
            const date = document.getElementById('loan-repayment-date').value;

            if (!accountId || (principal <= 0 && interest <= 0) || !date) {
                alert("請輸入有效的還款金額與日期。");
                return;
            }
            
            const totalPayment = principal + interest;
            const loanRef = doc(loansColRef, accountId);
            const loanAccount = allLoans.find(l => l.id === accountId);

            try {
                if (txId) {
                    const originalPrincipal = parseFloat(document.getElementById('loan-transaction-original-principal').value);
                    const originalInterest = parseFloat(document.getElementById('loan-transaction-original-interest').value);
                    const originalTotal = originalPrincipal + originalInterest;

                    const principalDiff = principal - originalPrincipal;
                    const totalDiff = totalPayment - originalTotal;

                    await updateDoc(loanRef, {
                        remainingPrincipal: increment(-principalDiff),
                        totalRepaid: increment(totalDiff)
                    });

                    const txRef = doc(transactionsColRef, txId);
                    await updateDoc(txRef, {
                        amount: totalPayment,
                        remarks: `還本金: ${principal}, 還利息: ${interest}`,
                        timestamp: Timestamp.fromDate(new Date(date))
                    });

                } else {
                    await updateDoc(loanRef, {
                        remainingPrincipal: increment(-principal),
                        totalRepaid: increment(totalPayment)
                    });

                    await addDoc(transactionsColRef, {
                        type: 'expense',
                        amount: totalPayment,
                        category: '貸款還款',
                        project: loanAccount.name,
                        remarks: `還本金: ${principal}, 還利息: ${interest}`,
                        timestamp: Timestamp.fromDate(new Date(date)),
                        loanAccountId: accountId
                    });
                }
                
                loanTransactionModal.classList.add('hidden');
                if (!loanDetailModal.classList.contains('hidden')) {
                    handleLoanCardClick(accountId);
                }

            } catch (error) {
                console.error("處理貸款交易失敗:", error);
            }
        }
        
        function handleCalculatorPasswordSubmit(e) {
            e.preventDefault();
            const passwordInput = document.getElementById('calculator-password-input');
            const errorMsg = document.getElementById('calculator-password-error');
            if (passwordInput.value === '111') {
                calculatorPasswordModal.classList.add('hidden');
                calculatorView.dataset.unlocked = "true";
                errorMsg.classList.add('hidden');
            } else {
                errorMsg.classList.remove('hidden');
            }
            passwordInput.value = '';
        }
        
        function handleLoanTypeChange() {
            if (loanTypeSelect.value === 'interest-only') {
                loanTermContainer.classList.add('hidden');
                loanTermInput.required = false;
            } else {
                loanTermContainer.classList.remove('hidden');
                loanTermInput.required = true;
            }
        }

        async function handleFixedExpenseFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('fixed-expense-name').value.trim();
            const amount = parseFloat(document.getElementById('fixed-expense-amount').value);
            if (name === '' || isNaN(amount) || amount <= 0) {
                alert("請輸入有效的項目名稱與金額。");
                return;
            }
            try {
                await addDoc(fixedExpensesColRef, {
                    name,
                    amount,
                    createdAt: Timestamp.now()
                });
                fixedExpenseForm.reset();
            } catch (error) {
                console.error("新增固定支出失敗:", error);
            }
        }


        // --- Helper Functions ---
        function updateTypeSelection() {
            const isExpense = expenseRadio.checked;
            typeLabels[0].classList.toggle('bg-red-500', isExpense); typeLabels[0].classList.toggle('text-white', isExpense);
            typeLabels[1].classList.toggle('bg-green-500', !isExpense); typeLabels[1].classList.toggle('text-white', !isExpense);
            populateCategoryDatalist();
        }

        function populateDatalist(datalistElement, items) {
            datalistElement.innerHTML = '';
            [...new Set(items)].forEach(item => { datalistElement.insertAdjacentHTML('beforeend', `<option value="${item}">${item}</option>`); });
        }

        function populateCategoryDatalist() {
            const type = expenseRadio.checked ? 'expense' : 'income';
            const categories = [...defaultCategories[type], ...customCategories.map(c => c.name)];
            populateDatalist(categoryDatalist, categories);
        }

        function populateBudgetAccountSelect() {
            budgetAccountSelect.innerHTML = '<option value="">-- 選擇投資帳戶 --</option>';
            const accountNames = allInvestments.map(inv => inv.name);
            [...new Set(accountNames)].forEach(name => {
                budgetAccountSelect.insertAdjacentHTML('beforeend', `<option value="${name}">${name}</option>`);
            });
        }

        function populateModalList(ulElement, items, emptyMsg, type) {
            ulElement.innerHTML = '';
            if (items.length === 0) { ulElement.innerHTML = `<li class="text-center text-gray-500">${emptyMsg}</li>`; return; }
            items.forEach(item => { ulElement.insertAdjacentHTML('beforeend', `<li class="flex justify-between items-center p-2 rounded-md hover:bg-gray-100"><span>${item.name}</span><button data-id="${item.id}" class="delete-${type}-btn text-red-400 hover:text-red-600 font-bold">刪除</button></li>`); });
        }

        function setupModal(openBtn, modal, closeBtns) {
            openBtn.addEventListener('click', () => modal.classList.remove('hidden'));
            closeBtns.forEach(btn => btn.addEventListener('click', () => modal.classList.add('hidden')));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
        }

        async function saveNewCustomItemIfNeeded(itemName, existingItems, collectionRef) {
            const trimmedName = itemName.trim();
            if (trimmedName === '') return;
            const isNew = !existingItems.some(item => item.name.toLowerCase() === trimmedName.toLowerCase());
            if (isNew) {
                try { await addDoc(collectionRef, { name: trimmedName, createdAt: serverTimestamp() }); }
                 catch (error) { console.error("儲存新項目失敗:", error); }
            }
        }

        function handleBackup() {
            const dataToBackup = {
                transactions: allTransactions.map(t => ({...t, timestamp: t.timestamp.toDate()})),
                debts: allDebts.map(d => ({...d, createdAt: d.createdAt.toDate()})),
                lendings: allLendings.map(l => ({...l, createdAt: l.createdAt.toDate()})),
                events: allEvents.map(e => ({...e, date: e.date.toDate(), createdAt: e.createdAt.toDate()})),
                investments: allInvestments.map(i => ({...i, createdAt: i.createdAt.toDate(), transactions: i.transactions.map(t => ({...t, date: t.date.toDate()}))})),
                loans: allLoans.map(l => ({...l, createdAt: l.createdAt.toDate()})),
                budgets: currentBudget,
                fixedExpenses: allFixedExpenses.map(f => ({...f, createdAt: f.createdAt.toDate()})),
                customCategories: customCategories,
                customProjects: customProjects
            };

            const jsonString = JSON.stringify(dataToBackup, null, 2);
            const blob = new Blob([jsonString], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = `記帳軟體備份-${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handlePrint(sectionSelector) {
            const printSection = document.querySelector(sectionSelector);
            if (!printSection) {
                console.error("Print section not found:", sectionSelector);
                return;
            }
            printSection.classList.add('print-section');
            window.print();
        }
        
        function handleAfterPrint() {
            document.querySelectorAll('.print-section').forEach(el => {
                el.classList.remove('print-section');
            });
        }
        
        async function handleInterestReductionToggle(e) {
            const loanId = e.target.dataset.id;
            const isChecked = e.target.checked;
            if (!loanId) return;
            const loanRef = doc(loansColRef, loanId);
            try {
                await updateDoc(loanRef, { interestReduction: isChecked });
            } catch (error) {
                console.error("更新還本降息失敗:", error);
            }
        }

        function initializeMonthSelector() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            budgetMonthSelect.value = `${year}-${month}`;
        }

        // --- App Initialization ---
        setupEventListeners();
        updateTypeSelection();
        transactionDateInput.valueAsDate = new Date();
        historyDateFilter.valueAsDate = new Date();
        document.getElementById('event-date').valueAsDate = new Date();
        initializeMonthSelector();
    </script>
</body>
</html>

