<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>雲端記帳 Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#4F46E5', secondary: '#10B981', danger: '#EF4444', warning: '#F59E0B', dark: '#1F2937' },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    fontSize: { 'xxs': '0.65rem' } 
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #e5e7eb; }
        .app-frame { 
            max-width: 28rem; 
            margin: 0 auto; 
            background-color: #F9FAFB; 
            height: 100dvh; 
            width: 100%;
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            position: relative; 
            overflow: hidden; 
        }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fab { box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
        .card-shadow { box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); }
        .animate-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-btn.active { color: #4F46E5; }
        .nav-btn.active i { transform: translateY(-2px); }
        .tab-pill.active { background-color: #4F46E5; color: white; }
        input:focus, select:focus, textarea:focus { ring: 2px; ring-color: #4F46E5; border-color: transparent; outline: none; }
    </style>
</head>
<body class="text-gray-700 text-sm">

    <!-- Auth View -->
    <div id="login-view" class="fixed inset-0 z-50 bg-white flex flex-col justify-center items-center p-6 animate-fade max-w-md mx-auto h-full shadow-2xl">
        <div class="mb-10 text-center">
            <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary text-3xl"><i class="fa-solid fa-wallet"></i></div>
            <h1 class="text-2xl font-bold text-gray-800">雲端記帳</h1>
            <p class="text-gray-500 mt-2 text-xs">個人財務管理助手</p>
        </div>
        <button onclick="App.loginGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-medium shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2 transition">
            <i class="fa-brands fa-google text-red-500"></i> Google 登入
        </button>
        <button onclick="App.loginAnon()" class="mt-3 w-full bg-gray-800 text-white py-3 rounded-xl font-medium shadow-lg hover:bg-gray-900 transition">訪客體驗</button>
    </div>

    <!-- Main App Frame -->
    <div id="app-container" class="hidden app-frame">
        <!-- Header -->
        <header class="bg-white px-4 py-3 flex justify-between items-center shadow-sm z-20 shrink-0">
            <h1 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-chart-pie text-primary"></i> <span id="page-title">總覽</span></h1>
            <div class="flex items-center gap-3">
                <div id="user-info" class="text-xs font-medium text-gray-500"></div>
                <button onclick="App.logout()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>

        <!-- Content -->
        <main id="main-content" class="flex-1 overflow-y-auto hide-scrollbar relative bg-gray-50 pb-20">
            <div id="view-accounting" class="view-section animate-fade"></div>
            <div id="view-investment" class="view-section hidden p-3 space-y-3 animate-fade"></div>
            <div id="view-debt" class="view-section hidden p-3 space-y-3 animate-fade"></div>
            <div id="view-reports" class="view-section hidden p-3 space-y-3 animate-fade"></div>
            <div id="view-events" class="view-section hidden p-3 space-y-3 animate-fade"></div>
        </main>

        <!-- Nav -->
        <nav class="bg-white border-t border-gray-100 px-2 py-2 flex justify-between items-center text-[10px] font-medium text-gray-400 z-50 shrink-0 pb-safe">
            <button id="nav-accounting" onclick="App.switchTab('accounting', this)" class="nav-btn active flex flex-col items-center gap-1 transition p-1 min-w-[3.5rem]"><i class="fa-solid fa-house text-lg"></i> 記帳</button>
            <button onclick="App.switchTab('investment', this)" class="nav-btn flex flex-col items-center gap-1 transition p-1 min-w-[3.5rem]"><i class="fa-solid fa-arrow-trend-up text-lg"></i> 投資</button>
            <button onclick="App.switchTab('debt', this)" class="nav-btn flex flex-col items-center gap-1 transition p-1 min-w-[3.5rem]"><i class="fa-solid fa-credit-card text-lg"></i> 負債</button>
            <div class="relative -top-6 pointer-events-none mx-1">
                <button onclick="App.openModal('transaction-modal')" class="fab w-12 h-12 bg-primary rounded-full text-white text-xl flex items-center justify-center transition hover:scale-105 active:scale-95 shadow-xl shadow-primary/30 pointer-events-auto"><i class="fa-solid fa-plus"></i></button>
            </div>
            <button onclick="App.switchTab('events', this)" class="nav-btn flex flex-col items-center gap-1 transition p-1 min-w-[3.5rem]"><i class="fa-solid fa-calendar-day text-lg"></i> 大事記</button>
            <button onclick="App.switchTab('reports', this)" class="nav-btn flex flex-col items-center gap-1 transition p-1 min-w-[3.5rem]"><i class="fa-solid fa-chart-simple text-lg"></i> 報表</button>
        </nav>
    </div>

    <!-- Modal System -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-50 hidden flex items-end sm:items-center justify-center animate-fade backdrop-blur-sm">
        <div id="modal-content" class="bg-white w-full max-w-[28rem] rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl transform transition-transform duration-300 pb-10 sm:pb-6 max-h-[85vh] overflow-y-auto hide-scrollbar"></div>
    </div>

    <!-- Templates -->
    <template id="tpl-accounting">
        <div class="bg-white p-4 rounded-b-2xl card-shadow mb-3 sticky top-0 z-10">
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs font-bold text-gray-400">本月概況</span>
                <input type="month" id="date-filter" class="bg-gray-100 border-none rounded-lg px-2 py-1 text-xs font-bold text-gray-600 focus:ring-0 cursor-pointer" onchange="App.handleDateFilterChange()">
            </div>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-green-50 p-2 rounded-lg"><p class="text-[10px] text-green-600 mb-0.5">收入</p><p id="monthly-income" class="text-sm font-bold text-green-700">0</p></div>
                <div class="bg-red-50 p-2 rounded-lg"><p class="text-[10px] text-red-600 mb-0.5">支出</p><p id="monthly-expense" class="text-sm font-bold text-red-700">0</p></div>
                <div class="bg-blue-50 p-2 rounded-lg"><p class="text-[10px] text-blue-600 mb-0.5">結餘</p><p id="monthly-balance" class="text-sm font-bold text-blue-700">0</p></div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center">
                <span class="text-xs font-bold text-gray-800">本日小計</span>
                <div class="flex gap-2 text-xs items-center">
                    <span class="text-green-600 font-medium">收:<span id="today-income">0</span></span>
                    <span class="text-red-500 font-medium">支:<span id="today-expense">0</span></span>
                    <span class="text-blue-600 font-medium border-l pl-2 border-gray-200" id="today-balance-container">餘:<span id="today-balance">0</span></span>
                </div>
            </div>
        </div>
        <div class="px-3 pb-4"><ul id="tx-list" class="space-y-3"></ul></div>
    </template>

    <template id="tpl-investment">
        <div class="flex justify-between items-center mb-3 px-1">
            <h3 class="text-sm font-bold text-gray-600">投資概況</h3>
            <input type="month" id="inv-date-filter" class="bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold text-gray-600 focus:ring-0 cursor-pointer shadow-sm" onchange="App.renderInvestments()">
        </div>
        <div class="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-2xl p-4 text-white shadow-lg card-shadow mb-4">
            <p class="text-indigo-100 text-xs mb-1">總資產現值 (進行中)</p>
            <h2 id="inv-total-val" class="text-3xl font-bold tracking-tight">--</h2>
            <div class="flex gap-4 mt-3 text-xs border-t border-white/20 pt-3">
                <div><span class="opacity-70 block mb-0.5">總損益</span> <span id="inv-total-ret" class="font-bold text-base">--</span></div>
                <div><span class="opacity-70 block mb-0.5">報酬率</span> <span id="inv-roi" class="font-bold text-base">--</span></div>
            </div>
        </div>
        <div class="flex bg-gray-200 p-1 rounded-xl mb-3">
            <button class="tab-pill flex-1 py-1.5 rounded-lg text-xs font-bold text-gray-500 active transition" onclick="App.switchInvTab('active', this)">進行中</button>
            <button class="tab-pill flex-1 py-1.5 rounded-lg text-xs font-bold text-gray-500 transition" onclick="App.switchInvTab('archived', this)">已結案</button>
        </div>
        <div class="flex justify-between items-center px-1 mb-2">
            <span class="text-xs font-bold text-gray-500">投資帳戶 (點擊查看明細)</span>
            <button onclick="App.openModal('investment-modal')" class="text-primary text-xs font-bold bg-primary/10 px-2 py-1 rounded hover:bg-primary/20 transition">+ 新增</button>
        </div>
        <div id="inv-list" class="grid gap-2"></div>
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex justify-between items-center px-1 mb-2"><span class="text-xs font-bold text-gray-500">收入預算/目標</span><button onclick="App.openBudgetModal('investment')" class="text-secondary text-xs font-bold bg-secondary/10 px-2 py-1 rounded hover:bg-secondary/20 transition">+ 預算</button></div>
            <ul id="inv-budget-list" class="space-y-2"></ul>
        </div>
    </template>

    <template id="tpl-debt">
        <div class="flex justify-between items-center mb-3 px-1">
            <h3 class="text-sm font-bold text-gray-600">負債概況</h3>
            <input type="month" id="debt-date-filter" class="bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold text-gray-600 focus:ring-0 cursor-pointer shadow-sm" onchange="App.renderDebts()">
        </div>
        <div class="bg-white p-4 rounded-2xl card-shadow border-t-4 border-warning mb-4">
            <div class="flex justify-between items-end mb-2">
                <div><p class="text-xs text-gray-500">剩餘總負債</p><p id="debt-total-remaining" class="text-2xl font-bold text-gray-800">--</p></div>
                <div class="text-right"><p class="text-[10px] text-gray-400">總進度</p><p id="debt-progress-text" class="text-sm font-bold text-warning">0%</p></div>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-2"><div id="debt-progress-bar" class="bg-warning h-2 rounded-full transition-all duration-500" style="width: 0%"></div></div>
        </div>
        <div class="flex justify-between items-center px-1 mb-2">
            <span class="text-xs font-bold text-gray-500">負債項目 (點擊查看明細)</span>
            <button onclick="App.openModal('debt-modal')" class="text-primary text-xs font-bold bg-primary/10 px-2 py-1 rounded hover:bg-primary/20 transition">+ 新增</button>
        </div>
        <div id="debt-list" class="space-y-2"></div>
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex justify-between items-center px-1 mb-2"><span class="text-xs font-bold text-gray-500">還款計畫</span><button onclick="App.openBudgetModal('debt')" class="text-danger text-xs font-bold bg-danger/10 px-2 py-1 rounded hover:bg-danger/20 transition">+ 計畫</button></div>
            <ul id="debt-budget-list" class="space-y-2"></ul>
        </div>
    </template>

    <template id="tpl-reports">
        <div class="bg-white p-3 rounded-xl card-shadow mb-2 space-y-2">
            <div class="flex gap-2">
                <select id="report-year" class="bg-gray-50 rounded-lg px-2 py-1.5 text-xs font-bold border-transparent focus:border-primary flex-1 min-w-0" onchange="App.renderReports()"></select>
                <select id="report-month-select" class="bg-gray-50 rounded-lg px-2 py-1.5 text-xs font-bold border-transparent focus:border-primary flex-1 min-w-0" onchange="App.renderReports()">
                    <option value="all">全年度</option>
                    <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option><option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
                    <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option><option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
                </select>
            </div>
            <div class="flex gap-2">
                <select id="report-project" class="bg-gray-50 rounded-lg px-2 py-1.5 text-xs font-bold border-transparent focus:border-primary flex-1 min-w-0" onchange="App.renderReports()">
                    <option value="all">全部專案</option>
                </select>
                <select id="report-category" class="bg-gray-50 rounded-lg px-2 py-1.5 text-xs font-bold border-transparent focus:border-primary flex-1 min-w-0" onchange="App.renderReports()">
                    <option value="all">全部分類</option>
                </select>
                <button type="button" onclick="App.exportReport()" class="bg-gray-100 px-3 py-1.5 rounded-lg text-gray-500 hover:text-primary hover:bg-blue-50 transition flex-shrink-0"><i class="fa-solid fa-file-export"></i></button>
            </div>
        </div>
        <div class="bg-white p-4 rounded-2xl card-shadow">
            <h3 class="font-bold mb-4 text-center text-xs text-gray-500 uppercase tracking-wider">支出分佈</h3>
            <div class="h-56 relative"><canvas id="expense-chart"></canvas></div>
        </div>
        <div class="bg-white p-4 rounded-2xl card-shadow mt-3">
            <h3 class="font-bold mb-3 text-xs border-b border-gray-100 pb-2 text-gray-500">分類統計</h3>
            <ul id="report-stats" class="space-y-2 text-xs mb-4"></ul>
            <h3 class="font-bold mb-3 text-xs border-b border-gray-100 pb-2 text-gray-500">交易明細 (點擊可編輯)</h3>
            <ul id="report-details" class="space-y-2"></ul>
        </div>
    </template>

    <template id="tpl-events">
        <button type="button" onclick="App.openModal('event-modal')" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-gray-50 hover:border-gray-400 transition mb-2 text-xs">+ 紀錄大事記</button>
        <div id="event-list" class="space-y-4 pl-2"></div>
    </template>

    <!-- Modals -->
    <template id="tpl-transaction-modal">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-lg font-bold text-gray-800" id="tx-modal-title">記一筆</h3>
            <div class="flex items-center gap-2">
                 <button type="button" id="btn-delete-tx" class="hidden w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 transition"><i class="fa-solid fa-trash-can"></i></button>
                 <button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        <form onsubmit="App.handleSaveTransaction(event)" class="space-y-4">
            <input type="hidden" name="id">
            <input type="hidden" name="project">
            <!-- Added hidden field for legacy investment ID to track migration -->
            <input type="hidden" name="legacy_inv_id"> 
            <div class="flex bg-gray-100 p-1 rounded-xl">
                <button type="button" class="type-btn flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow text-danger transition" onclick="App.toggleTxType('expense')" id="btn-expense">支出</button>
                <button type="button" class="type-btn flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 transition" onclick="App.toggleTxType('income')" id="btn-income">收入</button>
            </div>
            <input type="hidden" name="type" id="tx-type" value="expense">
            <div><label class="text-[10px] font-bold text-gray-400 ml-1">金額</label><input type="number" name="amount" class="w-full text-3xl font-bold text-gray-800 border-b border-gray-200 py-1 focus:border-primary bg-transparent text-center focus:outline-none" placeholder="0" required inputmode="decimal"></div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="text-[10px] font-bold text-gray-400 ml-1">日期</label><input type="date" name="date" class="w-full bg-gray-50 rounded-xl px-3 py-2.5 text-xs font-medium focus:bg-white focus:ring-1 focus:ring-primary transition" required></div>
                <div><label class="text-[10px] font-bold text-gray-400 ml-1">分類</label><input list="cat-list" name="category" class="w-full bg-gray-50 rounded-xl px-3 py-2.5 text-xs font-medium focus:bg-white focus:ring-1 focus:ring-primary transition" placeholder="選擇分類" required><datalist id="cat-list"></datalist></div>
            </div>
            <div><label class="text-[10px] font-bold text-gray-400 ml-1">專案 / 帳戶 (選填)</label><input type="text" name="project" class="w-full bg-gray-50 rounded-xl px-3 py-2.5 text-xs font-medium focus:bg-white focus:ring-1 focus:ring-primary transition" placeholder="例如: 台積電、學貸..."></div>
            <div><label class="text-[10px] font-bold text-gray-400 ml-1">備註</label><input type="text" name="remarks" class="w-full bg-gray-50 rounded-xl px-3 py-2.5 text-xs font-medium focus:bg-white focus:ring-1 focus:ring-primary transition" placeholder="寫點什麼..."></div>
            <div class="flex gap-2 pt-2"><button type="button" onclick="App.closeModal()" class="flex-1 bg-gray-100 py-3.5 rounded-xl font-bold text-gray-500 text-sm">取消</button><button type="submit" class="flex-1 bg-primary text-white font-bold py-3.5 rounded-xl shadow-lg shadow-primary/30 text-sm">儲存</button></div>
        </form>
    </template>

    <template id="tpl-investment-modal">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">投資帳戶</h3><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveInvestment(event)" class="space-y-4">
            <input type="hidden" name="id">
            <input type="text" name="name" class="w-full bg-gray-50 rounded-xl p-3 text-sm focus:bg-white border-transparent focus:border-primary transition" placeholder="名稱 (如: 台積電)" required>
            <input type="number" name="initial" class="w-full bg-gray-50 rounded-xl p-3 text-sm focus:bg-white border-transparent focus:border-primary transition" placeholder="初始成本 (選填)">
            <div class="flex items-center gap-2 px-1">
                <input type="checkbox" name="isArchived" id="inv-archived" class="rounded text-primary focus:ring-primary">
                <label for="inv-archived" class="text-sm text-gray-600">已結案 (歸檔)</label>
            </div>
            <div class="flex gap-2 text-sm pt-2"><button type="button" onclick="App.closeModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">取消</button><button type="submit" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-primary/30">儲存</button></div>
        </form>
    </template>

    <template id="tpl-debt-modal">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">負債項目</h3><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveDebt(event)" class="space-y-4">
            <input type="hidden" name="id">
            <input type="text" name="name" class="w-full bg-gray-50 rounded-xl p-3 text-sm" placeholder="名稱 (如: 學貸)" required>
            <input type="number" name="total" class="w-full bg-gray-50 rounded-xl p-3 text-sm" placeholder="總金額" required>
            <div class="flex gap-2 text-sm pt-2"><button type="button" onclick="App.closeModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">取消</button><button type="submit" class="flex-1 bg-warning text-white py-3 rounded-xl font-bold shadow-lg shadow-warning/30">儲存</button></div>
        </form>
    </template>

    <template id="tpl-budget-form">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800" id="budget-modal-title">新增預算</h3><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveBudget(event)" class="space-y-4">
            <input type="hidden" name="id"><input type="hidden" name="context" id="budget-context">
            <select name="targetId" id="budget-target" class="w-full bg-gray-50 rounded-xl p-3 text-sm appearance-none" required></select>
            <input type="number" name="amount" class="w-full bg-gray-50 rounded-xl p-3 text-sm" placeholder="金額" required>
            <input type="date" name="date" class="w-full bg-gray-50 rounded-xl p-3 text-sm" required>
            <input type="text" name="desc" class="w-full bg-gray-50 rounded-xl p-3 text-sm placeholder-blue-400 text-blue-600 font-medium" placeholder="說明 (如: 預計賣出/還款)" required>
            <div class="flex gap-2 text-sm pt-2"><button type="button" onclick="App.closeModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">取消</button><button type="submit" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-primary/30 text-sm">設定</button></div>
        </form>
    </template>

    <template id="tpl-repay-form">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">還款</h3><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
        <p id="repay-debt-name" class="text-xs text-gray-500 mb-4"></p>
        <form onsubmit="App.handleRepayDebt(event)" class="space-y-4">
            <input type="hidden" name="id" id="repay-id">
            <input type="number" name="amount" class="w-full text-3xl font-bold border-b py-2 focus:border-primary text-center focus:outline-none" placeholder="金額" required inputmode="decimal">
            <input type="date" name="date" class="w-full bg-gray-50 rounded-xl p-3 text-sm" required>
            <div class="flex gap-2 text-sm pt-2"><button type="button" onclick="App.closeModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">取消</button><button type="submit" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-500/30">確認</button></div>
        </form>
    </template>
    
    <template id="tpl-event-form">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">大事記</h3><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveEvent(event)" class="space-y-4"><input type="hidden" name="id"><input type="date" name="date" class="w-full bg-gray-50 rounded-xl p-3 text-sm" required><input type="text" name="title" class="w-full bg-gray-50 rounded-xl p-3 text-sm" placeholder="標題" required><textarea name="desc" rows="3" class="w-full bg-gray-50 rounded-xl p-3 text-sm" placeholder="內容..."></textarea><div class="flex gap-2 text-sm pt-2"><button type="button" onclick="App.closeModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">取消</button><button type="submit" class="w-full bg-dark text-white py-3 rounded-xl font-bold text-sm shadow-lg">紀錄</button></div></form>
    </template>

    <!-- Details Modal Template -->
    <template id="tpl-details-modal">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800 details-title truncate pr-4"></h3>
            <button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 flex-shrink-0"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="max-h-[60vh] overflow-y-auto hide-scrollbar">
             <!-- Budget Section -->
            <div class="details-budget-section mb-4 hidden">
                <h4 class="text-xs font-bold text-gray-500 mb-2 border-b pb-1">預算 / 計畫</h4>
                <ul class="details-budget-list space-y-1"></ul>
            </div>
            <!-- Transaction Section -->
            <div>
                <h4 class="text-xs font-bold text-gray-500 mb-2 border-b pb-1">交易紀錄</h4>
                <ul class="details-list space-y-2">
                    <li class="text-center text-gray-400 py-4">載入中...</li>
                </ul>
            </div>
        </div>
        <div class="details-actions mt-4 pt-2 border-t border-gray-100 flex flex-col gap-2"></div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, updateDoc, increment, Timestamp, writeBatch, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp({ apiKey: "AIzaSyAqFHm6Bn35m8xauc50ZvNNy_rxIZzCMTE", authDomain: "moneyw-f8105.firebaseapp.com", projectId: "moneyw-f8105", storageBucket: "moneyw-f8105.appspot.com", messagingSenderId: "155586195799", appId: "1:155586195799:web:302184fbf613f032a88e12" });
        const auth = getAuth(app); const db = getFirestore(app);
        const State = { 
            user: null, 
            data: { transactions: [], debts: [], investments: [], events: [], investmentBudgets: [], debtBudgets: [], legacyTxs: {} }, 
            listeners: [], 
            chart: null, 
            categories: { expense: ['飲食', '交通', '居住', '娛樂', '購物', '醫療', '教育', '投資', '其他'], income: ['薪資', '獎金', '投資', '兼職', '其他'] },
            view: { invTab: 'active' }
        };

        // Robust Date Parser
        const getTxDate = (tx) => {
            if (!tx) return new Date();
            try {
                if (tx.timestamp && typeof tx.timestamp.toDate === 'function') return tx.timestamp.toDate();
                if (tx.date) {
                    if (typeof tx.date.toDate === 'function') return tx.date.toDate();
                    const d = new Date(tx.date);
                    if (!isNaN(d.getTime())) return d;
                }
                if (tx.timestamp && tx.timestamp.seconds) return new Date(tx.timestamp.seconds * 1000);
            } catch (e) { }
            return new Date();
        };
        const toDateStr=(ts)=>{
            try { if(ts && ts.toDate) return ts.toDate().toISOString().split('T')[0]; } catch(e){}
            return new Date().toISOString().split('T')[0];
        };

        window.App = {
            init: () => onAuthStateChanged(auth, u => {
                State.user = u;
                document.getElementById('login-view').classList.toggle('hidden', !!u);
                document.getElementById('app-container').classList.toggle('hidden', !u);
                if(u) {
                    document.getElementById('user-info').innerText = u.isAnonymous ? '訪客' : u.displayName;
                    const today = new Date();
                    document.getElementById('view-accounting').innerHTML = document.getElementById('tpl-accounting').innerHTML;
                    document.getElementById('date-filter').value = today.toISOString().slice(0, 7);
                    App.startListeners(u.uid);
                } else App.stopListeners();
            }),
            startListeners: (uid) => {
                const listen = (c, k, cb) => State.listeners.push(onSnapshot(query(collection(db, `users/${uid}/${c}`)), s => { 
                    State.data[k] = s.docs.map(d=>({id:d.id, ...d.data()})); 
                    if(cb) cb(); 
                }));
                listen('transactions', 'transactions', () => { 
                    if(document.getElementById('tx-list')) App.renderTransactions(); 
                    if(document.getElementById('monthly-balance')) App.updateDashboard(); 
                    if(document.getElementById('report-stats')) App.renderReports(); 
                    if(document.getElementById('inv-list')) App.renderInvestments();
                });
                listen('debts', 'debts', () => { if(document.getElementById('debt-list')) App.renderDebts(); });
                listen('events', 'events', () => { if(document.getElementById('event-list')) App.renderEvents(); });
                listen('investmentBudgets', 'investmentBudgets', () => { if(document.getElementById('inv-budget-list')) App.renderInvestments(); });
                listen('debtBudgets', 'debtBudgets', () => { if(document.getElementById('debt-budget-list')) App.renderDebts(); });
                
                // Investment + Legacy Loader (With Migration info)
                State.listeners.push(onSnapshot(query(collection(db, `users/${uid}/investments`)), async (s) => {
                    State.data.investments = s.docs.map(d=>({id:d.id, ...d.data()}));
                    for (let inv of State.data.investments) {
                        if (!State.data.legacyTxs[inv.id]) {
                            try {
                                const subSnap = await getDocs(collection(db, `users/${uid}/investments/${inv.id}/transactions`));
                                State.data.legacyTxs[inv.id] = subSnap.docs.map(d => {
                                    const data = d.data();
                                    let ts = data.timestamp || data.date;
                                    if (typeof ts === 'string') {
                                        const pd = new Date(ts);
                                        if(!isNaN(pd.getTime())) ts = Timestamp.fromDate(pd);
                                        else ts = Timestamp.fromDate(new Date());
                                    } else if (ts && !ts.toDate) { ts = Timestamp.fromDate(new Date()); }
                                    
                                    return { 
                                        id: d.id, ...data, 
                                        timestamp: ts, 
                                        remarks: data.remarks || data.remark, 
                                        isLegacy: true, // Mark as legacy
                                        investmentId: inv.id // Track parent for migration
                                    };
                                });
                            } catch(e) { State.data.legacyTxs[inv.id] = []; }
                        }
                    }
                    if(document.getElementById('inv-list')) App.renderInvestments(); 
                    if(document.getElementById('report-stats')) App.renderReports();
                }));
            },
            stopListeners: () => { State.listeners.forEach(u=>u()); State.listeners=[]; },
            loginGoogle: () => signInWithPopup(auth, new GoogleAuthProvider()), loginAnon: () => signInAnonymously(auth), logout: () => signOut(auth),

            // Logic & Renderers
            switchTab: (tab, btn) => {
                document.querySelectorAll('.view-section').forEach(e => { e.classList.add('hidden'); e.innerHTML = ''; }); 
                const target = document.getElementById(`view-${tab}`);
                target.classList.remove('hidden');
                target.innerHTML = document.getElementById(`tpl-${tab}`).innerHTML; 

                if(tab === 'accounting') {
                    document.getElementById('date-filter').value = new Date().toISOString().slice(0, 7);
                    App.renderTransactions(); App.updateDashboard();
                } else if(tab === 'investment') {
                    document.getElementById('inv-date-filter').value = new Date().toISOString().slice(0, 7);
                    App.renderInvestments();
                } else if(tab === 'debt') {
                    document.getElementById('debt-date-filter').value = new Date().toISOString().slice(0, 7);
                    App.renderDebts();
                } else if(tab === 'reports') {
                    const yrSel = document.getElementById('report-year');
                    const curYr = new Date().getFullYear();
                    for(let y=curYr-2; y<=curYr+1; y++) yrSel.innerHTML += `<option value="${y}" ${y===curYr?'selected':''}>${y}年</option>`;
                    document.getElementById('report-month-select').value = (new Date().getMonth()+1).toString();
                    App.renderReports();
                } else if(tab === 'events') {
                    App.renderEvents();
                }

                document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active', 'text-primary'));
                if(btn) { btn.classList.add('active', 'text-primary'); }
                document.getElementById('page-title').innerText = {accounting:'總覽', investment:'投資', debt:'負債', reports:'報表', events:'大事記'}[tab];
            },
            handleDateFilterChange: () => { App.renderTransactions(); App.updateDashboard(); },
            switchInvTab: (tab, btn) => {
                State.view.invTab = tab;
                document.querySelectorAll('.tab-pill').forEach(e => e.classList.remove('active', 'bg-gray-600', 'text-white'));
                btn.classList.add('active');
                App.renderInvestments();
            },

            getAllTransactions: () => {
                let allTxs = [];
                let linkedIds = new Set();
                if (State.data.investments && State.data.legacyTxs) {
                    State.data.investments.forEach(inv => {
                        const sub = State.data.legacyTxs[inv.id] || [];
                        sub.forEach(t => {
                            let tsObj = getTxDate(t);
                            const finalTs = Timestamp.fromDate(tsObj);
                            allTxs.push({ ...t, project: inv.name, category: t.category || (t.type === 'income' ? '投資收入' : '投資支出'), timestamp: finalTs, amount: parseFloat(t.amount) || 0, isLegacy: true });
                            if(t.mainTransactionId) linkedIds.add(t.mainTransactionId);
                        });
                    });
                }
                if (State.data.transactions) {
                    State.data.transactions.forEach(t => {
                        if (!linkedIds.has(t.id)) allTxs.push(t);
                    });
                }
                return allTxs.sort((a,b) => (getTxDate(b) - getTxDate(a)));
            },

            // Handlers - UPDATED FOR MIGRATION
            handleSaveTransaction: async (e) => {
                e.preventDefault(); 
                const f=e.target, uid=State.user.uid;
                const id = f.id.value;
                const legacyInvId = f.legacy_inv_id ? f.legacy_inv_id.value : null;
                
                const d = { 
                    type: f.type.value, 
                    amount: parseFloat(f.amount.value), 
                    category: f.category.value, 
                    remarks: f.remarks.value, 
                    timestamp: Timestamp.fromDate(new Date(f.date.value)),
                    project: f.project.value
                };

                if (legacyInvId && id) {
                    // MIGRATION LOGIC
                    const batch = writeBatch(db);
                    // 1. Create new in main
                    const newRef = doc(collection(db, `users/${uid}/transactions`));
                    batch.set(newRef, d);
                    // 2. Delete old from sub
                    const oldRef = doc(db, `users/${uid}/investments/${legacyInvId}/transactions`, id);
                    batch.delete(oldRef);
                    await batch.commit();
                } else {
                    // Standard
                    f.id.value ? await updateDoc(doc(db, `users/${uid}/transactions`, f.id.value), d) : await addDoc(collection(db, `users/${uid}/transactions`), d);
                }
                App.closeModal();
            },
            handleSaveInvestment: async (e) => {
                e.preventDefault(); const f=e.target, uid=State.user.uid, init=parseFloat(f.initial.value)||0;
                const d = { name: f.name.value, initialValue: init, isArchived: f.isArchived.checked };
                if(!f.id.value) { d.marketValue = init; d.createdAt = Timestamp.now(); }
                else {
                     const oldInv = State.data.investments.find(i => i.id === f.id.value);
                     const oldName = oldInv ? oldInv.name : '';
                     if (oldName && oldName !== f.name.value) {
                        const q = query(collection(db, `users/${uid}/transactions`), where("project", "==", oldName));
                        const snap = await getDocs(q);
                        const batch = writeBatch(db);
                        snap.forEach(doc => batch.update(doc.ref, { project: f.name.value }));
                        await batch.commit();
                     }
                }
                f.id.value ? await updateDoc(doc(db, `users/${uid}/investments`, f.id.value), d) : (await addDoc(collection(db, `users/${uid}/investments`), d) && init>0 && await addDoc(collection(db, `users/${uid}/transactions`), {type:'expense', amount:init, category:'投資', project:f.name.value, remarks:'初始投入', timestamp:Timestamp.now()}));
                App.closeModal();
            },
            handleSaveDebt: async (e) => { e.preventDefault(); const f=e.target, uid=State.user.uid; const d={name:f.name.value, totalAmount:parseFloat(f.total.value)}; if(!f.id.value){d.remainingAmount=d.totalAmount;d.createdAt=Timestamp.now();} f.id.value?await updateDoc(doc(db,`users/${uid}/debts`,f.id.value),d):await addDoc(collection(db,`users/${uid}/debts`),d); App.closeModal(); },
            handleSaveBudget: async (e) => { e.preventDefault(); const f=e.target, uid=State.user.uid, ctx=f.context.value; const col = ctx === 'investment' ? 'investmentBudgets' : 'debtBudgets'; const d = { targetId: f.targetId.value, amount: parseFloat(f.amount.value), expectedDate: Timestamp.fromDate(new Date(f.date.value)), description: f.desc.value }; if(!f.id.value) { d.isRealized = false; d.createdAt = Timestamp.now(); } f.id.value ? await updateDoc(doc(db, `users/${uid}/${col}`, f.id.value), d) : await addDoc(collection(db, `users/${uid}/${col}`), d); App.closeModal(); },
            handleRepayDebt: async (e) => { e.preventDefault(); const f=e.target, amt=parseFloat(f.amount.value), uid=State.user.uid; const debt=State.data.debts.find(d=>d.id===f.id.value); const batch=writeBatch(db); batch.update(doc(db,`users/${uid}/debts`,f.id.value),{remainingAmount:increment(-amt)}); batch.set(doc(collection(db,`users/${uid}/transactions`)),{type:'expense',amount:amt,category:'負債還款',project:debt.name,remarks:`償還: ${debt.name}`,timestamp:Timestamp.fromDate(new Date(f.date.value))}); await batch.commit(); App.closeModal(); },
            handleSaveEvent: async(e) => { e.preventDefault(); const f=e.target, uid=State.user.uid; const d = { title:f.title.value, description:f.desc.value, date:Timestamp.fromDate(new Date(f.date.value)) }; f.id.value ? await updateDoc(doc(db, `users/${uid}/events`, f.id.value), d) : await addDoc(collection(db, `users/${uid}/events`), d); App.closeModal(); },
            
            deleteItem: async (c,id) => { if(confirm('刪除?')) await deleteDoc(doc(db, `users/${State.user.uid}/${c}`, id)); },
            updateMarketValue: async (id,old) => { const v=prompt("目前市值:",old); if(v&&!isNaN(v)) await updateDoc(doc(db, `users/${State.user.uid}/investments`, id), {marketValue:parseFloat(v)}); },
            realizeBudget: async(ctx, id) => {
                const isInv = ctx === 'investment'; const col = isInv ? 'investmentBudgets' : 'debtBudgets'; const budget = State.data[col].find(b => b.id === id); if(!budget) return;
                const accountList = isInv ? State.data.investments : State.data.debts; const account = accountList.find(a => a.id === budget.targetId); if(!account) { alert('請先編輯預算選擇帳戶'); return; }
                if(!confirm(`確定執行預算？`)) return;
                const batch = writeBatch(db); const now = Timestamp.now();
                batch.update(doc(db, `users/${State.user.uid}/${col}`, id), { isRealized: true });
                batch.set(doc(collection(db, `users/${State.user.uid}/transactions`)), { type: isInv ? 'income' : 'expense', amount: budget.amount, category: isInv ? '投資' : '負債還款', project: account.name, remarks: `${isInv ? '預算實現' : '還款計畫'}: ${budget.description}`, timestamp: now });
                if(!isInv) batch.update(doc(db, `users/${State.user.uid}/debts`, account.id), { remainingAmount: increment(-budget.amount) });
                await batch.commit();
            },
            exportReport: () => {
                if(!confirm("匯出報表?")) return;
                const csv = "日期,分類,專案,備註,類型,金額\n" + App.getAllTransactions().map(t=>`${getTxDate(t).toLocaleDateString()},${t.category},${t.project||''},${t.remarks||''},${t.type==='income'?'收入':'支出'},${t.amount}`).join("\n");
                const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'})); link.download="report.csv"; link.click();
            },

            // Show Details
            showDetails: async (type, id) => {
                const item = State.data[type + 's'].find(i => i.id === id);
                if (!item) return;
                const tpl = document.getElementById('tpl-details-modal').innerHTML;
                const content = document.getElementById('modal-content');
                content.innerHTML = tpl;
                content.querySelector('.details-title').innerText = item.name;
                document.getElementById('modal-overlay').classList.remove('hidden'); 
                document.getElementById('modal-overlay').classList.add('flex');

                // Budget Rendering
                const budgetCol = type === 'investment' ? 'investmentBudgets' : 'debtBudgets';
                const relatedBudgets = State.data[budgetCol].filter(b => b.targetId === id && !b.isRealized).sort((a,b) => (a.expectedDate?.seconds || 0) - (b.expectedDate?.seconds || 0));
                const budgetSection = content.querySelector('.details-budget-section');
                const budgetListEl = content.querySelector('.details-budget-list');
                
                if (relatedBudgets.length > 0) {
                    budgetSection.classList.remove('hidden');
                    budgetListEl.innerHTML = relatedBudgets.map(b => {
                        const isOverdue = b.expectedDate && b.expectedDate.toDate() < new Date().setHours(0,0,0,0);
                        const dateClass = isOverdue ? 'text-red-500 font-bold' : 'text-gray-400';
                        const boxClass = isOverdue ? 'bg-red-50 border-red-200' : 'bg-white border border-gray-100';
                        return `<li class="flex justify-between items-center p-2 rounded-xl ${boxClass}">
                            <div class="text-xs">
                                <span class="font-bold text-gray-700">${b.description}</span> 
                                <span class="${type==='investment'?'text-secondary':'text-danger'}">$${b.amount.toLocaleString()}</span>
                                <span class="text-[10px] ml-2 ${dateClass}">${b.expectedDate?.toDate().toLocaleDateString()||''}</span>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="App.realizeBudget('${type}', '${b.id}')" class="text-gray-400 hover:text-green-600"><i class="fa-solid fa-check"></i></button>
                                <button onclick="App.openBudgetModal('${type}', '${b.id}')" class="text-gray-400 hover:text-blue-500"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="App.deleteItem('${budgetCol}', '${b.id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </li>`;
                    }).join('');
                } else {
                    budgetSection.classList.add('hidden');
                }

                let relatedTxs = [];
                if (type === 'investment') {
                    const subTxs = State.data.legacyTxs[id] || [];
                    const mainTxs = State.data.transactions.filter(t => t.project === item.name);
                    const linkedIds = new Set(subTxs.map(t => t.mainTransactionId).filter(Boolean));
                    const uniqueMain = mainTxs.filter(t => !linkedIds.has(t.id));
                    relatedTxs = [...subTxs, ...uniqueMain];
                    
                    const btn = document.createElement('button');
                    btn.className = "w-full bg-blue-50 text-blue-600 py-2.5 rounded-xl font-bold text-xs mt-3 shadow-sm";
                    btn.innerText = "更新目前市值";
                    btn.onclick = () => App.updateMarketValue(id, item.marketValue);
                    content.querySelector('.details-actions').appendChild(btn);
                } else {
                    relatedTxs = State.data.transactions.filter(t => t.project === item.name);
                }
                
                const addTxBtn = document.createElement('button');
                addTxBtn.className = "w-full bg-primary text-white py-2.5 rounded-xl font-bold text-xs mt-2 shadow-lg shadow-primary/20 mb-2";
                addTxBtn.innerText = "+ 新增交易";
                addTxBtn.onclick = () => App.openModal('transaction-modal', null, { project: item.name, category: type === 'investment' ? '投資' : '負債還款' });
                content.querySelector('.details-actions').insertBefore(addTxBtn, content.querySelector('.details-actions').firstChild);

                relatedTxs.sort((a,b) => getTxDate(b) - getTxDate(a));

                content.querySelector('.details-list').innerHTML = relatedTxs.length ? relatedTxs.map(t => `
                    <li class="flex justify-between items-center py-3 px-3 rounded-xl mb-2 ${t.type==='expense' ? 'bg-red-50' : 'bg-green-50'}">
                        <div><p class="text-[10px] text-gray-500 mb-0.5">${getTxDate(t).toLocaleDateString()}</p><p class="text-xs font-bold text-gray-700">${t.remarks || t.category}</p></div>
                        <div class="flex items-center gap-3"><span class="text-sm font-bold ${t.type==='expense'?'text-red-500':'text-green-600'}">${t.type==='expense'?'-':'+'} NT$ ${t.amount.toLocaleString()}</span>
                        <div class="flex gap-1">${!t.isSub ? `<button onclick="App.openModal('transaction-modal', '${t.id}')" class="text-gray-400 hover:text-blue-500 p-1"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="App.deleteItem('transactions', '${t.id}')" class="text-gray-400 hover:text-red-500 p-1"><i class="fa-solid fa-xmark text-xs"></i></button>` : ''}</div></div>
                    </li>`).join('') : '<li class="text-center text-xs text-gray-400 py-4">無相關紀錄</li>';
            },
            toggleTxType: (t) => { document.getElementById('tx-type').value=t; const e=document.getElementById('btn-expense'), i=document.getElementById('btn-income'); if(t==='expense'){e.classList.add('bg-white','shadow','text-danger');e.classList.remove('text-gray-500');i.classList.remove('bg-white','shadow','text-primary');i.classList.add('text-gray-500'); renderDatalist(document.getElementById('cat-list'), State.categories.expense);}else{i.classList.add('bg-white','shadow','text-primary');i.classList.remove('text-gray-500');e.classList.remove('bg-white','shadow','text-danger');e.classList.add('text-gray-500');renderDatalist(document.getElementById('cat-list'), State.categories.income);} }
        };
        window.App = App; App.init();
    </script>
</body>
</html>
