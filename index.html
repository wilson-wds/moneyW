<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端記帳軟體 (簡化版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .loader-small { border: 2px solid #f3f3f3; border-top: 2px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #555; }
        .tab-btn.active { border-color: #3b82f6; background-color: #3b82f6; color: white; }
        .debt-card-clickable, .asset-card-clickable, .lending-card-clickable, .investment-card-clickable, .loan-card-clickable { cursor: pointer; }
        .category-stat-item.active { background-color: #dbeafe; }
    </style>
    <!-- Print-specific styles -->
    <style>
        @media print {
            body * { visibility: hidden; }
            .print-section, .print-section * { visibility: visible; }
            .print-section { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; padding: 20px !important; border: none !important; box-shadow: none !important; background-color: white !important; }
            .print-section .no-print { display: none !important; }
            .print-section.fixed { position: relative !important; inset: auto !important; }
            .print-section > div { box-shadow: none !important; max-width: 100% !important; width: 100% !important; padding: 0 !important; border: none !important; }
            .print-section ul, .print-section li { list-style: none; padding: 0; margin: 0; }
            .print-section li { border-bottom: 1px solid #ccc; padding: 8px 0; page-break-inside: avoid; }
            .print-section h1, .print-section h2, .print-section h3, .print-section h4 { margin-bottom: 1rem; color: black !important; }
            .print-section p, .print-section span, .print-section div { color: black !important; background: none !important; }
            .print-section a { text-decoration: none; }
            .print-section .text-green-600, .print-section .text-red-600 { color: black !important; }
            .print-section .bg-gray-50, .print-section .bg-green-100, .print-section .bg-red-100, .print-section .bg-blue-100 { background: none !important; border: 1px solid #ddd; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- 登入畫面 -->
    <div id="login-view" class="container mx-auto p-8 max-w-md text-center h-screen flex flex-col justify-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">歡迎使用雲端記帳</h1>
        <p class="text-gray-600 mb-8">請選擇登入方式以開始使用。</p>
        <div class="space-y-4">
            <button id="google-login-btn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 flex items-center justify-center gap-3 transition-colors">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                使用 Google 登入
            </button>
            <button id="anonymous-login-btn" class="w-full bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-gray-800 transition-colors">
                以訪客身份繼續
            </button>
        </div>
    </div>
    <!-- 主應用程式畫面 (預設隱藏) -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-5xl opacity-0 transition-opacity duration-500 hidden">
        <header class="mb-6 text-center no-print">
            <div id="auth-info" class="flex justify-center items-center gap-4 mb-4"></div>
            <h1 class="text-4xl font-bold text-gray-800">雲端記帳軟體</h1>
        </header>

        <!-- 分頁導覽 -->
        <nav class="mb-8 flex justify-center border-b flex-wrap no-print">
            <button id="tab-accounting" class="tab-btn active py-3 px-6 text-lg font-semibold border-b-4 transition-colors">記帳</button>
            <button id="tab-investment" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">投資</button>
            <button id="tab-debt" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">負債</button>
            <button id="tab-events" class="tab-btn py-3 px-6 text-lg font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-800 transition-colors">事件紀錄</button>
        </nav>

        <!-- 記帳分頁內容 -->
        <div id="accounting-view">
            <section class="mb-8 bg-white p-6 md:p-8 rounded-2xl shadow-lg no-print">
                <h2 class="text-2xl font-bold mb-6 text-center">即時統計</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-600 text-center border-b pb-2">本日</h3>
                        <div id="today-summary">
                            <div class="bg-teal-50 p-3 rounded-xl shadow-sm"><h2 class="text-sm font-semibold text-teal-800">收入</h2><p id="today-income" class="text-lg font-bold text-teal-600 mt-1">NT$ 0</p></div>
                            <div class="bg-orange-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-orange-800">支出</h2><p id="today-expense" class="text-lg font-bold text-orange-600 mt-1">NT$ 0</p></div>
                            <div class="bg-indigo-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-indigo-800">結餘</h2><p id="today-balance" class="text-lg font-bold text-indigo-600 mt-1">NT$ 0</p></div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-600 text-center border-b pb-2">本月</h3>
                        <div id="monthly-summary">
                            <div class="bg-pink-50 p-3 rounded-xl shadow-sm"><h2 class="text-sm font-semibold text-pink-800">收入</h2><p id="monthly-income" class="text-lg font-bold text-pink-600 mt-1">NT$ 0</p></div>
                            <div class="bg-amber-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-amber-800">支出</h2><p id="monthly-expense" class="text-lg font-bold text-amber-600 mt-1">NT$ 0</p></div>
                            <div class="bg-purple-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-purple-800">結餘</h2><p id="monthly-balance" class="text-lg font-bold text-purple-600 mt-1">NT$ 0</p></div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-600 text-center border-b pb-2">總計</h3>
                        <div id="summary">
                            <div class="bg-green-50 p-3 rounded-xl shadow-sm"><h2 class="text-sm font-semibold text-green-800">總收入</h2><p id="total-income" class="text-lg font-bold text-green-600 mt-1">NT$ 0</p></div>
                            <div class="bg-red-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-red-800">總支出</h2><p id="total-expense" class="text-lg font-bold text-red-600 mt-1">NT$ 0</p></div>
                            <div class="bg-blue-50 p-3 rounded-xl shadow-sm mt-4"><h2 class="text-sm font-semibold text-blue-800">目前結餘</h2><p id="balance" class="text-lg font-bold text-blue-600 mt-1">NT$ 0</p></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8 no-print">
                <h2 class="text-2xl font-bold mb-6">新增 / 編輯紀錄</h2>
                <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="hidden" id="transaction-id">
                    <div class="md:col-span-2"><fieldset class="flex gap-4"><legend class="sr-only">交易類型</legend><div><input type="radio" name="type" id="type-expense" value="expense" class="sr-only" checked><label for="type-expense" class="type-label cursor-pointer block w-full text-center p-3 rounded-lg border-2 border-gray-300 transition">支出</label></div><div><input type="radio" name="type" id="type-income" value="income" class="sr-only"><label for="type-income" class="type-label cursor-pointer block w-full text-center p-3 rounded-lg border-2 border-gray-300 transition">收入</label></div></fieldset></div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="amount" class="block text-sm font-medium text-gray-700 mb-1">金額</label><input type="number" id="amount" placeholder="輸入金額" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div>
                        <div><label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="transaction-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div>
                    </div>
                    <div class="flex items-end gap-2"><div class="flex-grow"><label for="category-input" class="block text-sm font-medium text-gray-700 mb-1">分類</label><input list="category-list" id="category-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="選擇或輸入新分類" required><datalist id="category-list"></datalist></div><button type="button" id="manage-categories-btn" class="p-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" title="管理分類"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button></div>
                    <div class="flex items-end gap-2"><div class="flex-grow"><label for="project-input" class="block text-sm font-medium text-gray-700 mb-1">專案 (選填)</label><input list="project-list" id="project-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="選擇或輸入新專案"><datalist id="project-list"></datalist></div><button type="button" id="manage-projects-btn" class="p-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" title="管理專案"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg></button></div>
                    <div class="md:col-span-2"><label for="remarks" class="block text-sm font-medium text-gray-700 mb-1">備註 (選填)</label><input type="text" id="remarks" placeholder="這筆錢用在哪裡？" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 flex justify-center items-center"><span id="submit-btn-text">新增紀錄</span><div id="submit-spinner" class="hidden loader-small"></div></button></div>
                </form>
            </section>
            <section id="main-transaction-list-section" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold">歷史紀錄</h2>
                    <div class="flex items-center gap-2 no-print">
                        <label for="history-date-filter" class="text-sm font-medium text-gray-600">篩選日期:</label>
                        <input type="date" id="history-date-filter" class="p-2 border rounded-lg text-sm">
                        <button id="show-today-btn" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition text-sm">顯示本日</button>
                        <button id="print-transactions-btn" class="bg-gray-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-gray-600 text-sm">列印</button>
                    </div>
                </div>
                <p id="history-display-date" class="text-lg font-semibold text-gray-600 mb-4 text-center"></p>
                <div id="loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <ul id="transaction-list" class="space-y-4"></ul>
                <p id="empty-state" class="hidden text-center text-gray-500 py-8">還沒有任何紀錄，快來新增第一筆吧！</p>
            </section>
        </div>

        <!-- 投資分頁內容 -->
        <div id="investment-view" class="hidden">
            <section class="mb-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4">投資總覽</h2>
                <div id="investment-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-100 p-6 rounded-xl shadow-sm">
                        <h2 class="text-lg font-semibold text-blue-800">總資產現值</h2>
                        <p id="total-investment-value" class="text-2xl font-bold text-blue-600 mt-2">NT$ 0</p>
                    </div>
                    <div class="bg-purple-100 p-6 rounded-xl shadow-sm">
                        <h2 class="text-lg font-semibold text-purple-800">總報酬 (已實現)</h2>
                        <p id="total-investment-return" class="text-2xl font-bold text-purple-600 mt-2">NT$ 0</p>
                    </div>
                    <div class="bg-teal-100 p-6 rounded-xl shadow-sm">
                        <h2 class="text-lg font-semibold text-teal-800">總報酬率 (ROI)</h2>
                        <p id="total-investment-roi" class="text-2xl font-bold text-teal-600 mt-2">0.00%</p>
                    </div>
                </div>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">新增投資帳戶</h2>
                <form id="investment-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="investment-name" class="block text-sm font-medium text-gray-700 mb-1">帳戶名稱</label><input type="text" id="investment-name" placeholder="例如: 富邦證券" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <div><label for="investment-initial-value" class="block text-sm font-medium text-gray-700 mb-1">初始投入金額 (選填)</label><input type="number" id="investment-initial-value" placeholder="輸入初始金額 (可為0)" class="w-full p-3 border border-gray-300 rounded-lg"></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">建立帳戶</button></div>
                </form>
            </section>

            <!-- 收入預算區塊 -->
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">新增投資收入預算</h2>
                <form id="investment-budget-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="budget-investment-account" class="block text-sm font-medium text-gray-700 mb-1">投資帳戶</label>
                        <select id="budget-investment-account" class="w-full p-3 border border-gray-300 rounded-lg bg-white" required>
                            <option value="">-- 選擇帳戶 --</option>
                        </select>
                    </div>
                    <div class="md:col-span-1">
                        <label for="budget-expected-date" class="block text-sm font-medium text-gray-700 mb-1">預期日期</label>
                        <input type="date" id="budget-expected-date" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="md:col-span-1">
                        <label for="budget-expected-amount" class="block text-sm font-medium text-gray-700 mb-1">預期金額</label>
                        <input type="number" id="budget-expected-amount" placeholder="輸入金額" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="md:col-span-3">
                        <label for="budget-description" class="block text-sm font-medium text-gray-700 mb-1">說明</label>
                        <input type="text" id="budget-description" placeholder="例如: 0056 配息" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="md:col-span-3">
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">新增預算</button>
                    </div>
                </form>
            </section>

            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">待實現收入預算</h2>
                <div id="investment-budget-loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <ul id="investment-budget-list" class="space-y-4"></ul>
                <p id="investment-budget-empty-state" class="hidden text-center text-gray-500 py-8">尚未建立任何待實現的收入預算。</p>
            </section>
            <!-- 收入預算區塊結束 -->

            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">投資帳戶列表</h2>
                <div id="investment-loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <div id="investment-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <p id="investment-empty-state" class="hidden text-center text-gray-500 py-8">尚未建立任何投資帳戶。</p>
            </section>
        </div>

        <!-- 負債分頁內容 -->
        <div id="debt-view" class="hidden">
            <section class="mb-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4">負債總覽</h2>
                <div id="debt-summary" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-yellow-100 p-4 rounded-xl shadow-sm">
                        <h2 class="text-base font-semibold text-yellow-800">初始總負債</h2>
                        <p id="total-initial-debt" class="text-xl font-bold text-yellow-600 mt-1">NT$ 0</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-xl shadow-sm">
                        <h2 class="text-base font-semibold text-red-800">目前總負債</h2>
                        <p id="total-current-debt" class="text-xl font-bold text-red-600 mt-1">NT$ 0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-xl shadow-sm">
                        <h2 class="text-base font-semibold text-green-800">已還款總額</h2>
                        <p id="total-repaid-debt" class="text-xl font-bold text-green-600 mt-1">NT$ 0</p>
                    </div>
                    <div class="bg-cyan-100 p-4 rounded-xl shadow-sm">
                        <h2 class="text-base font-semibold text-cyan-800">當月總還款</h2>
                        <p id="total-monthly-repayment" class="text-xl font-bold text-cyan-600 mt-1">NT$ 0</p>
                    </div>
                </div>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">新增一筆負債</h2>
                <form id="debt-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="debt-name" class="block text-sm font-medium text-gray-700 mb-1">負債項目</label><input type="text" id="debt-name" placeholder="例如: 信用卡、學貸" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required></div>
                    <div><label for="debt-total-amount" class="block text-sm font-medium text-gray-700 mb-1">總金額</label><input type="number" id="debt-total-amount" placeholder="輸入總負債金額" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300 flex justify-center items-center"><span id="add-debt-btn-text">新增負債</span><div id="add-debt-spinner" class="hidden loader-small"></div></button></div>
                </form>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">負債列表</h2>
                <div id="debt-loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <div id="debt-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <p id="debt-empty-state" class="hidden text-center text-gray-500 py-8">太棒了！目前沒有任何負債紀錄。</p>
            </section>
        </div>

        <!-- 事件紀錄分頁 -->
        <div id="events-view" class="hidden">
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6">新增事件紀錄</h2>
                <form id="event-form" class="space-y-4">
                    <div><label for="event-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="event-date" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <div><label for="event-title" class="block text-sm font-medium text-gray-700 mb-1">標題</label><input type="text" id="event-title" placeholder="事件標題" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                    <div><label for="event-description" class="block text-sm font-medium text-gray-700 mb-1">內容</label><textarea id="event-description" placeholder="詳細內容..." rows="4" class="w-full p-3 border border-gray-300 rounded-lg"></textarea></div>
                    <div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">新增事件</button></div>
                </form>
            </section>
            <section class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">事件時間軸</h2>
                <div id="event-loading-indicator" class="flex justify-center items-center py-8"><div class="loader"></div></div>
                <div id="event-list" class="space-y-6 border-l-2 border-indigo-200 ml-3"></div>
                <p id="event-empty-state" class="hidden text-center text-gray-500 py-8">尚未有任何事件紀錄。</p>
            </section>
        </div>

    </div>
    <!-- Modals -->
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">管理分類</h3><button id="close-category-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><ul id="custom-category-list" class="space-y-2 max-h-60 overflow-y-auto mb-6 border-t border-b py-4"></ul><div class="flex justify-end"><button type="button" id="close-category-modal-btn-bottom" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">關閉</button></div></div></div>
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">管理專案</h3><button id="close-project-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><ul id="custom-project-list" class="space-y-2 max-h-60 overflow-y-auto mb-6 border-t border-b py-4"></ul><div class="flex justify-end"><button type="button" id="close-project-modal-btn-bottom" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">關閉</button></div></div></div>
    <div id="repayment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-6">記錄一筆還款</h3><form id="repayment-form"><input type="hidden" id="repayment-debt-id"><input type="hidden" id="repayment-debt-name"><div class="mb-4"><label for="repayment-amount" class="block text-sm font-medium text-gray-700 mb-1">還款金額</label><input type="number" id="repayment-amount" placeholder="輸入此次還款金額" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="repayment-date" class="block text-sm font-medium text-gray-700 mb-1">還款日期</label><input type="date" id="repayment-date" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="repayment-remark" class="block text-sm font-medium text-gray-700 mb-1">備註 (選填)</label><input type="text" id="repayment-remark" placeholder="還款備註" class="w-full p-3 border border-gray-300 rounded-lg"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-repayment-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">確認還款</button></div></form></div></div>
    <div id="debt-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-lg"><div class="flex justify-between items-center mb-4"><h3 id="debt-detail-title" class="text-2xl font-bold">負債詳情</h3><button id="close-debt-detail-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none no-print">&times;</button></div><div id="debt-detail-display-view"><div class="mb-4 p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">項目名稱</p><p id="debt-detail-name" class="text-lg font-semibold"></p><p class="text-sm text-gray-500 mt-2">初始總金額</p><p id="debt-detail-total" class="text-lg font-semibold"></p><p class="text-sm text-gray-500 mt-2">本月已還</p><p id="debt-detail-monthly-repayment" class="text-lg font-semibold text-cyan-600"></p></div><div class="flex justify-end mb-4 gap-2 no-print"><button id="print-debt-detail-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">列印</button><button id="edit-debt-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">編輯</button></div></div><form id="debt-edit-form" class="hidden mb-4 no-print"><input type="hidden" id="edit-debt-id"><div class="mb-4"><label for="edit-debt-name" class="block text-sm font-medium text-gray-700 mb-1">項目名稱</label><input type="text" id="edit-debt-name" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="edit-debt-total" class="block text-sm font-medium text-gray-700 mb-1">初始總金額</label><input type="number" id="edit-debt-total" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="flex justify-end gap-4"><button type="button" id="cancel-edit-debt-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">儲存變更</button></div></form><h4 class="text-lg font-bold mb-2 border-t pt-4">還款紀錄</h4><ul id="repayment-history-list" class="space-y-2 max-h-48 overflow-y-auto"></ul><p id="repayment-history-empty" class="hidden text-center text-gray-500 py-4">尚無還款紀錄</p></div></div>
    <div id="investment-transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><h3 id="investment-transaction-title" class="text-2xl font-bold mb-6"></h3><form id="investment-transaction-form"><input type="hidden" id="investment-transaction-account-id"><input type="hidden" id="investment-transaction-account-name"><input type="hidden" id="investment-transaction-id"><input type="hidden" id="investment-main-transaction-id"><div class="mb-4"><label for="investment-transaction-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="investment-transaction-date" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">類型</label><select id="investment-transaction-type" class="w-full p-3 border border-gray-300 rounded-lg bg-white"><option value="expense">支出 (買入/投入)</option><option value="income">收入 (賣出/配息)</option></select></div><div class="mb-4"><label for="investment-transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">金額</label><input type="number" id="investment-transaction-amount" placeholder="輸入金額" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="investment-transaction-remark" class="block text-sm font-medium text-gray-700 mb-1">備註</label><input type="text" id="investment-transaction-remark" placeholder="例如: 買入TSMC 1股" class="w-full p-3 border border-gray-300 rounded-lg"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-investment-transaction-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">確認</button></div></form></div></div>
    <div id="investment-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-lg"><div class="flex justify-between items-center mb-4"><h3 id="investment-detail-title" class="text-2xl font-bold"></h3><div class="flex items-center gap-2 no-print"><button id="print-investment-detail-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">列印</button><button id="close-investment-detail-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div></div><h4 class="text-lg font-bold mb-2 border-t pt-4">交易紀錄</h4><ul id="investment-history-list" class="space-y-2 max-h-96 overflow-y-auto"></ul><p id="investment-history-empty" class="hidden text-center text-gray-500 py-4">尚無交易紀錄</p></div></div>
    <div id="edit-investment-account-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-6">編輯投資帳戶</h3><form id="edit-investment-account-form"><input type="hidden" id="edit-investment-account-id"><div class="mb-4"><label for="edit-investment-account-name" class="block text-sm font-medium text-gray-700 mb-1">帳戶名稱</label><input type="text" id="edit-investment-account-name" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="flex justify-end gap-4"><button type="button" id="cancel-edit-investment-account-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">儲存</button></div></form></div></div>
    <div id="update-market-value-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md"><h3 id="update-market-value-title" class="text-2xl font-bold mb-6">更新資產現值</h3><form id="update-market-value-form"><input type="hidden" id="update-market-value-id"><div class="mb-4"><label for="update-market-value-amount" class="block text-sm font-medium text-gray-700 mb-1">目前資產總價值</label><input type="number" id="update-market-value-amount" placeholder="輸入目前總市價" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="flex justify-end gap-4"><button type="button" id="cancel-update-market-value-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">取消</button><button type="submit" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">確認更新</button></div></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, serverTimestamp, updateDoc, increment, Timestamp, getDocs, writeBatch, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM 元素 ---
        const loginView = document.getElementById('login-view');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const anonymousLoginBtn = document.getElementById('anonymous-login-btn');
        const appContainer = document.getElementById('app-container'), authInfo = document.getElementById('auth-info');
        const accountingView = document.getElementById('accounting-view'), debtView = document.getElementById('debt-view'), eventsView = document.getElementById('events-view'), investmentView = document.getElementById('investment-view');
        const tabAccounting = document.getElementById('tab-accounting'), tabDebt = document.getElementById('tab-debt'), tabEvents = document.getElementById('tab-events'), tabInvestment = document.getElementById('tab-investment');
        const form = document.getElementById('transaction-form'), amountInput = document.getElementById('amount'), transactionDateInput = document.getElementById('transaction-date'), remarksInput = document.getElementById('remarks'), transactionList = document.getElementById('transaction-list');
        const categoryInput = document.getElementById('category-input'), categoryDatalist = document.getElementById('category-list');
        const projectInput = document.getElementById('project-input'), projectDatalist = document.getElementById('project-list');
        const totalIncomeEl = document.getElementById('total-income'), totalExpenseEl = document.getElementById('total-expense'), balanceEl = document.getElementById('balance');
        const todayIncomeEl = document.getElementById('today-income'), todayExpenseEl = document.getElementById('today-expense'), todayBalanceEl = document.getElementById('today-balance');
        const monthlyIncomeEl = document.getElementById('monthly-income'), monthlyExpenseEl = document.getElementById('monthly-expense'), monthlyBalanceEl = document.getElementById('monthly-balance');
        const loadingIndicator = document.getElementById('loading-indicator'), emptyState = document.getElementById('empty-state');
        const typeLabels = document.querySelectorAll('.type-label'), expenseRadio = document.getElementById('type-expense');
        const submitBtnText = document.getElementById('submit-btn-text'), submitSpinner = document.getElementById('submit-spinner');
        const manageCategoriesBtn = document.getElementById('manage-categories-btn'), categoryModal = document.getElementById('category-modal'), customCategoryList = document.getElementById('custom-category-list');
        const manageProjectsBtn = document.getElementById('manage-projects-btn'), projectModal = document.getElementById('project-modal'), customProjectList = document.getElementById('custom-project-list');
        const debtForm = document.getElementById('debt-form'), debtList = document.getElementById('debt-list'), debtLoadingIndicator = document.getElementById('debt-loading-indicator'), debtEmptyState = document.getElementById('debt-empty-state');
        const totalInitialDebtEl = document.getElementById('total-initial-debt'), totalCurrentDebtEl = document.getElementById('total-current-debt'), totalRepaidDebtEl = document.getElementById('total-repaid-debt'), totalMonthlyRepaymentEl = document.getElementById('total-monthly-repayment');
        const repaymentModal = document.getElementById('repayment-modal'), repaymentForm = document.getElementById('repayment-form'), repaymentDebtIdInput = document.getElementById('repayment-debt-id'), repaymentDebtNameInput = document.getElementById('repayment-debt-name'), repaymentAmountInput = document.getElementById('repayment-amount'), repaymentDateInput = document.getElementById('repayment-date'), cancelRepaymentBtn = document.getElementById('cancel-repayment-btn');
        const debtDetailModal = document.getElementById('debt-detail-modal'), closeDebtDetailModalBtn = document.getElementById('close-debt-detail-modal-btn');
        const debtDetailDisplayView = document.getElementById('debt-detail-display-view'), debtEditForm = document.getElementById('debt-edit-form');
        const debtDetailName = document.getElementById('debt-detail-name'), debtDetailTotal = document.getElementById('debt-detail-total'), debtDetailMonthlyRepayment = document.getElementById('debt-detail-monthly-repayment');
        const editDebtBtn = document.getElementById('edit-debt-btn'), cancelEditDebtBtn = document.getElementById('cancel-edit-debt-btn');
        const editDebtIdInput = document.getElementById('edit-debt-id'), editDebtNameInput = document.getElementById('edit-debt-name'), editDebtTotalInput = document.getElementById('edit-debt-total');
        const repaymentHistoryList = document.getElementById('repayment-history-list'), repaymentHistoryEmpty = document.getElementById('repayment-history-empty');
        const eventForm = document.getElementById('event-form'), eventList = document.getElementById('event-list'), eventLoadingIndicator = document.getElementById('event-loading-indicator'), eventEmptyState = document.getElementById('event-empty-state');
        const investmentForm = document.getElementById('investment-form'), investmentList = document.getElementById('investment-list'), investmentLoadingIndicator = document.getElementById('investment-loading-indicator'), investmentEmptyState = document.getElementById('investment-empty-state');
        const totalInvestmentValueEl = document.getElementById('total-investment-value'), totalInvestmentReturnEl = document.getElementById('total-investment-return'), totalInvestmentRoiEl = document.getElementById('total-investment-roi');
        const investmentTransactionModal = document.getElementById('investment-transaction-modal'), investmentTransactionForm = document.getElementById('investment-transaction-form'), cancelInvestmentTransactionBtn = document.getElementById('cancel-investment-transaction-btn');
        const investmentDetailModal = document.getElementById('investment-detail-modal'), closeInvestmentDetailModalBtn = document.getElementById('close-investment-detail-modal-btn'), investmentHistoryList = document.getElementById('investment-history-list'), investmentHistoryEmpty = document.getElementById('investment-history-empty');
        const editInvestmentAccountModal = document.getElementById('edit-investment-account-modal'), editInvestmentAccountForm = document.getElementById('edit-investment-account-form'), cancelEditInvestmentAccountBtn = document.getElementById('cancel-edit-investment-account-btn');
        const updateMarketValueModal = document.getElementById('update-market-value-modal'), updateMarketValueForm = document.getElementById('update-market-value-form'), cancelUpdateMarketValueBtn = document.getElementById('cancel-update-market-value-btn');
        const printTransactionsBtn = document.getElementById('print-transactions-btn');
        const printDebtDetailBtn = document.getElementById('print-debt-detail-btn');
        const printInvestmentDetailBtn = document.getElementById('print-investment-detail-btn');
        const historyDateFilter = document.getElementById('history-date-filter');
        const showTodayBtn = document.getElementById('show-today-btn');
        const historyDisplayDateEl = document.getElementById('history-display-date');

        // Investment Budget Elements
        const investmentBudgetForm = document.getElementById('investment-budget-form');
        const budgetInvestmentSelect = document.getElementById('budget-investment-account');
        const investmentBudgetList = document.getElementById('investment-budget-list');
        const investmentBudgetLoadingIndicator = document.getElementById('investment-budget-loading-indicator');
        const investmentBudgetEmptyState = document.getElementById('investment-budget-empty-state');


        // --- Firebase & App 狀態 ---
        let db, auth, userId, transactionsColRef, categoriesColRef, projectsColRef, debtsColRef, eventsColRef, investmentsColRef, investmentBudgetsColRef;
        let unsubscribeTransactions, unsubscribeCategories, unsubscribeProjects, unsubscribeDebts, unsubscribeEvents, unsubscribeInvestments, unsubscribeInvestmentBudgets;
        let allTransactions = [], customCategories = [], customProjects = [], allDebts = [], allEvents = [], allInvestments = [], allInvestmentBudgets = [];
        const defaultCategories = { expense: ['飲食', '交通', '居住', '娛樂', '購物', '醫療', '教育', '負債還款', '投資支出', '其他'], income: ['薪資', '獎金', '投資收入', '兼職', '債權回收', '其他'] };

        const firebaseConfig = {
          apiKey: "AIzaSyAqFHm6Bn35m8xauc50ZvNNy_rxIZzCMTE",
          authDomain: "moneyw-f8105.firebaseapp.com",
          projectId: "moneyw-f8105",
          storageBucket: "moneyw-f8105.appspot.com",
          messagingSenderId: "155586195799",
          appId: "1:155586195799:web:302184fbf613f032a88e12"
        };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                // 使用者原先的路徑
                const basePath = `/users/${userId}`;
                transactionsColRef = collection(db, `${basePath}/transactions`);
                categoriesColRef = collection(db, `${basePath}/categories`);
                projectsColRef = collection(db, `${basePath}/projects`);
                debtsColRef = collection(db, `${basePath}/debts`);
                eventsColRef = collection(db, `${basePath}/events`);
                investmentsColRef = collection(db, `${basePath}/investments`);
                investmentBudgetsColRef = collection(db, `${basePath}/investmentBudgets`); // 新增的路徑

                setupUIForLoggedInUser(user);

                listenForTransactions();
                listenForCustomItems(categoriesColRef, (items) => { customCategories = items; populateCategoryDatalist(); populateModalList(customCategoryList, customCategories, '尚無自訂分類', 'category'); });
                listenForCustomItems(projectsColRef, (items) => { customProjects = items; populateDatalist(projectDatalist, customProjects.map(p => p.name)); populateModalList(customProjectList, customProjects, '尚無自訂專案', 'project'); });
                listenForDebts();
                listenForEvents();
                listenForInvestments();
                listenForInvestmentBudgets(); // 開始監聽投資預算

            } else {
                setupUIForLoggedOutUser();
                if (unsubscribeTransactions) unsubscribeTransactions();
                if (unsubscribeCategories) unsubscribeCategories();
                if (unsubscribeProjects) unsubscribeProjects();
                if (unsubscribeDebts) unsubscribeDebts();
                if (unsubscribeEvents) unsubscribeEvents();
                if (unsubscribeInvestments) unsubscribeInvestments();
                if (unsubscribeInvestmentBudgets) unsubscribeInvestmentBudgets(); // 停止監聽
            }
        });

        function setupUIForLoggedInUser(user) {
            loginView.classList.add('hidden');
            appContainer.classList.remove('hidden');
            setTimeout(() => appContainer.classList.remove('opacity-0'), 50);

            let userInfoHtml = '';
            if (user.isAnonymous) {
                userInfoHtml = `<span>訪客模式 (UID: <span class="font-mono">${user.uid.substring(0, 6)}...</span>)</span>`;
            } else {
                userInfoHtml = `<img src="${user.photoURL}" alt="User Avatar" class="w-8 h-8 rounded-full"><span class="font-semibold">${user.displayName}</span>`;
            }
            authInfo.innerHTML = `${userInfoHtml}<button id="logout-btn" class="ml-4 bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-red-600">登出</button>`;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        }

        function setupUIForLoggedOutUser() {
            loginView.classList.remove('hidden');
            appContainer.classList.add('hidden');
            appContainer.classList.add('opacity-0');
            authInfo.innerHTML = '';
            transactionList.innerHTML = '';
            debtList.innerHTML = '';
            eventList.innerHTML = '';
            investmentList.innerHTML = '';
            investmentBudgetList.innerHTML = ''; // 登出時清空
        }

        function listenForTransactions() {
            if (unsubscribeTransactions) unsubscribeTransactions();
            unsubscribeTransactions = onSnapshot(query(transactionsColRef), (snapshot) => {
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allTransactions.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

                const now = new Date();
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                const todayTransactions = allTransactions.filter(tx => {
                    if (!tx.timestamp) return false;
                    const txDate = tx.timestamp.toDate();
                    return txDate >= startOfToday && txDate < endOfToday;
                });

                renderMainTransactionList();
                updateSummary(allTransactions);
                updateTodaySummary(todayTransactions);
                updateMonthlySummary(allTransactions);
                updateMonthlyRepaymentSummary();
            }, (error) => console.error("監聽交易資料失敗:", error));
        }

        function listenForDebts() {
            if (unsubscribeDebts) unsubscribeDebts();
            unsubscribeDebts = onSnapshot(query(debtsColRef), (snapshot) => {
                if (debtLoadingIndicator) debtLoadingIndicator.classList.add('hidden');
                allDebts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allDebts.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                updateDebtSummary(allDebts);
                renderDebts(allDebts);
                if (debtEmptyState) debtEmptyState.classList.toggle('hidden', allDebts.length > 0);
            }, (error) => console.error("監聽負債資料失敗:", error));
        }

        function listenForEvents() {
            if (unsubscribeEvents) unsubscribeEvents();
            unsubscribeEvents = onSnapshot(query(eventsColRef), (snapshot) => {
                if (eventLoadingIndicator) eventLoadingIndicator.classList.add('hidden');
                allEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allEvents.sort((a, b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0));
                renderEvents(allEvents);
                if (eventEmptyState) eventEmptyState.classList.toggle('hidden', allEvents.length > 0);
            }, (error) => console.error("監聽事件資料失敗:", error));
        }

        function listenForInvestments() {
            if(unsubscribeInvestments) unsubscribeInvestments();
            unsubscribeInvestments = onSnapshot(query(investmentsColRef), async (snapshot) => {
                if (investmentLoadingIndicator) investmentLoadingIndicator.classList.add('hidden');
                const investmentPromises = snapshot.docs.map(async (investmentDoc) => {
                    const investmentData = { id: investmentDoc.id, ...investmentDoc.data() };
                    const investmentTxColRef = collection(db, `${investmentsColRef.path}/${investmentDoc.id}/transactions`);
                    const txSnapshot = await getDocs(query(investmentTxColRef));
                    investmentData.transactions = txSnapshot.docs.map(txDoc => ({id: txDoc.id, ...txDoc.data()}));
                    return investmentData;
                });
                allInvestments = await Promise.all(investmentPromises);
                renderInvestments(allInvestments);
                updateInvestmentSummary(allInvestments);
                if (investmentEmptyState) investmentEmptyState.classList.toggle('hidden', allInvestments.length > 0);
                populateBudgetInvestmentSelect(); // 確保下拉選單更新
            }, (error) => console.error("監聽投資資料失敗:", error));
        }

        // 新增：監聽投資收入預算
        function listenForInvestmentBudgets() {
            if (unsubscribeInvestmentBudgets) unsubscribeInvestmentBudgets();
            
            // 移除 where 查詢，改為客戶端過濾
            const q = query(investmentBudgetsColRef); 
            
            unsubscribeInvestmentBudgets = onSnapshot(q, (snapshot) => {
                if (investmentBudgetLoadingIndicator) investmentBudgetLoadingIndicator.classList.add('hidden');
                
                const allBudgets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 在客戶端過濾未實現的項目
                allInvestmentBudgets = allBudgets.filter(budget => budget.isRealized === false);
                
                allInvestmentBudgets.sort((a, b) => (a.expectedDate?.toMillis() || 0) - (b.expectedDate?.toMillis() || 0));
                
                renderInvestmentBudgets(allInvestmentBudgets);
                
                if (investmentBudgetEmptyState) investmentBudgetEmptyState.classList.toggle('hidden', allInvestmentBudgets.length > 0);
            }, (error) => {
                console.error("監聽投資預算資料失敗:", error);
                // 顯示錯誤給使用者或採取備用措施
                if (investmentBudgetLoadingIndicator) investmentBudgetLoadingIndicator.classList.add('hidden');
                if (investmentBudgetList) investmentBudgetList.innerHTML = `<li class="text-center text-red-500">載入預算資料失敗，請檢查 Firestore 索引或網路連線。</li>`;
            });
        }


        function listenForCustomItems(collectionRef, callback) {
            const q = query(collectionRef);
            return onSnapshot(q, (snapshot) => {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                callback(items);
            }, (error) => console.error("監聽自訂項目失敗:", error));
        }

        // --- 渲染函式 ---
        function renderTransactions(transactions) {
            if (!transactionList) return;
            transactionList.innerHTML = '';
            transactions.forEach(tx => {
                const isIncome = tx.type === 'income';
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 rounded-lg hover:bg-gray-50 border-b';
                li.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="flex-shrink-0">
                            <p class="font-semibold">${tx.category}</p>
                            <p class="text-sm text-gray-500">${tx.project || '無專案'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">${tx.remarks || '無備註'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'} NT$ ${tx.amount.toLocaleString()}</p>
                        <div class="flex items-center gap-2 justify-end">
                            <span class="text-xs text-gray-400">${tx.timestamp ? tx.timestamp.toDate().toLocaleDateString('zh-TW') : '...'}</span>
                            <button data-id="${tx.id}" class="edit-btn text-gray-400 hover:text-blue-500 no-print p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                            </button>
                            <button data-id="${tx.id}" class="delete-btn text-gray-400 hover:text-red-500 no-print p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>`;
                transactionList.appendChild(li);
            });
        }

        function renderDebts(debts) {
            if (!debtList) return;
            debtList.innerHTML = '';
            debts.forEach(debt => {
                const percentage = debt.totalAmount > 0 ? ((debt.totalAmount - debt.remainingAmount) / debt.totalAmount) * 100 : 100;
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border debt-card-clickable hover:shadow-md transition-shadow';
                card.dataset.id = debt.id;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-md font-bold text-gray-800">${debt.name}</h3>
                        <button class="delete-debt-btn text-gray-400 hover:text-red-500 z-10 relative no-print" data-id="${debt.id}">&times;</button>
                    </div>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>剩餘: NT$ ${debt.remainingAmount.toLocaleString()}</span>
                            <span>總額: NT$ ${debt.totalAmount.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-green-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    <div class="mt-3 text-right no-print">
                        <button class="repay-btn bg-green-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-green-700 z-10 relative text-sm" data-id="${debt.id}" data-name="${debt.name}" data-remaining="${debt.remainingAmount}">償還</button>
                    </div>
                `;
                debtList.appendChild(card);
            });
        }

        function renderEvents(events) {
            if (!eventList) return;
            eventList.innerHTML = '';
            events.forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.className = 'relative pl-8';
                eventEl.innerHTML = `
                    <div class="absolute left-0 top-1 w-4 h-4 bg-indigo-500 rounded-full -ml-2 border-2 border-white"></div>
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <div class="flex justify-between items-center mb-1">
                            <p class="font-bold text-indigo-800">${event.title}</p>
                            <span class="text-sm text-gray-500">${event.date.toDate().toLocaleDateString('zh-TW')}</span>
                        </div>
                        <p class="text-gray-700 whitespace-pre-wrap">${event.description}</p>
                        <div class="text-right mt-2 no-print">
                             <button class="delete-event-btn text-gray-400 hover:text-red-500 text-xs" data-id="${event.id}">刪除</button>
                        </div>
                    </div>
                `;
                eventList.appendChild(eventEl);
            });
        }

        function renderInvestments(investments) {
            if (!investmentList) return;
            investmentList.innerHTML = '';
            investments.forEach(inv => {
                const income = inv.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expense = inv.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const totalCost = expense;
                const profit = income - expense;
                const roi = totalCost > 0 ? (profit / totalCost) * 100 : 0;

                const profitColor = profit >= 0 ? 'text-green-600' : 'text-red-600';
                const roiColor = roi >= 0 ? 'text-teal-600' : 'text-orange-600';

                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-md font-bold text-gray-800 investment-card-clickable flex-grow" data-id="${inv.id}">${inv.name}</h3>
                        <div class="flex items-center no-print">
                            <button class="edit-investment-account-btn text-gray-400 hover:text-blue-500 p-1" data-id="${inv.id}" data-name="${inv.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                            </button>
                            <button class="delete-investment-btn text-gray-400 hover:text-red-500 p-1" data-id="${inv.id}">&times;</button>
                        </div>
                    </div>
                    <div class="mt-2 grid grid-cols-3 gap-y-2 gap-x-4 investment-card-clickable" data-id="${inv.id}">
                        <div>
                            <p class="text-xs text-gray-500">資產現值</p>
                            <p class="text-lg font-bold text-blue-600">NT$ ${(inv.marketValue || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">總報酬 (已實現)</p>
                            <p class="text-lg font-bold ${profitColor}">${profit >= 0 ? '+' : ''}${profit.toLocaleString()}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">報酬率</p>
                            <p class="text-lg font-bold ${roiColor}">${roi.toFixed(2)}%</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">總投資收入</p>
                            <p class="text-lg font-bold text-green-600">NT$ ${income.toLocaleString()}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">總投資支出</p>
                            <p class="text-lg font-bold text-red-600">NT$ ${expense.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-end gap-2 no-print">
                        <button class="update-market-value-btn bg-yellow-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-yellow-600 text-sm" data-id="${inv.id}" data-name="${inv.name}" data-value="${inv.marketValue || 0}">更新現值</button>
                        <button class="add-investment-tx-btn bg-blue-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-700 text-sm" data-id="${inv.id}" data-name="${inv.name}">新增交易</button>
                    </div>
                `;
                investmentList.appendChild(card);
            });
        }
        
        // 新增：渲染投資收入預算列表
        function renderInvestmentBudgets(budgets) {
            if (!investmentBudgetList) return;
            investmentBudgetList.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); // 設定為今天凌晨

            budgets.forEach(budget => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 rounded-lg bg-gray-50 border gap-4';
                
                const expectedDate = budget.expectedDate.toDate();
                const isOverdue = expectedDate < today;
                const dateString = expectedDate.toLocaleDateString('zh-TW');

                li.innerHTML = `
                    <div class="flex-shrink-0">
                        <input type="checkbox" data-id="${budget.id}" class="realize-budget-btn h-6 w-6 text-green-600 border-gray-300 rounded focus:ring-green-500 cursor-pointer">
                    </div>
                    <div class="flex-grow">
                        <p class="font-bold text-gray-800">${budget.description}</p>
                        <p class="text-sm text-gray-500">${budget.investmentName}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-lg font-bold text-green-600">+ NT$ ${budget.amount.toLocaleString()}</p>
                        <p class="text-sm ${isOverdue ? 'text-red-600 font-bold' : 'text-gray-500'}">${dateString} ${isOverdue ? ' (已過期)' : ''}</p>
                    </div>
                    <div class="flex-shrink-0 no-print">
                         <button data-id="${budget.id}" class="delete-investment-budget-btn text-gray-400 hover:text-red-500 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                         </button>
                    </div>
                `;
                investmentBudgetList.appendChild(li);
            });
        }

        function renderRepaymentHistory(debtName) {
            const history = allTransactions.filter(tx => tx.category === '負債還款' && tx.project === debtName);
            repaymentHistoryList.innerHTML = '';
            repaymentHistoryEmpty.classList.toggle('hidden', history.length > 0);
            history.forEach(tx => {
                const li = document.createElement('li');
                li.className = 'p-2 bg-gray-50 rounded';
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm text-gray-600">${tx.timestamp.toDate().toLocaleDateString('zh-TW')}</span>
                            ${tx.remarks ? `<p class="text-xs text-gray-500 mt-1">${tx.remarks}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                             <span class="text-sm font-semibold text-red-600">- NT$ ${tx.amount.toLocaleString()}</span>
                             <button data-id="${tx.id}" data-amount="${tx.amount}" class="delete-repayment-btn text-gray-400 hover:text-red-500 p-1 rounded-full no-print">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                             </button>
                        </div>
                    </div>
                `;
                repaymentHistoryList.appendChild(li);
            });
        }

        function renderInvestmentHistory(investmentId) {
            const investment = allInvestments.find(inv => inv.id === investmentId);
            if (!investment) return;
            investmentHistoryList.innerHTML = '';
            investmentHistoryEmpty.classList.toggle('hidden', investment.transactions.length > 0);

            investment.transactions.sort((a,b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0)).forEach(tx => {
                const li = document.createElement('li');
                const isIncome = tx.type === 'income';
                li.className = `p-2 rounded ${isIncome ? 'bg-green-50' : 'bg-red-50'}`;
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-grow">
                            <p class="text-sm text-gray-600">${tx.date.toDate().toLocaleDateString('zh-TW')}</p>
                            <p class="text-sm text-gray-500">${tx.remark || '無備註'}</p>
                        </div>
                        <span class="text-sm font-semibold ${isIncome ? 'text-green-700' : 'text-red-700'}">${isIncome ? '+' : '-'} NT$ ${tx.amount.toLocaleString()}</span>
                        <div class="flex items-center ml-2 no-print">
                            <button class="edit-investment-tx-btn text-gray-400 hover:text-blue-500 p-1" data-investment-id="${investmentId}" data-tx-id="${tx.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                            </button>
                            <button class="delete-investment-tx-btn text-gray-400 hover:text-red-500 p-1" data-investment-id="${investmentId}" data-tx-id="${tx.id}" data-main-tx-id="${tx.mainTransactionId}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                `;
                investmentHistoryList.appendChild(li);
            });
        }
        
        function updateSummary(transactions) {
            if (!totalIncomeEl || !totalExpenseEl || !balanceEl) return;
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            totalIncomeEl.textContent = `NT$ ${income.toLocaleString()}`;
            totalExpenseEl.textContent = `NT$ ${expense.toLocaleString()}`;
            balanceEl.textContent = `NT$ ${(income - expense).toLocaleString()}`;
        }

        function updateTodaySummary(transactions) {
            if (!todayIncomeEl || !todayExpenseEl || !todayBalanceEl) return;
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            todayIncomeEl.textContent = `NT$ ${income.toLocaleString()}`;
            todayExpenseEl.textContent = `NT$ ${expense.toLocaleString()}`;
            todayBalanceEl.textContent = `NT$ ${(income - expense).toLocaleString()}`;
        }

        function updateMonthlySummary(transactions) {
            if (!monthlyIncomeEl || !monthlyExpenseEl || !monthlyBalanceEl) return;
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);

            const monthlyTransactions = transactions.filter(tx => {
                 if (!tx.timestamp) return false;
                 const txDate = tx.timestamp.toDate();
                 return txDate >= startOfMonth && txDate <= endOfMonth;
            });

            const income = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            monthlyIncomeEl.textContent = `NT$ ${income.toLocaleString()}`;
            monthlyExpenseEl.textContent = `NT$ ${expense.toLocaleString()}`;
            monthlyBalanceEl.textContent = `NT$ ${(income - expense).toLocaleString()}`;
        }

        function updateDebtSummary(debts) {
            if (!totalInitialDebtEl || !totalCurrentDebtEl || !totalRepaidDebtEl) return;
            const initialDebt = debts.reduce((sum, d) => sum + d.totalAmount, 0);
            const currentDebt = debts.reduce((sum, d) => sum + d.remainingAmount, 0);
            const repaidDebt = initialDebt - currentDebt;
            totalInitialDebtEl.textContent = `NT$ ${initialDebt.toLocaleString()}`;
            totalCurrentDebtEl.textContent = `NT$ ${currentDebt.toLocaleString()}`;
            totalRepaidDebtEl.textContent = `NT$ ${repaidDebt.toLocaleString()}`;
        }

        function updateInvestmentSummary(investments) {
            if (!totalInvestmentValueEl || !totalInvestmentReturnEl || !totalInvestmentRoiEl) return;
            let totalMarketValue = 0;
            let totalReturn = 0;
            let totalCostAggregated = 0;

            investments.forEach(inv => {
                const income = inv.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expense = inv.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const totalCost = expense;
                const profit = income - expense;

                totalMarketValue += (inv.marketValue || 0);
                totalCostAggregated += totalCost;
                totalReturn += profit;
            });

            const totalRoi = totalCostAggregated > 0 ? (totalReturn / totalCostAggregated) * 100 : 0;

            totalInvestmentValueEl.textContent = `NT$ ${totalMarketValue.toLocaleString()}`;
            totalInvestmentReturnEl.textContent = `NT$ ${totalReturn.toLocaleString()}`;
            totalInvestmentRoiEl.textContent = `${totalRoi.toFixed(2)}%`;

            totalInvestmentReturnEl.className = `text-2xl font-bold mt-2 ${totalReturn >= 0 ? 'text-purple-600' : 'text-red-600'}`;
            totalInvestmentRoiEl.className = `text-2xl font-bold mt-2 ${totalRoi >= 0 ? 'text-teal-600' : 'text-orange-600'}`;
        }

        function updateLendingSummary(lendings) {
            // 已移除
        }

        function updateMonthlyRepaymentSummary() {
            if (!totalMonthlyRepaymentEl) return;
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);

            const monthlyRepayments = allTransactions.filter(tx => {
                if (tx.category !== '負債還款' || !tx.timestamp) return false;
                const txDate = tx.timestamp.toDate();
                return txDate >= startOfMonth && txDate <= endOfMonth;
            });

            const totalMonthlyPayment = monthlyRepayments.reduce((sum, tx) => sum + tx.amount, 0);
            totalMonthlyRepaymentEl.textContent = `NT$ ${totalMonthlyPayment.toLocaleString()}`;
        }

        // --- UI & Event Listeners ---
        function setupEventListeners() {
            googleLoginBtn.addEventListener('click', () => {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider).catch(error => console.error("Google 登入失敗", error));
            });
            anonymousLoginBtn.addEventListener('click', () => {
                signInAnonymously(auth).catch(error => console.error("匿名登入失敗", error));
            });

            tabAccounting.addEventListener('click', () => switchTab('accounting'));
            tabInvestment.addEventListener('click', () => switchTab('investment'));
            tabDebt.addEventListener('click', () => switchTab('debt'));
            tabEvents.addEventListener('click', () => switchTab('events'));

            form.addEventListener('submit', handleFormSubmit);
            debtForm.addEventListener('submit', handleDebtFormSubmit);
            eventForm.addEventListener('submit', handleEventFormSubmit);
            investmentForm.addEventListener('submit', handleInvestmentFormSubmit);
            investmentTransactionForm.addEventListener('submit', handleInvestmentTransactionSubmit);
            editInvestmentAccountForm.addEventListener('submit', handleEditInvestmentAccountSubmit);
            updateMarketValueForm.addEventListener('submit', handleUpdateMarketValueSubmit);
            investmentBudgetForm.addEventListener('submit', handleInvestmentBudgetSubmit); // 監聽預算表單

            repaymentForm.addEventListener('submit', handleRepaymentSubmit);
            debtEditForm.addEventListener('submit', handleDebtEditSubmit);

            cancelRepaymentBtn.addEventListener('click', () => repaymentModal.classList.add('hidden'));
            cancelInvestmentTransactionBtn.addEventListener('click', () => investmentTransactionModal.classList.add('hidden'));
            cancelEditInvestmentAccountBtn.addEventListener('click', () => editInvestmentAccountModal.classList.add('hidden'));
            cancelUpdateMarketValueBtn.addEventListener('click', () => updateMarketValueModal.classList.add('hidden'));

            expenseRadio.addEventListener('change', updateTypeSelection);
            document.querySelector('input[name="type"][value="income"]').addEventListener('change', updateTypeSelection);
            
            setupModal(manageCategoriesBtn, categoryModal, [document.getElementById('close-category-modal-btn'), document.getElementById('close-category-modal-btn-bottom')]);
            setupModal(manageProjectsBtn, projectModal, [document.getElementById('close-project-modal-btn'), document.getElementById('close-project-modal-btn-bottom')]);

            const handleTransactionListClick = (e) => {
                if (e.target.closest('.delete-btn')) {
                    handleDelete(e, '.delete-btn', transactionsColRef);
                } else if (e.target.closest('.edit-btn')) {
                    handleEditTransactionClick(e);
                }
            };
            transactionList.addEventListener('click', handleTransactionListClick);

            eventList.addEventListener('click', (e) => handleDelete(e, '.delete-event-btn', eventsColRef));

            debtList.addEventListener('click', (e) => {
                const debtCard = e.target.closest('.debt-card-clickable');
                if (e.target.closest('.repay-btn') || e.target.closest('.delete-debt-btn')) {
                    e.stopPropagation();
                     handleDelete(e, '.delete-debt-btn', debtsColRef);
                    handleRepayClick(e);
                    return;
                }
                if (debtCard) handleDebtCardClick(debtCard.dataset.id);
            });
            investmentList.addEventListener('click', (e) => {
                const cardClick = e.target.closest('.investment-card-clickable');
                const addTxBtn = e.target.closest('.add-investment-tx-btn');
                const editAccountBtn = e.target.closest('.edit-investment-account-btn');
                const deleteBtn = e.target.closest('.delete-investment-btn');
                const updateValueBtn = e.target.closest('.update-market-value-btn');

                if (addTxBtn) handleAddInvestmentTxClick(addTxBtn);
                else if (editAccountBtn) handleEditInvestmentAccountClick(editAccountBtn);
                else if (deleteBtn) handleDelete(deleteBtn, '.delete-investment-btn', investmentsColRef);
                else if (updateValueBtn) handleUpdateMarketValueClick(updateValueBtn);
                else if (cardClick) handleInvestmentCardClick(cardClick.dataset.id);
            });
            
            // 監聽投資預算列表的點擊
            investmentBudgetList.addEventListener('click', (e) => {
                if (e.target.closest('.realize-budget-btn')) {
                    handleRealizeBudget(e.target);
                }
                if (e.target.closest('.delete-investment-budget-btn')) {
                    handleDelete(e, '.delete-investment-budget-btn', investmentBudgetsColRef);
                }
            });

            customCategoryList.addEventListener('click', (e) => handleDelete(e, '.delete-category-btn', categoriesColRef));
            customProjectList.addEventListener('click', (e) => handleDelete(e, '.delete-project-btn', projectsColRef));
            
            closeDebtDetailModalBtn.addEventListener('click', () => debtDetailModal.classList.add('hidden'));
            editDebtBtn.addEventListener('click', toggleDebtEditView);
            cancelEditDebtBtn.addEventListener('click', toggleDebtEditView);
            repaymentHistoryList.addEventListener('click', handleDeleteRepayment);
            closeInvestmentDetailModalBtn.addEventListener('click', () => investmentDetailModal.classList.add('hidden'));
            investmentHistoryList.addEventListener('click', (e) => {
                if (e.target.closest('.delete-investment-tx-btn')) handleDeleteInvestmentTx(e);
                if (e.target.closest('.edit-investment-tx-btn')) handleEditInvestmentTxClick(e);
            });
            printTransactionsBtn.addEventListener('click', () => handlePrint('#main-transaction-list-section'));
            printDebtDetailBtn.addEventListener('click', () => handlePrint('#debt-detail-modal'));
            printInvestmentDetailBtn.addEventListener('click', () => handlePrint('#investment-detail-modal'));
            historyDateFilter.addEventListener('change', renderMainTransactionList);
            showTodayBtn.addEventListener('click', () => {
                historyDateFilter.value = new Date().toISOString().split('T')[0];
                renderMainTransactionList();
            });
            window.addEventListener('afterprint', handleAfterPrint);
        }

        function switchTab(tabName) {
            const views = { accounting: accountingView, investment: investmentView, debt: debtView, events: eventsView };
            const tabs = { accounting: tabAccounting, investment: tabInvestment, debt: tabDebt, events: tabEvents };

            for (const key in views) {
                const isHidden = key !== tabName;
                if(views[key]) views[key].classList.toggle('hidden', isHidden);
                if(tabs[key]) tabs[key].classList.toggle('active', !isHidden);
            }
        }
        
        function renderMainTransactionList() {
            if (!historyDateFilter || !transactionList || !historyDisplayDateEl || !emptyState) return;
            
            const filterDateStr = historyDateFilter.value;
            let dateToFilter;

            if (filterDateStr) {
                dateToFilter = new Date(filterDateStr);
            } else {
                dateToFilter = new Date();
                historyDateFilter.value = dateToFilter.toISOString().split('T')[0];
            }

            // Adjust for timezone offset to compare dates correctly
            const startOfDay = new Date(dateToFilter.getFullYear(), dateToFilter.getMonth(), dateToFilter.getDate());
            const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);

            const filteredTransactions = allTransactions.filter(tx => {
                if (!tx.timestamp) return false;
                const txDate = tx.timestamp.toDate();
                return txDate >= startOfDay && txDate < endOfDay;
            });

            renderTransactions(filteredTransactions);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (startOfDay.getTime() === today.getTime()) {
                historyDisplayDateEl.textContent = `本日 (${startOfDay.toLocaleDateString('zh-TW')}) 紀錄`;
            } else {
                historyDisplayDateEl.textContent = `${startOfDay.toLocaleDateString('zh-TW')} 紀錄`;
            }

            emptyState.classList.toggle('hidden', filteredTransactions.length > 0 || allTransactions.length > 0);
             if (filteredTransactions.length === 0 && allTransactions.length > 0) {
                emptyState.textContent = '此日期無交易紀錄。';
            } else if (allTransactions.length === 0) {
                 emptyState.textContent = '還沒有任何紀錄，快來新增第一筆吧！';
            }
        }

        function resetTransactionForm() {
            form.reset();
            document.getElementById('transaction-id').value = '';
            transactionDateInput.valueAsDate = new Date();
            submitBtnText.textContent = '新增紀錄';
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            updateTypeSelection();
        }

        function handleEditTransactionClick(e) {
            const editBtn = e.target.closest('.edit-btn');
            if (!editBtn) return;

            const txId = editBtn.dataset.id;
            const tx = allTransactions.find(t => t.id === txId);

            if (tx) {
                document.getElementById('transaction-id').value = tx.id;
                
                if (tx.type === 'income') {
                    document.getElementById('type-income').checked = true;
                } else {
                    document.getElementById('type-expense').checked = true;
                }
                updateTypeSelection(); 

                amountInput.value = tx.amount;
                transactionDateInput.value = tx.timestamp.toDate().toISOString().split('T')[0];
                categoryInput.value = tx.category;
                projectInput.value = tx.project || '';
                remarksInput.value = tx.remarks || '';

                submitBtnText.textContent = '儲存變更';
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitButton.classList.add('bg-green-600', 'hover:bg-green-700');

                form.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!userId) return;
            
            const txId = document.getElementById('transaction-id').value;
            const amount = parseFloat(amountInput.value);
            const category = categoryInput.value.trim();
            const project = projectInput.value.trim();
            const date = transactionDateInput.value;
            
            if (isNaN(amount) || amount <= 0 || category === '' || !date) { 
                console.warn("請輸入有效的金額、分類和日期！"); 
                return; 
            }

            submitBtnText.classList.add('hidden'); 
            submitSpinner.classList.remove('hidden'); 
            form.querySelector('button[type="submit"]').disabled = true;

            try {
                await saveNewCustomItemIfNeeded(category, customCategories, categoriesColRef);
                if (project) await saveNewCustomItemIfNeeded(project, customProjects, projectsColRef);

                const payload = {
                    type: document.querySelector('input[name="type"]:checked').value,
                    amount,
                    category,
                    project,
                    remarks: remarksInput.value.trim(),
                    timestamp: Timestamp.fromDate(new Date(date))
                };

                if (txId) {
                    const txRef = doc(transactionsColRef, txId);
                    await updateDoc(txRef, payload);
                } else {
                    await addDoc(transactionsColRef, payload);
                }
                
                resetTransactionForm();
            } catch (error) { 
                console.error("處理紀錄失敗:", error); 
            } finally { 
                submitBtnText.classList.remove('hidden'); 
                submitSpinner.classList.add('hidden'); 
                form.querySelector('button[type="submit"]').disabled = false; 
            }
        }

        async function handleDebtFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('debt-name').value.trim();
            const totalAmount = parseFloat(document.getElementById('debt-total-amount').value);
            if (name === '' || isNaN(totalAmount) || totalAmount <= 0) { console.warn("請輸入有效的負債項目和金額"); return; }

            const btnText = document.getElementById('add-debt-btn-text'), spinner = document.getElementById('add-debt-spinner');
            btnText.classList.add('hidden'); spinner.classList.remove('hidden'); debtForm.querySelector('button[type="submit"]').disabled = true;
            try {
                await addDoc(debtsColRef, { name, totalAmount, remainingAmount: totalAmount, createdAt: Timestamp.now() });
                debtForm.reset();
            } catch (error) { console.error("新增負債失敗:", error); }
            finally { btnText.classList.remove('hidden'); spinner.classList.add('hidden'); debtForm.querySelector('button[type="submit"]').disabled = false; }
        }

        async function handleEventFormSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('event-date').value;
            const title = document.getElementById('event-title').value.trim();
            const description = document.getElementById('event-description').value.trim();
            if (!date || title === '') { console.warn("請輸入日期和標題"); return; }

            try {
                await addDoc(eventsColRef, {
                    date: Timestamp.fromDate(new Date(date)),
                    title,
                    description,
                    createdAt: Timestamp.now()
                });
                eventForm.reset();
                document.getElementById('event-date').valueAsDate = new Date();
            } catch (error) {
                console.error("新增事件失敗:", error);
            }
        }

        async function handleInvestmentFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('investment-name').value.trim();
            const initialValue = parseFloat(document.getElementById('investment-initial-value').value) || 0;
            if (name === '') { console.warn("請輸入有效的帳戶名稱"); return; }

            try {
                const now = new Date();
                const timestamp = Timestamp.fromDate(now);

                const newInvestmentRef = await addDoc(investmentsColRef, {
                     name,
                     initialValue,
                     marketValue: initialValue,
                     createdAt: timestamp
                 });

                if (initialValue > 0) {
                    const mainTxPayload = {
                        type: 'expense',
                         amount: initialValue,
                         category: '投資支出',
                         project: name,
                         remarks: `建立投資帳戶: ${name}`,
                         timestamp: timestamp
                    };
                    const mainTxRef = await addDoc(transactionsColRef, mainTxPayload);

                    const investmentTxColRef = collection(db, `${investmentsColRef.path}/${newInvestmentRef.id}/transactions`);
                    await addDoc(investmentTxColRef, {
                        date: timestamp,
                        type: 'expense',
                        amount: initialValue,
                        remark: '初始投入金額',
                        mainTransactionId: mainTxRef.id
                    });
                }
                investmentForm.reset();
            } catch (error) { console.error("新增投資帳戶失敗:", error); }
        }
        
        // 新增：處理投資預算表單提交
        async function handleInvestmentBudgetSubmit(e) {
            e.preventDefault();
            const selectedOption = budgetInvestmentSelect.options[budgetInvestmentSelect.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                console.warn("請選擇一個有效的投資帳戶");
                return;
            }
            
            const investmentId = selectedOption.value;
            const investmentName = selectedOption.dataset.name; 
            const expectedDate = document.getElementById('budget-expected-date').value;
            const expectedAmount = parseFloat(document.getElementById('budget-expected-amount').value);
            const description = document.getElementById('budget-description').value.trim();

            if (!investmentId || !investmentName || !expectedDate || isNaN(expectedAmount) || expectedAmount <= 0 || !description) {
                console.warn("請填寫所有預算欄位");
                return;
            }

            try {
                await addDoc(investmentBudgetsColRef, {
                    investmentId: investmentId,
                    investmentName: investmentName,
                    expectedDate: Timestamp.fromDate(new Date(expectedDate)),
                    amount: expectedAmount,
                    description: description,
                    isRealized: false, // 預設為未實現
                    createdAt: serverTimestamp()
                });
                investmentBudgetForm.reset();
                document.getElementById('budget-expected-date').valueAsDate = new Date();
            } catch (error) {
                console.error("新增投資預算失敗:", error);
            }
        }
        
        // 新增：處理實現預算
        async function handleRealizeBudget(checkbox) {
            const budgetId = checkbox.dataset.id;
            if (!budgetId || checkbox.disabled) return;

            checkbox.disabled = true; // 防止重複點擊
            
            const budget = allInvestmentBudgets.find(b => b.id === budgetId);
            if (!budget) {
                console.error("找不到該預算");
                checkbox.disabled = false;
                return;
            }

            const budgetDocRef = doc(investmentBudgetsColRef, budgetId);
            const investmentTxColRef = collection(db, `${investmentsColRef.path}/${budget.investmentId}/transactions`);

            const timestamp = Timestamp.now();
            
            // 1. 準備主記帳交易
            const mainTxPayload = {
                type: 'income',
                amount: budget.amount,
                category: '投資收入',
                project: budget.investmentName,
                remarks: `實現預算: ${budget.description}`,
                timestamp: timestamp
            };
            
            // 2. 準備投資帳戶明細交易
            const investmentTxPayload = {
                date: timestamp,
                type: 'income',
                amount: budget.amount,
                remark: `實現預算: ${budget.description}`,
                mainTransactionId: '' // 待回填
            };

            try {
                const batch = writeBatch(db);

                // 3. 新增主交易紀錄
                const mainTxRef = doc(collection(db, transactionsColRef.path)); // 先產生一個參照
                batch.set(mainTxRef, mainTxPayload);

                // 4. 新增投資明細紀錄 (並回填主交易 ID)
                investmentTxPayload.mainTransactionId = mainTxRef.id;
                const investmentTxRef = doc(collection(db, investmentTxColRef.path)); // 產生參照
                batch.set(investmentTxRef, investmentTxPayload);
                
                // 5. 更新預算狀態為「已實現」
                batch.update(budgetDocRef, { isRealized: true });

                await batch.commit();
                
                // 成功後，監聽器會自動移除該項目，不需手動操作 DOM

            } catch (error) {
                console.error("實現預算失敗:", error);
                checkbox.disabled = false; // 失敗時解鎖
                checkbox.checked = false; // 回復勾選狀態
            }
        }


        function handleAddInvestmentTxClick(btn) {
            if(btn) {
                investmentTransactionForm.reset();
                document.getElementById('investment-transaction-title').textContent = `新增交易至 "${btn.dataset.name}"`;
                document.getElementById('investment-transaction-account-id').value = btn.dataset.id;
                document.getElementById('investment-transaction-account-name').value = btn.dataset.name;
                document.getElementById('investment-transaction-id').value = '';
                document.getElementById('investment-main-transaction-id').value = '';
                document.getElementById('investment-transaction-date').valueAsDate = new Date();
                investmentTransactionModal.classList.remove('hidden');
            }
        }

        async function handleInvestmentTransactionSubmit(e) {
            e.preventDefault();
            const accountId = document.getElementById('investment-transaction-account-id').value;
            const accountName = document.getElementById('investment-transaction-account-name').value;
            const txId = document.getElementById('investment-transaction-id').value;
            const mainTxId = document.getElementById('investment-main-transaction-id').value;
            const date = document.getElementById('investment-transaction-date').value;
            const type = document.getElementById('investment-transaction-type').value;
            const amount = parseFloat(document.getElementById('investment-transaction-amount').value);
            const remark = document.getElementById('investment-transaction-remark').value.trim();

            if (!accountId || !date || isNaN(amount) || amount <= 0) {
                console.warn("請填寫完整交易資訊");
                return;
            }

            const transactionTimestamp = Timestamp.fromDate(new Date(date));
            const investmentTxColRef = collection(db, `${investmentsColRef.path}/${accountId}/transactions`);

            const mainTxPayload = {
                type: type,
                amount: amount,
                category: type === 'income' ? '投資收入' : '投資支出',
                project: accountName,
                remarks: remark,
                timestamp: transactionTimestamp
            };

            try {
                if (txId && mainTxId) {
                    const investmentTxRef = doc(investmentTxColRef, txId);
                    const mainTxRef = doc(transactionsColRef, mainTxId);

                    const batch = writeBatch(db);
                    batch.update(investmentTxRef, { date: transactionTimestamp, type, amount, remark });
                    batch.update(mainTxRef, mainTxPayload);
                    await batch.commit();

                } else {
                    const mainTxRef = await addDoc(transactionsColRef, mainTxPayload);
                    await addDoc(investmentTxColRef, { ...mainTxPayload, date: transactionTimestamp, remark: remark, mainTransactionId: mainTxRef.id });
                }

                investmentTransactionForm.reset();
                investmentTransactionModal.classList.add('hidden');
                listenForInvestments();
            } catch (error) {
                console.error("處理投資交易失敗:", error);
            }
        }

        async function handleDeleteInvestmentTx(e) {
            const deleteBtn = e.target.closest('.delete-investment-tx-btn');
            if (deleteBtn) {
                const investmentId = deleteBtn.dataset.investmentId;
                const txId = deleteBtn.dataset.txId;
                const mainTxId = deleteBtn.dataset.mainTxId;

                if (investmentId && txId) {
                    const txDocRef = doc(db, investmentsColRef.path, investmentId, 'transactions', txId);
                    try {
                        deleteBtn.disabled = true;
                        const batch = writeBatch(db);
                        batch.delete(txDocRef);
                        if (mainTxId) {
                            const mainTxRef = doc(transactionsColRef, mainTxId);
                            batch.delete(mainTxRef);
                        }
                        await batch.commit();

                        listenForInvestments();

                        if (!investmentDetailModal.classList.contains('hidden')) {
                           renderInvestmentHistory(investmentId);
                        }
                    } catch (error) {
                        console.error("刪除投資交易失敗:", error);
                        deleteBtn.disabled = false;
                    }
                }
            }
        }

        function handleEditInvestmentAccountClick(btn) {
            const accountId = btn.dataset.id;
            const accountName = btn.dataset.name;
            document.getElementById('edit-investment-account-id').value = accountId;
            document.getElementById('edit-investment-account-name').value = accountName;
            editInvestmentAccountModal.classList.remove('hidden');
        }

        async function handleEditInvestmentAccountSubmit(e) {
            e.preventDefault();
            const accountId = document.getElementById('edit-investment-account-id').value;
            const newName = document.getElementById('edit-investment-account-name').value.trim();
            if (!accountId || newName === '') return;

            const accountRef = doc(investmentsColRef, accountId);
            try {
                await updateDoc(accountRef, { name: newName });
                editInvestmentAccountModal.classList.add('hidden');
                listenForInvestments();
            } catch (error) {
                console.error("更新投資帳戶名稱失敗:", error);
            }
        }

        function handleEditInvestmentTxClick(e) {
            const editBtn = e.target.closest('.edit-investment-tx-btn');
            if (!editBtn) return;

            const investmentId = editBtn.dataset.investmentId;
            const txId = editBtn.dataset.txId;

            const investment = allInvestments.find(inv => inv.id === investmentId);
            const tx = investment?.transactions.find(t => t.id === txId);

            if (investment && tx) {
                document.getElementById('investment-transaction-title').textContent = `編輯交易 "${investment.name}"`;
                document.getElementById('investment-transaction-account-id').value = investmentId;
                document.getElementById('investment-transaction-account-name').value = investment.name;
                document.getElementById('investment-transaction-id').value = txId;
                document.getElementById('investment-main-transaction-id').value = tx.mainTransactionId || '';
                document.getElementById('investment-transaction-date').value = tx.date.toDate().toISOString().split('T')[0];
                document.getElementById('investment-transaction-type').value = tx.type;
                document.getElementById('investment-transaction-amount').value = tx.amount;
                document.getElementById('investment-transaction-remark').value = tx.remark || '';

                investmentTransactionModal.classList.remove('hidden');
            }
        }

        function handleUpdateMarketValueClick(btn) {
            const id = btn.dataset.id;
            const name = btn.dataset.name;
            const value = btn.dataset.value;
            document.getElementById('update-market-value-title').textContent = `更新 "${name}" 的現值`;
            document.getElementById('update-market-value-id').value = id;
            document.getElementById('update-market-value-amount').value = value;
            updateMarketValueModal.classList.remove('hidden');
        }

        async function handleUpdateMarketValueSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('update-market-value-id').value;
            const amount = parseFloat(document.getElementById('update-market-value-amount').value);
            if (!id || isNaN(amount) || amount < 0) {
                console.warn("請輸入有效的金額");
                return;
            }
            const investmentRef = doc(investmentsColRef, id);
            try {
                await updateDoc(investmentRef, { marketValue: amount });
                updateMarketValueModal.classList.add('hidden');
                listenForInvestments();
            } catch(error) {
                console.error("更新資產現值失敗:", error);
            }
        }

        function handleRepayClick(e) {
            const repayBtn = e.target.closest('.repay-btn');
            if (repayBtn) {
                repaymentDebtIdInput.value = repayBtn.dataset.id;
                repaymentDebtNameInput.value = repayBtn.dataset.name;
                repaymentAmountInput.max = repayBtn.dataset.remaining;
                repaymentDateInput.valueAsDate = new Date();
                repaymentModal.classList.remove('hidden');
                repaymentAmountInput.focus();
            }
        }

        function handleDebtCardClick(debtId) {
            const debt = allDebts.find(d => d.id === debtId);
            if (!debt) return;

            const now = new Date(), startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1), endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            const monthlyRepayments = allTransactions.filter(tx => tx.category === '負債還款' && tx.project === debt.name && tx.timestamp && tx.timestamp.toDate() >= startOfMonth && tx.timestamp.toDate() <= endOfMonth);
            const totalMonthlyPaymentForDebt = monthlyRepayments.reduce((sum, tx) => sum + tx.amount, 0);

            debtDetailName.textContent = debt.name;
            debtDetailTotal.textContent = `NT$ ${debt.totalAmount.toLocaleString()}`;
            debtDetailMonthlyRepayment.textContent = `NT$ ${totalMonthlyPaymentForDebt.toLocaleString()}`;
            editDebtIdInput.value = debt.id;
            editDebtNameInput.value = debt.name;
            editDebtTotalInput.value = debt.totalAmount;
            renderRepaymentHistory(debt.name);
            debtDetailDisplayView.classList.remove('hidden');
            debtEditForm.classList.add('hidden');
            debtDetailModal.classList.remove('hidden');
        }

        function handleInvestmentCardClick(investmentId) {
            const investment = allInvestments.find(inv => inv.id === investmentId);
            if (!investment) return;

            document.getElementById('investment-detail-title').textContent = `"${investment.name}" 交易紀錄`;
            renderInvestmentHistory(investment.id);
            investmentDetailModal.classList.remove('hidden');
        }

        function toggleDebtEditView() {
            debtDetailDisplayView.classList.toggle('hidden');
            debtEditForm.classList.toggle('hidden');
        }

        async function handleDebtEditSubmit(e) {
            e.preventDefault();
            const debtId = editDebtIdInput.value, newName = editDebtNameInput.value.trim(), newTotal = parseFloat(editDebtTotalInput.value);
            if (!debtId || newName === '' || isNaN(newTotal) || newTotal < 0) { console.warn("請輸入有效的項目名稱和總金額"); return; }

            const debtRef = doc(db, debtsColRef.path, debtId);
            try {
                const currentDebt = allDebts.find(d => d.id === debtId);
                if (!currentDebt) { console.error("找不到要編輯的負債"); return; }

                const amountPaid = currentDebt.totalAmount - currentDebt.remainingAmount;
                const newRemainingAmount = newTotal - amountPaid;

                await updateDoc(debtRef, { name: newName, totalAmount: newTotal, remainingAmount: newRemainingAmount < 0 ? 0 : newRemainingAmount });
                debtDetailModal.classList.add('hidden');
            } catch (error) { console.error("更新負債失敗:", error); }
        }

        async function handleRepaymentSubmit(e) {
            e.preventDefault();
            const debtId = repaymentDebtIdInput.value, debtName = repaymentDebtNameInput.value, amount = parseFloat(repaymentAmountInput.value), date = repaymentDateInput.value;
            const remark = document.getElementById('repayment-remark').value.trim();
            if (isNaN(amount) || amount <= 0 || !date) { console.warn("請輸入有效的還款金額和日期"); return; }

            const timestamp = Timestamp.fromDate(new Date(date));

            const debtRef = doc(db, debtsColRef.path, debtId);
            try {
                await updateDoc(debtRef, { remainingAmount: increment(-amount) });
                await addDoc(transactionsColRef, { type: 'expense', amount: amount, category: '負債還款', project: debtName, remarks: remark || `償還負債: ${debtName}`, timestamp: timestamp });
                repaymentForm.reset();
                repaymentModal.classList.add('hidden');
            } catch (error) { console.error("更新還款失敗:", error); }
        }

        async function handleDeleteRepayment(e) {
            const deleteBtn = e.target.closest('.delete-repayment-btn');
            if (!deleteBtn) return;

            const txId = deleteBtn.dataset.id;
            const amountToRestore = parseFloat(deleteBtn.dataset.amount);
            const debtId = editDebtIdInput.value;

            if (!txId || !debtId || isNaN(amountToRestore)) {
                console.error("無法刪除還款紀錄：缺少必要資訊。");
                return;
            }

            const txRef = doc(transactionsColRef, txId);
            const debtRef = doc(debtsColRef, debtId);

            try {
                deleteBtn.disabled = true;
                const batch = writeBatch(db);
                batch.delete(txRef);
                batch.update(debtRef, { remainingAmount: increment(amountToRestore) });
                await batch.commit();
                handleDebtCardClick(debtId);
            } catch (error) {
                console.error("刪除還款紀錄失敗:", error);
                deleteBtn.disabled = false;
            }
        }

        async function handleDelete(eventOrElement, selector, collectionRef) {
            const deleteBtn = eventOrElement.target ? eventOrElement.target.closest(selector) : eventOrElement;
            if (deleteBtn && collectionRef) {
                const id = deleteBtn.dataset.id;
                try {
                    deleteBtn.disabled = true;
                    await deleteDoc(doc(db, collectionRef.path, id));
                } catch (error) { console.error("刪除失敗:", error); deleteBtn.disabled = false; }
            }
        }

        // --- Helper Functions ---
        function updateTypeSelection() {
            const isExpense = expenseRadio.checked;
            typeLabels[0].classList.toggle('bg-red-500', isExpense); typeLabels[0].classList.toggle('text-white', isExpense);
            typeLabels[1].classList.toggle('bg-green-500', !isExpense); typeLabels[1].classList.toggle('text-white', !isExpense);
            populateCategoryDatalist();
        }

        function populateDatalist(datalistElement, items) {
            datalistElement.innerHTML = '';
            [...new Set(items)].forEach(item => { datalistElement.insertAdjacentHTML('beforeend', `<option value="${item}">${item}</option>`); });
        }

        function populateCategoryDatalist() {
            const type = expenseRadio.checked ? 'expense' : 'income';
            const categories = [...defaultCategories[type], ...customCategories.map(c => c.name)];
            populateDatalist(categoryDatalist, categories);
        }

        // 新增：填充投資預算表單的帳戶下拉選單
        function populateBudgetInvestmentSelect() {
            if (!budgetInvestmentSelect) return;
            const currentVal = budgetInvestmentSelect.value;
            budgetInvestmentSelect.innerHTML = '<option value="">-- 選擇帳戶 --</option>';
            allInvestments.forEach(inv => {
                const selected = inv.id === currentVal ? ' selected' : '';
                // 將 investment name 存在 data-name 屬性中
                budgetInvestmentSelect.insertAdjacentHTML('beforeend', `<option value="${inv.id}" data-name="${inv.name}"${selected}>${inv.name}</option>`);
            });
        }

        function populateModalList(ulElement, items, emptyMsg, type) {
            ulElement.innerHTML = '';
            if (items.length === 0) { ulElement.innerHTML = `<li class="text-center text-gray-500">${emptyMsg}</li>`; return; }
            items.forEach(item => { ulElement.insertAdjacentHTML('beforeend', `<li class="flex justify-between items-center p-2 rounded-md hover:bg-gray-100"><span>${item.name}</span><button data-id="${item.id}" class="delete-${type}-btn text-red-400 hover:text-red-600 font-bold">刪除</button></li>`); });
        }

        function setupModal(openBtn, modal, closeBtns) {
            if (openBtn) openBtn.addEventListener('click', () => modal.classList.remove('hidden'));
            if (closeBtns) closeBtns.forEach(btn => btn.addEventListener('click', () => modal.classList.add('hidden')));
            if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
        }

        async function saveNewCustomItemIfNeeded(itemName, existingItems, collectionRef) {
            const trimmedName = itemName.trim();
            if (trimmedName === '') return;
            const isNew = !existingItems.some(item => item.name.toLowerCase() === trimmedName.toLowerCase());
            if (isNew) {
                try { await addDoc(collectionRef, { name: trimmedName, createdAt: serverTimestamp() }); }
                 catch (error) { console.error("儲存新項目失敗:", error); }
            }
        }

        function handlePrint(sectionSelector) {
            const printSection = document.querySelector(sectionSelector);
            if (!printSection) {
                console.error("Print section not found:", sectionSelector);
                return;
            }
            printSection.classList.add('print-section');
            window.print();
        }
        
        function handleAfterPrint() {
            document.querySelectorAll('.print-section').forEach(el => {
                el.classList.remove('print-section');
            });
        }

        // --- App Initialization ---
        setupEventListeners();
        updateTypeSelection();
        transactionDateInput.valueAsDate = new Date();
        historyDateFilter.valueAsDate = new Date();
        document.getElementById('event-date').valueAsDate = new Date();
        document.getElementById('budget-expected-date').valueAsDate = new Date(); // 初始化預算日期
    </script>
</body>
</html>

