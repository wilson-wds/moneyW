<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>雲端記帳 Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#4F46E5', secondary: '#10B981', danger: '#EF4444', warning: '#F59E0B', dark: '#1F2937' },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    fontSize: { 'xxs': '0.65rem' } 
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #F3F4F6; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fab { box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
        .card-shadow { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .animate-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-btn.active { color: #4F46E5; }
        .nav-btn.active i { transform: translateY(-2px); }
        input:focus, select:focus, textarea:focus { ring: 2px; ring-color: #4F46E5; border-color: transparent; outline: none; }
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden text-sm">

    <!-- Auth View -->
    <div id="login-view" class="fixed inset-0 z-50 bg-white flex flex-col justify-center items-center p-6 animate-fade">
        <div class="mb-8 text-center">
            <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary text-3xl"><i class="fa-solid fa-wallet"></i></div>
            <h1 class="text-2xl font-bold text-gray-800">雲端記帳</h1>
            <p class="text-gray-500 mt-2 text-xs">簡單、直覺、好用的財務管家</p>
        </div>
        <button onclick="App.loginGoogle()" class="w-full max-w-xs bg-white border border-gray-300 text-gray-700 py-2.5 rounded-xl font-medium shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2 transition">
            <i class="fa-brands fa-google text-red-500"></i> Google 登入
        </button>
        <button onclick="App.loginAnon()" class="mt-3 w-full max-w-xs bg-gray-800 text-white py-2.5 rounded-xl font-medium shadow-lg hover:bg-gray-900 transition">訪客體驗</button>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden flex-col h-full">
        <!-- Header -->
        <header class="bg-white px-4 py-3 flex justify-between items-center shadow-sm z-10">
            <h1 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-chart-pie text-primary"></i> <span id="page-title">總覽</span></h1>
            <div class="flex items-center gap-3">
                <div id="user-info" class="text-xs font-medium text-gray-500"></div>
                <button onclick="App.logout()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>

        <!-- Content -->
        <main id="main-content" class="flex-1 overflow-y-auto p-3 pb-24 hide-scrollbar relative bg-gray-50">
            
            <!-- Dashboard -->
            <div id="view-accounting" class="view-section space-y-3 animate-fade">
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-primary/5 p-3 rounded-xl border border-primary/10">
                        <p class="text-xs text-gray-500 mb-1">本月結餘</p>
                        <p id="monthly-balance" class="text-lg font-bold text-primary">--</p>
                    </div>
                    <div class="bg-red-50 p-3 rounded-xl border border-red-100">
                        <p class="text-xs text-gray-500 mb-1">本月支出</p>
                        <p id="monthly-expense" class="text-lg font-bold text-danger">--</p>
                    </div>
                </div>

                <div class="flex gap-2 overflow-x-auto hide-scrollbar py-1">
                    <button onclick="openModal('transaction-modal')" class="bg-primary text-white px-3 py-1.5 rounded-full text-xs shadow-md whitespace-nowrap"><i class="fa-solid fa-plus mr-1"></i> 記一筆</button>
                    <input type="date" id="date-filter" class="bg-white border-none rounded-full px-3 py-1.5 text-xs shadow-sm" onchange="App.renderTransactions()">
                </div>

                <div class="bg-white rounded-xl p-3 card-shadow">
                    <h3 class="font-bold text-gray-800 mb-2 text-xs">近期紀錄</h3>
                    <ul id="tx-list" class="space-y-2"></ul>
                </div>
            </div>

            <!-- Investment -->
            <div id="view-investment" class="view-section hidden space-y-3 animate-fade">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-4 text-white shadow-lg">
                    <p class="text-blue-100 text-xs">總資產現值</p>
                    <h2 id="inv-total-val" class="text-2xl font-bold mt-1">--</h2>
                    <div class="flex gap-4 mt-2 text-xs">
                        <div><span class="opacity-70">總損益</span> <span id="inv-total-ret" class="font-bold">--</span></div>
                        <div><span class="opacity-70">ROI</span> <span id="inv-roi" class="font-bold">--</span></div>
                    </div>
                </div>
                <div class="flex justify-between items-center"><span class="text-xs font-bold text-gray-500">投資帳戶</span><button onclick="openModal('investment-modal')" class="text-primary text-xs font-bold">+ 新增</button></div>
                <div id="inv-list" class="grid gap-2"></div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-500">收入預算/目標</span><button onclick="openBudgetModal('investment')" class="text-secondary text-xs font-bold">+ 預算</button></div>
                    <ul id="inv-budget-list" class="space-y-2"></ul>
                </div>
            </div>

            <!-- Debt -->
            <div id="view-debt" class="view-section hidden space-y-3 animate-fade">
                <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-warning">
                    <p class="text-xs text-gray-500">剩餘總負債</p>
                    <p id="debt-total-remaining" class="text-2xl font-bold text-gray-800">--</p>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2"><div id="debt-progress-bar" class="bg-warning h-1.5 rounded-full" style="width: 0%"></div></div>
                </div>
                <div class="flex justify-between items-center"><span class="text-xs font-bold text-gray-500">負債項目</span><button onclick="openModal('debt-modal')" class="text-primary text-xs font-bold">+ 新增</button></div>
                <div id="debt-list" class="space-y-2"></div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-500">還款計畫</span><button onclick="openBudgetModal('debt')" class="text-danger text-xs font-bold">+ 計畫</button></div>
                    <ul id="debt-budget-list" class="space-y-2"></ul>
                </div>
            </div>

            <!-- Reports -->
            <div id="view-reports" class="view-section hidden space-y-3 animate-fade">
                <div class="bg-white p-3 rounded-xl card-shadow">
                    <h3 class="font-bold mb-3 text-center text-xs">支出分佈</h3>
                    <div class="h-48 relative"><canvas id="expense-chart"></canvas></div>
                </div>
                <div class="bg-white p-3 rounded-xl card-shadow">
                    <h3 class="font-bold mb-2 text-xs border-b pb-2">詳細數據</h3>
                    <ul id="report-stats" class="space-y-2 text-xs"></ul>
                </div>
            </div>

            <!-- Events -->
            <div id="view-events" class="view-section hidden space-y-3 animate-fade">
                 <button onclick="openModal('event-modal')" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold hover:bg-gray-50 mb-2 text-xs">+ 紀錄大事記</button>
                 <div id="event-list" class="space-y-3 pl-2"></div>
            </div>
        </main>

        <!-- Nav -->
        <nav class="bg-white border-t border-gray-100 px-4 py-2 flex justify-between items-center text-[10px] font-medium text-gray-400 z-20">
            <button onclick="switchTab('accounting', this)" class="nav-btn active flex flex-col items-center gap-1 transition"><i class="fa-solid fa-house text-base"></i> 記帳</button>
            <button onclick="switchTab('investment', this)" class="nav-btn flex flex-col items-center gap-1 transition"><i class="fa-solid fa-arrow-trend-up text-base"></i> 投資</button>
            <div class="relative -top-5">
                <button onclick="openModal('transaction-modal')" class="fab w-12 h-12 bg-primary rounded-full text-white text-xl flex items-center justify-center transition hover:scale-105 active:scale-95"><i class="fa-solid fa-plus"></i></button>
            </div>
            <button onclick="switchTab('debt', this)" class="nav-btn flex flex-col items-center gap-1 transition"><i class="fa-solid fa-credit-card text-base"></i> 負債</button>
            <button onclick="switchTab('reports', this)" class="nav-btn flex flex-col items-center gap-1 transition"><i class="fa-solid fa-chart-simple text-base"></i> 報表</button>
        </nav>
    </div>

    <!-- Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-50 hidden flex items-end sm:items-center justify-center animate-fade backdrop-blur-sm">
        <div id="modal-content" class="bg-white w-full sm:w-[380px] rounded-t-2xl sm:rounded-xl p-5 shadow-2xl transform transition-transform duration-300 pb-8 sm:pb-5"></div>
    </div>

    <!-- Templates -->
    <template id="tpl-transaction-form">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold">記帳</h3><button onclick="closeModal()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveTransaction(event)" class="space-y-3">
            <input type="hidden" name="id">
            <div class="flex bg-gray-100 p-1 rounded-lg">
                <button type="button" class="type-btn flex-1 py-1.5 rounded-md text-xs font-bold bg-white shadow text-danger transition" onclick="toggleTxType('expense')" id="btn-expense">支出</button>
                <button type="button" class="type-btn flex-1 py-1.5 rounded-md text-xs font-bold text-gray-500 transition" onclick="toggleTxType('income')" id="btn-income">收入</button>
            </div>
            <input type="hidden" name="type" id="tx-type" value="expense">
            <input type="number" name="amount" class="w-full text-2xl font-bold text-gray-800 border-b border-gray-200 py-1 focus:border-primary bg-transparent text-center" placeholder="0" required>
            <div class="grid grid-cols-2 gap-3">
                <input type="date" name="date" class="bg-gray-50 rounded-lg px-3 py-2 text-xs" required>
                <input list="cat-list" name="category" class="bg-gray-50 rounded-lg px-3 py-2 text-xs" placeholder="分類" required><datalist id="cat-list"></datalist>
            </div>
            <input type="text" name="remarks" class="w-full bg-gray-50 rounded-lg px-3 py-2 text-xs" placeholder="備註...">
            <button type="submit" class="w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg mt-1 text-sm">儲存</button>
        </form>
    </template>

    <template id="tpl-investment-form">
        <h3 class="text-lg font-bold mb-3">投資帳戶</h3>
        <form onsubmit="App.handleSaveInvestment(event)" class="space-y-3">
            <input type="hidden" name="id">
            <input type="text" name="name" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" placeholder="名稱 (如: 台積電)" required>
            <input type="number" name="initial" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" placeholder="初始成本 (選填)">
            <div class="flex gap-2 text-sm"><button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 py-2.5 rounded-lg font-bold">取消</button><button type="submit" class="flex-1 bg-primary text-white py-2.5 rounded-lg font-bold shadow">儲存</button></div>
        </form>
    </template>

    <template id="tpl-debt-form">
        <h3 class="text-lg font-bold mb-3">負債項目</h3>
        <form onsubmit="App.handleSaveDebt(event)" class="space-y-3">
            <input type="hidden" name="id">
            <input type="text" name="name" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" placeholder="名稱 (如: 學貸)" required>
            <input type="number" name="total" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" placeholder="總金額" required>
            <div class="flex gap-2 text-sm"><button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 py-2.5 rounded-lg font-bold">取消</button><button type="submit" class="flex-1 bg-warning text-white py-2.5 rounded-lg font-bold shadow">儲存</button></div>
        </form>
    </template>

    <template id="tpl-budget-form">
        <h3 class="text-lg font-bold mb-3" id="budget-modal-title">新增預算</h3>
        <form onsubmit="App.handleSaveBudget(event)" class="space-y-3">
            <input type="hidden" name="id">
            <input type="hidden" name="context" id="budget-context">
            <select name="targetId" id="budget-target" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" required></select>
            <input type="number" name="amount" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" placeholder="金額" required>
            <input type="date" name="date" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" required>
            <input type="text" name="desc" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" placeholder="說明 (如: 預計賣出/還款)" required>
            <button type="submit" class="w-full bg-primary text-white py-2.5 rounded-lg font-bold shadow text-sm">設定</button>
        </form>
    </template>

    <template id="tpl-repay-form">
        <h3 class="text-lg font-bold mb-1">還款</h3>
        <p id="repay-debt-name" class="text-xs text-gray-500 mb-3"></p>
        <form onsubmit="App.handleRepayDebt(event)" class="space-y-3">
            <input type="hidden" name="id" id="repay-id">
            <input type="number" name="amount" class="w-full text-2xl font-bold border-b py-1 focus:border-primary text-center" placeholder="金額" required>
            <input type="date" name="date" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" required>
            <button type="submit" class="w-full bg-green-500 text-white py-2.5 rounded-lg font-bold shadow">確認</button>
        </form>
    </template>
    <template id="tpl-event-form"><h3 class="text-lg font-bold mb-3">大事記</h3><form onsubmit="App.handleAddEvent(event)" class="space-y-3"><input type="date" name="date" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" required><input type="text" name="title" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" placeholder="標題" required><textarea name="desc" rows="2" class="w-full bg-gray-50 rounded-lg p-2.5 text-sm" placeholder="內容..."></textarea><button type="submit" class="w-full bg-dark text-white py-2.5 rounded-lg font-bold text-sm">紀錄</button></form></template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, updateDoc, increment, Timestamp, writeBatch, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp({ apiKey: "AIzaSyAqFHm6Bn35m8xauc50ZvNNy_rxIZzCMTE", authDomain: "moneyw-f8105.firebaseapp.com", projectId: "moneyw-f8105", storageBucket: "moneyw-f8105.appspot.com", messagingSenderId: "155586195799", appId: "1:155586195799:web:302184fbf613f032a88e12" });
        const auth = getAuth(app); const db = getFirestore(app);
        const State = { user: null, data: { transactions: [], debts: [], investments: [], events: [], investmentBudgets: [], debtBudgets: [] }, listeners: [], chart: null, categories: { expense: ['飲食', '交通', '居住', '娛樂', '購物', '醫療', '教育', '投資', '其他'], income: ['薪資', '獎金', '投資', '兼職', '其他'] } };

        window.App = {
            init: () => onAuthStateChanged(auth, u => {
                State.user = u;
                document.getElementById('login-view').classList.toggle('hidden', !!u);
                document.getElementById('app-container').classList.toggle('hidden', !u);
                document.getElementById('app-container').classList.toggle('flex', !!u);
                if(u) {
                    document.getElementById('user-info').innerText = u.isAnonymous ? '訪客' : u.displayName;
                    document.getElementById('date-filter').valueAsDate = new Date();
                    App.startListeners(u.uid);
                } else App.stopListeners();
            }),
            startListeners: (uid) => {
                const listen = (c, k, render) => State.listeners.push(onSnapshot(query(collection(db, `users/${uid}/${c}`)), s => { State.data[k] = s.docs.map(d=>({id:d.id, ...d.data()})); render(); }));
                listen('transactions', 'transactions', () => { App.renderTransactions(); App.updateDashboard(); App.renderReports(); });
                listen('debts', 'debts', App.renderDebts);
                listen('investments', 'investments', App.renderInvestments);
                listen('events', 'events', App.renderEvents);
                listen('investmentBudgets', 'investmentBudgets', App.renderInvestments);
                listen('debtBudgets', 'debtBudgets', App.renderDebts);
            },
            stopListeners: () => { State.listeners.forEach(u=>u()); State.listeners=[]; },
            loginGoogle: () => signInWithPopup(auth, new GoogleAuthProvider()), loginAnon: () => signInAnonymously(auth), logout: () => signOut(auth),

            // Handlers
            handleSaveTransaction: async (e) => {
                e.preventDefault(); const f=e.target, uid=State.user.uid;
                const d = { type: f.type.value, amount: parseFloat(f.amount.value), category: f.category.value, remarks: f.remarks.value, timestamp: Timestamp.fromDate(new Date(f.date.value)) };
                f.id.value ? await updateDoc(doc(db, `users/${uid}/transactions`, f.id.value), d) : await addDoc(collection(db, `users/${uid}/transactions`), d);
                closeModal();
            },
            handleSaveInvestment: async (e) => {
                e.preventDefault(); const f=e.target, uid=State.user.uid, init=parseFloat(f.initial.value)||0;
                const d = { name: f.name.value, initialValue: init };
                if(!f.id.value) { d.marketValue = init; d.createdAt = Timestamp.now(); }
                f.id.value ? await updateDoc(doc(db, `users/${uid}/investments`, f.id.value), d) : (await addDoc(collection(db, `users/${uid}/investments`), d) && init>0 && await addDoc(collection(db, `users/${uid}/transactions`), {type:'expense', amount:init, category:'投資', project:f.name.value, remarks:'初始投入', timestamp:Timestamp.now()}));
                closeModal();
            },
            handleSaveDebt: async (e) => {
                e.preventDefault(); const f=e.target, uid=State.user.uid;
                const d = { name: f.name.value, totalAmount: parseFloat(f.total.value) };
                if(!f.id.value) { d.remainingAmount = d.totalAmount; d.createdAt = Timestamp.now(); }
                f.id.value ? await updateDoc(doc(db, `users/${uid}/debts`, f.id.value), d) : await addDoc(collection(db, `users/${uid}/debts`), d);
                closeModal();
            },
            handleSaveBudget: async (e) => {
                e.preventDefault(); const f=e.target, uid=State.user.uid, ctx=f.context.value;
                const col = ctx === 'investment' ? 'investmentBudgets' : 'debtBudgets';
                const d = { targetId: f.targetId.value, amount: parseFloat(f.amount.value), expectedDate: Timestamp.fromDate(new Date(f.date.value)), description: f.desc.value };
                if(!f.id.value) { d.isRealized = false; d.createdAt = Timestamp.now(); }
                f.id.value ? await updateDoc(doc(db, `users/${uid}/${col}`, f.id.value), d) : await addDoc(collection(db, `users/${uid}/${col}`), d);
                closeModal();
            },
            handleRepayDebt: async (e) => {
                e.preventDefault(); const f=e.target, amt=parseFloat(f.amount.value), uid=State.user.uid;
                const debt = State.data.debts.find(d=>d.id===f.id.value);
                const batch = writeBatch(db);
                batch.update(doc(db, `users/${uid}/debts`, f.id.value), { remainingAmount: increment(-amt) });
                batch.set(doc(collection(db, `users/${uid}/transactions`)), { type:'expense', amount:amt, category:'負債還款', project:debt.name, remarks:`償還: ${debt.name}`, timestamp:Timestamp.fromDate(new Date(f.date.value)) });
                await batch.commit(); closeModal();
            },
            handleAddEvent: async(e) => { e.preventDefault(); const f=e.target; await addDoc(collection(db, `users/${State.user.uid}/events`), {title:f.title.value, description:f.desc.value, date:Timestamp.fromDate(new Date(f.date.value))}); closeModal(); },
            
            // Actions
            deleteItem: async (c,id) => confirm('刪除?') && await deleteDoc(doc(db, `users/${State.user.uid}/${c}`, id)),
            updateMarketValue: async (id,old) => { const v=prompt("目前市值:",old); if(v&&!isNaN(v)) await updateDoc(doc(db, `users/${State.user.uid}/investments`, id), {marketValue:parseFloat(v)}); },
            realizeBudget: async(ctx, id) => {
                const col = ctx === 'investment' ? 'investmentBudgets' : 'debtBudgets';
                await updateDoc(doc(db, `users/${State.user.uid}/${col}`, id), { isRealized: true });
            },

            // Renderers
            renderTransactions: () => {
                const d = new Date(document.getElementById('date-filter').value), mTxs = State.data.transactions.filter(t=>t.timestamp.toDate().getMonth()===d.getMonth());
                const txs = [...State.data.transactions].sort((a,b)=>b.timestamp-a.timestamp).slice(0,30);
                document.getElementById('tx-list').innerHTML = txs.map(t=>`
                    <li class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 p-1 rounded" onclick="openModal('transaction-modal', '${t.id}')">
                        <div class="flex items-center gap-2">
                            <div class="bg-gray-100 w-8 h-8 rounded-full flex items-center justify-center text-gray-500 text-xs font-bold">${t.category[0]}</div>
                            <div><p class="font-bold text-gray-800 text-xs">${t.category}</p><p class="text-[10px] text-gray-400">${t.timestamp.toDate().toLocaleDateString()} ${t.remarks||''}</p></div>
                        </div>
                        <div class="text-right"><p class="font-bold text-xs ${t.type==='expense'?'':'text-green-600'}">${t.type==='expense'?'-':'+'} ${t.amount}</p></div>
                    </li>`).join('')||'<div class="text-center text-xs text-gray-400 py-2">無紀錄</div>';
            },
            updateDashboard: () => {
                const now = new Date(), start = new Date(now.getFullYear(), now.getMonth(), 1);
                const txs = State.data.transactions.filter(t=>t.timestamp.toDate()>=start);
                const inc = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0), exp = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
                document.getElementById('monthly-balance').innerText = `$${(inc-exp).toLocaleString()}`;
                document.getElementById('monthly-expense').innerText = `$${exp.toLocaleString()}`;
            },
            renderInvestments: () => {
                const invs = State.data.investments;
                let tv=0, ti=0;
                document.getElementById('inv-list').innerHTML = invs.map(i=>{
                    tv+=i.marketValue||0; ti+=i.initialValue||0; const g=(i.marketValue||0)-(i.initialValue||0);
                    return `<div class="bg-white p-3 rounded-xl card-shadow flex justify-between items-center">
                        <div onclick="App.updateMarketValue('${i.id}', ${i.marketValue})"><h4 class="font-bold text-gray-800 text-sm">${i.name} <span class="text-[10px] font-normal text-gray-400">成本:${i.initialValue}</span></h4></div>
                        <div class="flex items-center gap-3"><div class="text-right"><p class="font-bold text-gray-800 text-sm">$${(i.marketValue||0).toLocaleString()}</p><p class="text-[10px] font-bold ${g>=0?'text-red-500':'text-green-500'}">${g>0?'+':''}${g}</p></div><button onclick="openModal('investment-modal','${i.id}')" class="text-gray-300 hover:text-blue-500"><i class="fa-solid fa-pen text-xs"></i></button></div></div>`
                }).join('');
                const tg=tv-ti, roi=ti>0?(tg/ti)*100:0;
                document.getElementById('inv-total-val').innerText = `$${tv.toLocaleString()}`; document.getElementById('inv-total-ret').innerText = `${tg>0?'+':''}${tg.toLocaleString()}`; document.getElementById('inv-roi').innerText = `${roi.toFixed(1)}%`;
                // Budgets
                document.getElementById('inv-budget-list').innerHTML = State.data.investmentBudgets.filter(b=>!b.isRealized).map(b=>`
                    <li class="flex justify-between items-center bg-white p-2 rounded border border-gray-100"><div class="text-xs"><span class="font-bold text-gray-700">${(invs.find(i=>i.id===b.targetId)?.name)||'未知'}</span>: ${b.description} <span class="text-secondary">$${b.amount}</span></div><div class="flex gap-2"><button onclick="App.realizeBudget('investment','${b.id}')" class="text-secondary hover:text-green-700"><i class="fa-solid fa-check"></i></button><button onclick="App.deleteItem('investmentBudgets','${b.id}')" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div></li>
                `).join('')||'<li class="text-xs text-gray-400 text-center">無預算</li>';
            },
            renderDebts: () => {
                let tr=0, to=0;
                document.getElementById('debt-list').innerHTML = State.data.debts.map(d=>{
                    tr+=d.remainingAmount; to+=d.totalAmount; const p=Math.round(((d.totalAmount-d.remainingAmount)/d.totalAmount)*100);
                    return `<div class="bg-white p-3 rounded-xl card-shadow"><div class="flex justify-between mb-1"><span class="font-bold text-sm">${d.name}</span><button onclick="openModal('debt-modal','${d.id}')" class="text-gray-300 hover:text-blue-500"><i class="fa-solid fa-pen text-xs"></i></button></div><div class="flex justify-between text-xs text-gray-500 mb-1"><span>剩 $${d.remainingAmount}</span><span>${p}%</span></div><div class="w-full bg-gray-100 rounded-full h-1.5 mb-2"><div class="bg-primary h-1.5 rounded-full" style="width:${p}%"></div></div><div class="flex justify-end gap-2"><button onclick="openRepayModal('${d.id}','${d.name}')" class="text-xs bg-green-50 text-green-600 px-2 py-0.5 rounded font-bold">還款</button><button onclick="App.deleteItem('debts','${d.id}')" class="text-xs text-gray-300 px-1"><i class="fa-solid fa-trash"></i></button></div></div>`
                }).join('');
                document.getElementById('debt-total-remaining').innerText = `$${tr.toLocaleString()}`; document.getElementById('debt-progress-bar').style.width = `${to>0?((to-tr)/to)*100:0}%`;
                // Budgets
                document.getElementById('debt-budget-list').innerHTML = State.data.debtBudgets.filter(b=>!b.isRealized).map(b=>`
                    <li class="flex justify-between items-center bg-white p-2 rounded border border-gray-100"><div class="text-xs"><span class="font-bold text-gray-700">${(State.data.debts.find(d=>d.id===b.targetId)?.name)||'未知'}</span>: ${b.description} <span class="text-danger">$${b.amount}</span></div><div class="flex gap-2"><button onclick="App.realizeBudget('debt','${b.id}')" class="text-secondary hover:text-green-700"><i class="fa-solid fa-check"></i></button><button onclick="App.deleteItem('debtBudgets','${b.id}')" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div></li>
                `).join('')||'<li class="text-xs text-gray-400 text-center">無計畫</li>';
            },
            renderEvents: () => document.getElementById('event-list').innerHTML = State.data.events.sort((a,b)=>b.date-a.date).map(e=>`<div class="relative pl-4 border-l-2 border-gray-200 pb-3"><div class="absolute -left-[5px] top-1 w-2.5 h-2.5 bg-primary rounded-full"></div><p class="text-[10px] text-gray-400">${e.date.toDate().toLocaleDateString()}</p><h4 class="font-bold text-gray-800 text-xs">${e.title}</h4><p class="text-xs text-gray-500 mt-1">${e.description}</p><button onclick="App.deleteItem('events','${e.id}')" class="absolute right-0 top-0 text-gray-200 hover:text-red-300"><i class="fa-solid fa-trash text-xs"></i></button></div>`).join(''),
            renderReports: () => {
                if(State.chart) State.chart.destroy();
                const map={}, total=State.data.transactions.filter(t=>t.type==='expense').reduce((s,t)=>{map[t.category]=(map[t.category]||0)+t.amount;return s+t.amount},0);
                State.chart = new Chart(document.getElementById('expense-chart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(map), datasets: [{ data: Object.values(map), backgroundColor: ['#4F46E5','#10B981','#F59E0B','#EF4444','#EC4899','#8B5CF6'], borderWidth:0 }] }, options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right',labels:{font:{size:10},boxWidth:10}}}} });
                document.getElementById('report-stats').innerHTML = Object.entries(map).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<li class="flex justify-between border-b border-gray-50 pb-1"><span>${k}</span><span class="font-bold">$${v.toLocaleString()} <span class="text-[10px] text-gray-400 font-normal">(${((v/total)*100).toFixed(1)}%)</span></span></li>`).join('');
            }
        };

        window.switchTab = (v,b) => { document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden')); document.getElementById(`view-${v}`).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); if(b) b.classList.add('active'); const t={accounting:'總覽',investment:'投資組合',debt:'負債管理',reports:'財務報表',events:'大事記'}; document.getElementById('page-title').innerText=t[v]; if(v==='reports') App.renderReports(); };
        window.openModal = (t, id) => {
            const c=document.getElementById('modal-content'); c.innerHTML=document.getElementById(t==='transaction-modal'?'tpl-transaction-form':t==='investment-modal'?'tpl-investment-form':t==='debt-modal'?'tpl-debt-form':'tpl-event-form').innerHTML;
            if(t==='transaction-modal') renderDatalist(c.querySelector('#cat-list'), State.categories.expense);
            if(id) {
                const item = State.data[t==='transaction-modal'?'transactions':t==='investment-modal'?'investments':'debts'].find(i=>i.id===id);
                if(item) {
                    c.querySelector('[name=id]').value = id;
                    if(t==='transaction-modal') { c.querySelector('[name=amount]').value=item.amount; c.querySelector('[name=date]').value=toDateStr(item.timestamp); c.querySelector('[name=category]').value=item.category; c.querySelector('[name=remarks]').value=item.remarks; toggleTxType(item.type); }
                    else if(t==='investment-modal') { c.querySelector('[name=name]').value=item.name; c.querySelector('[name=initial]').value=item.initialValue; }
                    else if(t==='debt-modal') { c.querySelector('[name=name]').value=item.name; c.querySelector('[name=total]').value=item.totalAmount; }
                }
            } else if(t==='transaction-modal') c.querySelector('[name=date]').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal-overlay').classList.remove('hidden'); document.getElementById('modal-overlay').classList.add('flex');
        };
        window.openBudgetModal = (ctx) => {
            const c=document.getElementById('modal-content'); c.innerHTML=document.getElementById('tpl-budget-form').innerHTML;
            c.querySelector('#budget-modal-title').innerText = ctx==='investment'?'新增投資預算':'新增還款計畫';
            c.querySelector('#budget-context').value = ctx;
            const sel = c.querySelector('#budget-target');
            (ctx==='investment'?State.data.investments:State.data.debts).forEach(i => sel.innerHTML+=`<option value="${i.id}">${i.name}</option>`);
            c.querySelector('[name=date]').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal-overlay').classList.remove('hidden'); document.getElementById('modal-overlay').classList.add('flex');
        }
        window.openRepayModal = (id,n) => { const c=document.getElementById('modal-content'); c.innerHTML=document.getElementById('tpl-repay-form').innerHTML; c.querySelector('#repay-id').value=id; c.querySelector('#repay-debt-name').innerText=n; c.querySelector('[name=date]').value=new Date().toISOString().split('T')[0]; document.getElementById('modal-overlay').classList.remove('hidden'); document.getElementById('modal-overlay').classList.add('flex'); };
        window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');
        window.toggleTxType = (t) => { document.getElementById('tx-type').value=t; const e=document.getElementById('btn-expense'), i=document.getElementById('btn-income'); if(t==='expense'){e.classList.add('bg-white','shadow','text-danger');e.classList.remove('text-gray-500');i.classList.remove('bg-white','shadow','text-primary');i.classList.add('text-gray-500'); renderDatalist(document.getElementById('cat-list'), State.categories.expense);}else{i.classList.add('bg-white','shadow','text-primary');i.classList.remove('text-gray-500');e.classList.remove('bg-white','shadow','text-danger');e.classList.add('text-gray-500');renderDatalist(document.getElementById('cat-list'), State.categories.income);} };
        const renderDatalist=(e,i)=>e.innerHTML=i.map(v=>`<option value="${v}">`).join('');
        const toDateStr=(ts)=>ts.toDate().toISOString().split('T')[0];
        window.App = App; App.init();
    </script>
</body>
</html>
