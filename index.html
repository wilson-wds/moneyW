<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯è¨˜å¸³ RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#4F46E5', secondary: '#10B981', danger: '#EF4444', warning: '#F59E0B', dark: '#1F2937' },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    fontSize: { 'xxs': '0.65rem' } 
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #e5e7eb; }
        .app-frame { 
            max-width: 28rem; 
            margin: 0 auto; 
            background-color: #F9FAFB; 
            height: 100dvh; 
            width: 100%;
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            position: relative; 
            overflow: hidden; 
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fab { box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
        .card-shadow { box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); }
        .animate-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-btn.active { color: #4F46E5; }
        .nav-btn.active i { transform: translateY(-2px); }
        .tab-pill.active { background-color: #4F46E5; color: white; }
        input:focus, select:focus, textarea:focus { ring: 2px; ring-color: #4F46E5; border-color: transparent; outline: none; }

        /* RPG Animations */
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .dmg-text { position: absolute; font-weight: bold; font-size: 1.5rem; color: #EF4444; animation: floatUp 1s ease-out forwards; pointer-events: none; text-shadow: 1px 1px 0 #fff; z-index: 50; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }
        .hero-attack { animation: lunge 0.3s ease-in-out; }
        @keyframes lunge { 0% { transform: translateX(0); } 50% { transform: translateX(50px); } 100% { transform: translateX(0); } }
        .boss-hit { animation: shake 0.5s; filter: brightness(0.5) sepia(1) hue-rotate(-50deg) saturate(5); }
    </style>
</head>
<body class="text-gray-700 text-sm">

    <!-- Auth View -->
    <div id="login-view" class="fixed inset-0 z-50 bg-white flex flex-col justify-center items-center p-6 animate-fade max-w-md mx-auto h-full shadow-2xl">
        <div class="mb-10 text-center">
            <div class="w-20 h-20 bg-primary/10 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary text-4xl"><i class="fa-solid fa-shield-halved"></i></div>
            <h1 class="text-2xl font-bold text-gray-800">é›²ç«¯è¨˜å¸³ RPG</h1>
            <p class="text-gray-500 mt-2 text-xs">æ‰“å€’è² å‚µé­”ç‹ï¼Œå®ˆè­·è²¡å¯Œï¼</p>
        </div>
        <button onclick="App.loginGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-medium shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2 transition">
            <i class="fa-brands fa-google text-red-500"></i> Google ç™»å…¥
        </button>
        <button onclick="App.loginAnon()" class="mt-3 w-full bg-gray-800 text-white py-3 rounded-xl font-medium shadow-lg hover:bg-gray-900 transition">è¨ªå®¢é«”é©—</button>
    </div>

    <!-- Main App Frame -->
    <div id="app-container" class="hidden app-frame">
        <header class="bg-white px-4 py-3 flex justify-between items-center shadow-sm z-20 shrink-0">
            <h1 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-dungeon text-primary"></i> <span id="page-title">å†’éšªç¸½è¦½</span></h1>
            <div class="flex items-center gap-3">
                <div id="user-info" class="text-xs font-medium text-gray-500"></div>
                <button onclick="App.logout()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto hide-scrollbar relative bg-gray-50 pb-20">
            <!-- RPG Arena (Always visible in accounting tab, injected dynamically) -->
            
            <div id="view-accounting" class="view-section animate-fade"></div>
            <div id="view-investment" class="view-section hidden p-3 space-y-3 animate-fade"></div>
            <div id="view-debt" class="view-section hidden p-3 space-y-3 animate-fade"></div>
            <div id="view-reports" class="view-section hidden p-3 space-y-3 animate-fade"></div>
            <div id="view-events" class="view-section hidden p-3 space-y-3 animate-fade"></div>
        </main>

        <nav class="bg-white border-t border-gray-100 px-2 py-2 flex justify-between items-center text-[10px] font-medium text-gray-400 z-50 shrink-0 pb-safe">
            <button id="nav-accounting" onclick="App.switchTab('accounting', this)" class="nav-btn active flex flex-col items-center gap-1 transition p-1 min-w-[3.5rem]"><i class="fa-solid fa-scroll text-lg"></i> å†’éšª</button>
            <button onclick="App.switchTab('investment', this)" class="nav-btn flex flex-col items-center gap-1 transition p-1 min-w-[3.5rem]"><i class="fa-solid fa-sack-dollar text-lg"></i> é‡‘åº«</button>
            <button onclick="App.switchTab('debt', this)" class="nav-btn flex flex-col items-center gap-1 transition p-1 min-w-[3.5rem]"><i class="fa-solid fa-ghost text-lg"></i> é­”ç‰©</button>
            <div class="relative -top-6 pointer-events-none mx-1">
                <button onclick="App.openModal('transaction-modal')" class="fab w-14 h-14 bg-gradient-to-br from-primary to-indigo-600 rounded-full text-white text-2xl flex items-center justify-center transition hover:scale-105 active:scale-95 shadow-xl shadow-primary/40 pointer-events-auto border-4 border-white"><i class="fa-solid fa-sword"></i></button>
            </div>
            <button onclick="App.switchTab('events', this)" class="nav-btn flex flex-col items-center gap-1 transition p-1 min-w-[3.5rem]"><i class="fa-solid fa-book-journal-whills text-lg"></i> å²è©©</button>
            <button onclick="App.switchTab('reports', this)" class="nav-btn flex flex-col items-center gap-1 transition p-1 min-w-[3.5rem]"><i class="fa-solid fa-chart-pie text-lg"></i> æˆ°å ±</button>
        </nav>
    </div>

    <!-- Modal System -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-50 hidden flex items-end sm:items-center justify-center animate-fade backdrop-blur-sm">
        <div id="modal-content" class="bg-white w-full max-w-[28rem] rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl transform transition-transform duration-300 pb-10 sm:pb-6 max-h-[85vh] overflow-y-auto hide-scrollbar"></div>
    </div>
    <div id="sub-modal-overlay" class="fixed inset-0 bg-black/40 z-[60] hidden flex items-end sm:items-center justify-center animate-fade backdrop-blur-sm">
        <div id="sub-modal-content" class="bg-white w-full max-w-[28rem] rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl transform transition-transform duration-300 pb-10 sm:pb-6 max-h-[50vh] overflow-y-auto hide-scrollbar"></div>
    </div>

    <!-- Templates -->
    <template id="tpl-accounting">
        <!-- RPG Arena -->
        <div id="rpg-arena" class="relative bg-gradient-to-b from-blue-100 to-white pt-6 pb-2 px-4 mb-2 overflow-hidden min-h-[160px] flex items-end justify-between border-b border-gray-100">
            <!-- Background Decoration -->
            <div class="absolute top-2 left-4 text-4xl opacity-20"><i class="fa-solid fa-cloud"></i></div>
            <div class="absolute top-8 right-8 text-3xl opacity-20"><i class="fa-solid fa-cloud"></i></div>
            
            <!-- Hero -->
            <div class="z-10 text-center relative hero-container">
                <div class="text-xs font-bold text-blue-600 mb-1 bg-white/80 px-2 py-0.5 rounded-full">å‹‡è€… (Lv.<span id="hero-level">1</span>)</div>
                <div id="hero-sprite" class="text-6xl filter drop-shadow-lg transition-transform transform origin-bottom">ğŸ§™â€â™‚ï¸</div>
            </div>

            <!-- VS -->
            <div class="z-0 mb-6 text-gray-300 font-black text-2xl italic opacity-50">VS</div>

            <!-- Boss -->
            <div class="z-10 text-center relative boss-container w-1/2">
                <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-1 px-1">
                    <span id="boss-name">è² å‚µé­”ç‹</span>
                    <span id="boss-hp-text">100%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-2 border border-gray-300 relative overflow-hidden">
                    <div id="boss-hp-bar" class="bg-red-500 h-full rounded-full transition-all duration-1000" style="width: 100%"></div>
                </div>
                <div id="boss-sprite" class="text-7xl filter drop-shadow-xl transition-transform transform origin-bottom">ğŸ‘¹</div>
            </div>
            
            <!-- Effects Container -->
            <div id="fx-container" class="absolute inset-0 pointer-events-none z-50"></div>
        </div>

        <div class="bg-white p-4 rounded-b-2xl card-shadow mb-3 sticky top-0 z-10">
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs font-bold text-gray-400">æœ¬æœˆæ¦‚æ³</span>
                <input type="month" id="date-filter" class="bg-gray-100 border-none rounded-lg px-2 py-1 text-xs font-bold text-gray-600 focus:ring-0 cursor-pointer" onchange="App.renderTransactions()">
            </div>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-green-50 p-2 rounded-lg"><p class="text-[10px] text-green-600 mb-0.5">æ”¶å…¥</p><p id="monthly-income" class="text-sm font-bold text-green-700">0</p></div>
                <div class="bg-red-50 p-2 rounded-lg"><p class="text-[10px] text-red-600 mb-0.5">æ”¯å‡º</p><p id="monthly-expense" class="text-sm font-bold text-red-700">0</p></div>
                <div class="bg-blue-50 p-2 rounded-lg"><p class="text-[10px] text-blue-600 mb-0.5">çµé¤˜</p><p id="monthly-balance" class="text-sm font-bold text-blue-700">0</p></div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center">
                <span class="text-xs font-bold text-gray-800">æœ¬æ—¥å°è¨ˆ</span>
                <div class="flex gap-2 text-xs items-center">
                    <span class="text-green-600 font-medium">æ”¶:<span id="today-income">0</span></span>
                    <span class="text-red-500 font-medium">æ”¯:<span id="today-expense">0</span></span>
                    <span class="text-blue-600 font-medium border-l pl-2 border-gray-200" id="today-balance-container">é¤˜:<span id="today-balance">0</span></span>
                </div>
            </div>
        </div>
        <div class="px-3 pb-4"><ul id="tx-list" class="space-y-3"></ul></div>
    </template>

    <!-- Template: Investment -->
    <template id="tpl-investment">
        <div class="flex justify-between items-center mb-3 px-1">
            <div class="flex items-center gap-2">
                <h3 class="text-sm font-bold text-gray-600">é‡‘åº«æ¦‚æ³</h3>
                <span id="inv-monthly-summary" class="text-xs text-secondary font-bold bg-green-50 px-2 py-0.5 rounded">æœ¬æœˆæ”¶ç›Š: $0</span>
            </div>
            <input type="month" id="inv-date-filter" class="bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold text-gray-600 focus:ring-0 cursor-pointer shadow-sm" onchange="App.renderInvestments()">
        </div>
        <div class="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-2xl p-4 text-white shadow-lg card-shadow mb-4">
            <p class="text-indigo-100 text-xs mb-1">ç¸½è³‡ç”¢ç¾å€¼</p>
            <h2 id="inv-total-val" class="text-3xl font-bold tracking-tight">--</h2>
            <div class="flex gap-4 mt-3 text-xs border-t border-white/20 pt-3">
                <div><span class="opacity-70 block mb-0.5">ç¸½æç›Š</span> <span id="inv-total-ret" class="font-bold text-base">--</span></div>
                <div><span class="opacity-70 block mb-0.5">å ±é…¬ç‡</span> <span id="inv-roi" class="font-bold text-base">--</span></div>
            </div>
        </div>
        <div class="flex bg-gray-200 p-1 rounded-xl mb-3">
            <button class="tab-pill flex-1 py-1.5 rounded-lg text-xs font-bold text-gray-500 active transition" onclick="App.switchInvTab('active', this)">é€²è¡Œä¸­</button>
            <button class="tab-pill flex-1 py-1.5 rounded-lg text-xs font-bold text-gray-500 transition" onclick="App.switchInvTab('archived', this)">å·²çµæ¡ˆ</button>
        </div>
        <div class="flex justify-between items-center px-1 mb-2">
            <span class="text-xs font-bold text-gray-500">æŠ•è³‡å¸³æˆ¶</span>
            <button onclick="App.openModal('investment-modal')" class="text-primary text-xs font-bold bg-primary/10 px-2 py-1 rounded hover:bg-primary/20 transition">+ æ–°å¢</button>
        </div>
        <div id="inv-list" class="grid gap-2"></div>
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex justify-between items-center px-1 mb-2"><span class="text-xs font-bold text-gray-500">æ”¶å…¥é ç®—/ç›®æ¨™</span><button onclick="App.openBudgetModal('investment')" class="text-secondary text-xs font-bold bg-secondary/10 px-2 py-1 rounded hover:bg-secondary/20 transition">+ é ç®—</button></div>
            <ul id="inv-budget-list" class="space-y-2"></ul>
        </div>
    </template>

    <!-- Template: Debt -->
    <template id="tpl-debt">
        <div class="flex justify-between items-center mb-3 px-1">
            <div class="flex items-center gap-2">
                <h3 class="text-sm font-bold text-gray-600">é­”ç‰©åœ–é‘‘ (è² å‚µ)</h3>
                <span id="debt-monthly-summary" class="text-xs text-danger font-bold bg-red-50 px-2 py-0.5 rounded">æœ¬æœˆé‚„æ¬¾: $0</span>
            </div>
            <input type="month" id="debt-date-filter" class="bg-white border border-gray-200 rounded-lg px-2 py-1 text-xs font-bold text-gray-600 focus:ring-0 cursor-pointer shadow-sm" onchange="App.renderDebts()">
        </div>
        <div class="bg-white p-4 rounded-2xl card-shadow border-t-4 border-warning mb-4">
            <div class="flex justify-between items-end mb-2">
                <div><p class="text-xs text-gray-500">å‰©é¤˜ç¸½è² å‚µ</p><p id="debt-total-remaining" class="text-2xl font-bold text-gray-800">--</p></div>
                <div class="text-right"><p class="text-[10px] text-gray-400">ç¸½é€²åº¦</p><p id="debt-progress-text" class="text-sm font-bold text-warning">0%</p></div>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-2"><div id="debt-progress-bar" class="bg-warning h-2 rounded-full transition-all duration-500" style="width: 0%"></div></div>
        </div>
        <div class="flex justify-between items-center px-1 mb-2">
            <span class="text-xs font-bold text-gray-500">è² å‚µé …ç›®</span>
            <button onclick="App.openModal('debt-modal')" class="text-primary text-xs font-bold bg-primary/10 px-2 py-1 rounded hover:bg-primary/20 transition">+ æ–°å¢</button>
        </div>
        <div id="debt-list" class="space-y-2"></div>
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex justify-between items-center px-1 mb-2"><span class="text-xs font-bold text-gray-500">é‚„æ¬¾è¨ˆç•«</span><button onclick="App.openBudgetModal('debt')" class="text-danger text-xs font-bold bg-danger/10 px-2 py-1 rounded hover:bg-danger/20 transition">+ è¨ˆç•«</button></div>
            <ul id="debt-budget-list" class="space-y-2"></ul>
        </div>
    </template>

    <!-- Template: Reports -->
    <template id="tpl-reports">
        <div class="bg-white p-3 rounded-xl card-shadow mb-2 space-y-2">
            <div class="flex gap-2">
                <select id="report-year" class="bg-gray-50 rounded-lg px-2 py-1.5 text-xs font-bold border-transparent focus:border-primary flex-1 min-w-0" onchange="App.renderReports()"></select>
                <select id="report-month-select" class="bg-gray-50 rounded-lg px-2 py-1.5 text-xs font-bold border-transparent focus:border-primary flex-1 min-w-0" onchange="App.renderReports()">
                    <option value="all">å…¨å¹´åº¦</option>
                    <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option><option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option><option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                </select>
            </div>
            <div class="flex gap-2">
                <select id="report-project" class="bg-gray-50 rounded-lg px-2 py-1.5 text-xs font-bold border-transparent focus:border-primary flex-1 min-w-0" onchange="App.renderReports()">
                    <option value="all">å…¨éƒ¨å°ˆæ¡ˆ</option>
                </select>
                <select id="report-category" class="bg-gray-50 rounded-lg px-2 py-1.5 text-xs font-bold border-transparent focus:border-primary flex-1 min-w-0" onchange="App.renderReports()">
                    <option value="all">å…¨éƒ¨åˆ†é¡</option>
                </select>
                <button type="button" onclick="App.exportReport()" class="bg-gray-100 px-3 py-1.5 rounded-lg text-gray-500 hover:text-primary hover:bg-blue-50 transition flex-shrink-0"><i class="fa-solid fa-file-export"></i></button>
            </div>
        </div>
        <div class="bg-white p-4 rounded-2xl card-shadow">
            <h3 class="font-bold mb-4 text-center text-xs text-gray-500 uppercase tracking-wider">æ”¯å‡ºåˆ†ä½ˆ</h3>
            <div class="h-56 relative"><canvas id="expense-chart"></canvas></div>
        </div>
        <div class="bg-white p-4 rounded-2xl card-shadow mt-3">
            <h3 class="font-bold mb-3 text-xs border-b border-gray-100 pb-2 text-gray-500">åˆ†é¡çµ±è¨ˆ</h3>
            <ul id="report-stats" class="space-y-2 text-xs mb-4"></ul>
            <h3 class="font-bold mb-3 text-xs border-b border-gray-100 pb-2 text-gray-500">äº¤æ˜“æ˜ç´° (é»æ“Šå¯ç·¨è¼¯)</h3>
            <ul id="report-details" class="space-y-2"></ul>
        </div>
    </template>

    <template id="tpl-events">
        <button type="button" onclick="App.openModal('event-modal')" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-gray-50 hover:border-gray-400 transition mb-2 text-xs">+ ç´€éŒ„å¤§äº‹è¨˜</button>
        <div id="event-list" class="space-y-4 pl-2"></div>
    </template>

    <!-- Modals -->
    <template id="tpl-transaction-modal">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-lg font-bold text-gray-800" id="tx-modal-title">æ”»æ“Š / è£œçµ¦</h3>
            <div class="flex items-center gap-2">
                 <button type="button" id="btn-delete-tx" class="hidden w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 transition"><i class="fa-solid fa-trash-can"></i></button>
                 <button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        <form onsubmit="App.handleSaveTransaction(event)" class="space-y-4">
            <input type="hidden" name="id">
            <input type="hidden" name="legacy_inv_id"> 
            <div class="flex bg-gray-100 p-1 rounded-xl">
                <button type="button" class="type-btn flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow text-danger transition" onclick="App.toggleTxType('expense')" id="btn-expense">æ”¯å‡º (æ”»æ“Š)</button>
                <button type="button" class="type-btn flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 transition" onclick="App.toggleTxType('income')" id="btn-income">æ”¶å…¥ (è£œçµ¦)</button>
            </div>
            <input type="hidden" name="type" id="tx-type" value="expense">
            <div><label class="text-[10px] font-bold text-gray-400 ml-1">é‡‘é¡ (å‚·å®³)</label><input type="number" name="amount" class="w-full text-3xl font-bold text-gray-800 border-b border-gray-200 py-1 focus:border-primary bg-transparent text-center focus:outline-none" placeholder="0" required inputmode="decimal"></div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="text-[10px] font-bold text-gray-400 ml-1">æ—¥æœŸ</label><input type="date" name="date" class="w-full bg-gray-50 rounded-xl px-3 py-2.5 text-xs font-medium focus:bg-white focus:ring-1 focus:ring-primary transition" required></div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 ml-1">åˆ†é¡</label>
                    <div class="flex gap-2">
                        <input name="category" class="w-full bg-gray-50 rounded-xl px-3 py-2.5 text-xs font-medium focus:bg-white focus:ring-1 focus:ring-primary transition" placeholder="é¸æ“‡æˆ–è¼¸å…¥..." required>
                        <button type="button" onclick="App.openCategorySelector()" class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center text-gray-500 hover:bg-gray-200 transition"><i class="fa-solid fa-list-ul"></i></button>
                    </div>
                </div>
            </div>
            <div><label class="text-[10px] font-bold text-gray-400 ml-1">å°ˆæ¡ˆ / å¸³æˆ¶ (é¸å¡«)</label><input type="text" name="project" class="w-full bg-gray-50 rounded-xl px-3 py-2.5 text-xs font-medium focus:bg-white focus:ring-1 focus:ring-primary transition" placeholder="ä¾‹å¦‚: å°ç©é›»ã€å­¸è²¸..."></div>
            <div><label class="text-[10px] font-bold text-gray-400 ml-1">å‚™è¨»</label><input type="text" name="remarks" class="w-full bg-gray-50 rounded-xl px-3 py-2.5 text-xs font-medium focus:bg-white focus:ring-1 focus:ring-primary transition" placeholder="å¯«é»ä»€éº¼..."></div>
            <div class="flex gap-2 pt-2"><button type="button" onclick="App.closeModal()" class="flex-1 bg-gray-100 py-3.5 rounded-xl font-bold text-gray-500 text-sm">å–æ¶ˆ</button><button type="submit" class="flex-1 bg-primary text-white font-bold py-3.5 rounded-xl shadow-lg shadow-primary/30 text-sm">ç™¼å‹•æ”»æ“Š</button></div>
        </form>
    </template>
    
    <!-- Category Selection Modal Template -->
    <template id="tpl-category-selector">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800">é¸æ“‡åˆ†é¡</h3>
            <button onclick="App.closeSubModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="category-chips" class="flex flex-wrap gap-2 max-h-60 overflow-y-auto"></div>
    </template>

    <template id="tpl-investment-modal">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">æŠ•è³‡å¸³æˆ¶</h3><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveInvestment(event)" class="space-y-4">
            <input type="hidden" name="id"><input type="text" name="name" class="w-full bg-gray-50 rounded-xl p-3 text-sm focus:bg-white border-transparent focus:border-primary transition" placeholder="åç¨±" required><input type="number" name="initial" class="w-full bg-gray-50 rounded-xl p-3 text-sm focus:bg-white border-transparent focus:border-primary transition" placeholder="åˆå§‹æˆæœ¬">
            <div class="flex items-center gap-2 px-1"><input type="checkbox" name="isArchived" id="inv-archived" class="rounded text-primary focus:ring-primary"><label for="inv-archived" class="text-sm text-gray-600">å·²çµæ¡ˆ (æ­¸æª”)</label></div>
            <button type="submit" class="w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg text-sm">å„²å­˜</button>
        </form>
    </template>
    <template id="tpl-debt-modal">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">è² å‚µé …ç›®</h3><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveDebt(event)" class="space-y-4">
            <input type="hidden" name="id">
            <div><label class="text-[10px] font-bold text-gray-400 ml-1">åç¨±</label><input type="text" name="name" class="w-full bg-gray-50 rounded-xl p-3 text-sm" placeholder="åç¨±" required></div>
            <div class="grid grid-cols-2 gap-3">
                <div><label class="text-[10px] font-bold text-gray-400 ml-1">ç¸½é‡‘é¡</label><input type="number" name="total" class="w-full bg-gray-50 rounded-xl p-3 text-sm" placeholder="ç¸½é‡‘é¡" required></div>
                <div><label class="text-[10px] font-bold text-gray-400 ml-1">å‰©é¤˜é‡‘é¡ (æ‰‹å‹•æ ¡æ­£)</label><input type="number" name="remaining" class="w-full bg-gray-50 rounded-xl p-3 text-sm border border-gray-200" placeholder="å‰©é¤˜é‡‘é¡"></div>
            </div>
            <button type="submit" class="w-full bg-warning text-white font-bold py-3 rounded-xl shadow-lg text-sm">å„²å­˜</button>
        </form>
    </template>
    <template id="tpl-budget-form">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800" id="budget-modal-title">æ–°å¢é ç®—</h3><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveBudget(event)" class="space-y-4"><input type="hidden" name="id"><input type="hidden" name="context" id="budget-context"><select name="targetId" id="budget-target" class="w-full bg-gray-50 rounded-xl p-3 text-sm appearance-none" required></select><input type="number" name="amount" class="w-full bg-gray-50 rounded-xl p-3 text-sm" placeholder="é‡‘é¡" required><input type="date" name="date" class="w-full bg-gray-50 rounded-xl p-3 text-sm" required><input type="text" name="desc" class="w-full bg-gray-50 rounded-xl p-3 text-sm placeholder-blue-400 text-blue-600 font-medium" placeholder="èªªæ˜" required><button type="submit" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-primary/30 text-sm">è¨­å®š</button></form>
    </template>
    <template id="tpl-repay-form">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">é‚„æ¬¾</h3><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
        <p id="repay-debt-name" class="text-xs text-gray-500 mb-4"></p>
        <form onsubmit="App.handleRepayDebt(event)" class="space-y-4"><input type="hidden" name="id" id="repay-id"><input type="number" name="amount" class="w-full text-3xl font-bold border-b py-2 focus:border-primary text-center focus:outline-none" placeholder="é‡‘é¡" required inputmode="decimal"><input type="date" name="date" class="w-full bg-gray-50 rounded-xl p-3 text-sm" required><div class="flex gap-2 text-sm pt-2"><button type="button" onclick="App.closeModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button type="submit" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-500/30">ç¢ºèª</button></div></form>
    </template>
    <template id="tpl-event-modal">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">å¤§äº‹è¨˜</h3><button type="button" id="btn-delete-event" class="hidden w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 transition"><i class="fa-solid fa-trash-can"></i></button><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
        <form onsubmit="App.handleSaveEvent(event)" class="space-y-4"><input type="hidden" name="id"><input type="date" name="date" class="w-full bg-gray-50 rounded-xl p-3 text-sm" required><input type="text" name="title" class="w-full bg-gray-50 rounded-xl p-3 text-sm" placeholder="æ¨™é¡Œ" required><textarea name="desc" rows="3" class="w-full bg-gray-50 rounded-xl p-3 text-sm" placeholder="å…§å®¹..."></textarea><button type="submit" class="w-full bg-dark text-white py-3 rounded-xl font-bold text-sm shadow-lg">ç´€éŒ„</button></form>
    </template>
    <template id="tpl-details-modal">
        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800 details-title truncate pr-4"></h3><button type="button" onclick="App.closeModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 flex-shrink-0"><i class="fa-solid fa-xmark"></i></button></div>
        <div class="max-h-[60vh] overflow-y-auto hide-scrollbar"><div class="details-budget-section mb-4 hidden"><h4 class="text-xs font-bold text-gray-500 mb-2 border-b pb-1">é ç®— / è¨ˆç•«</h4><ul class="details-budget-list space-y-1"></ul></div><div><h4 class="text-xs font-bold text-gray-500 mb-2 border-b pb-1">äº¤æ˜“ç´€éŒ„</h4><ul class="details-list space-y-2"><li class="text-center text-gray-400 py-4">è¼‰å…¥ä¸­...</li></ul></div></div>
        <div class="details-actions mt-4 pt-2 border-t border-gray-100 flex flex-col gap-2"></div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, updateDoc, increment, Timestamp, writeBatch, where, orderBy, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp({ apiKey: "AIzaSyAqFHm6Bn35m8xauc50ZvNNy_rxIZzCMTE", authDomain: "moneyw-f8105.firebaseapp.com", projectId: "moneyw-f8105", storageBucket: "moneyw-f8105.appspot.com", messagingSenderId: "155586195799", appId: "1:155586195799:web:302184fbf613f032a88e12" });
        const auth = getAuth(app); const db = getFirestore(app);
        const State = { user: null, data: { transactions: [], debts: [], investments: [], events: [], investmentBudgets: [], debtBudgets: [], legacyTxs: {} }, listeners: [], chart: null, categories: { expense: ['é£²é£Ÿ', 'äº¤é€š', 'å±…ä½', 'å¨›æ¨‚', 'è³¼ç‰©', 'é†«ç™‚', 'æ•™è‚²', 'æŠ•è³‡', 'å…¶ä»–'], income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–'] }, view: { invTab: 'active', currentTab: 'accounting' } };

        // ğŸ›¡ï¸ Ultra Robust Date Parser
        const getTxDate = (tx) => {
            if (!tx) return new Date();
            try {
                if (tx.timestamp && typeof tx.timestamp.toDate === 'function') return tx.timestamp.toDate();
                if (tx.date) {
                    if (typeof tx.date.toDate === 'function') return tx.date.toDate();
                    const d = new Date(tx.date);
                    if (!isNaN(d.getTime())) return d;
                }
                if (tx.timestamp && tx.timestamp.seconds) return new Date(tx.timestamp.seconds * 1000);
            } catch (e) {}
            return new Date();
        };

        // FIX: Use local date components string construction
        const toDateStr = (dateObj) => {
            const d = (dateObj instanceof Date) ? dateObj : getTxDate({timestamp: dateObj});
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const renderDatalist = (e, i) => { if(e) e.innerHTML = i.map(v => `<option value="${v}">`).join(''); };

        window.App = {
            init: () => onAuthStateChanged(auth, u => {
                State.user = u;
                document.getElementById('login-view').classList.toggle('hidden', !!u);
                document.getElementById('app-container').classList.toggle('hidden', !u);
                if(u) {
                    document.getElementById('user-info').innerText = u.isAnonymous ? 'è¨ªå®¢' : u.displayName;
                    App.switchTab('accounting', document.querySelector('#nav-accounting'));
                    setTimeout(() => App.startListeners(u.uid), 100);
                } else App.stopListeners();
            }),
            startListeners: (uid) => {
                const listen = (c, k) => State.listeners.push(onSnapshot(query(collection(db, `users/${uid}/${c}`)), s => { 
                    State.data[k] = s.docs.map(d=>({id:d.id, ...d.data()})); 
                    App.refreshCurrentView();
                }));
                listen('transactions', 'transactions');
                listen('debts', 'debts');
                listen('events', 'events');
                listen('investmentBudgets', 'investmentBudgets');
                listen('debtBudgets', 'debtBudgets');
                
                State.listeners.push(onSnapshot(query(collection(db, `users/${uid}/investments`)), async (s) => {
                    State.data.investments = s.docs.map(d=>({id:d.id, ...d.data()}));
                    for (let inv of State.data.investments) {
                        if (!State.data.legacyTxs[inv.id]) {
                            try {
                                const subSnap = await getDocs(collection(db, `users/${uid}/investments/${inv.id}/transactions`));
                                State.data.legacyTxs[inv.id] = subSnap.docs.map(d => {
                                    const data = d.data();
                                    let ts = data.timestamp || data.date;
                                    if (typeof ts === 'string') {
                                        const pd = new Date(ts);
                                        if(!isNaN(pd.getTime())) ts = Timestamp.fromDate(pd);
                                        else ts = Timestamp.fromDate(new Date());
                                    } else if (ts && !ts.toDate) { 
                                        if(ts.seconds) ts = new Timestamp(ts.seconds, ts.nanoseconds);
                                        else ts = Timestamp.fromDate(new Date()); 
                                    }
                                    return { id: d.id, ...data, timestamp: ts, remarks: data.remarks || data.remark, isLegacy: true, legacyInvId: inv.id };
                                });
                            } catch(e) { State.data.legacyTxs[inv.id] = []; }
                        }
                    }
                    App.refreshCurrentView();
                }));
            },
            stopListeners: () => { State.listeners.forEach(u=>u()); State.listeners=[]; },
            loginGoogle: () => signInWithPopup(auth, new GoogleAuthProvider()), loginAnon: () => signInAnonymously(auth), logout: () => signOut(auth),
            
            refreshCurrentView: () => {
                const tab = State.view.currentTab;
                try {
                    if (tab === 'accounting' && document.getElementById('tx-list')) { App.renderTransactions(); App.updateDashboard(); }
                    else if (tab === 'investment' && document.getElementById('inv-list')) App.renderInvestments();
                    else if (tab === 'debt' && document.getElementById('debt-list')) App.renderDebts();
                    else if (tab === 'reports' && document.getElementById('report-stats')) App.renderReports();
                    else if (tab === 'events' && document.getElementById('event-list')) App.renderEvents();
                } catch(e) { console.error("Render Error:", e); }
            },
            
            switchTab: (tab, btn) => {
                State.view.currentTab = tab;
                document.querySelectorAll('.view-section').forEach(e => { e.classList.add('hidden'); e.innerHTML = ''; }); 
                const target = document.getElementById(`view-${tab}`);
                target.classList.remove('hidden');
                target.innerHTML = document.getElementById(`tpl-${tab}`).innerHTML; 

                if(tab === 'accounting') document.getElementById('date-filter').value = new Date().toISOString().slice(0, 7);
                else if(tab === 'investment') document.getElementById('inv-date-filter').value = new Date().toISOString().slice(0, 7);
                else if(tab === 'debt') document.getElementById('debt-date-filter').value = new Date().toISOString().slice(0, 7);
                else if(tab === 'reports') {
                    const yrSel = document.getElementById('report-year');
                    const curYr = new Date().getFullYear();
                    yrSel.innerHTML = '';
                    for(let y=curYr-2; y<=curYr+1; y++) yrSel.innerHTML += `<option value="${y}" ${y===curYr?'selected':''}>${y}å¹´</option>`;
                    document.getElementById('report-month-select').value = (new Date().getMonth()+1).toString();
                }

                document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active', 'text-primary'));
                if(btn) btn.classList.add('active', 'text-primary');
                document.getElementById('page-title').innerText = {accounting:'ç¸½è¦½', investment:'æŠ•è³‡', debt:'è² å‚µ', reports:'å ±è¡¨', events:'å¤§äº‹è¨˜'}[tab];
                App.refreshCurrentView();
            },
            
            getAllTransactions: () => {
                let allTxs = [];
                let linkedIds = new Set();
                if (State.data.investments && State.data.legacyTxs) {
                    State.data.investments.forEach(inv => {
                        const sub = State.data.legacyTxs[inv.id] || [];
                        sub.forEach(t => {
                            let tsObj = getTxDate(t);
                            allTxs.push({ 
                                ...t, 
                                project: inv.name, 
                                category: t.category || (t.type === 'income' ? 'æŠ•è³‡æ”¶å…¥' : 'æŠ•è³‡æ”¯å‡º'), 
                                timestamp: Timestamp.fromDate(tsObj), 
                                amount: parseFloat(t.amount) || 0, 
                                isLegacy: true,
                                legacyInvId: inv.id 
                            });
                            if(t.mainTransactionId) linkedIds.add(t.mainTransactionId);
                        });
                    });
                }
                if (State.data.transactions) {
                    State.data.transactions.forEach(t => {
                        if (!linkedIds.has(t.id)) allTxs.push(t);
                    });
                }
                return allTxs.sort((a,b) => (getTxDate(b) - getTxDate(a)));
            },

            handleDateFilterChange: () => { App.renderTransactions(); App.updateDashboard(); },
            switchInvTab: (tab, btn) => { State.view.invTab = tab; document.querySelectorAll('.tab-pill').forEach(e => e.classList.remove('active', 'bg-gray-600', 'text-white')); btn.classList.add('active'); App.renderInvestments(); },

            handleSaveTransaction: async (e) => {
                // ... (Logic stays mostly same, but make sure to update debt if new expense on debt project)
                e.preventDefault(); const f=e.target, uid=State.user.uid, id=f.id.value, lid=f.legacy_inv_id.value;
                const localDate = new Date(f.date.value + 'T12:00:00'); 
                const d = { type: f.type.value, amount: parseFloat(f.amount.value), category: f.category.value, remarks: f.remarks.value, timestamp: Timestamp.fromDate(localDate), project: f.project.value };
                
                const batch = writeBatch(db);

                // Auto Debt: Deduct amount if new expense on debt project
                if (d.type === 'expense' && d.project && !id) { // Only on CREATE for safety
                     const debt = State.data.debts.find(db => db.name === d.project);
                     if (debt) {
                         const debtRef = doc(db, `users/${uid}/debts`, debt.id);
                         batch.update(debtRef, { remainingAmount: increment(-d.amount) });
                     }
                }

                if (lid && id) {
                    const newRef = doc(collection(db, `users/${uid}/transactions`));
                    batch.set(newRef, d);
                    batch.delete(doc(db, `users/${uid}/investments/${lid}/transactions`, id));
                    if (State.data.legacyTxs[lid]) {
                         State.data.legacyTxs[lid] = State.data.legacyTxs[lid].filter(t => t.id !== id);
                    }
                } else {
                    id ? await updateDoc(doc(db, `users/${uid}/transactions`, id), d) : await addDoc(collection(db, `users/${uid}/transactions`), d);
                }
                await batch.commit();
                
                // RPG Effect
                const el = document.getElementById('fx-container');
                if(el) {
                    const fx = document.createElement('div');
                    fx.className = 'dmg-text';
                    fx.style.left = '50%'; fx.style.bottom = '100px';
                    fx.innerText = d.type === 'income' ? `+${d.amount}` : `-${d.amount}`;
                    el.appendChild(fx);
                    setTimeout(() => fx.remove(), 1000);
                    
                    const hero = document.getElementById('hero-sprite');
                    if(hero) { hero.classList.add('hero-attack'); setTimeout(() => hero.classList.remove('hero-attack'), 300); }
                    const boss = document.getElementById('boss-sprite');
                    if(boss) { setTimeout(() => boss.classList.add('boss-hit'), 150); setTimeout(() => boss.classList.remove('boss-hit'), 650); }
                }

                App.closeModal();
            },
            // Simplified Handlers
            handleSaveInvestment: async (e) => { e.preventDefault(); const f=e.target; const d={name:f.name.value, initialValue:parseFloat(f.initial.value)||0, isArchived:f.isArchived.checked}; if(!f.id.value){d.marketValue=d.initialValue;d.createdAt=Timestamp.now();} f.id.value?await updateDoc(doc(db,`users/${State.user.uid}/investments`,f.id.value),d):(await addDoc(collection(db,`users/${State.user.uid}/investments`),d) && d.initialValue>0 && await addDoc(collection(db,`users/${State.user.uid}/transactions`),{type:'expense',amount:d.initialValue,category:'æŠ•è³‡',project:f.name.value,remarks:'åˆå§‹æŠ•å…¥',timestamp:Timestamp.now()})); App.closeModal(); },
            
            handleSaveDebt: async (e) => { 
                e.preventDefault(); 
                const f=e.target, uid=State.user.uid; 
                const total = parseFloat(f.total.value);
                const d = { name:f.name.value, totalAmount: total };
                
                if (f.remaining && f.remaining.value) {
                    d.remainingAmount = parseFloat(f.remaining.value);
                } else if(!f.id.value) {
                    d.remainingAmount = total;
                    d.createdAt = Timestamp.now();
                }

                f.id.value ? await updateDoc(doc(db,`users/${uid}/debts`,f.id.value),d) : await addDoc(collection(db,`users/${uid}/debts`),d); 
                App.closeModal(); 
            },
            
            handleSaveBudget: async (e) => { e.preventDefault(); const f=e.target, uid=State.user.uid, ctx=f.context.value; const col = ctx === 'investment' ? 'investmentBudgets' : 'debtBudgets'; const d = { targetId: f.targetId.value,amount:parseFloat(f.amount.value),expectedDate:Timestamp.fromDate(new Date(f.date.value)),description:f.desc.value}; if(!f.id.value){d.isRealized=false;d.createdAt=Timestamp.now();} f.id.value?await updateDoc(doc(db,`users/${State.user.uid}/${f.context.value==='investment'?'investmentBudgets':'debtBudgets'}`,f.id.value),d):await addDoc(collection(db,`users/${State.user.uid}/${f.context.value==='investment'?'investmentBudgets':'debtBudgets'}`),d); App.closeModal(); },
            handleRepayDebt: async (e) => { e.preventDefault(); const f=e.target, amt=parseFloat(f.amount.value), uid=State.user.uid; const debt=State.data.debts.find(d=>d.id===f.id.value); const batch=writeBatch(db); batch.update(doc(db,`users/${State.user.uid}/debts`,f.id.value),{remainingAmount:increment(-amt)}); batch.set(doc(collection(db,`users/${State.user.uid}/transactions`)),{type:'expense',amount:amt,category:'è² å‚µé‚„æ¬¾',project:debt.name,remarks:`å„Ÿé‚„: ${debt.name}`,timestamp:Timestamp.fromDate(new Date(f.date.value))}); await batch.commit(); App.closeModal(); },
            handleSaveEvent: async(e) => { e.preventDefault(); const f=e.target, uid=State.user.uid; const d = { title:f.title.value, description:f.desc.value, date:Timestamp.fromDate(new Date(f.date.value)) }; f.id.value?await updateDoc(doc(db,`users/${uid}/events`,f.id.value),d):await addDoc(collection(db,`users/${uid}/events`),d); App.closeModal(); },
            
            deleteTransaction: async (id, legacyInvId) => {
                if (!confirm('ç¢ºå®šåˆªé™¤?')) return;
                const uid = State.user.uid;
                let path = `users/${uid}/transactions/${id}`;
                let isLegacy = false;

                if (legacyInvId && legacyInvId !== 'undefined') {
                    path = `users/${uid}/investments/${legacyInvId}/transactions/${id}`;
                    isLegacy = true;
                }

                const docRef = doc(db, path);
                try {
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) { alert("æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™"); return; }
                    const txData = docSnap.data();
                    const batch = writeBatch(db);

                    // Reverse Debt Repayment (Add back the amount)
                    if (!isLegacy && txData.type === 'expense' && txData.project) {
                         const debt = State.data.debts.find(d => d.name === txData.project);
                         if (debt) {
                             const debtRef = doc(db, `users/${uid}/debts`, debt.id);
                             batch.update(debtRef, { remainingAmount: increment(txData.amount) });
                         }
                    }

                    batch.delete(docRef);
                    await batch.commit();

                    if (isLegacy && State.data.legacyTxs[legacyInvId]) {
                         State.data.legacyTxs[legacyInvId] = State.data.legacyTxs[legacyInvId].filter(t => t.id !== id);
                    }
                    App.closeModal();
                } catch (e) { console.error(e); alert("åˆªé™¤å¤±æ•—"); }
            },
            deleteItem: async (c,id) => { if(confirm('åˆªé™¤?')) await deleteDoc(doc(db, `users/${State.user.uid}/${c}`, id)); },
            updateMarketValue: async (id,old) => { const v=prompt("ç›®å‰å¸‚å€¼:",old); if(v&&!isNaN(v)) await updateDoc(doc(db, `users/${State.user.uid}/investments`, id), {marketValue:parseFloat(v)}); },
            realizeBudget: async(ctx, id) => { if(!confirm("åŸ·è¡Œé ç®—?"))return; const col=ctx==='investment'?'investmentBudgets':'debtBudgets'; const b=State.data[col].find(i=>i.id===id); const acc=(ctx==='investment'?State.data.investments:State.data.debts).find(a=>a.id===b.targetId); const batch=writeBatch(db); batch.update(doc(db,`users/${State.user.uid}/${col}`,id),{isRealized:true}); batch.set(doc(collection(db,`users/${State.user.uid}/transactions`)),{type:ctx==='investment'?'income':'expense',amount:b.amount,category:ctx==='investment'?'æŠ•è³‡':'è² å‚µé‚„æ¬¾',project:acc.name,remarks:`é ç®—åŸ·è¡Œ: ${b.description}`,timestamp:Timestamp.now()}); if(ctx!=='investment') batch.update(doc(db,`users/${State.user.uid}/debts`,acc.id),{remainingAmount:increment(-b.amount)}); await batch.commit(); },
            exportReport: () => { if(!confirm("åŒ¯å‡º?"))return; const csv="Date,Category,Project,Note,Type,Amount\n"+App.getAllTransactions().map(t=>`${toDateStr(t.timestamp)},${t.category},${t.project||''},${t.remarks||''},${t.type},${t.amount}`).join("\n"); const l=document.createElement("a"); l.href=URL.createObjectURL(new Blob(["\uFEFF"+csv],{type:'text/csv'})); l.download="report.csv"; l.click(); },
            exportEvents: () => {
                if(!confirm("åŒ¯å‡ºå¤§äº‹è¨˜?")) return;
                const txt = State.data.events
                    .sort((a,b) => getTxDate(b) - getTxDate(a))
                    .map(e => `${toDateStr(getTxDate(e))} - ${e.title}\n${e.description || ''}\n-------------------------`)
                    .join("\n");
                const l = document.createElement("a");
                l.href = URL.createObjectURL(new Blob([txt], {type:'text/plain;charset=utf-8;'}));
                l.download = "events.txt";
                l.click();
            },

            // CATEGORY SELECTION LOGIC
            openCategorySelector: () => {
                const type = document.getElementById('tx-type').value;
                const allTxs = App.getAllTransactions();
                const historyCats = allTxs.filter(t => t.type === type && t.category).map(t => t.category);
                const counts = {}; historyCats.forEach(c => counts[c] = (counts[c] || 0) + 1);
                const sortedHistory = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
                const defaults = State.categories[type];
                const combined = [...new Set([...sortedHistory, ...defaults])];

                const c = document.getElementById('sub-modal-content');
                c.innerHTML = document.getElementById('tpl-category-selector').innerHTML;
                const list = document.getElementById('category-chips');
                list.innerHTML = combined.map(c => 
                    `<button onclick="App.pickCategory('${c}')" class="bg-gray-100 hover:bg-primary hover:text-white text-gray-700 px-3 py-2 rounded-xl text-sm transition">${c}</button>`
                ).join('');
                document.getElementById('sub-modal-overlay').classList.remove('hidden');
                document.getElementById('sub-modal-overlay').classList.add('flex');
            },
            closeSubModal: () => document.getElementById('sub-modal-overlay').classList.add('hidden'),
            pickCategory: (val) => { document.querySelector('#modal-content input[name="category"]').value = val; App.closeSubModal(); },

            renderTransactions: () => {
                if(!document.getElementById('tx-list')) return;
                const val = document.getElementById('date-filter').value; const [y, m] = val.split('-').map(Number);
                const start = new Date(y, m-1, 1), end = new Date(y, m, 0, 23, 59, 59);
                const txs = State.data.transactions.filter(t => { const d = getTxDate(t); return d >= start && d <= end; }).sort((a,b) => getTxDate(b) - getTxDate(a));
                const grouped = {};
                txs.forEach(t => { const k = getTxDate(t).toLocaleDateString('zh-TW',{month:'numeric',day:'numeric',weekday:'short'}); if(!grouped[k]) grouped[k]={list:[],inc:0,exp:0}; grouped[k].list.push(t); if(t.type==='income') grouped[k].inc+=parseFloat(t.amount); else grouped[k].exp+=parseFloat(t.amount); });
                document.getElementById('tx-list').innerHTML = Object.entries(grouped).map(([k, v]) => {
                    const bal = v.inc - v.exp; return `<div class="mb-4"><div class="flex justify-between items-center text-xs font-bold text-gray-400 mb-2 px-1 sticky top-0"><span>${k}</span><div class="flex gap-2"><span class="text-green-600">+${v.inc.toLocaleString()}</span><span class="text-red-500">-${v.exp.toLocaleString()}</span><span class="${bal<0?'text-red-500':'text-blue-600'} border-l pl-2 border-gray-300">=${bal.toLocaleString()}</span></div></div><div class="bg-white rounded-2xl shadow-sm card-shadow overflow-hidden">${v.list.map(t => `<div class="flex justify-between items-center py-3 px-3 border-b border-gray-50 hover:bg-gray-50 cursor-pointer" onclick="App.openModal('transaction-modal', '${t.id}')"><div class="flex items-center gap-3"><div class="bg-gray-100 w-9 h-9 rounded-full flex items-center justify-center text-gray-500 text-xs font-bold">${(t.category||'æœª')[0]}</div><div><p class="font-bold text-gray-800 text-xs">${t.category||'æœªåˆ†é¡'}</p><p class="text-[10px] text-gray-400">${t.remarks||''}</p></div></div><div class="flex items-center gap-2"><p class="font-bold text-sm ${t.type==='expense'?'text-red-500':'text-green-600'}">${t.type==='expense'?'-':'+'} ${parseFloat(t.amount).toLocaleString()}</p><div class="flex gap-1"><button type="button" class="text-gray-400 hover:text-blue-500 z-10 relative" onclick="event.stopPropagation();App.openModal('transaction-modal','${t.id}')"><i class="fa-solid fa-pen text-xs"></i></button><button type="button" class="text-gray-400 hover:text-red-500 z-10 relative" onclick="event.stopPropagation();App.deleteTransaction('${t.id}')"><i class="fa-solid fa-trash-can text-xs"></i></button></div></div></div>`).join('')}</div></div>`
                }).join('') || '<div class="text-center py-10 text-gray-300">ç„¡ç´€éŒ„</div>';
            },
            updateDashboard: () => {
                if(!document.getElementById('monthly-balance')) return;
                const val = document.getElementById('date-filter').value; const [y, m] = val.split('-').map(Number);
                const start = new Date(y, m-1, 1), end = new Date(y, m, 0, 23, 59, 59);
                const txs = State.data.transactions.filter(t => { const d = getTxDate(t); return d >= start && d <= end; });
                const inc = txs.filter(t=>t.type==='income').reduce((a,b)=>a+(parseFloat(b.amount)||0),0);
                const exp = txs.filter(t=>t.type==='expense').reduce((a,b)=>a+(parseFloat(b.amount)||0),0);
                document.getElementById('monthly-income').innerText = inc.toLocaleString(); document.getElementById('monthly-expense').innerText = exp.toLocaleString(); document.getElementById('monthly-balance').innerText = (inc-exp).toLocaleString();
                const now = new Date();
                
                // RPG Stats Update
                const debts = State.data.debts.reduce((a,b)=>a+parseFloat(b.remainingAmount), 0);
                document.getElementById('boss-hp-text').innerText = `$${debts.toLocaleString()}`;
                const totalDebt = State.data.debts.reduce((a,b)=>a+parseFloat(b.totalAmount), 0);
                const hpPercent = totalDebt > 0 ? (debts / totalDebt) * 100 : 0;
                document.getElementById('boss-hp-bar').style.width = `${hpPercent}%`;
                document.getElementById('hero-level').innerText = Math.floor(State.data.transactions.length / 5) + 1;

                if(now.getMonth()+1 === m && now.getFullYear() === y) {
                    const tStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()), tEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
                    const todayTxs = State.data.transactions.filter(t => { const d = getTxDate(t); return d >= tStart && d < tEnd; });
                    const tInc = todayTxs.filter(t=>t.type==='income').reduce((a,b)=>a+(parseFloat(b.amount)||0),0);
                    const tExp = todayTxs.filter(t=>t.type==='expense').reduce((a,b)=>a+(parseFloat(b.amount)||0),0);
                    const tBal = tInc - tExp;
                    document.getElementById('today-income').innerText = tInc.toLocaleString(); document.getElementById('today-expense').innerText = tExp.toLocaleString(); document.getElementById('today-balance').innerText = tBal.toLocaleString();
                    document.getElementById('today-balance-container').className = `${tBal<0?'text-red-500':'text-blue-600'} font-medium border-l pl-2 border-gray-200`;
                }
            },
            renderInvestments: () => {
                if(!document.getElementById('inv-list')) return;
                const mVal = document.getElementById('inv-date-filter').value; const [yr, mn] = mVal ? mVal.split('-').map(Number) : [new Date().getFullYear(), new Date().getMonth()+1];
                const startM = new Date(yr, mn-1, 1), endM = new Date(yr, mn, 0, 23, 59, 59);

                const invs = State.data.investments.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                const activeInvs = invs.filter(i => State.view.invTab === 'active' ? !i.isArchived : i.isArchived);
                let tv=0, tr=0, tc=0;
                document.getElementById('inv-list').innerHTML = activeInvs.length ? activeInvs.map(i=>{
                    const subTxs = State.data.legacyTxs[i.id] || [];
                    const mainTxs = State.data.transactions.filter(t => t.project === i.name);
                    const linked = new Set(subTxs.map(t => t.mainTransactionId).filter(Boolean));
                    const all = [...subTxs, ...mainTxs.filter(t => !linked.has(t.id))];
                    const inc = all.filter(t=>t.type==='income').reduce((a,b)=>a+parseFloat(b.amount),0);
                    const exp = all.filter(t=>t.type==='expense').reduce((a,b)=>a+parseFloat(b.amount),0);
                    const profit = inc - exp;
                    if(State.view.invTab === 'active') { tv += (parseFloat(i.marketValue)||0); tc += exp; tr += profit; }

                    // FIX: Monthly earnings calculation (Income only)
                    const mInc = all.filter(t => {
                         const d = getTxDate(t);
                         return t.type==='income' && d >= startM && d <= endM;
                    }).reduce((s,t) => s + parseFloat(t.amount), 0);
                    
                    const mDisp = mInc > 0 ? `<span class="text-green-600 text-[10px] ml-2 font-bold">æœ¬æœˆæ”¶ç›Š: +${mInc.toLocaleString()}</span>` : '<span class="text-gray-300 text-[10px] ml-2">æœ¬æœˆæ”¶ç›Š: $0</span>';

                    return `<div class="bg-white p-3 rounded-xl card-shadow flex justify-between items-center cursor-pointer" onclick="App.showDetails('investment', '${i.id}')"><div class="flex-1 min-w-0 mr-2"><h4 class="font-bold text-gray-800 text-sm">${i.name}</h4><p class="text-[10px] text-gray-400">æˆæœ¬: ${(parseFloat(i.initialValue)||0).toLocaleString()}</p></div><div class="text-right"><p class="font-bold text-sm">$${(parseFloat(i.marketValue)||0).toLocaleString()}</p><p class="text-[10px] font-bold ${profit>=0?'text-green-500':'text-red-500'}">ç¸½: ${profit.toLocaleString()}</p>${mDisp}</div><button onclick="event.stopPropagation();App.openModal('investment-modal', '${i.id}')" type="button" class="text-gray-300 hover:text-blue-500 ml-2"><i class="fa-solid fa-pen text-xs"></i></button></div>`;
                }).join('') : '<div class="text-center text-gray-400 py-4 text-xs">ç„¡å¸³æˆ¶</div>';
                
                const allInvIncome = App.getAllTransactions().filter(t => {
                    const d = getTxDate(t);
                    return t.type === 'income' && t.category.includes('æŠ•è³‡') && d >= startM && d <= endM;
                }).reduce((s, t) => s + parseFloat(t.amount), 0);
                document.getElementById('inv-monthly-summary').innerText = `æœ¬æœˆæ”¶ç›Š: $${allInvIncome.toLocaleString()}`;
                
                const roi = tc > 0 ? (tr / tc) * 100 : 0;
                document.getElementById('inv-total-val').innerText = `$${tv.toLocaleString()}`; document.getElementById('inv-total-ret').innerText = `${tr>0?'+':''}${tr.toLocaleString()}`; document.getElementById('inv-roi').innerText = `${roi.toFixed(1)}%`;
                document.getElementById('inv-budget-list').innerHTML = State.data.investmentBudgets.filter(b=>!b.isRealized).sort((a,b)=>(a.expectedDate?.seconds||0)-(b.expectedDate?.seconds||0)).map(b=>`<li class="flex justify-between items-center p-2 rounded-xl border card-shadow mb-1 ${b.expectedDate?.toDate()<new Date().setHours(0,0,0,0)?'bg-red-50 border-red-200':'bg-white border-gray-100'}"><div class="text-xs"><span class="font-bold text-gray-700">${(invs.find(i=>i.id===b.targetId)?.name)||'æœªçŸ¥'}</span>: <span class="text-blue-600 font-medium">${b.description}</span> <span class="text-secondary">$${(parseFloat(b.amount)||0).toLocaleString()}</span><span class="text-[10px] ml-2 ${b.expectedDate?.toDate()<new Date().setHours(0,0,0,0)?'text-red-500 font-bold':'text-gray-400'}">${b.expectedDate?.toDate().toLocaleDateString()||''}</span></div><div class="flex gap-2"><button onclick="App.realizeBudget('investment','${b.id}')" class="text-secondary hover:text-green-700"><i class="fa-solid fa-check"></i></button><button onclick="App.openBudgetModal('investment','${b.id}')" class="text-gray-300 hover:text-blue-500"><i class="fa-solid fa-pen"></i></button><button onclick="App.deleteItem('investmentBudgets','${b.id}')" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div></li>`).join('')||'<li class="text-xs text-gray-400 text-center py-2">ç„¡é ç®—</li>';
            },
            renderDebts: () => { if(!document.getElementById('debt-list')) return;
                const mVal = document.getElementById('debt-date-filter').value; const [yr, mn] = mVal ? mVal.split('-').map(Number) : [new Date().getFullYear(), new Date().getMonth()+1];
                const startM = new Date(yr, mn-1, 1), endM = new Date(yr, mn, 0, 23, 59, 59);
                const debts = State.data.debts.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
                let tr=0, totalMonthlyRepaid=0; 
                document.getElementById('debt-list').innerHTML = debts.map(d=>{
                    tr+=parseFloat(d.remainingAmount); const p=Math.round(((d.totalAmount-d.remainingAmount)/d.totalAmount)*100);
                    // FIX: Relaxed filter for Debt Repayment
                    const debtTxs = State.data.transactions.filter(t => 
                         t.type === 'expense' && 
                         t.project === d.name &&
                         (t.category === 'è² å‚µé‚„æ¬¾' || t.remarks.includes('å„Ÿé‚„') || t.project.includes(d.name))
                    );
                    const mRepaid = debtTxs.reduce((sum, t) => {
                        const dt = getTxDate(t); 
                        return (dt >= startM && dt <= endM) ? sum + (parseFloat(t.amount)||0) : sum;
                    }, 0);
                    totalMonthlyRepaid += mRepaid;
                    const mDisp = mRepaid > 0 ? `<span class="text-[10px] text-green-600 font-medium ml-2">æœ¬æœˆå·²é‚„:$${mRepaid.toLocaleString()}</span>` : '';
                    return `<div class="bg-white p-3 rounded-xl card-shadow cursor-pointer" onclick="App.showDetails('debt', '${d.id}')"><div class="flex justify-between mb-1"><span class="font-bold text-sm">${d.name}</span><button onclick="event.stopPropagation();App.openModal('debt-modal','${d.id}')" class="text-gray-300 hover:text-blue-500"><i class="fa-solid fa-pen text-xs"></i></button></div><div class="flex justify-between text-xs text-gray-500 mb-1"><span>å‰© $${d.remainingAmount.toLocaleString()}</span>${mDisp}<span>${p}%</span></div><div class="w-full bg-gray-100 rounded-full h-1.5 mb-2"><div class="bg-primary h-1.5 rounded-full" style="width:${p}%"></div></div><div class="flex justify-end gap-2"><button onclick="event.stopPropagation();App.openRepayModal('${d.id}','${d.name}')" class="text-xs bg-green-50 px-2 py-0.5 rounded">é‚„æ¬¾</button><button onclick="event.stopPropagation();App.deleteItem('debts','${d.id}')" class="text-xs text-gray-300 px-1"><i class="fa-solid fa-trash"></i></button></div></div>`
                }).join('');
                document.getElementById('debt-total-remaining').innerText = `$${tr.toLocaleString()}`;
                document.getElementById('debt-monthly-summary').innerText = `æœ¬æœˆé‚„æ¬¾: $${totalMonthlyRepaid.toLocaleString()}`;
                document.getElementById('debt-budget-list').innerHTML = State.data.debtBudgets.filter(b=>!b.isRealized).sort((a,b)=>(a.expectedDate?.seconds||0)-(b.expectedDate?.seconds||0)).map(b=>`<li class="flex justify-between items-center p-2 rounded-xl border card-shadow mb-1 ${b.expectedDate?.toDate()<new Date().setHours(0,0,0,0)?'bg-red-50 border-red-200':'bg-white border-gray-100'}"><div class="text-xs"><span class="font-bold text-gray-700">${(State.data.debts.find(d=>d.id===b.targetId)?.name)||'æœªçŸ¥'}</span>: <span class="text-blue-600 font-medium">${b.description}</span> <span class="text-danger">$${(parseFloat(b.amount)||0).toLocaleString()}</span><span class="text-[10px] ml-2 ${b.expectedDate?.toDate()<new Date().setHours(0,0,0,0)?'text-red-500 font-bold':'text-gray-400'}">${b.expectedDate?.toDate().toLocaleDateString()||''}</span></div><div class="flex gap-2"><button onclick="App.realizeBudget('debt','${b.id}')" class="text-secondary hover:text-green-700"><i class="fa-solid fa-check"></i></button><button onclick="App.openBudgetModal('debt','${b.id}')" class="text-gray-300 hover:text-blue-500"><i class="fa-solid fa-pen"></i></button><button onclick="App.deleteItem('debtBudgets','${b.id}')" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div></li>`).join('')||'<li class="text-xs text-gray-400 text-center py-2">ç„¡è¨ˆç•«é …ç›®</li>';
            },
            renderReports: () => {
                if(!document.getElementById('report-project')) return;
                const allTxs = App.getAllTransactions();
                const pSel=document.getElementById('report-project'), cSel=document.getElementById('report-category');
                const curP=pSel.value, curC=cSel.value;
                const projs = [...new Set(allTxs.map(t=>t.project).filter(Boolean))].sort();
                pSel.innerHTML = '<option value="all">å…¨éƒ¨å°ˆæ¡ˆ</option>' + projs.map(p=>`<option value="${p}">${p}</option>`).join('');
                if(projs.includes(curP)) pSel.value = curP;
                const cats = [...new Set(allTxs.map(t=>t.category).filter(Boolean))].sort();
                cSel.innerHTML = '<option value="all">å…¨éƒ¨åˆ†é¡</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
                if(cats.includes(curC)) cSel.value = curC;
                const yr = parseInt(document.getElementById('report-year').value), mnVal = document.getElementById('report-month-select').value;
                let start, end;
                if(mnVal==='all') { start=new Date(yr,0,1); end=new Date(yr,11,31,23,59,59); } else { const m=parseInt(mnVal); start=new Date(yr,m-1,1); end=new Date(yr,m,0,23,59,59); }
                const filtered = allTxs.filter(t => { const d = getTxDate(t); return d>=start && d<=end && (pSel.value==='all'||t.project===pSel.value) && (cSel.value==='all'||t.category===cSel.value); }).sort((a,b)=>getTxDate(b)-getTxDate(a));
                if(State.chart) State.chart.destroy();
                const map={}, total=filtered.filter(t=>t.type==='expense').reduce((s,t)=>{const c=t.category||'æœªåˆ†é¡'; map[c]=(map[c]||0)+parseFloat(t.amount); return s+parseFloat(t.amount)},0);
                State.chart = new Chart(document.getElementById('expense-chart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(map), datasets: [{ data: Object.values(map), backgroundColor: ['#EF4444','#F59E0B','#10B981','#3B82F6','#6366F1','#8B5CF6','#EC4899','#6B7280'], borderWidth:0 }] }, options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right',labels:{font:{size:10},boxWidth:10}}}} });
                let statsHtml = '';
                const incMap={}, expMap={}; let incTotal=0, expTotal=0;
                filtered.forEach(t => { const amt = parseFloat(t.amount)||0; const c = t.category||'æœªåˆ†é¡'; if (t.type === 'expense') { expMap[c]=(expMap[c]||0)+amt; expTotal+=amt; } else { incMap[c]=(incMap[c]||0)+amt; incTotal+=amt; } });
                if (incTotal > 0) { statsHtml += `<li class="text-xs font-bold text-green-600 mb-2 border-b border-gray-100 pb-1 mt-2">æ”¶å…¥çµ±è¨ˆ (ç¸½è¨ˆ: $${incTotal.toLocaleString()})</li>` + Object.entries(incMap).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<li class="flex justify-between border-b border-gray-50 pb-1 last:border-0"><span>${k}</span><span class="font-bold text-green-600">$${v.toLocaleString()} <span class="text-[10px] text-gray-400 font-normal">(${((v/incTotal)*100).toFixed(1)}%)</span></span></li>`).join(''); }
                if (expTotal > 0) { statsHtml += `<li class="text-xs font-bold text-red-500 mb-2 border-b border-gray-100 pb-1 mt-4">æ”¯å‡ºçµ±è¨ˆ (ç¸½è¨ˆ: $${expTotal.toLocaleString()})</li>` + Object.entries(expMap).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<li class="flex justify-between border-b border-gray-50 pb-1 last:border-0"><span>${k}</span><span class="font-bold text-red-500">$${v.toLocaleString()} <span class="text-[10px] text-gray-400 font-normal">(${((v/expTotal)*100).toFixed(1)}%)</span></span></li>`).join(''); }
                if (incTotal === 0 && expTotal === 0) statsHtml = '<li class="text-center text-gray-400 py-4">ç„¡æ•¸æ“š</li>';
                document.getElementById('report-stats').innerHTML = statsHtml;
                document.getElementById('report-details').innerHTML = filtered.length ? filtered.map(t => `<li class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0 group cursor-pointer hover:bg-gray-50 p-1 rounded transition" onclick="App.openModal('transaction-modal', '${t.id}')"><div class="flex-1 min-w-0 mr-2"><p class="text-xs text-gray-500 mb-0.5">${getTxDate(t).toLocaleDateString()} <span class="font-medium text-gray-700">${t.category}</span></p><p class="text-[10px] text-gray-400 truncate">${t.remarks||''}</p></div><div class="flex items-center gap-2"><span class="text-xs font-bold ${t.type==='expense'?'text-red-500':'text-green-600'} whitespace-nowrap">${t.type==='expense'?'-':'+'} ${parseFloat(t.amount).toLocaleString()}</span><div class="flex gap-1"><button type="button" class="text-gray-400 hover:text-blue-500 z-10 relative" onclick="event.stopPropagation();App.openModal('transaction-modal','${t.id}')"><i class="fa-solid fa-pen text-xs"></i></button><button type="button" class="text-gray-400 hover:text-red-500 z-10 relative" onclick="event.stopPropagation();App.deleteTransaction('${t.id}', '${t.legacyInvId}')"><i class="fa-solid fa-trash-can text-xs"></i></button></div></div></li>`).join('') : '<li class="text-center text-xs text-gray-400 py-2">ç„¡äº¤æ˜“ç´€éŒ„</li>';
            },
            toggleTxType: (t) => { document.getElementById('tx-type').value=t; const e=document.getElementById('btn-expense'), i=document.getElementById('btn-income'); if(t==='expense'){e.classList.add('bg-white','shadow','text-danger');e.classList.remove('text-gray-500');i.classList.remove('bg-white','shadow','text-primary');i.classList.add('text-gray-500'); renderDatalist(document.getElementById('cat-list'), State.categories.expense);}else{i.classList.add('bg-white','shadow','text-primary');i.classList.remove('text-gray-500');e.classList.remove('bg-white','shadow','text-danger');e.classList.add('text-gray-500');renderDatalist(document.getElementById('cat-list'), State.categories.income);} }
        };
        window.App = App; App.init();
    </script>
</body>
</html>
